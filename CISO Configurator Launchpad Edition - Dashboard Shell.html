<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CISO Configurator Launchpad Edition Dashboard Shell</title>
  <meta name="description" content="Customer configurator prototype with a lightweight dashboard view in the existing Launchpad shell." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* Brand palette */
      --azure:#3C64FF;
      --silver:#D7D7E7;
      --white:#FFFFFF;
      --onyx:#17181C;
      --lime:#12DD7E;
      --tangerine:#FF700D;
      --amber:#FFBF00;
      --lilac:#B06FFF;
      --coral:#F23F55;

      /* Launchpad spacing scale */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-7: 32px;
      --s-8: 40px;

      /* Launchpad shape + typography tokens */
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 8px;
      --font: "Geologica", Arial, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --lh-header: 1.2;
      --lh-body: 1.4;
      --tracking-header: -0.04em;
      --tracking-body: 0;
      --w-light: 300;
      --w-regular: 400;
      --w-medium: 500;
      --w-semibold: 600;

      /* 10% tints */
      --tint-azure: rgba(60,100,255,.10);
      --tint-lime: rgba(18,221,126,.10);
      --tint-tangerine: rgba(255,112,13,.10);
      --tint-lilac: rgba(176,111,255,.10);
      --tint-coral: rgba(242,63,85,.10);
      --tint-amber: rgba(255,191,0,.10);

      /* Launchpad semantic surfaces */
      --bg: #f6f7fb;
      --surface: #ffffff;
      --surface-2: #f2f4fa;
      --surface-3: #edf0f8;
      --text: #0f172a;
      --muted: #5b677a;
      --subtle: rgba(15,23,42,.56);
      --border: rgba(15,23,42,.10);
      --border-strong: rgba(15,23,42,.16);
      --shadow: 0 14px 40px rgba(15,23,42,.10);
      --shadow-sm: 0 8px 22px rgba(15,23,42,.10);
      --shadow-card: 0 1px 2px rgba(15,23,42,.10), 0 4px 12px rgba(15,23,42,.08);
      --focus: 0 0 0 3px color-mix(in srgb, var(--azure) 22%, transparent);

      /* Backward-compatible aliases used across this prototype */
      --soft: var(--bg);
      --soft2: var(--surface-2);
      --radius: var(--radius-lg);

      --container: 1240px;

      /* Default accent */
      --accent: var(--azure);
      --accentSoft: var(--tint-azure);
    }

    html[data-shell-tone="soft"]{
      --bg: #f0f3fa;
      --surface: #ffffff;
      --surface-2: #edf1fb;
      --surface-3: #e8edf9;
    }

    html[data-shell-tone="dark"]{
      color-scheme: dark;
      --bg: #17181C;
      --surface: #25282E;
      --surface-2: #2F3033;
      --surface-3: #2F3033;
      --onyx: #F5F5F6;
      --text: #F5F5F6;
      --muted: #C5C6C9;
      --subtle: rgba(245,245,246,.72);
      --border: #454649;
      --border-strong: color-mix(in srgb, #454649 78%, #F5F5F6);
      --shadow: 0 16px 46px rgba(0,0,0,.55);
      --shadow-sm: 0 10px 28px rgba(0,0,0,.55);
      --shadow-card: 0 1px 2px rgba(0,0,0,.65), 0 8px 22px rgba(0,0,0,.55);
      --focus: 0 0 0 3px color-mix(in srgb, var(--azure) 22%, transparent);
    }

    html[data-shell-tone="comfort"]{
      color-scheme: dark;
      --bg: #1E2127;
      --surface: #2A2E36;
      --surface-2: #323844;
      --surface-3: #373E4B;
      --onyx: #ECEFF4;
      --text: #ECEFF4;
      --muted: #BEC5D1;
      --subtle: rgba(236,239,244,.74);
      --border: #515866;
      --border-strong: color-mix(in srgb, #515866 74%, #ECEFF4);
      --shadow: 0 16px 46px rgba(0,0,0,.48);
      --shadow-sm: 0 10px 28px rgba(0,0,0,.48);
      --shadow-card: 0 1px 2px rgba(0,0,0,.58), 0 8px 22px rgba(0,0,0,.48);
      --focus: 0 0 0 3px color-mix(in srgb, var(--azure) 22%, transparent);
    }

    html[data-shell-tone="dark"] .qBlock,
    html[data-shell-tone="comfort"] .qBlock{
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    html[data-shell-density="compact"]{ font-size:12px; }
    html[data-shell-density="comfortable"]{ font-size:13px; }

    html{ font-size:13px; }
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background: var(--soft);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
      line-height: var(--lh-body);
      font-size:1rem;
    }

    a{ color:inherit; }
    .wrap{ max-width: var(--container); margin:0 auto; padding: 0 22px; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: var(--surface);
      border-bottom:1px solid var(--border);
    }
    .topbarInner{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 0;
      gap:16px;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
      min-width:0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
      font-weight:700;
      letter-spacing:-0.02em;
      flex: 0 0 auto;
    }
    .logo{ height:28px; width:auto; display:block; }
    .nav-dashboard{
      appearance:none;
      border:1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: .88rem;
      font-weight: 650;
      line-height: 1;
      cursor:pointer;
      white-space: nowrap;
      transition: border-color .12s ease, background .12s ease, color .12s ease;
    }
    .nav-dashboard:hover{
      border-color: var(--border-strong);
      background: var(--surface-2);
    }
    .nav-dashboard[data-active="true"]{
      border-color: color-mix(in srgb, var(--azure) 44%, var(--border));
      background: color-mix(in srgb, var(--azure) 12%, var(--surface));
    }
    .workspaceNav{
      display:flex;
      width:100%;
      flex-direction:column;
      border-bottom:1px solid var(--border);
      background: var(--bg);
    }
    .workspaceItem{
      appearance:none;
      border:0;
      background: transparent;
      color: var(--text);
      width:100%;
      min-height:56px;
      padding: 8px 10px 8px 20px;
      display:grid;
      grid-template-columns: 44px minmax(0, 1fr);
      align-items:center;
      gap:10px;
      font-size:.82rem;
      font-weight:700;
      cursor:pointer;
      text-align:left;
    }
    .workspaceItem:hover{
      background: color-mix(in srgb, var(--surface) 90%, var(--bg));
    }
    .workspaceItem[data-active="true"]{
      background: transparent;
      box-shadow: none;
    }
    .workspaceItemIco{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--azure) 34%, var(--border));
      background: color-mix(in srgb, var(--azure) 10%, var(--surface));
      display:grid;
      place-items:center;
      font-size:16px;
      line-height:1;
      color: var(--text);
      flex: 0 0 auto;
    }
    .workspaceItem > span:last-child{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:13px;
      font-weight:700;
      letter-spacing:0;
    }
    .workspaceCompanies{
      border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 97%, var(--accent) 3%);
    }
    .workspaceCompaniesHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding: 8px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 86%, transparent);
    }
    .workspaceCompaniesLabel{
      font-size:.68rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:700;
    }
    .workspaceCompaniesCount{
      font-size:.72rem;
      color: var(--muted);
      border:1px solid var(--border);
      border-radius:999px;
      padding: 2px 7px;
      background: var(--surface);
      line-height:1.2;
    }
    .workspaceCompaniesList{
      display:grid;
      gap:6px;
      padding: 8px;
      overflow:visible;
    }
    .workspaceCompanyBtn{
      appearance:none;
      border:1px solid color-mix(in srgb, var(--border) 84%, transparent);
      border-radius:10px;
      background: var(--surface);
      color: var(--text);
      text-align:left;
      padding: 8px 9px;
      display:grid;
      gap:3px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
    }
    .workspaceCompanyBtn:hover{
      border-color: color-mix(in srgb, var(--azure) 78%, var(--border));
      background: var(--surface);
    }
    .workspaceCompanyBtn[data-active="true"]{
      border-color: color-mix(in srgb, var(--azure) 84%, var(--border));
      background: var(--surface);
      box-shadow:none;
    }
    .workspaceCompanyBtn:focus-visible{
      outline:none;
      border-color: color-mix(in srgb, var(--azure) 84%, var(--border));
      box-shadow:none;
    }
    .workspaceCompanyName{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
      font-size:.84rem;
      font-weight:700;
      letter-spacing:-.01em;
    }
    .workspaceCompanyNameLabel{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .workspacePriorityStar{
      flex:0 0 auto;
      display:inline-grid;
      place-items:center;
      width:14px;
      font-size:.94rem;
      line-height:1;
      color: color-mix(in srgb, var(--tangerine) 86%, var(--text) 14%);
      transform-origin: 50% 58%;
    }
    .workspacePriorityStar.is-animate{
      animation: workspaceStarPop .46s cubic-bezier(.2,.9,.24,1.1);
    }
    @keyframes workspaceStarPop{
      0%{
        opacity:0;
        transform: translateY(2px) scale(.35) rotate(-22deg);
      }
      62%{
        opacity:1;
        transform: translateY(-1px) scale(1.22) rotate(8deg);
      }
      100%{
        opacity:1;
        transform: translateY(0) scale(1) rotate(0);
      }
    }
    .workspaceCompanyMeta{
      font-size:.72rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .workspaceCompaniesEmpty{
      font-size:.78rem;
      color: var(--muted);
      padding: 6px 4px;
      line-height:1.4;
    }
    .recordContext{
      border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 97%, var(--accent) 3%);
      padding: 6px 8px;
    }
    .recordContextBtn{
      appearance:none;
      width:100%;
      border:1px solid color-mix(in srgb, var(--border) 84%, transparent);
      border-radius: 10px;
      background: color-mix(in srgb, var(--surface) 94%, var(--accent) 6%);
      color: var(--text);
      padding: 8px 9px;
      display:grid;
      grid-template-columns: 18px 1fr;
      align-items:center;
      gap:8px;
      text-align:left;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
    }
    .recordContextBtn:hover{
      border-color: color-mix(in srgb, var(--azure) 44%, var(--border));
      background: color-mix(in srgb, var(--azure) 11%, var(--surface));
    }
    .recordContextArrow{
      display:grid;
      place-items:center;
      font-size:12px;
      color: var(--azure);
      font-weight:800;
      line-height:1;
    }
    .recordContextBody{
      min-width:0;
    }
    .recordContextBack{
      display:block;
      font-size:.68rem;
      text-transform: uppercase;
      letter-spacing:.11em;
      color: var(--muted);
      font-weight:700;
      line-height:1;
    }
    .recordContextName{
      display:block;
      margin-top:4px;
      font-size:.94rem;
      font-weight:700;
      color: var(--text);
      letter-spacing:-.01em;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .progress{
      display:flex; gap:10px; align-items:center;
      overflow:auto;
      padding:2px 0;
      flex: 1 1 auto;
      justify-content:flex-end;
    }
    .chip{
      appearance:none;
      display:inline-flex; align-items:center; gap:10px;
      border:1px solid var(--border);
      background: var(--surface);
      border-radius:999px;
      padding:10px 12px;
      font-size:1rem;
      color: var(--muted);
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .chip:hover{ transform: translateY(-1px); }
    .chip strong{
      display:inline-grid; place-items:center;
      width:22px; height:22px;
      border-radius:7px;
      background: var(--soft2);
      color: var(--text);
      font-size:.8rem;
      font-weight:900;
    }
    .chip[data-active="true"]{
      border-color: rgba(60,100,255,.38);
      background: rgba(60,100,255,.10);
      color: var(--text);
    }
    .chip[data-done="true"] strong{
      background: var(--tint-lime);
      border: 1px solid rgba(18,221,126,.25);
      color: #0f172a;
    }
    .chip:focus-visible{ outline:none; box-shadow: var(--focus); border-color: var(--azure); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      padding: 16px 0 36px;
      align-items:start;
    }
    #dashboardView{
      display:none;
      padding: 16px 0 30px;
    }
    #archivedView{
      display:none;
      padding: 16px 0 30px;
    }
    #accountView{
      display:none;
      padding: 16px 0 30px;
    }
    body.is-dashboard-view #dashboardView{
      display:block;
    }
    body.is-archived-view #archivedView{
      display:block;
    }
    body.is-account-view #accountView{
      display:block;
    }
    body.is-dashboard-view .grid{
      display:none;
    }
    body.is-archived-view .grid{
      display:none;
    }
    body.is-account-view .grid{
      display:none;
    }
    body.is-dashboard-view #interstitialView{
      display:none;
    }
    body.is-dashboard-view #accountView{
      display:none;
    }
    body.is-dashboard-view #archivedView{
      display:none;
    }
    body.is-interstitial-view #dashboardView{
      display:none;
    }
    body.is-interstitial-view #archivedView{
      display:none;
    }
    body.is-interstitial-view #accountView{
      display:none;
    }
    body.is-account-view #dashboardView{
      display:none;
    }
    body.is-account-view #archivedView{
      display:none;
    }
    body.is-archived-view #dashboardView{
      display:none;
    }
    body.is-archived-view #interstitialView{
      display:none;
    }
    body.is-archived-view #accountView{
      display:none;
    }
    body.is-account-view #interstitialView{
      display:none;
    }
    body.is-interstitial-view #interstitialView{
      display:block;
    }
    body.is-interstitial-view .grid{
      display:none;
    }
    body.is-dashboard-view footer{
      display:none;
    }
    body.is-account-view footer{
      display:none;
    }
    body.is-archived-view footer{
      display:none;
    }
    body.is-interstitial-view footer{
      display:none;
    }
    body.is-dashboard-view .colResize--right{
      display:none !important;
    }
    body.is-account-view .colResize--right{
      display:none !important;
    }
    body.is-archived-view .colResize--right{
      display:none !important;
    }
    body.is-interstitial-view .colResize--right{
      display:none !important;
    }
    body:is(.is-dashboard-view, .is-interstitial-view, .is-account-view, .is-archived-view) .progress{
      display:none;
    }
    body:is(.is-dashboard-view, .is-interstitial-view, .is-account-view, .is-archived-view) .recordContext{
      display:none;
    }
    body.is-configurator-view .workspaceNav,
    body.is-configurator-view .workspaceCompanies,
    body.is-configurator-view .nav-settingsDock{
      display:none;
    }
    .globalActionBar{
      position: sticky;
      top: 0;
      z-index: 20;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:56px;
      padding: 10px 14px;
      margin: 12px 0 10px;
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      background:
        radial-gradient(520px 190px at 12% -34%, color-mix(in srgb, var(--azure) 10%, transparent), transparent 72%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 96%, var(--accent) 4%), var(--surface));
      box-shadow: var(--shadow-card);
    }
    .globalActionContext{
      min-width:0;
      font-size: clamp(1.45rem, 2.5vw, 2rem);
      line-height:1.08;
      font-weight:760;
      color: var(--text);
      letter-spacing:-0.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .globalActionBtns{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      margin-left:auto;
    }
    .dashboardShell{
      border:1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      box-shadow: var(--shadow-card);
      overflow:hidden;
    }
    .dashboardHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 18px 20px 16px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(620px 240px at 10% -20%, color-mix(in srgb, var(--azure) 9%, transparent), transparent 70%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 95%, var(--accent) 5%), var(--surface));
    }
    .dashboardHead h2{
      margin:0;
      font-size: clamp(1.35rem, 2.6vw, 1.9rem);
      letter-spacing:-0.03em;
      font-weight:700;
    }
    .dashboardSub{
      margin-top:6px;
      color: var(--muted);
      font-size: .95rem;
    }
    .dashboardMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 12px 20px;
      border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 70%, var(--surface));
    }
    .dashboardPill{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size:.82rem;
      color: var(--muted);
      background: var(--surface);
    }
    .dashboardToolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 10px 20px;
      border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 60%, var(--surface));
    }
    .dashboardSelectAll{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:.86rem;
      color: var(--text);
    }
    .dashboardSelectAll input{
      width:16px;
      height:16px;
    }
    .dashboardSelectCount{
      font-size:.84rem;
      color: var(--muted);
    }
    .dashArchiveSelectedBtn{
      white-space: nowrap;
    }
    .dashboardTableWrap{
      padding: 0 14px 12px;
      overflow-x:auto;
      overflow-y:hidden;
    }
    .dashboardTable{
      width:100%;
      border-collapse: collapse;
      min-width: 0;
      table-layout: fixed;
      --dash-col-company: 17%;
      --dash-col-completion: 13%;
      --dash-col-tier: 10%;
      --dash-col-outcomes: 26%;
      --dash-col-gaps: 15%;
      --dash-col-actions: 11%;
    }
    .dashboardTable th,
    .dashboardTable td{
      padding: 12px 10px;
      border-bottom:1px solid var(--border);
      vertical-align: top;
      text-align:left;
    }
    .dashboardTable th.dashSelectCol,
    .dashboardTable td.dashSelectCol{
      width: 24px;
      text-align:center;
      padding-left:2px;
      padding-right:2px;
    }
    .dashboardTable th:nth-child(2), .dashboardTable td:nth-child(2){ width: var(--dash-col-company); }
    .dashboardTable th:nth-child(3), .dashboardTable td:nth-child(3){ width: var(--dash-col-completion); }
    .dashboardTable th:nth-child(4), .dashboardTable td:nth-child(4){ width: var(--dash-col-tier); }
    .dashboardTable th:nth-child(5), .dashboardTable td:nth-child(5){ width: var(--dash-col-outcomes); }
    .dashboardTable th:nth-child(6), .dashboardTable td:nth-child(6){ width: var(--dash-col-gaps); }
    .dashboardTable th:nth-child(7), .dashboardTable td:nth-child(7){
      width: var(--dash-col-actions);
      text-align:right;
      white-space: nowrap;
    }
    .dashboardTable th{
      position: relative;
      font-size: .74rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
      background: color-mix(in srgb, var(--surface-2) 74%, var(--surface));
      white-space: nowrap;
    }
    .dashColHeadLabel{
      display:inline-block;
      padding-right: 14px;
    }
    .dashColResizer{
      appearance:none;
      position:absolute;
      top:0;
      right:-6px;
      bottom:0;
      width:12px;
      border:0;
      background:transparent;
      padding:0;
      cursor: col-resize;
      touch-action:none;
      z-index: 2;
    }
    .dashColResizer::before{
      content:"";
      position:absolute;
      top:8px;
      bottom:8px;
      left:5px;
      width:1px;
      background: color-mix(in srgb, var(--border) 70%, transparent);
    }
    .dashColResizer:hover::before,
    .dashboardTable th.is-col-resizing .dashColResizer::before{
      background: color-mix(in srgb, var(--accent) 50%, var(--border));
    }
    body.is-dash-col-resizing{
      cursor: col-resize;
      user-select:none;
    }
    .dashboardTable tbody tr{
      cursor: pointer;
    }
    .dashboardTable tbody tr[data-selected="true"]{
      background: color-mix(in srgb, var(--azure) 8%, var(--surface));
    }
    .dashboardTable tbody tr:hover{
      background: color-mix(in srgb, var(--azure) 6%, var(--surface));
    }
    .dashRowCheck{
      width:13px;
      height:13px;
      cursor:pointer;
    }
    .dashCompanyCell{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .dashStarBtn{
      appearance:none;
      border:0;
      background:transparent;
      color: color-mix(in srgb, var(--muted) 82%, var(--text) 18%);
      font-size:1rem;
      line-height:1;
      width:20px;
      height:20px;
      display:grid;
      place-items:center;
      padding:0;
      cursor:pointer;
      border-radius:6px;
      flex: 0 0 auto;
    }
    .dashStarBtn:hover{
      background: color-mix(in srgb, var(--surface-2) 72%, var(--surface));
    }
    .dashStarBtn[data-active="true"]{
      color: color-mix(in srgb, var(--tangerine) 86%, var(--text) 14%);
      text-shadow: 0 0 0.5px color-mix(in srgb, var(--tangerine) 70%, transparent);
    }
    .dash-company{
      font-weight: 700;
      letter-spacing: -.01em;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .dash-tier{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: .8rem;
      font-weight: 700;
      background: color-mix(in srgb, var(--surface-2) 76%, var(--surface));
    }
    .dashCompletion{
      display:flex;
      align-items:center;
      min-height: 44px;
    }
    .dashCompletionRing{
      --pct: 0;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background:
        conic-gradient(
          color-mix(in srgb, var(--azure) 85%, var(--lilac) 15%) calc(var(--pct) * 1%),
          color-mix(in srgb, var(--surface-2) 76%, var(--surface)) 0
        );
      position: relative;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--border) 80%, transparent);
    }
    .dashCompletionRing::before{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:inherit;
      background: var(--surface);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--border) 78%, transparent);
    }
    .dashCompletionRing > span{
      position:relative;
      z-index:1;
      font-size:.74rem;
      font-weight: 800;
      color: var(--text);
      letter-spacing:-.01em;
    }
    .dash-outcomes,
    .dash-gaps{
      font-size:.92rem;
      color: var(--text);
      line-height: 1.45;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .dash-open{
      color: var(--azure);
      font-size: .86rem;
      font-weight: 700;
      white-space: nowrap;
    }
    .dashActions{
      display:inline-flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      width:100%;
    }
    .dashActionBtn{
      appearance:none;
      border:1px solid var(--border);
      border-radius:999px;
      background: var(--surface);
      color: var(--text);
      font-size:.76rem;
      font-weight:700;
      padding: 5px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    .dashActionBtn:hover{
      border-color: color-mix(in srgb, var(--azure) 44%, var(--border));
      background: color-mix(in srgb, var(--azure) 8%, var(--surface));
    }
    .dashActionBtn.open{
      color: var(--azure);
    }
    .accountShell{
      border:1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      box-shadow: var(--shadow-card);
      overflow:hidden;
    }
    .accountHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 18px 20px 16px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(620px 240px at 10% -20%, color-mix(in srgb, var(--azure) 10%, transparent), transparent 70%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 95%, var(--accent) 5%), var(--surface));
    }
    .accountHead h2{
      margin:0;
      font-size: clamp(1.35rem, 2.6vw, 1.85rem);
      letter-spacing:-0.03em;
      font-weight:700;
    }
    .accountSub{
      margin-top:6px;
      color: var(--muted);
      font-size:.95rem;
      max-width: 760px;
      line-height:1.45;
    }
    .accountBody{
      padding: 16px 18px 18px;
      display:grid;
      gap:14px;
    }
    #accountView .settingsRow{
      margin:0;
    }
    #interstitialView{
      display:none;
      padding: 16px 0 30px;
    }
    .interShell{
      border:1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      box-shadow: var(--shadow-card);
      overflow:hidden;
    }
    .interHead{
      padding: 18px 20px 14px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(600px 220px at 8% -24%, color-mix(in srgb, var(--azure) 10%, transparent), transparent 70%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 95%, var(--accent) 5%), var(--surface));
    }
    .interCrumbs{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.82rem;
      color: var(--muted);
      margin-bottom:8px;
    }
    .interCrumbHome{
      color: var(--azure);
      font-weight: 650;
    }
    .interTitleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .interTitleMain{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .interTitleStarBtn{
      appearance:none;
      flex:0 0 auto;
      width:32px;
      height:32px;
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--border) 84%, transparent);
      background: var(--surface);
      color: color-mix(in srgb, var(--muted) 82%, var(--text) 18%);
      display:grid;
      place-items:center;
      font-size:1rem;
      line-height:1;
      cursor:pointer;
      transition: border-color .16s ease, color .16s ease, transform .16s ease, background .16s ease;
    }
    .interTitleStarBtn:hover{
      border-color: color-mix(in srgb, var(--azure) 58%, var(--border));
      color: color-mix(in srgb, var(--tangerine) 72%, var(--text) 28%);
    }
    .interTitleStarBtn[data-active="true"]{
      border-color: color-mix(in srgb, var(--tangerine) 60%, var(--border));
      color: color-mix(in srgb, var(--tangerine) 88%, var(--text) 12%);
      background: color-mix(in srgb, var(--tangerine) 8%, var(--surface));
    }
    .interTitleStarBtn:active{
      transform: scale(.92);
    }
    .interTitleRow h2{
      margin:0;
      font-size: clamp(1.4rem, 2.6vw, 2rem);
      letter-spacing:-0.03em;
      font-weight:700;
      line-height:1.08;
    }
    .interSub{
      margin-top:6px;
      color: var(--muted);
      font-size:.95rem;
    }
    .interActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .interMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .interPill{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding: 6px 10px;
      font-size:.82rem;
      color: var(--muted);
      background: var(--surface);
    }
    .interPackageHero{
      padding: 16px 20px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(680px 240px at 6% -40%, color-mix(in srgb, var(--azure) 13%, transparent), transparent 72%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 97%, var(--accent) 3%), var(--surface));
    }
    .interPackageKicker{
      margin:0;
      font-size:.78rem;
      text-transform: uppercase;
      letter-spacing:.14em;
      font-weight: 800;
      color: color-mix(in srgb, var(--text) 72%, var(--azure) 28%);
    }
    .interPackageTitle{
      margin:6px 0 0;
      font-size: clamp(1.4rem, 2.2vw, 2rem);
      line-height:1.06;
      letter-spacing:-.03em;
      font-weight: 800;
      color: var(--azure);
    }
    .interPackageBody{
      margin:9px 0 0;
      font-size: .98rem;
      line-height:1.45;
      color: color-mix(in srgb, var(--text) 84%, var(--muted) 16%);
      max-width: 980px;
    }
    .interPackageHero[data-tier-key="core"] .interPackageTitle{
      color: color-mix(in srgb, var(--azure) 88%, var(--text) 12%);
    }
    .interPackageHero[data-tier-key="adv"] .interPackageTitle{
      color: color-mix(in srgb, var(--azure) 92%, var(--lilac) 8%);
    }
    .interPackageHero[data-tier-key="ult"] .interPackageTitle{
      color: color-mix(in srgb, var(--lime) 75%, var(--text) 25%);
    }
    .interViz{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      padding: 14px;
      border-bottom:1px solid var(--border);
      background:
        radial-gradient(760px 260px at 96% -40%, color-mix(in srgb, var(--lilac) 9%, transparent), transparent 76%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 97%, var(--azure) 3%), var(--surface));
    }
    .interVizCard{
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      background: color-mix(in srgb, var(--surface) 93%, var(--accent) 7%);
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.4);
    }
    .interVizTitle{
      margin:0;
      font-size:1rem;
      font-weight:700;
      letter-spacing:-.01em;
    }
    .interVizSub{
      margin:4px 0 0;
      font-size:.85rem;
      color: var(--muted);
      line-height:1.4;
    }
    .interRoiGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
    }
    .interRoiMetric{
      border:1px solid color-mix(in srgb, var(--border) 84%, transparent);
      border-radius: 10px;
      padding: 9px;
      background: color-mix(in srgb, var(--surface) 90%, var(--azure) 10%);
    }
    .interRoiMetricLabel{
      margin:0;
      font-size:.72rem;
      text-transform: uppercase;
      letter-spacing:.08em;
      color: var(--muted);
      font-weight:700;
    }
    .interRoiMetricValue{
      margin:5px 0 0;
      font-size:1.08rem;
      line-height:1.1;
      letter-spacing:-.02em;
      font-weight:750;
      color: var(--text);
      min-height:1.2em;
    }
    .interOutcomeList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .interOutcomeRow{
      display:grid;
      gap:4px;
    }
    .interOutcomeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .interOutcomeLabel{
      font-size:.84rem;
      font-weight:650;
      color: var(--text);
      line-height:1.3;
    }
    .interOutcomePct{
      font-size:.8rem;
      font-weight:700;
      color: var(--azure);
      min-width:42px;
      text-align:right;
    }
    .interOutcomeTrack{
      width:100%;
      height:7px;
      border-radius:999px;
      background: color-mix(in srgb, var(--border) 48%, var(--surface));
      overflow:hidden;
      position:relative;
    }
    .interOutcomeFill{
      display:block;
      height:100%;
      width:0;
      border-radius:999px;
      background: linear-gradient(90deg, color-mix(in srgb, var(--azure) 90%, white 10%), color-mix(in srgb, var(--lilac) 66%, var(--azure)));
      transition: width .6s cubic-bezier(.22,.61,.36,1);
      transition-delay: var(--delay, 0ms);
    }
    .interGrid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding: 14px;
    }
    .interCard{
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      padding: 14px;
    }
    .interCard h3{
      margin:0 0 10px;
      font-size:1.04rem;
      letter-spacing:-0.01em;
      font-weight:700;
    }
    .interCardWide{
      grid-column: 1 / -1;
    }
    .interKvs{
      display:grid;
      gap:0;
    }
    .interKv{
      display:grid;
      grid-template-columns: 165px 1fr;
      gap:12px;
      padding: 8px 0;
      border-bottom:1px solid color-mix(in srgb, var(--border) 84%, transparent);
      align-items:flex-start;
    }
    .interKv:last-child{
      border-bottom:0;
    }
    .interKvLabel{
      color: var(--muted);
      font-size:.83rem;
      font-weight:650;
      text-transform: uppercase;
      letter-spacing:.04em;
    }
    .interKvVal{
      color: var(--text);
      font-size:.93rem;
      line-height:1.42;
    }
    .interGapList{
      display:grid;
      gap:10px;
    }
    .interGapItem{
      border:1px solid color-mix(in srgb, var(--tangerine) 40%, var(--border));
      border-radius: var(--radius-sm);
      background: color-mix(in srgb, var(--tangerine) 8%, var(--surface));
      padding: 10px 11px;
    }
    .interGapTitle{
      margin:0;
      font-size:.95rem;
      font-weight:700;
      letter-spacing:-0.01em;
    }
    .interGapWhy{
      margin:5px 0 0;
      font-size:.88rem;
      color: color-mix(in srgb, var(--muted) 72%, var(--text));
      line-height:1.42;
    }
    .interGapActions{
      margin-top:8px;
    }
    .interEditLink{
      appearance:none;
      border:0;
      background: transparent;
      color: var(--azure);
      font-size:.86rem;
      font-weight:700;
      padding:0;
      cursor:pointer;
    }
    .interEmpty{
      border:1px solid color-mix(in srgb, var(--lime) 40%, var(--border));
      border-radius: var(--radius-sm);
      background: color-mix(in srgb, var(--lime) 10%, var(--surface));
      padding: 10px 11px;
      font-size:.9rem;
      color: color-mix(in srgb, var(--lime) 76%, var(--text));
      font-weight:650;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .sticky{ position: static !important; top:auto !important; }
      .progress{ justify-content:flex-start; }
      .globalActionBar{
        position: static;
        flex-direction:column;
        align-items:flex-start;
      }
      .globalActionBtns{
        width:100%;
      }
      .dashboardHead{
        flex-direction:column;
      }
      .accountHead{
        flex-direction:column;
      }
      .dashboardTable{
        min-width: 760px;
      }
      .interTitleRow{
        flex-direction:column;
      }
      .interViz{
        grid-template-columns: 1fr;
      }
      .interRoiGrid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .interGrid{
        grid-template-columns: 1fr;
      }
      .interKv{
        grid-template-columns: 1fr;
        gap:6px;
      }
    }

    /* Cards */
    .card{
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .cardPad{ padding:18px; }

    /* Intro */
    .titleBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title h1{
      margin:0;
      font-size: clamp(1.55rem, 2.4vw, 2.15rem);
      line-height:1.12;
      letter-spacing:-0.04em;
      font-weight:650;
    }
    .titleActions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      margin-left:auto;
    }
    .saveRecordBtn{
      min-width: 124px;
      background: var(--azure);
      border-color: var(--azure);
      color:#fff;
      transition: background .22s ease, border-color .22s ease, color .22s ease, box-shadow .22s ease;
    }
    .saveRecordBtn[data-thinking="true"]{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--azure) 20%, transparent);
      cursor: progress;
    }
    .saveRecordBtn[data-saved="true"]{
      background: color-mix(in srgb, var(--lime) 16%, var(--surface));
      border-color: color-mix(in srgb, var(--lime) 46%, var(--border));
      color: color-mix(in srgb, var(--lime) 82%, #0f5132 18%);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--lime) 18%, transparent);
    }
    .saveRecordBtn .saveSpinner{
      width: 13px;
      height: 13px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.36);
      border-top-color: rgba(255,255,255,.95);
      display: none;
      animation: saveBtnSpin .75s linear infinite;
      flex: 0 0 auto;
    }
    .saveRecordBtn[data-thinking="true"] .saveSpinner{
      display: inline-block;
    }
    .saveRecordBtn .saveCheck{
      display:none;
      font-weight:900;
      line-height:1;
    }
    .saveRecordBtn[data-thinking="true"] .saveCheck{
      display:none !important;
    }
    .saveRecordBtn[data-saved="true"] .saveCheck{
      display:inline-block;
    }
    @keyframes saveBtnSpin{
      to { transform: rotate(360deg); }
    }
    @media (max-width: 720px){
      .titleActions{
        width:100%;
        margin-left:0;
        justify-content:flex-end;
      }
      .saveRecordBtn{
        width:auto;
      }
    }
    .subhead{
      margin-top:8px;
      color: var(--muted);
      font-size:1rem;
    }

    details.introDetails{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--soft);
      padding:12px 14px;
    }
    details.introDetails summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--text);
    }
    details.introDetails summary::-webkit-details-marker{ display:none; }
    details.introDetails summary .chev{
      color: var(--muted);
      font-weight:900;
      transform: rotate(0deg);
      transition: transform .14s ease;
    }
    details.introDetails[open] summary .chev{ transform: rotate(180deg); }
    details.introDetails p{
      margin:10px 0 0;
      color: var(--muted);
      font-size:1rem;
      line-height:1.55;
    }

    /* Step shell */
    .stepHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin: 0 0 14px;
    }
    .stepHeadActions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .reviewCtaBar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .reviewCtaBar{
        width:100%;
      }
    }
    @media (max-width: 620px){
      .reviewCtaBar{
        width:100%;
        flex-direction:column;
        align-items:stretch;
      }
      .reviewCtaBar .btn{
        width:100%;
      }
    }
    #bookForm{ scroll-margin-top: 92px; }
    .formHead .sectionTitle{ font-size:1.05rem; }
    .stepHead h2{
      margin:0;
      font-size:1.15rem;
      letter-spacing:-0.02em;
      font-weight:900;
      color: var(--onyx);
    }
    .stepHead .hint{
      margin-top:6px;
      font-size:1rem;
      color: var(--muted);
      line-height:1.45;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background: var(--soft2);
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      font-size:1rem;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.small{ padding:6px 10px; font-size:.9rem; }


    .divider{
      height:1px;
      background: var(--border);
      margin:16px 0;
    }
    .step{ display:none; }
    .step[data-active="true"]{ display:block; }

    /* Step accents */
    .step[data-step="1"]{ --accent: var(--azure); --accentSoft: var(--tint-azure); }
    .step[data-step="2"]{ --accent: var(--lilac); --accentSoft: var(--tint-lilac); }
    .step[data-step="3"]{ --accent: var(--tangerine); --accentSoft: var(--tint-tangerine); }
    .step[data-step="4"]{ --accent: var(--azure); --accentSoft: var(--tint-azure); }
    .step[data-step="5"]{ --accent: var(--lime); --accentSoft: var(--tint-lime); }
    .step[data-step="6"]{ --accent: var(--azure); --accentSoft: var(--tint-azure); }

    /* Form */
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 720px){ .row{ grid-template-columns:1fr; } }

    label{
      display:block;
      font-size:1rem;
      color: var(--muted);
      margin:0 0 8px;
      font-weight:650;
    }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font: inherit;
      font-size:1rem;
      outline:none;
      background: var(--surface);
    }
    textarea{ min-height: 108px; resize: vertical; }
    input:focus, select:focus, textarea:focus{ border-color: var(--azure); box-shadow: var(--focus); }

    .sectionTitle{
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--onyx);
      font-size:1rem;
    }

    .labelRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    /* Info tooltip (small "i") */
    .info{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--soft2);
      color: var(--muted);
      font-size:1rem;
      font-weight:900;
      cursor:help;
      user-select:none;
      line-height:1;
      flex:0 0 auto;
      margin-top: -2px;
    }
    .info:focus-visible{ outline:none; box-shadow: var(--focus); border-color: var(--azure); }
    .info .tip{
      position:absolute;
      left:50%;
      bottom:130%;
      transform:translateX(-50%) translateY(0);
      width:min(380px, calc(100vw - 28px));
      background:rgba(15,17,22,.94);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-size:1rem;
      line-height:1.45;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 34px rgba(0,0,0,.28);
      opacity:0;
      pointer-events:none;
      transition: opacity .14s ease, transform .14s ease;
      z-index:80;
    }
    .info:hover .tip,
    .info:focus .tip{
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(-2px);
    }
    .labelRow > .info .tip{
      left:auto;
      right:0;
      transform:translateY(0);
    }
    .labelRow > .info:hover .tip,
    .labelRow > .info:focus .tip{
      transform:translateY(-2px);
    }
    .roiTitleRow > .info .tip,
    .rangeLabel > .info .tip,
    .summaryLabelWithInfo > .info .tip{
      left:0;
      right:auto;
      transform:translateY(0);
      width:min(360px, calc(100vw - 28px));
    }
    .roiTitleRow > .info:hover .tip,
    .roiTitleRow > .info:focus .tip,
    .rangeLabel > .info:hover .tip,
    .rangeLabel > .info:focus .tip,
    .summaryLabelWithInfo > .info:hover .tip,
    .summaryLabelWithInfo > .info:focus .tip{
      transform:translateY(-2px);
    }

    /* Question block */
    .qBlock{
      border:1px solid rgba(23,24,28,.12);
      border-radius: var(--radius-sm);
      padding:14px;
      background: var(--accentSoft);
      position:relative;
    }
        .qBlock > *{ position:relative; }

    .mini{
      margin-top:10px;
      font-size:1rem;
      color: var(--muted);
      line-height:1.5;
    }


    .helperText{
      margin-top:8px;
      font-size:.95rem;
      color: var(--muted);
      line-height:1.45;
    }

/* Regulation picker controls */
.regControls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:stretch;
  margin-top:12px;
}
.regControls .grow,
.regControls .fixed{
  display:grid;
  gap:6px;
  align-content:end;
}
.regControls .grow{ flex: 1 1 360px; }
.regControls .fixed{ flex: 0 1 220px; min-width: 200px; }
.regMetaRow{
  display:flex;
  align-items:flex-start;
  gap:12px;
  margin-top:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}
.regMetaRow .mini,
.regMetaRow .helperText{
  margin-top:0;
}
.regMetaRow #regSuggestedFor{
  color: var(--text);
  font-weight:650;
}
.regMetaRow #regModeHint{
  flex:1 1 auto;
  min-width:0;
  padding-left:12px;
  border-left:1px solid var(--border);
  font-size:.92rem;
}
#regSearch{
  width:100%;
  box-sizing:border-box;
  border:1px solid color-mix(in srgb, var(--border) 92%, transparent);
  border-radius: 12px;
  padding: 12px 14px 12px 42px;
  font: inherit;
  font-size:1rem;
  line-height:1.35;
  outline:none;
  background-color: color-mix(in srgb, var(--surface) 95%, var(--accent) 5%);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.76);
  transition: border-color .14s ease, box-shadow .14s ease, background .14s ease;
  min-height: 46px;
  -webkit-appearance: none;
  appearance: none;
  background-repeat:no-repeat;
  background-size:16px 16px;
  background-position: 14px 50%;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='7' cy='7' r='4.8' fill='none' stroke='%235B677A' stroke-width='1.6'/%3E%3Cpath d='M10.8 10.8L14.2 14.2' stroke='%235B677A' stroke-width='1.6' stroke-linecap='round'/%3E%3C/svg%3E");
}
#regSearch:hover{
  border-color: var(--border-strong);
}
#regSearch:focus{
  border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
}
#regSearch::-webkit-search-cancel-button{
  -webkit-appearance: none;
}
@media (max-width: 860px){
  .regMetaRow{
    flex-direction:column;
    gap:8px;
  }
  .regMetaRow #regModeHint{
    padding-left:0;
    border-left:0;
    padding-top:8px;
    border-top:1px solid var(--border);
  }
}
.seg{
  display:inline-flex;
  border:1px solid var(--border);
  border-radius:999px;
  overflow:hidden;
  background: var(--surface);
  width:100%;
}
.segBtn{
  flex:1 1 auto;
  border:0;
  background:transparent;
  padding:10px 12px;
  font: inherit;
  font-size:1rem;
  font-weight:650;
  cursor:pointer;
  color: var(--muted);
  transition: background .12s ease, color .12s ease;
}
.segBtn + .segBtn{ border-left:1px solid var(--border); }
.segBtn[data-active="true"]{
  background: var(--accentSoft);
  color: var(--text);
}
.segBtn:focus-visible{ outline:none; box-shadow: var(--focus); position:relative; z-index:2; }

    /* Options pills */
    .options{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    .opt{
      border:1px solid var(--border);
      background: var(--surface);
      border-radius:999px;
      padding:10px 14px;
      font-size:1rem;
      font-weight:650;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .opt:hover{ transform: translateY(-1px); }
    .opt[aria-pressed="true"]{
      border-color: var(--border-strong);
      background: var(--accentSoft);
      box-shadow: 0 0 0 2px rgba(0,0,0,0);
      position:relative;
    }
    .opt[aria-pressed="true"]::before{
      content:"";
      display:inline-block;
      width:10px; height:10px;
      border-radius:999px;
      background: var(--accent);
      margin-right:8px;
      transform: translateY(1px);
    }
    .opt:focus-visible{ outline:none; box-shadow: var(--focus); border-color: var(--azure); }

    /* Radio cards */
    .radioGrid{ display:grid; gap:12px; margin-top:12px; }
    .radioGrid.twoCol{ grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .radioGrid.twoCol{ grid-template-columns:1fr; } }

    .radio{
      display:flex; align-items:flex-start; gap:12px;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      cursor:pointer;
      background: var(--surface);
      position:relative;
    }
    .radio input{ margin-top:2px; width:20px; height:20px; }
    .radio strong{ font-size:1rem; font-weight:900; letter-spacing:-0.01em; color: var(--onyx); }
    .radio span{ display:block; font-size:1rem; font-weight:400; color: var(--muted); margin-top:4px; line-height:1.35; }
    .radio .mapHint{
      display:block;
      margin-top:8px;
      font-size:.84rem;
      font-weight:700;
      color: var(--text);
      opacity:.82;
    }

    .radio:has(input:checked){
      border-color: var(--border-strong);
      background: var(--accentSoft);
      box-shadow: 0 0 0 3px rgba(0,0,0,0);
    }

    .outcomeTop3{
      margin:12px auto 0;
      color: var(--muted);
      display:grid;
      gap:8px;
      font-size:.97rem;
      line-height:1.35;
      width:min(100%, 1240px);
    }
    .outcomeTopItem{
      display:grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      align-items:center;
      column-gap:10px;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:8px 10px;
      background: var(--surface);
      color: var(--onyx);
      font-weight:800;
      min-height:42px;
      opacity:1;
      transform: translateY(0);
    }
    .outcomeTop3.is-stagger .outcomeTopItem{
      opacity:0;
      transform: translateY(8px);
      animation: outcomeTopIn .34s cubic-bezier(.2,.7,.2,1) forwards;
      animation-delay: calc(var(--row-i, 0) * 85ms);
    }
    .outcomeTopItem .outcomeBadge{
      margin-right:0;
      transform:none;
      flex:0 0 auto;
    }
    .outcomeTopLabel{
      min-width:0;
      line-height:1.3;
      display:block;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .outcomeTopPct{
      align-self:center;
      justify-self:end;
      font-size:1.32rem;
      line-height:1.2;
      letter-spacing:-0.03em;
      font-weight:900;
      color: var(--onyx);
      white-space:nowrap;
    }
    .outcomeCardGrid{
      margin:12px auto 0;
      width:min(100%, 1240px);
    }
    .outcomeCard{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      background: var(--surface);
    }
    .outcomeCard h4{
      margin:0;
      font-size:1rem;
      color: var(--onyx);
      letter-spacing:-0.01em;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .outcomeCard h4 .outcomeBadge{
      margin-right:0;
      transform:none;
      flex:0 0 auto;
    }
    .outcomeCard .outcomeTitle{
      display:block;
      min-width:0;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.3;
    }
    .outcomeCard .oneLiner{
      margin-top:7px;
      color: var(--muted);
      font-size:.94rem;
      line-height:1.35;
    }
    .outcomeCard .whyTitle{
      margin-top:8px;
      color: var(--text);
      font-size:.9rem;
      font-weight:800;
    }
    .outcomeCard .whyBody{
      margin:6px 0 0;
      color: var(--muted);
      font-size:.9rem;
      line-height:1.35;
    }
    .outcomeCard[data-top="true"]{
      border-color: var(--accent);
      background: var(--surface);
      box-shadow: 0 0 0 3px var(--accentSoft);
    }
    .outcomeBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:24px;
      height:24px;
      border-radius:999px;
      font-size:.8rem;
      font-weight:900;
      color:#fff;
      background: var(--accent);
      margin-right:8px;
      transform:translateY(-1px);
    }
    .sideOutcomeGrid{
      display:grid;
      gap:8px;
    }
    .sideOutcomeGrid[data-count="1"]{ grid-template-columns: 1fr; }
    .sideOutcomeGrid[data-count="2"]{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .sideOutcomeGrid[data-count="3"]{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .sideOutcomeCell{
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      padding:8px;
      min-height:68px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      text-align:left;
      color: var(--onyx);
      font-size:.83rem;
      font-weight:800;
      line-height:1.22;
    }
    .sideOutcomeTitle{
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
    }
    @media (max-width: 880px){
      .sideOutcomeGrid[data-count="3"]{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .sideOutcomeGrid[data-count="2"],
      .sideOutcomeGrid[data-count="3"]{ grid-template-columns: 1fr; }
      .sideOutcomeCell{ min-height:48px; }
    }
    .drillGrid{
      display:grid;
      gap:12px;
      margin-top:12px;
    }
    .drillCard{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      background: var(--surface);
    }
    .drillCard .drillTitle{
      margin:0 0 6px;
      font-size:.95rem;
      font-weight:900;
      color: var(--onyx);
      letter-spacing:-0.01em;
    }
    .drillCard .drillQ{
      margin:0;
      color: var(--muted);
      font-size:.9rem;
      line-height:1.35;
    }
    .drillCard .radioGrid{ margin-top:10px; }

    .optReg{
      border-radius: 12px;
      padding: 10px 12px;
      text-align:left;
      line-height:1.2;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .optReg .regType{
      font-size:.76rem;
      font-weight:900;
      border:1px solid var(--border-strong);
      border-radius:999px;
      padding:3px 8px;
      color: var(--text);
      background: var(--surface);
      white-space:nowrap;
    }
    
    /* Tech stack grid */
    .stackGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:12px;
    }
    @media (max-width: 860px){ .stackGrid{ grid-template-columns:1fr; } }
    .stackH{
      font-weight:900;
      letter-spacing:-0.01em;
      color: var(--onyx);
      margin-bottom:10px;
    }

    /* Buttons */
    .actions{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-top:16px;
    }
    .configBottomActions{
      display:flex;
      justify-content:flex-end;
      margin-top:18px;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius-sm);
      padding:12px 16px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      text-decoration:none;
    }
    .btn:focus-visible{ outline:none; box-shadow: var(--focus); border-color: var(--azure); }
    .btn.primary{
      background: var(--azure);
      border-color: var(--azure);
      color:#fff;
    }
    .btn.secondaryBlue{
      background: rgba(60,100,255,.10);
      border-color: rgba(60,100,255,.40);
      color: var(--azure);
    }
    .btn.secondaryBlue:hover{ background: rgba(60,100,255,.16); }
    .btn.ghost{ background: transparent; }
    .btn.small{
      padding:10px 12px;
      font-weight:850;
    }
    .btn.fullWidth{ width:100%; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .bookOnlyActions{
      margin-top:16px;
    }

    /* Segmented controls */
.seg{
  display:inline-flex;
  border:1px solid var(--border);
  border-radius:999px;
  overflow:hidden;
  background: var(--surface);
}
    .seg button{
      border:0;
      background:transparent;
      padding:10px 12px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      color: var(--muted);
      white-space:nowrap;
    }
    .seg.small{ border-radius:18px; }
    .seg.small button{ padding:8px 10px; font-size:.95rem; }
    .seg button[aria-pressed="true"]{
      background: var(--azure);
      color: #fff;
    }

    /* ROI */
.roiBox{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:16px;
      background: var(--tint-azure);
      margin-top:0;
    }
    .roiTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .roiTop > div{ flex:1 1 100%; min-width:0; }

    .roiTitleRow{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--onyx);
    }
    .roiSub{ margin-top:8px; color: var(--muted); font-size:1rem; line-height:1.45; }
    .roiControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    /* ROI estimate control bar */
.roiCtrlBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
  width:100%;

  /* Keep currency + Reset accessible while scrolling Step 4 */
  position: sticky;
  top: 64px; /* sits below the global header */
  z-index: 12;

  /* No full-width banner: keep controls compact */
  padding: 0;
  background: transparent;
  border: 0;
}
@media (max-width: 560px){
  .roiCtrlBar{ flex-wrap:wrap; }
  #resetValue{ margin-left:auto; }
}

.resetPill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  justify-content:center;

  border-radius:18px;
  padding:8px 10px;
  border:1px solid var(--border-strong);
  background: var(--surface) !important;
  box-shadow: none;
  font-size:.95rem;
}
.resetPill:hover{
  background: var(--surface);
  border-color: var(--border-strong);
}
.resetPill .resetIcon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:22px; height:22px;
  border-radius:12px;
  background: rgba(63,109,255,.10);
  color: var(--azure);
  font-weight:900;
  line-height:1;
}

    /* Range helper text under a label */
    .rangeLabel .labelRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .rangeHelp{
      margin-top:4px;
      color: var(--muted);
      font-size: 0.92rem;
      line-height:1.35;
    }

    .rangeLine{
      display:grid;
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "label ."
        "control value";
      gap:8px 12px;
      align-items:center;
      margin-top:12px;
    }
    .rangeLabel{
      grid-area:label;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .rangeLabel label{
      margin:0;
      font-weight:900;
      color: var(--onyx);
    }
    .rangeControl{ grid-area:control; }
    .pill.rangeValue{
      grid-area:value;
      min-width: 140px;
      justify-self:end;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight:900;
      color: var(--onyx);
      background: rgba(255,255,255,.7);
      font-size:1.25rem;
      padding:10px 14px;
    }
    @media (max-width: 560px){
      .rangeLine{
        grid-template-columns: 1fr;
        grid-template-areas:
          "label"
          "control"
          "value";
      }
      .pill.rangeValue{
        justify-self:start;
        text-align:left;
        min-width:unset;
        width:fit-content;
      }
    }

        input[type="range"]{ width:100%; }

            @media (max-width: 860px){
                }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:14px;
    }
    
.kpiRow{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  align-items:stretch;
}
@media (max-width: 560px){ .kpiRow{ grid-template-columns:1fr; } }
.kpiRow .v.vSmall{
  font-size:1rem;
  line-height:1.25;
}
.kpi{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      background: var(--surface);
      min-width: 0;
    }
    .kpi .k{ font-size:1rem; color: var(--muted); margin:0; }
    .kpi .v{
      font-size:1.15rem;
      font-weight:900;
      margin:8px 0 0;
      letter-spacing:-0.02em;
      color: var(--onyx);
      min-width: 0;
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: break-word;
    }


    .roiOutputsHead{
      margin-top:16px;
    }
    .roiOutputsTitle{
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--onyx);
    }
    .roiOutputsSub{
      margin-top:4px;
      font-size:.95rem;
      color: var(--muted);
      line-height:1.4;
    }
    .roiOutputsSeg{
      margin-top:10px;
    }

    /* Collapsible (generic) */
    details.collapse{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding:12px 14px;
      margin-top:14px;
    }
    details.collapse summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--onyx);
    }
    details.collapse summary::-webkit-details-marker{ display:none; }
    details.collapse .chev{
      display:inline-block;
      transform: rotate(0deg);
      transition: transform .14s ease;
      color: var(--muted);
      font-weight:900;
    }
    details.collapse[open] .chev{ transform: rotate(180deg); }

    /* Side panel */
    .sticky{ position:sticky; top:76px; }
    .sideTitle{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .recTitle{
      margin:12px 0 0;
      font-size:1.22rem;
      line-height:1.18;
      letter-spacing:-0.03em;
      font-weight:900;
      color: var(--onyx);
    }
    .recDesc{
      margin:8px 0 0;
      color: var(--muted);
      font-size:1rem;
      line-height:1.45;
    }
    .reasons{
      margin:14px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .reasons li{
      display:flex; gap:10px; align-items:flex-start;
      font-size:1rem;
      color: var(--muted);
      line-height:1.45;
    }
    .hide{ display:none !important; }

    /* Basket (side-panel shopping list) */
    .toggleHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:0;
    }

    /* iOS-style switch */
    .switch{
      position:relative;
      display:inline-block;
      width:46px;
      height:28px;
      flex:0 0 auto;
    }
    .switch input{
      opacity:0;
      width:0;
      height:0;
    }
    .slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background: color-mix(in srgb, var(--text) 16%, transparent);
      transition: .18s ease;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--text) 16%, transparent);
    }
    .slider:before{
      position:absolute;
      content:"";
      height:22px;
      width:22px;
      left:3px;
      top:50%;
      transform: translateY(-50%);
      background: var(--surface);
      border-radius:999px;
      transition:.18s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.18);
    }
    .switch input:checked + .slider{
      background: var(--azure);
      border-color: var(--azure);
    }
    .switch input:checked + .slider:before{
      transform: translateY(-50%) translateX(18px);
    }
    .switch input:focus-visible + .slider{
      box-shadow: var(--focus);
    }

    .basketPanel{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding:12px 14px;
      margin-top:10px;
    }
    .basketBody{
      display:grid;
      gap:14px;
    }
    .basketGroup{
      display:grid;
      gap:8px;
      padding-left:10px;
      border-left:4px solid rgba(23,24,28,.12);
    }
    .basketGroup.org{ border-left-color: var(--azure); }
    .basketGroup.challenge{ border-left-color: var(--coral); }
    .basketGroup.coverage{ border-left-color: var(--lilac); }
    .basketGroup.context{ border-left-color: var(--amber); }
    .basketGroup.tools{ border-left-color: var(--tangerine); }
    .basketGroup.fit{ border-left-color: var(--lime); }

    .basketTitle{
      font-weight:900;
      letter-spacing:-0.02em;
      color: var(--onyx);
      font-size:.88rem;
    }
    .basketLine{
      display:grid;
      grid-template-columns: 110px 1fr;
      column-gap:10px;
      row-gap:2px;
      align-items:start;
      font-size:.88rem;
      line-height:1.35;
    }
    .basketK{
      color: var(--text);
      font-weight:850;
      flex:0 0 auto;
    }
    .basketK:after{ content: ":"; }
    .basketV{
      color: var(--muted);
      font-weight:600;
      text-align:left;
      min-width:0;
      word-break: break-word;
    }
    .basketText{
      color: var(--muted);
      font-size:.88rem;
      line-height:1.35;
    }

    .snapshotDecision,
    .snapshotInputs{
      display:grid;
      gap:10px;
      align-content:start;
    }

    .decisionCard{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding:12px;
    }
    .decisionPackageCard .recTitle{
      margin:8px 0 0;
      font-weight:900;
      color: var(--accent);
    }
    .decisionPackageCard .recDesc{
      margin-top:6px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .sideOutcomeSingle{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      padding:10px 12px;
      font-size:.92rem;
      font-weight:650;
      line-height:1.35;
      color: var(--text);
    }
    .sideOutcomeList{
      display:grid;
      gap:8px;
    }
    .sideOutcomeList.is-stagger .sideOutcomeItem{
      opacity:0;
      transform: translateY(8px);
      animation: sideOutcomeIn .34s cubic-bezier(.2,.7,.2,1) forwards;
      animation-delay: calc(var(--item-i, 0) * 90ms);
    }
    .sideOutcomeItem{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      border:1px solid var(--border);
      border-radius:999px;
      background: var(--surface);
      padding:6px 10px;
      font-size:.86rem;
      font-weight:700;
      line-height:1.2;
      color: var(--text);
    }
    .sideOutcomeRank{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      background: var(--accent);
      color:#fff;
      font-size:.7rem;
      font-weight:800;
      flex:0 0 auto;
    }
    .sideOutcomeText{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .miniDisclosure{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:8px;
    }
    .miniDisclosure summary{
      list-style:none;
      cursor:pointer;
      font-size:.86rem;
      font-weight:700;
      color: var(--muted);
      letter-spacing:.01em;
    }
    .miniDisclosure summary::-webkit-details-marker{ display:none; }
    .miniDisclosure .mini{
      margin-top:8px;
      line-height:1.4;
    }

    .inputAccordion{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      overflow:hidden;
      margin:0;
    }
    .inputAccordion > summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid transparent;
      background: var(--surface);
    }
    .inputAccordion > summary::-webkit-details-marker{ display:none; }
    .inputAccordion[open] > summary{
      border-bottom-color: var(--border);
      background: var(--surface-2);
    }
    .inputAccHead{
      min-width:0;
      display:grid;
      gap:4px;
    }
    .inputAccTitle{
      font-size:.88rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-weight:750;
      color: color-mix(in srgb, var(--text) 84%, var(--accent) 16%);
    }
    .inputAccBody{
      padding:10px 12px 12px;
      display:grid;
      gap:8px;
    }
    .kvRow{
      display:grid;
      grid-template-columns: minmax(84px, 4fr) minmax(0, 8fr);
      align-items:start;
      gap:10px;
    }
    .kvLabel{
      margin-top:2px;
      font-size:.74rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:700;
      color: color-mix(in srgb, var(--muted) 92%, var(--text) 8%);
    }
    .kvValue{
      font-size:.86rem;
      color: var(--text);
      line-height:1.35;
      min-width:0;
      word-break: break-word;
    }
    .kvValue.is-refresh{
      animation: snapshotValueIn .26s ease;
    }

    .chipsInline{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      min-width:0;
    }
    .valueChip{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:3px 8px;
      font-size:.78rem;
      color: var(--muted);
      background: var(--surface-2);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chipsMore{
      margin-top:6px;
    }
    .chipsMore summary{
      list-style:none;
      cursor:pointer;
      font-size:.78rem;
      font-weight:700;
      color: var(--muted);
      letter-spacing:.03em;
      text-transform:uppercase;
    }
    .chipsMore summary::-webkit-details-marker{ display:none; }
    .chipsMore .chipsInline{
      margin-top:6px;
    }

    .snapshotDecision details.collapse{
      margin-top:0;
    }
    .decisionSecondary summary{
      font-size:.9rem;
      font-weight:700;
      color: var(--muted);
    }

    @media (max-width: 460px){
      .basketLine{ grid-template-columns: 1fr; }
      .basketK:after{ content:""; }
    }

    .dot{
      width:10px; height:10px; border-radius:999px; margin-top:6px; flex:0 0 auto;
      background: var(--lime);
    }

    .examples{
      display:grid;
      gap:12px;
      margin-top:14px;
    }
    .ex{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      background: var(--soft);
    }
    .ex strong{ display:block; font-size:1rem; font-weight:900; color: var(--onyx); letter-spacing:-0.01em; }
    .ex span{ display:block; font-size:1rem; color: var(--muted); margin-top:6px; line-height:1.45; }

    /* Toast + modal */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%) translateY(10px);
      opacity:0;
      pointer-events:none;
      background:rgba(15,17,22,.92);
      color:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:1rem;
      line-height:1.3;
      transition: opacity .18s ease, transform .18s ease;
      border:1px solid rgba(255,255,255,.12);
      z-index:200;
      max-width: min(860px, 92vw);
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:rgba(15,17,22,.55);
      z-index:180;
    }
    .modal.show{ display:flex; }
    .modalCard{
      width:min(680px, 100%);
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
    }
    .modalCard h3{
      margin:0 0 10px;
      font-size:1.2rem;
      letter-spacing:-0.02em;
      font-weight:900;
      color: var(--onyx);
    }
    .modalCard p{
      margin:0;
      color: var(--muted);
      font-size:1rem;
      line-height:1.55;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:16px;
    }

    .settings{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:rgba(15,17,22,.45);
      z-index:190;
    }
    .settings.open{ display:flex; }
    .settingsPanel{
      width:min(620px, 100%);
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .settingsHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
    }
    .settingsTitle{
      margin:0;
      font-size:1.18rem;
      line-height:1.2;
      letter-spacing:-0.02em;
      font-weight:700;
      color: var(--onyx);
    }
    .settingsSub{
      margin:4px 0 0;
      font-size:.95rem;
      color: var(--muted);
      line-height:1.4;
    }
    .settingsBody{
      padding:16px 18px 18px;
      display:grid;
      gap:14px;
    }
    .settingsRow{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px;
      background: var(--surface-2);
    }
    .settingsLabel{
      font-size:.9rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:700;
      color: var(--muted);
      margin-bottom:10px;
    }
    .settingsOptions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .settingsOption{
      border:1px solid var(--border);
      border-radius:999px;
      background: var(--surface);
      padding:8px 12px;
      font-size:.95rem;
      font-weight:650;
      color: var(--text);
      cursor:pointer;
    }
    .settingsOption[aria-pressed="true"]{
      border-color: color-mix(in srgb, var(--azure) 45%, var(--border));
      background: color-mix(in srgb, var(--azure) 14%, var(--surface));
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--azure) 16%, transparent);
    }
    .settingsReset{
      display:flex;
      justify-content:flex-end;
    }
    .settingsHint{
      margin:0;
      font-size:.9rem;
      color: var(--muted);
      line-height:1.45;
    }
    .settingsFieldGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px 12px;
    }
    .settingsField{
      display:grid;
      gap:6px;
      min-width:0;
    }
    .settingsFieldLabel{
      font-size:.78rem;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-weight:700;
      color: color-mix(in srgb, var(--muted) 80%, var(--text) 20%);
    }
    .settingsFieldNote{
      margin:0;
      font-size:.78rem;
      line-height:1.35;
      color: var(--muted);
    }
    .settingsField > input,
    .settingsField > select{
      width:100%;
      min-width:0;
    }
    .settingsInlineOptions{
      margin-top:10px;
    }
    .settingsRowActions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    @media (max-width: 720px){
      .settingsFieldGrid{
        grid-template-columns: 1fr;
      }
      .settingsRowActions{
        justify-content:flex-start;
      }
    }

    footer{
      border-top:1px solid var(--border);
      padding: 20px 0 28px;
      color: var(--subtle);
      font-size:1rem;
    }
  
    /* Opt-in row (for dark form overrides) */
    .optinRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      font-weight:650;
      color: var(--muted);
    }

    /* Dark mode form card */
    .card.darkForm{
      background: var(--onyx);
      border-color: rgba(255,255,255,.14);
      color: #fff;
    }
    .darkForm .divider{ background: rgba(255,255,255,.12); }
    .darkForm label{ color: rgba(255,255,255,.78); }
    .darkForm .mini{ color: rgba(255,255,255,.70); }
    .darkForm input[type="text"],
    .darkForm input[type="email"],
    .darkForm input[type="tel"],
    .darkForm input[type="number"],
    .darkForm textarea{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
      color: #fff;
    }
    .darkForm input::placeholder,
    .darkForm textarea::placeholder{ color: rgba(255,255,255,.45); }

    .darkForm .optinRow{ color: rgba(255,255,255,.78); }

    .darkForm .btn{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
      color: #fff;
    }
    .darkForm .btn:hover{ background: rgba(255,255,255,.10); }
    .darkForm .btn.primary{
      background: var(--azure);
      border-color: var(--azure);
      color:#fff;
    }
    .darkForm .btn.primary:hover{ filter: brightness(0.95); }


    /* Review summary (Step 5) */
    .summaryGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 860px){ .summaryGrid{ grid-template-columns:1fr; } }

    .sumCard{
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      padding:12px 14px;
      background: var(--soft2);
    }
    .sumHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-weight:900;
      color: var(--onyx);
    }
    .link{
      border:0;
      background:transparent;
      padding:0;
      font-weight:900;
      font-size:1rem;
      color: var(--azure);
      cursor:pointer;
      text-decoration:underline;
      text-underline-offset:3px;
    }
    .link:hover{ opacity:.85; }

    .sumBody{ font-size:.95rem; color: var(--muted); line-height:1.35; }
.sumBody ul{
  margin:8px 0 0 18px;
  padding:0;
  display:grid;
  gap:5px;
}
.sumLine{
  display:flex;
  flex-direction:column;
  gap:2px;
  align-items:flex-start;
  margin-top:10px;
}
.sumLine:first-child{ margin-top:0; }
.sumK{
  min-width:unset;
  color: var(--text);
  font-weight:850;
  font-size:.92rem;
}
.sumV{ color: var(--muted); font-weight:600; }

    .flash{ animation: flash 1.2s ease; }
    @keyframes outcomeTopIn{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @keyframes sideOutcomeIn{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @keyframes snapshotValueIn{
      0%{ opacity:.35; transform: translateY(4px); }
      100%{ opacity:1; transform: translateY(0); }
    }
    @keyframes doneTickPop{
      0%{ transform: scale(.82); }
      60%{ transform: scale(1.08); }
      100%{ transform: scale(1); }
    }
    .chip strong.tick-pop{
      animation: doneTickPop .28s ease;
    }
    @keyframes flash{
      0%{ box-shadow:0 0 0 0 rgba(60,100,255,0); }
      25%{ box-shadow:0 0 0 4px rgba(60,100,255,.18); }
      100%{ box-shadow:0 0 0 0 rgba(60,100,255,0); }
    }



    /* =====================================================================
       Visual refinement pass (v10)  overrides only
       ===================================================================== */

    :root{
      /* Launchpad-edition aliases for this refinement layer */
      --border: rgba(15,23,42,.10);
      --soft: var(--bg);
      --soft2: var(--surface-2);

      --radius: var(--radius-lg);
      --radius-sm: var(--radius-md);

      --shadow: var(--shadow-sm);
      --focus: 0 0 0 3px color-mix(in srgb, var(--accent) 22%, transparent);

      --container: 1220px;
    }

    html{ font-size: 13px; }
    body{ line-height: var(--lh-body); }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* Layout rhythm */
    .grid{ gap: 20px; padding: 18px 0 40px; }
    .cardPad{ padding: 22px; }

    /* Progress chips */
    .chip{ padding: 8px 12px; font-size: .95rem; }
    .chip strong{ width:22px; height:22px; font-size: .78rem; border-radius:7px; }
    .chip:hover{ transform:none; border-color: var(--border-strong); background: var(--surface); }
    .chip[data-active="true"]{ border-color: rgba(60,100,255,.30); background: rgba(60,100,255,.08); }
    .chip[data-done="true"] strong{
      background: var(--surface);
      border: 1.5px solid color-mix(in srgb, var(--lime) 52%, var(--border));
      color: color-mix(in srgb, var(--lime) 78%, #0d6b43 22%);
      font-family: var(--font);
      font-weight: 900;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--lime) 12%, transparent);
    }

    /* Step header */
    .stepHead h2{ font-size: 1.25rem; font-weight: 750; }
    .stepHead .hint{ font-size: .95rem; }
    .pill{ font-size: .85rem; padding: 7px 11px; }

    /* Make step accent apply to native controls */
    .step{ accent-color: var(--accent); }

    /* Section titles / labels */
    .sectionTitle{ font-size: .95rem; font-weight: 750; }
    label{ font-size: .95rem; font-weight: 650; margin: 0 0 6px; }
    .questionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .helperMetaRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .helperMetaRow .helperText{
      margin-bottom:0;
    }
    .questionHead label{
      margin:0;
      min-width:0;
    }
    label.qPrompt{
      font-size:1.045rem; /* +10% from 0.95rem */
      font-weight:700;
      color: color-mix(in srgb, var(--text) 65%, var(--muted) 35%);
    }
    .countPill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--azure) 45%, var(--border));
      background: color-mix(in srgb, var(--azure) 14%, var(--surface));
      color: color-mix(in srgb, var(--azure) 72%, var(--text) 28%);
      font-size:.78rem;
      font-weight:750;
      line-height:1.05;
      letter-spacing:.01em;
      white-space:nowrap;
      flex:0 0 auto;
      transition: background-color .2s ease, border-color .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .countPill::after{
      content:"";
      display:inline-block;
      width:0;
      opacity:0;
      transform:translateX(-2px) scale(.7);
      transition: opacity .2s ease, transform .2s ease, margin-left .2s ease;
    }
    .countPill[data-complete="true"]{
      border-color: color-mix(in srgb, var(--lime) 62%, var(--border));
      background: color-mix(in srgb, var(--lime) 16%, var(--surface));
      color: color-mix(in srgb, var(--lime) 82%, var(--text) 18%);
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--lime) 24%, transparent) inset;
    }
    .countPill[data-complete="true"]::after{
      content:"";
      width:auto;
      margin-left:6px;
      opacity:1;
      transform:translateX(0) scale(1);
      color: color-mix(in srgb, var(--lime) 88%, var(--text) 12%);
      font-weight:900;
    }
    @keyframes pillPulse{
      0%{ transform:scale(1); }
      45%{ transform:scale(1.06); }
      100%{ transform:scale(1); }
    }
    .countPill.is-bump{
      animation:pillPulse .22s ease-out;
    }
    @media (max-width: 760px){
      .questionHead,
      .helperMetaRow{
        flex-wrap:wrap;
      }
    }

    /* Dividers */
    .divider{ margin: 18px 0; background: var(--border); }

    /* Question blocks */
    .qBlock{
      background: var(--surface);
      border-color: var(--border);
      padding: 16px;
    }
    .qBlock::before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height:3px;
      background: var(--accent);
      opacity: .14;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    }

    /* Option pills */
    .opt{
      border-color: var(--border);
      font-weight: 650;
    }
    .opt:hover{
      transform:none;
      border-color: var(--border-strong);
      box-shadow: 0 1px 0 color-mix(in srgb, var(--text) 8%, transparent);
    }
    .opt[aria-pressed="true"]{
      border-color: var(--accent);
      background: var(--surface);
      box-shadow: 0 0 0 3px var(--accentSoft);
    }
    .opt[aria-pressed="true"]::before{
      content:"";
      width:16px;
      height:16px;
      border-radius:999px;
      background: var(--accent);
      color:#fff;
      display:inline-grid;
      place-items:center;
      margin-right:8px;
      font-size:.80rem;
      font-weight: 900;
      transform: translateY(1px);
    }

    /* Radio cards */
    .radio{
      border-color: var(--border);
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .radio:hover{ border-color: var(--border-strong); transform:none; }
    .radio:has(input:checked){
      border-color: var(--accent);
      background: var(--surface);
      box-shadow: 0 0 0 3px var(--accentSoft);
    }

    /* Buttons */
    .btn{
      transition: background .12s ease, border-color .12s ease, box-shadow .12s ease, transform .08s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.ghost:hover{ background: color-mix(in srgb, var(--text) 4%, transparent); }
    .btn.primary{
      box-shadow: 0 8px 18px rgba(60,100,255,.22);
    }
    .btn.primary:hover{ filter: brightness(0.96); }

    /* Segmented control should follow step accent */
    .seg button[aria-pressed="true"]{ background: var(--accent); }

    /* KPI cards */
    .kpi{
      border-color: var(--border);
    }
    .kpi .k{
      font-size: .85rem;
      letter-spacing: .01em;
    }
    .kpi .v{
      font-size: 1.25rem;
      font-variant-numeric: tabular-nums;
    }

    /* Side panel typography density */
    .recTitle{ font-size: 1.18rem; }
    .reasons{ gap: 8px; }
    .dot{ margin-top: 7px; }

    /* Dark form: add a subtle brand cue */
    .card.darkForm{
      position:relative;
      overflow:hidden;
      background: linear-gradient(180deg, #17181C, #13141A);
    }
    .card.darkForm::before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height:3px;
      background: var(--accent);
      opacity:.35;
    }
    .darkForm .mini{ line-height: 1.5; }

    /* =====================================================================
       Launchpad visual push (high-impact skin layer)
       ===================================================================== */
    :root{
      --container: 1280px;
      --radius-lg: 18px;
      --radius-md: 13px;
      --radius-sm: 10px;
      --radius: var(--radius-lg);
      --shadow-xl: 0 28px 64px rgba(15,23,42,.14);
      --glass: color-mix(in srgb, var(--surface) 86%, transparent);
    }

    body{
      background:
        radial-gradient(1200px 520px at -15% -10%, color-mix(in srgb, var(--azure) 12%, transparent), transparent 68%),
        radial-gradient(1000px 460px at 120% -5%, color-mix(in srgb, var(--lilac) 10%, transparent), transparent 66%),
        linear-gradient(180deg, #f8f9ff 0%, #f2f5ff 54%, #f7f9fd 100%);
      background-attachment: fixed;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.30;
      background-image: radial-gradient(rgba(15,23,42,.08) .5px, transparent .5px);
      background-size: 16px 16px;
      z-index:0;
    }
    .topbar,
    main,
    .toast{ position: relative; z-index: 1; }

    .topbar{
      top: 0;
      background: var(--glass);
      backdrop-filter: blur(12px) saturate(135%);
      -webkit-backdrop-filter: blur(12px) saturate(135%);
      border-bottom: 1px solid color-mix(in srgb, var(--border) 72%, transparent);
      box-shadow: 0 8px 26px rgba(15,23,42,.08);
    }
    .topbarInner{
      min-height: 68px;
      gap: 20px;
      padding: 10px 0 12px;
    }
    .brandRow{
      padding: 5px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: color-mix(in srgb, var(--surface) 94%, var(--accent) 6%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.84);
    }
    .brand{
      padding: 7px 11px;
      border: 1px solid color-mix(in srgb, var(--border) 86%, transparent);
      border-radius: 999px;
      background: var(--surface-2);
      box-shadow: none;
    }
    .nav-dashboard{
      border-color: transparent;
      background: transparent;
      color: color-mix(in srgb, var(--muted) 92%, #0000);
      font-size: .84rem;
      padding: 8px 11px;
      border-radius: 12px;
      min-height: 38px;
    }
    .nav-dashboard:hover{
      border-color: color-mix(in srgb, var(--border) 80%, transparent);
      background: color-mix(in srgb, var(--surface) 88%, transparent);
    }
    .nav-dashboard[data-active="true"]{
      border-color: color-mix(in srgb, var(--azure) 42%, var(--border));
      background: color-mix(in srgb, var(--azure) 14%, var(--surface));
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--azure) 24%, transparent);
      color: var(--text);
    }
    .workspaceNav{
      border-top-color: var(--border);
      border-bottom-color: var(--border);
      background: color-mix(in srgb, var(--surface) 94%, var(--accent) 6%);
    }
    .workspaceItem{
      border-bottom-color: var(--border);
      font-weight: 640;
      letter-spacing: .01em;
    }
    .workspaceItem[data-active="true"]{
      box-shadow: inset 2px 0 0 color-mix(in srgb, var(--azure) 82%, var(--surface));
    }
    .workspaceItemIco{
      border-color: color-mix(in srgb, var(--azure) 44%, var(--border));
      background: color-mix(in srgb, var(--azure) 16%, var(--surface));
      color: color-mix(in srgb, var(--azure) 80%, var(--text));
    }
    .progress{
      gap: 7px;
      justify-content:flex-end;
      padding: 5px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: color-mix(in srgb, var(--surface) 94%, var(--accent) 6%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.84);
    }
    .progress::-webkit-scrollbar{ height: 8px; }
    .progress::-webkit-scrollbar-thumb{
      background: color-mix(in srgb, var(--text) 14%, transparent);
      border-radius: 999px;
    }
    .chip{
      min-height: 40px;
      padding: 8px 13px;
      border-radius: 14px;
      border-color: transparent;
      background: transparent;
      color: color-mix(in srgb, var(--muted) 92%, #0000);
      font-size: .9rem;
      font-weight: 650;
      letter-spacing: var(--tracking-body);
      transition: transform .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .chip strong{
      width: 22px;
      height: 22px;
      border-radius: 7px;
      font-size: .74rem;
      font-weight: 800;
      background: var(--surface-2);
      border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
    }
    .chip:hover{
      transform: translateY(-1px);
      border-color: color-mix(in srgb, var(--border) 80%, transparent);
      background: color-mix(in srgb, var(--surface) 88%, transparent);
    }
    .chip[data-active="true"]{
      border-color: color-mix(in srgb, var(--chip-accent, var(--accent)) 42%, var(--border));
      background: var(--chip-soft, var(--surface-2));
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--chip-accent, var(--accent)) 24%, transparent);
      color: var(--text);
    }
    .chip[data-active="true"] strong{
      background: color-mix(in srgb, var(--chip-accent, var(--accent)) 14%, var(--surface));
      border-color: color-mix(in srgb, var(--chip-accent, var(--accent)) 34%, var(--border));
    }
    .chip[data-done="true"] strong{
      background: var(--surface);
      border-color: color-mix(in srgb, var(--lime) 52%, var(--border));
      color: color-mix(in srgb, var(--lime) 78%, #0d6b43 22%);
      font-family: var(--font);
      font-weight: 900;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--lime) 14%, transparent);
    }
    .chip[data-chip="1"]{ --chip-accent: var(--azure); --chip-soft: color-mix(in srgb, var(--azure) 14%, var(--surface)); }
    .chip[data-chip="2"]{ --chip-accent: var(--lilac); --chip-soft: color-mix(in srgb, var(--lilac) 14%, var(--surface)); }
    .chip[data-chip="3"]{ --chip-accent: var(--tangerine); --chip-soft: color-mix(in srgb, var(--tangerine) 14%, var(--surface)); }
    .chip[data-chip="4"]{ --chip-accent: var(--azure); --chip-soft: color-mix(in srgb, var(--azure) 14%, var(--surface)); }
    .chip[data-chip="5"]{ --chip-accent: var(--lime); --chip-soft: color-mix(in srgb, var(--lime) 14%, var(--surface)); }
    .chip[data-chip="6"]{ --chip-accent: var(--azure); --chip-soft: color-mix(in srgb, var(--azure) 14%, var(--surface)); }
    .chip[data-incomplete="true"]{
      border-color: color-mix(in srgb, var(--coral) 44%, var(--border));
      background: color-mix(in srgb, var(--coral) 10%, var(--surface));
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--coral) 24%, transparent);
      color: color-mix(in srgb, var(--text) 88%, #751127 12%);
    }
    .chip[data-incomplete="true"] strong{
      border-color: color-mix(in srgb, var(--coral) 46%, var(--border));
      background: color-mix(in srgb, var(--coral) 14%, var(--surface));
      color: color-mix(in srgb, var(--coral) 82%, #751127 18%);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--coral) 20%, transparent);
    }
    .chip[data-incomplete="true"][data-active="true"]{
      border-color: color-mix(in srgb, var(--coral) 56%, var(--border));
      box-shadow:
        0 0 0 1px color-mix(in srgb, var(--coral) 26%, transparent),
        inset 2px 0 0 color-mix(in srgb, var(--coral) 84%, #751127 16%);
    }

    .grid{
      grid-template-columns: minmax(0, 1.34fr) minmax(300px, .66fr);
      gap: 26px;
      padding: 26px 0 46px;
      align-items:start;
    }
    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; gap: 18px; }
      .progress{ justify-content:flex-start; }
    }

    .card{
      border-radius: var(--radius-lg);
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--surface) 96%, var(--accent) 4%), var(--surface));
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }
    .cardPad{ padding: 24px; }

    section.card > .cardPad.title{
      padding-top: 26px;
      padding-bottom: 18px;
      border-bottom: 1px solid var(--border);
      background:
        radial-gradient(520px 220px at 20% -20%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 70%),
        radial-gradient(480px 180px at 90% -30%, color-mix(in srgb, var(--lilac) 8%, transparent), transparent 70%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 92%, var(--accent) 8%), var(--surface));
    }
    .title h1{
      font-size: clamp(1.95rem, 3.1vw, 2.7rem);
      line-height: 1.04;
      letter-spacing: -0.055em;
      font-weight: 500;
      max-width: none;
      white-space: nowrap;
    }
    .subhead{
      margin-top: 10px;
      max-width: 70ch;
      font-size: .98rem;
      line-height: 1.5;
    }

    .stepHead{
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 8%, var(--surface)), color-mix(in srgb, var(--accent) 3%, var(--surface)));
      margin-bottom: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.78);
    }
    .stepHead h2{
      font-size: 1.35rem;
      line-height: 1.15;
      letter-spacing: var(--tracking-header);
      font-weight: var(--w-semibold);
      text-wrap: balance;
    }
    .stepHead .hint{
      margin-top: 7px;
      font-size: .94rem;
      line-height: 1.48;
    }
    .pill{
      border-color: color-mix(in srgb, var(--border) 75%, transparent);
      background: color-mix(in srgb, var(--surface) 80%, var(--accent) 20%);
      color: color-mix(in srgb, var(--text) 82%, var(--accent) 18%);
      font-weight: 700;
      border-radius: 999px;
      letter-spacing: .005em;
    }

    .qBlock{
      border-radius: var(--radius-md);
      border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
      background:
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 96%, var(--accent) 4%), var(--surface));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
      padding: 18px;
    }
    .qBlock::before{
      height: 4px;
      opacity: .82;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent) 55%, var(--surface)));
    }
    .qBlock.is-incomplete{
      border-color: color-mix(in srgb, var(--coral) 54%, var(--border));
      background:
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 95%, var(--coral) 5%), var(--surface));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.86),
        0 0 0 2px color-mix(in srgb, var(--coral) 14%, transparent);
    }
    .qBlock.is-incomplete::before{
      opacity: 1;
      background: linear-gradient(90deg, color-mix(in srgb, var(--coral) 90%, #8d122e 10%), color-mix(in srgb, var(--coral) 62%, var(--surface)));
    }
    .qBlock.is-incomplete .sectionTitle{
      color: color-mix(in srgb, var(--text) 80%, var(--coral) 20%);
    }
    .qBlock.is-incomplete input:not(:focus),
    .qBlock.is-incomplete select:not(:focus),
    .qBlock.is-incomplete textarea:not(:focus){
      border-color: color-mix(in srgb, var(--coral) 34%, var(--border));
      background: color-mix(in srgb, var(--surface) 94%, var(--coral) 6%);
    }
    .sectionTitle{
      font-size: .9rem;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-weight: 750;
      color: color-mix(in srgb, var(--text) 82%, var(--accent) 18%);
    }

    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea{
      border-radius: 12px;
      border-color: color-mix(in srgb, var(--border) 92%, transparent);
      background: color-mix(in srgb, var(--surface) 95%, var(--accent) 5%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.76);
      padding: 12px 14px;
      transition: border-color .14s ease, box-shadow .14s ease, background .14s ease;
    }
    input:hover, select:hover, textarea:hover{
      border-color: var(--border-strong);
    }
    input:focus, select:focus, textarea:focus{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
      background-color: var(--surface);
    }

    .options{ gap: 12px; }
    .opt{
      border-radius: 14px;
      padding: 11px 14px;
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      font-weight: 650;
      letter-spacing: -.005em;
    }
    .opt:hover{
      transform: translateY(-2px);
      border-color: var(--border-strong);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    .opt[aria-pressed="true"]{
      border-color: color-mix(in srgb, var(--accent) 52%, var(--border));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 16%, var(--surface)), color-mix(in srgb, var(--accent) 8%, var(--surface)));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.65);
      color: var(--text);
    }

    .radio{
      border-radius: 14px;
      border-color: color-mix(in srgb, var(--border) 92%, transparent);
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      padding: 13px 14px;
      gap: 11px;
    }
    .radio:hover{
      border-color: var(--border-strong);
      box-shadow: 0 12px 28px rgba(15,23,42,.08);
      transform: translateY(-1px);
    }
    .radio:has(input:checked){
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, var(--surface)), color-mix(in srgb, var(--accent) 6%, var(--surface)));
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent), 0 10px 24px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .btn{
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      letter-spacing: -.01em;
      border-color: color-mix(in srgb, var(--border) 88%, transparent);
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      box-shadow: 0 4px 12px rgba(15,23,42,.06);
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 24px rgba(15,23,42,.10);
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--accent) 0%, color-mix(in srgb, var(--accent) 75%, #101638) 100%);
      border-color: color-mix(in srgb, var(--accent) 84%, #101638);
      color: #fff;
      box-shadow: 0 12px 26px color-mix(in srgb, var(--accent) 33%, transparent);
    }
    .btn.primary:hover{
      filter: brightness(1.02);
      box-shadow: 0 16px 32px color-mix(in srgb, var(--accent) 38%, transparent);
    }
    .btn.secondaryBlue{
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 13%, var(--surface)), color-mix(in srgb, var(--accent) 8%, var(--surface)));
      border-color: color-mix(in srgb, var(--accent) 45%, var(--border));
      color: color-mix(in srgb, var(--text) 74%, var(--accent) 26%);
    }
    .btn.ghost{
      background: color-mix(in srgb, var(--surface) 94%, transparent);
    }

    .roiBox{
      border-radius: var(--radius-md);
      border: 1px solid color-mix(in srgb, var(--accent) 28%, var(--border));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 9%, var(--surface)), var(--surface));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
    }
    .kpi{
      border-radius: 12px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--surface) 96%, var(--accent) 4%), var(--surface));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.86);
    }
    .kpi .k{
      text-transform: uppercase;
      letter-spacing: .05em;
      font-size: .76rem;
      font-weight: 700;
      color: color-mix(in srgb, var(--muted) 88%, var(--accent) 12%);
    }
    .kpi .v{
      font-size: 1.32rem;
      line-height: 1.2;
      letter-spacing: -.03em;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    details.collapse{
      border-radius: 14px;
      border-color: color-mix(in srgb, var(--border) 92%, transparent);
      background: color-mix(in srgb, var(--surface) 97%, var(--accent) 3%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.82);
    }
    details.collapse[open]{
      box-shadow: 0 10px 28px rgba(15,23,42,.08);
      border-color: color-mix(in srgb, var(--accent) 30%, var(--border));
    }
    details.collapse summary{
      font-weight: 700;
      letter-spacing: -.01em;
    }

    .sticky{
      top: 88px;
    }
    aside.card.sticky{
      background:
        radial-gradient(420px 220px at 92% -15%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 72%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 95%, var(--accent) 5%), var(--surface));
      border-color: color-mix(in srgb, var(--border) 92%, transparent);
    }
    aside.card.sticky .cardPad{
      padding: 18px;
    }
    .sideTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    #selPill{
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 700;
      background: color-mix(in srgb, var(--accent) 12%, var(--surface));
      border-color: color-mix(in srgb, var(--accent) 32%, var(--border));
      color: color-mix(in srgb, var(--text) 80%, var(--accent) 20%);
    }
    .recTitle{
      margin-top: 4px;
      font-size: 1.35rem;
      line-height: 1.12;
      letter-spacing: -0.03em;
      font-weight: 700;
      text-wrap: balance;
    }
    .recDesc{
      margin-top: 7px;
      font-size: .92rem;
      line-height: 1.45;
    }
    .basketPanel{
      border-radius: 12px;
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.84);
    }
    .basketGroup{
      gap: 7px;
      padding: 10px 12px;
      border-radius: 10px;
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      border: 1px solid color-mix(in srgb, var(--border) 90%, transparent);
      border-left-width: 3px;
      border-left-style: solid;
    }
    .basketTitle{
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: .75rem;
      font-weight: 750;
      color: color-mix(in srgb, var(--text) 80%, var(--accent) 20%);
    }
    .basketK{
      font-size: .74rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: color-mix(in srgb, var(--muted) 90%, var(--accent) 10%);
    }
    .basketV,
    .basketText{
      font-size: .86rem;
      line-height: 1.36;
    }
    .sideOutcomeGrid{
      gap: 10px;
    }
    .sideOutcomeGrid[data-count="3"]{
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .sideOutcomeGrid[data-count="3"] .sideOutcomeCell:first-child{
      grid-column: 1 / -1;
    }
    .sideOutcomeCell{
      min-height: 74px;
      border-radius: 11px;
      border-color: color-mix(in srgb, var(--accent) 30%, var(--border));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, var(--surface)), var(--surface));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.84);
      padding: 10px;
      font-size: .81rem;
      line-height: 1.24;
    }

    .summaryGrid{
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    .sumCard{
      border-radius: 12px;
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--surface) 96%, var(--accent) 4%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
    }
    .sumHead{
      border-bottom: 1px dashed color-mix(in srgb, var(--border) 90%, transparent);
      padding-bottom: 9px;
      margin-bottom: 9px;
      align-items: center;
    }
    .sumBody{
      font-size: .9rem;
      line-height: 1.4;
    }

    @media (max-width: 860px){
      .cardPad{ padding: 18px; }
      .summaryGrid{ grid-template-columns: 1fr; }
      .title h1{
        white-space: normal;
        font-size: clamp(1.55rem, 7.2vw, 2.05rem);
      }
    }
    @media (max-width: 1120px){
      .sticky{
        position: static !important;
        top: auto !important;
      }
      .sideOutcomeGrid[data-count="2"],
      .sideOutcomeGrid[data-count="3"]{
        grid-template-columns: 1fr 1fr;
      }
    }
    @media (max-width: 560px){
      .sideOutcomeGrid[data-count="2"],
      .sideOutcomeGrid[data-count="3"]{
        grid-template-columns: 1fr;
      }
      .sideOutcomeGrid[data-count="3"] .sideOutcomeCell:first-child{
        grid-column: auto;
      }
    }

    /* =====================================================================
       Report export + print (PoC)
       ===================================================================== */
    .printRoot{
      display:none;
      background:#fff;
      color: var(--onyx);
      padding: 22mm 18mm;
      box-sizing: border-box;
    }
    .printRoot .brandHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 8mm;
      margin: 0 0 6mm;
      padding: 0 0 5mm;
      border-bottom: 2px solid rgba(60,100,255,.28);
    }
    .printRoot .brandMark{
      min-width:0;
      flex:1 1 auto;
    }
    .printRoot .brandLogo{
      display:block;
      width: 46mm;
      max-width:100%;
      height:auto;
    }
    .printRoot .brandKicker{
      margin-top: 2mm;
      color: rgba(23,24,28,.66);
      font-size: 9pt;
      letter-spacing: .09em;
      text-transform: uppercase;
      font-weight: 600;
    }
    .printRoot .reportStamp{
      min-width: 48mm;
      text-align:right;
      flex:0 0 auto;
    }
    .printRoot .stampLabel{
      margin:0;
      color: rgba(23,24,28,.62);
      font-size: 8.5pt;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-weight: 700;
    }
    .printRoot .stampValue{
      margin:1mm 0 2.25mm;
      color: var(--onyx);
      font-size: 10pt;
      line-height: 1.25;
      font-weight: 700;
    }
    .printRoot .stampValue:last-child{
      margin-bottom:0;
    }
    .printRoot h1{
      margin:0 0 4mm;
      font-size: 22pt;
      line-height: 1.1;
      letter-spacing:-0.03em;
      font-weight: 800;
      color: #2F49CA;
    }
    .printRoot h2{
      margin: 8mm 0 3mm;
      font-size: 14pt;
      line-height: 1.15;
      letter-spacing:-0.02em;
      font-weight: 800;
      color: #2F49CA;
    }
    .printRoot .meta{
      color: rgba(23,24,28,.72);
      font-size: 10.5pt;
      margin-bottom: 6mm;
      line-height: 1.35;
    }
    .printRoot .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 0 0 6mm;
    }
    .printRoot .pillTag{
      display:inline-flex;
      align-items:center;
      border:1px solid rgba(60,100,255,.30);
      border-radius:999px;
      padding:6px 10px;
      font-size:10.5pt;
      color: rgba(29,42,125,.92);
      background: rgba(60,100,255,.08);
      white-space: normal;
      overflow-wrap: anywhere;
      line-height: 1.3;
    }
    .printRoot .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10mm;
      align-items:start;
    }
    .printRoot .box{
      border:1px solid rgba(60,100,255,.24);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(60,100,255,.03);
    }
    .printRoot .k{
      color: rgba(23,24,28,.72);
      font-size:10.5pt;
      margin:0;
    }
    .printRoot .v{
      font-size:12pt;
      font-weight:800;
      margin:4px 0 0;
      letter-spacing:-0.01em;
      overflow-wrap: anywhere;
    }
    .printRoot ul{
      margin: 2mm 0 0 18px;
      padding:0;
    }
    .printRoot li{
      margin: 0 0 2mm;
    }
    .printRoot .small{
      font-size:10.5pt;
      color: rgba(23,24,28,.72);
      line-height:1.45;
      overflow-wrap: anywhere;
    }
    .printRoot .meta{
      overflow-wrap: anywhere;
    }
    .printRoot li{
      overflow-wrap: anywhere;
    }
    .printRoot .divider{
      margin: 6mm 0;
      background: rgba(23,24,28,.12);
      height:1px;
    }
    .printRoot .page-break{
      break-before: page;
    }

    @media print{
      @page{ margin: 12mm; }
      html, body{ background:#fff !important; }
      body{ margin:0 !important; }
      header.topbar, footer, .modal, .toast{ display:none !important; }
      body.is-print-report main.wrap{ display:none !important; }
      body.is-print-report .printRoot{
        display:block !important;
        margin:0 !important;
        padding:0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      body:not(.is-print-report) .printRoot{ display:none !important; }
      .printRoot .grid2{
        grid-template-columns: 1fr;
        gap: 4mm;
      }
      .printRoot h1,
      .printRoot h2{
        break-after: avoid-page;
        page-break-after: avoid;
      }
      .printRoot .box,
      .printRoot ul,
      .printRoot .pillRow{
        break-inside: avoid;
        page-break-inside: avoid;
      }
    }

    /* =====================================================================
       App shell mode (Launchpad line-by-line parity): LHN + center + persistent right
       ===================================================================== */
    :root{
      --app-lhn-w: 236px;
      --app-right-w: 620px;
      --app-gap: 16px;
    }

    @media (min-width: 1200px){
      body{
        overflow-x: hidden;
        overflow-y: auto;
        background: var(--bg);
      }
      body::before{ display:none; }

      .topbar{
        position: fixed;
        top: 0;
        left: 0;
        width: var(--app-lhn-w);
        height: 100vh;
        min-height: 100vh;
        box-sizing: border-box;
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        background: var(--bg);
        box-shadow: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        z-index: 50;
      }
      .topbar .wrap{
        max-width: none;
        margin: 0;
        padding: 0;
      }
      .topbarInner{
        height: 100%;
        display:flex;
        flex-direction:column;
        justify-content: flex-start;
        align-items: stretch;
        gap: 0;
        padding: 0;
        overflow: hidden;
      }
      .brandRow{
        display:flex;
        align-items:center;
        gap: 8px;
        width: 100%;
        min-height: 51px;
        box-sizing: border-box;
        padding: 8px 8px 8px 20px;
        margin: 0;
        border: 0;
        border-bottom: 1px solid var(--border);
        border-radius: 0;
        background: var(--surface);
        box-shadow: none;
      }
      .brand{
        display:flex;
        align-items:center;
        width: auto;
        min-height: auto;
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        border: 0;
        border-radius: 0;
        background: transparent;
        box-shadow: none;
        flex: 1 1 auto;
        min-width: 0;
      }
      .nav-dashboard{
        min-height: 32px;
        border-radius: 10px;
        border: 1px solid color-mix(in srgb, var(--azure) 28%, var(--border));
        background: color-mix(in srgb, var(--azure) 8%, var(--surface));
        color: var(--text);
        font-size: 12px;
        padding: 6px 10px;
      }
      .nav-dashboard:hover{
        background: color-mix(in srgb, var(--azure) 14%, var(--surface));
        border-color: color-mix(in srgb, var(--azure) 44%, var(--border));
      }
      .nav-dashboard[data-active="true"]{
        background: color-mix(in srgb, var(--azure) 18%, var(--surface));
        border-color: color-mix(in srgb, var(--azure) 56%, var(--border));
        box-shadow: none;
      }
      .workspaceNav{
        border-top:0;
        border-bottom:1px solid var(--border);
      }
      .workspaceItem{
        min-height:56px;
        padding: 8px 10px 8px 20px;
        border-bottom:0;
        font-size:.82rem;
        letter-spacing:0;
      }
      .workspaceItem:hover{
        background: color-mix(in srgb, var(--surface) 90%, var(--bg));
      }
      .workspaceItem[data-active="true"]{
        background: transparent;
        box-shadow:none;
      }
      .workspaceItemIco{
        width:30px;
        height:30px;
        border-radius:11px;
        font-size:12px;
      }
      .workspaceCompanies{
        border-bottom:1px solid var(--border);
      }
      .workspaceCompaniesHead{
        padding: 8px 8px 8px 20px;
      }
      .workspaceCompaniesList{
        padding: 8px;
      }
      .recordContext{
        padding: 8px 8px 8px 20px;
      }
      .recordContextBtn{
        border-radius: 8px;
        padding: 8px 8px;
        grid-template-columns: 18px 1fr;
        gap:8px;
      }
      .recordContextBack{
        font-size:10px;
        letter-spacing:.14em;
      }
      .recordContextName{
        font-size:13px;
      }
      .logo{
        height: calc(27px * 0.9);
      }
      .nav-scroll{
        width: 100%;
        display:flex;
        flex-direction:column;
        gap: 0;
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
      }
      .nav-heading{
        margin: 0;
        padding: 8px 6px 8px 20px;
        width: 100%;
        box-sizing: border-box;
        border-bottom: 1px solid var(--border);
        font-size: 10px;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .progress{
        width: 100%;
        display:flex;
        flex-direction:column;
        align-items:stretch;
        justify-content:flex-start;
        gap: 0;
        padding: 0 0 0 0;
        border: 0;
        border-radius: 0;
        background: transparent;
        box-shadow: none;
        position: relative;
      }
      .progress::before{
        content:"";
        position:absolute;
        left: 37px;
        top: 0;
        bottom: 0;
        width: 1px;
        background: color-mix(in srgb, var(--border) 84%, transparent);
        pointer-events:none;
      }
      .chip{
        height: 46px;
        width: 100%;
        box-sizing: border-box;
        border-radius: 0;
        border: 0;
        background: transparent;
        display:grid;
        grid-template-columns: 22px 1fr;
        align-items:center;
        gap: 10px;
        padding: 0 8px 0 45px;
        color: var(--text);
        font-size: 13px;
        font-weight: var(--w-semibold);
        text-align: left;
        position: relative;
      }
      .chip::after{
        content:"";
        position:absolute;
        left:0;
        right:0;
        bottom:0;
        height:1px;
        background: var(--border);
      }
      .chip strong{
        width: 22px;
        height: 22px;
        margin-right: 0;
        border-radius: 7px;
        border: 1px solid var(--border);
        background: var(--surface);
        display:grid;
        place-items:center;
        font-size: 10px;
        font-family: var(--mono);
        font-weight: 600;
        position: relative;
        z-index: 1;
      }
      .chip:hover{
        transform:none;
        background: color-mix(in srgb, var(--surface) 86%, var(--bg));
      }
      .chip[data-active="true"]{
        background: color-mix(in srgb, var(--accent) 14%, var(--surface));
        box-shadow: none;
      }
      .chip[data-active="true"]::after{
        background: color-mix(in srgb, var(--accent) 35%, var(--border));
      }
      .chip[data-active="true"] strong{
        border-color: color-mix(in srgb, var(--accent) 30%, var(--border));
        background: color-mix(in srgb, var(--accent) 14%, var(--surface));
      }
      .chip[data-done="true"] strong{
        background: var(--surface);
        border-color: color-mix(in srgb, var(--lime) 56%, var(--border));
        color: color-mix(in srgb, var(--lime) 80%, #0d6b43 20%);
        font-family: var(--font);
        font-weight: 900;
        box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--lime) 14%, transparent);
      }
      .chip[data-incomplete="true"]{
        background: color-mix(in srgb, var(--coral) 12%, var(--surface));
        box-shadow: inset 2px 0 0 color-mix(in srgb, var(--coral) 84%, #751127 16%);
      }
      .chip[data-incomplete="true"]::after{
        background: color-mix(in srgb, var(--coral) 42%, var(--border));
      }
      .chip[data-incomplete="true"] strong{
        border-color: color-mix(in srgb, var(--coral) 50%, var(--border));
        background: color-mix(in srgb, var(--coral) 14%, var(--surface));
        color: color-mix(in srgb, var(--coral) 82%, #751127 18%);
      }

      .nav-settingsDock{
        width:100%;
        border-top: 1px solid var(--border);
        background: var(--bg);
        padding: 12px 0;
        flex: 0 0 auto;
      }
      .nav-settings{
        width:100%;
        border:0;
        background: transparent;
        display:grid;
        grid-template-columns: 34px minmax(0, 1fr);
        align-items:center;
        gap: 10px;
        padding: 0 10px 0 20px;
        text-align:left;
        cursor:pointer;
      }
      .nav-settings + .nav-settings{
        border-top: 1px solid var(--border);
        margin-top: 8px;
        padding-top: 8px;
      }
      .nav-settings:hover{
        background: color-mix(in srgb, var(--surface) 90%, var(--bg));
      }
      .nav-settingsIco{
        width:30px;
        height:30px;
        border-radius:11px;
        border:1px solid color-mix(in srgb, var(--azure) 34%, var(--border));
        background: color-mix(in srgb, var(--azure) 10%, var(--surface));
        display:grid;
        place-items:center;
        color: var(--text);
      }
      .nav-settingsIco svg{
        width:16px;
        height:16px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.8;
      }
      .nav-settingsText{
        display:flex;
        flex-direction:column;
        min-width:0;
        line-height:1.1;
      }
      .nav-settingsTitle{
        font-size:13px;
        font-weight:700;
        color: var(--text);
        white-space: nowrap;
      }
      .nav-settingsSub{
        margin-top:4px;
        font-size:12px;
        color: var(--muted);
        white-space: nowrap;
      }

      main.wrap{
        max-width: none;
        margin: 0;
        margin-left: var(--app-lhn-w);
        padding: 0 0 0 var(--app-gap);
      }
      .grid{
        grid-template-columns: minmax(620px, 1fr) clamp(520px, var(--app-right-w), 860px);
        gap: var(--app-gap);
        padding: 0;
        align-items: start;
      }

      .card{
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow-card);
      }
      section.card{
        border: 0;
        border-radius: 0;
        box-shadow: none;
        background: transparent;
        overflow: visible;
      }
      section.card > .cardPad{
        padding-left: 0;
        padding-right: 0;
      }
      section.card{
        --stage-text-inset: 16px;
      }
      .title h1,
      .recTitle{
        font-family: var(--font);
        font-weight: 300;
        font-size: 20px;
        line-height: 24px;
        letter-spacing: -0.8px;
      }
      .title h1{
        font-weight: 700;
      }
      .stepHead h2{
        font-family: var(--font);
        font-weight: 600;
        font-size: 1.3rem;
        line-height: 1.2;
        letter-spacing: -0.02em;
      }
      section.card > .cardPad.title{
        display:flex;
        align-items:center;
        min-height: 51px;
        box-sizing: border-box;
        background: transparent;
        border-bottom: 1px solid var(--border);
        padding: 0 var(--stage-text-inset);
      }
      .stepHead{
        padding-left: var(--stage-text-inset);
        padding-right: var(--stage-text-inset);
      }
      .title h1{
        margin: 0;
      }
      .qBlock{
        background: var(--surface);
        border-color: var(--border);
        box-shadow: none;
        padding-left: var(--stage-text-inset);
        padding-right: var(--stage-text-inset);
      }

      aside.card.sticky{
        --snap-type-title-size: .9rem;
        --snap-type-title-weight: 750;
        --snap-type-title-track: .06em;
        --snap-type-group-size: 1.02rem;
        --snap-type-group-weight: 700;
        --snap-type-group-track: -.01em;
        --snap-type-meta-size: .74rem;
        --snap-type-meta-weight: 700;
        --snap-type-meta-track: .08em;
        --snap-type-value-size: .86rem;
        --snap-type-chip-size: .78rem;
        position: sticky;
        top: 0;
        overflow: visible;
        height: 100vh;
        min-height: 100vh;
        max-height: 100vh;
        background: var(--surface) !important;
        border-radius: 0 !important;
        box-shadow: none !important;
      }
      aside.card.sticky .cardPad{
        display:grid;
        grid-template-columns: minmax(0, .92fr) minmax(0, 1.08fr);
        grid-template-rows: auto auto minmax(0, 1fr);
        gap: 0;
        align-content:start;
        height: 100%;
        min-height: 0;
        overflow: visible;
        padding: 0;
        background: var(--surface);
      }
      aside.card.sticky .cardPad > .sideTitle{
        grid-column: 1 / -1;
        margin: 0;
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
      }
      aside.card.sticky .sideTitle .sectionTitle,
      aside.card.sticky .snapshotDecision .sectionTitle,
      aside.card.sticky .sideAnswersBlock > summary .sectionTitle{
        font-size: var(--snap-type-title-size);
        font-weight: var(--snap-type-title-weight);
        letter-spacing: var(--snap-type-title-track);
        text-transform: uppercase;
      }
      #sideRoiBlock > summary .summaryLabelWithInfo > span:first-child{
        font-size: var(--snap-type-group-size);
        font-weight: var(--snap-type-group-weight);
        letter-spacing: var(--snap-type-group-track);
        line-height: 1.2;
      }

      .snapshotDecision{
        grid-column: 1 / -1;
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap:10px;
        margin: 0;
        padding: 10px 14px 12px;
        border-bottom: 1px solid var(--border);
      }
      .decisionPackageCard,
      .decisionOutcomeCard,
      #sideRoiBlock{
        grid-column: 1 / -1;
      }
      .snapshotDecision .decisionCard{
        border: 0;
        border-radius: 0;
        background: transparent;
        padding: 0;
      }
      .snapshotDecision .decisionOutcomeCard{
        border-top: 1px solid var(--border);
        margin-top: 2px;
        padding-top: 10px;
      }
      .snapshotDecision .sideOutcomeSingle{
        margin-top: 6px;
        border: 0;
        border-radius: 0;
        background: transparent;
        padding: 4px 2px;
      }
      .snapshotDecision .sideOutcomeList{
        display:grid;
        gap:8px;
        margin-top:0;
        padding:0 4px;
        box-sizing:border-box;
        grid-template-columns: minmax(0, 1fr);
      }
      .snapshotDecision .sideOutcomeList[data-count="2"]{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .snapshotDecision .sideOutcomeList[data-count="3"]{
        display:flex;
        gap:8px;
      }
      .snapshotDecision .sideOutcomeList[data-count="3"] .sideOutcomeItem{
        flex:1 1 0;
      }
      .snapshotDecision .sideOutcomeItem{
        width: 100%;
        min-width: 0;
        align-items:flex-start;
        border-radius:3px;
        padding:8px 10px;
      }
      .snapshotDecision .sideOutcomeText{
        display:block;
        white-space: normal;
        overflow-wrap: break-word;
        word-break: normal;
        line-height:1.3;
      }
      .decisionSecondary{
        grid-column: 1 / -1;
        opacity: .9;
      }
      .sideAnswersBlock{
        grid-column: 1 / -1;
        margin: 0 !important;
        padding: 0 !important;
        border: 0 !important;
        border-top: 1px solid var(--border) !important;
        border-radius: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
        min-height: 0;
        height: auto;
        max-height: 100%;
        align-self: stretch;
        overflow: hidden;
        display: grid;
        grid-template-rows: auto minmax(0, 1fr);
      }
      .sideAnswersBlock > summary{
        display:flex;
        align-items:center;
        justify-content:space-between;
        min-height:24px;
        padding: 10px 14px 8px;
      }
      .sideAnswersBlock[open] > summary{
        border-bottom: 1px solid var(--border);
      }
      .sideAnswersBlock .sideAnswersBody{
        min-height:0;
        height: 100%;
        max-height: 100%;
        overflow-y:auto;
        overflow-x:hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        padding: 8px 14px 12px;
      }
      .snapshotInputs{
        display:grid;
        grid-template-columns: minmax(0, 1fr);
        align-content:start;
        gap:6px;
        margin: 0;
        padding: 0 0 0 8px;
        border-left: 2px solid var(--border);
        min-height: auto;
        max-height: none;
        overflow: visible;
      }

      .snapshotDecision .recTitle{
        margin-top: 8px;
        margin-bottom: 2px;
        padding: 0;
      }
      .snapshotDecision .recDesc{
        margin-top: 6px;
        padding: 0;
      }
      .snapshotDecision details.collapse{
        border-radius: 0 !important;
        border: 0 !important;
        border-top: 1px solid var(--border) !important;
        margin: 0 !important;
        padding: 10px 0 !important;
        background: transparent !important;
        box-shadow: none !important;
      }
      .snapshotDecision details.collapse[open]{
        background: transparent !important;
        box-shadow: none !important;
      }
      .snapshotDecision details.collapse > summary{
        display:flex;
        align-items:center;
        justify-content:space-between;
        min-height:24px;
        padding:0;
      }
      #roiSnapGrid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      #roiSnapGrid .kpi{
        min-width: 0;
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 3px;
      }
      #roiSnapGrid .kpi .v{
        font-size: clamp(1.02rem, 1.15vw, 1.2rem);
        line-height: 1.18;
      }

      .snapshotInputs .inputAccordion{
        --section-accent: var(--azure);
        --section-keyline: var(--border);
        border: 1px solid var(--section-keyline);
        border-radius: 6px;
        background: var(--surface);
      }
      .snapshotInputs .inputAccordion[data-input="about"]{ --section-accent: var(--azure); }
      .snapshotInputs .inputAccordion[data-input="coverage"]{ --section-accent: var(--lilac); }
      .snapshotInputs .inputAccordion[data-input="fit"]{ --section-accent: var(--tangerine); }
      .snapshotInputs .inputAccordion[data-input="context"]{ --section-accent: var(--azure); }
      .snapshotInputs .inputAccordion[data-input="roi"]{ --section-accent: var(--lime); }
      .snapshotInputs .inputAccordion[data-input="review"]{ --section-accent: var(--azure); }
      .snapshotInputs .inputAccordion[data-incomplete="true"]{
        --section-accent: var(--coral);
        --section-keyline: color-mix(in srgb, var(--coral) 56%, var(--border));
        box-shadow: inset 0 3px 0 color-mix(in srgb, var(--coral) 88%, #8d122e 12%);
        background: color-mix(in srgb, var(--surface) 95%, var(--coral) 5%);
      }
      .snapshotInputs .inputAccordion[data-incomplete="true"] .inputAccTitle{
        color: color-mix(in srgb, var(--text) 80%, var(--coral) 20%);
      }
      .snapshotInputs .inputAccordion > summary{
        padding: 9px 10px;
        background: transparent;
        cursor: pointer;
        pointer-events: auto;
        align-items: center;
        min-height: 38px;
      }
      .snapshotInputs .inputAccordion[open] > summary{
        background: color-mix(in srgb, var(--surface-2) 60%, transparent);
      }
      .snapshotInputs .inputAccHead{
        display:flex;
        align-items:center;
        min-height:20px;
      }
      .snapshotInputs .inputAccordion > summary .chev{
        display: inline-block;
      }
      .snapshotInputs .inputAccBody{
        padding: 8px 10px 10px;
      }
      .snapshotInputs .inputAccordion[open] .inputAccBody{
        animation: snapshotValueIn .22s ease;
      }
      .snapshotInputs .inputSubhead{
        margin: 2px 0 6px;
        font-size: var(--snap-type-meta-size);
        letter-spacing: var(--snap-type-meta-track);
        text-transform: uppercase;
        font-weight: var(--snap-type-meta-weight);
        color: color-mix(in srgb, var(--muted) 88%, var(--text) 12%);
      }
      .snapshotInputs .inputAccTitle{
        text-transform:none;
        letter-spacing:var(--snap-type-group-track);
        font-size:var(--snap-type-group-size);
        font-weight:var(--snap-type-group-weight);
        line-height:1.2;
        color: var(--text);
      }
      #sideRoiBlock > summary .summaryLabelWithInfo{
        display:inline-flex;
        align-items:center;
        gap:8px;
      }
      #sideRoiBlock > summary .info.infoTiny{
        width:18px;
        height:18px;
        margin-top:0;
        font-size:.78rem;
      }
      #sideRoiBlock > summary .info.infoTiny .tip{
        left:0;
        right:auto;
        transform:translateY(0);
        width:min(320px, calc(100vw - 28px));
      }
      #sideRoiBlock > summary .info.infoTiny:hover .tip,
      #sideRoiBlock > summary .info.infoTiny:focus .tip{
        transform:translateY(-2px);
      }
      .snapshotInputs .chipsInline{
        gap:8px;
      }
      .snapshotInputs .valueChip{
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: none;
        font-size: var(--snap-type-chip-size);
        font-weight: 600;
        letter-spacing: 0;
        line-height:1.25;
        border-color: color-mix(in srgb, var(--section-accent) 34%, var(--border));
        background: color-mix(in srgb, var(--section-accent) 12%, var(--surface));
        color: color-mix(in srgb, var(--text) 70%, var(--section-accent) 30%);
      }
      .snapshotInputs .chipsMore summary{
        font-size: var(--snap-type-chip-size);
        letter-spacing: .04em;
        font-weight: 700;
        color: color-mix(in srgb, var(--text) 62%, var(--section-accent) 38%);
      }
      .snapshotInputs .kvRow{
        align-items: center;
      }
      .snapshotInputs .kvLabel{
        font-size: var(--snap-type-meta-size);
        letter-spacing: var(--snap-type-meta-track);
        font-weight: var(--snap-type-meta-weight);
        margin-top: 0;
      }
      .snapshotInputs .kvValue{
        font-size: var(--snap-type-value-size);
      }
      .snapshotInputs .kvEmpty{
        color: var(--muted);
      }
      #applyProofSet{
        width: 100%;
        justify-content: center;
      }
      .sideAnswersBlock > summary .chev,
      .snapshotDecision details.collapse > summary .chev,
      .snapshotInputs .inputAccordion > summary .chev{
        display:inline-block;
        width:15px;
        height:15px;
        flex:0 0 15px;
        margin-left:10px;
        transform: rotate(0deg);
        transition: transform .14s ease;
        font-size:0;
        line-height:0;
        color: transparent;
        background-repeat:no-repeat;
        background-size:15px 15px;
        background-position:center;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M4 6L8 10L12 6' fill='none' stroke='%235B677A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      }
      .sideAnswersBlock[open] > summary .chev,
      .snapshotDecision details.collapse[open] > summary .chev,
      .snapshotInputs .inputAccordion[open] > summary .chev{
        transform: rotate(180deg);
      }
      .snapshotInputs .inputAccordion + .inputAccordion{
        margin-top: 0;
      }

      .snapshotDecision,
      .sideAnswersBlock .sideAnswersBody{
        scrollbar-width: thin;
        scrollbar-color: color-mix(in srgb, var(--text) 18%, transparent) transparent;
      }
      .colResize{
        position: fixed;
        top: 0;
        bottom: 0;
        width: 10px;
        z-index: 85;
        cursor: col-resize;
        touch-action: none;
      }
      .colResize::before{
        content:"";
        position:absolute;
        top:0;
        bottom:0;
        left:4px;
        width:1px;
        background: transparent;
      }
      .colResize:hover::before,
      body.is-col-resizing .colResize::before{
        background: var(--border-strong);
      }
      .colResize--lhn{
        left: calc(var(--app-lhn-w) - 5px);
      }
      .colResize--right{
        left: calc(100vw - var(--app-right-w) - 5px);
      }
      body.is-col-resizing{
        user-select: none;
        cursor: col-resize;
      }
      footer{ display:none; }
    }

    /* Dark theme cleanup: high-contrast headings + flat keyline fields (no gloss) */
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .title h1,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .stepHead h2,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .sectionTitle,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .recTitle,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .settingsTitle,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .modalCard h3{
      color: var(--text) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .stepHead,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .radio,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .opt,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .roiBox,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .kpi,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) details.collapse{
      background: var(--surface) !important;
      box-shadow: none !important;
      border-color: var(--border) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .pill.rangeValue{
      background: color-mix(in srgb, var(--surface-2) 88%, var(--surface)) !important;
      color: var(--text) !important;
      border-color: var(--border-strong) !important;
      box-shadow: none !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock::before{
      background: var(--accent) !important;
      opacity: .9;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete::before{
      background: linear-gradient(90deg, color-mix(in srgb, var(--coral) 90%, #8d122e 10%), color-mix(in srgb, var(--coral) 62%, var(--surface))) !important;
      opacity: 1;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete{
      border-color: color-mix(in srgb, var(--coral) 56%, var(--border)) !important;
      background: color-mix(in srgb, var(--surface) 94%, var(--coral) 6%) !important;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete input[type="text"]:not(:focus),
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete input[type="email"]:not(:focus),
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete input[type="tel"]:not(:focus),
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete input[type="number"]:not(:focus),
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete select:not(:focus),
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) .qBlock.is-incomplete textarea:not(:focus){
      border-color: color-mix(in srgb, var(--coral) 46%, var(--border)) !important;
      background-color: color-mix(in srgb, var(--surface-2) 90%, var(--coral) 10%) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input[type="text"],
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input[type="email"],
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input[type="tel"],
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input[type="number"],
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) select,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) textarea,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) #regSearch{
      background-color: var(--surface-2) !important;
      border-color: var(--border) !important;
      box-shadow: none !important;
      color: var(--text) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input:hover,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) select:hover,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) textarea:hover,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) #regSearch:hover{
      border-color: var(--border-strong) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) input:focus,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) select:focus,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) textarea:focus,
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) #regSearch:focus{
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border)) !important;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 24%, transparent) !important;
    }

    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) ::placeholder{
      color: color-mix(in srgb, var(--muted) 84%, var(--text) 16%);
    }

    /* Select chevron: stronger contrast + better inset alignment */
    select{
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding-right: 44px !important;
      background-repeat: no-repeat !important;
      background-size: 16px 16px !important;
      background-position: calc(100% - 16px) 50% !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M4 6L8 10L12 6' fill='none' stroke='%235B677A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
    }
    select::-ms-expand{ display:none; }
    select:focus{
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M4 6L8 10L12 6' fill='none' stroke='%233C64FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) select{
      background-repeat: no-repeat !important;
      background-size: 16px 16px !important;
      background-position: calc(100% - 16px) 50% !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M4 6L8 10L12 6' fill='none' stroke='%23F5F5F6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) #regSearch{
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='7' cy='7' r='4.8' fill='none' stroke='%23F5F5F6' stroke-width='1.6'/%3E%3Cpath d='M10.8 10.8L14.2 14.2' stroke='%23F5F5F6' stroke-width='1.6' stroke-linecap='round'/%3E%3C/svg%3E") !important;
    }
    html:is([data-shell-tone="dark"], [data-shell-tone="comfort"]) select:focus{
      background-repeat: no-repeat !important;
      background-size: 16px 16px !important;
      background-position: calc(100% - 16px) 50% !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M4 6L8 10L12 6' fill='none' stroke='%233C64FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") !important;
    }

    /* Force header save button layout/style above generic later .btn variants */
    section.card > .cardPad.title .titleBar{
      width:100% !important;
      display:grid !important;
      grid-template-columns:minmax(0,1fr) auto !important;
      align-items:center !important;
      column-gap:12px !important;
    }
    section.card > .cardPad.title .titleActions{
      margin-left:0 !important;
      width:auto !important;
      display:flex !important;
      align-items:center !important;
      justify-content:flex-end !important;
    }
    section.card > .cardPad.title .btn.saveRecordBtn{
      margin-left:auto !important;
      background: var(--azure) !important;
      border-color: var(--azure) !important;
      color:#fff !important;
      opacity:1 !important;
    }
    section.card > .cardPad.title .btn.saveRecordBtn[data-saved="true"]{
      background: color-mix(in srgb, var(--lime) 16%, var(--surface)) !important;
      border-color: color-mix(in srgb, var(--lime) 46%, var(--border)) !important;
      color: color-mix(in srgb, var(--lime) 82%, #0f5132 18%) !important;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--lime) 18%, transparent) !important;
    }
    @media (max-width: 720px){
      section.card > .cardPad.title .titleActions{
        justify-content:flex-end !important;
      }
      section.card > .cardPad.title .btn.saveRecordBtn{
        width:auto !important;
      }
    }

    @media (max-width: 1199px){
      .nav-scroll{ display:block; }
      .nav-heading{ display:none; }
      .colResize{ display:none !important; }
      .nav-settingsDock{ display:none; }
      .workspaceCompanies{ display:none; }
    }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="wrap topbarInner">
      <div class="brandRow">
        <a class="brand" id="brandHome" href="#" aria-label="Immersive">
          <img class="logo" src="https://cdn.prod.website-files.com/6735fba9a631272fb4513263/6762d3c19105162149b9f1dc_Immersive%20Logo.svg" data-light="https://cdn.prod.website-files.com/6735fba9a631272fb4513263/6762d3c19105162149b9f1dc_Immersive%20Logo.svg" data-dark="https://cdn.prod.website-files.com/6735fba9a631272fb4513263/6911c98c1ee4440094a2ea32_Group.svg" alt="Immersive" />
        </a>
      </div>
      <div class="nav-scroll" aria-label="Configurator navigation">
        <nav class="workspaceNav" id="workspaceNav" aria-label="Workspace navigation">
          <button type="button" class="workspaceItem" id="workspaceDashboard" data-workspace="dashboard" data-active="false">
            <span class="workspaceItemIco" aria-hidden="true"></span>
            <span>Dashboard</span>
          </button>
        </nav>
        <section class="workspaceCompanies" id="workspaceCompanies" aria-label="Starred companies">
          <div class="workspaceCompaniesHead">
            <span class="workspaceCompaniesLabel">Starred</span>
            <span class="workspaceCompaniesCount" id="workspaceCompaniesCount">0</span>
          </div>
          <div class="workspaceCompaniesList" id="workspaceCompaniesList"></div>
        </section>
        <div class="recordContext" id="recordContext">
          <button type="button" class="recordContextBtn" id="recordOverviewBtn" aria-label="Back to record overview">
            <span class="recordContextArrow" aria-hidden="true"></span>
            <span class="recordContextBody">
              <span class="recordContextBack">Back</span>
              <span class="recordContextName" id="recordContextName">Orchid Corp</span>
            </span>
          </button>
        </div>
        <nav class="progress" aria-label="Progress">
          <button type="button" class="chip" data-chip="1" data-step="1" data-active="true"><strong>0</strong> About</button>
          <button type="button" class="chip" data-chip="2" data-step="2" data-active="false"><strong>1</strong> Coverage</button>
          <button type="button" class="chip" data-chip="3" data-step="3" data-active="false"><strong>2</strong> Package fit</button>
          <button type="button" class="chip" data-chip="4" data-step="4" data-active="false"><strong>3</strong> Context</button>
          <button type="button" class="chip" data-chip="5" data-step="5" data-active="false"><strong>4</strong> ROI estimate</button>
          <button type="button" class="chip" data-chip="6" data-step="6" data-active="false"><strong>5</strong> Review</button>
        </nav>
      </div>
      <div class="nav-settingsDock">
        <button type="button" class="nav-settings nav-settings--archive" id="workspaceArchive" data-workspace="archived" data-active="false" aria-label="Open archived accounts">
          <span class="nav-settingsIco" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <rect x="4.5" y="7" width="15" height="11" rx="2"></rect>
              <path d="M3.5 7h17"></path>
              <path d="M9 12h6"></path>
            </svg>
          </span>
          <span class="nav-settingsText">
            <span class="nav-settingsTitle">My archive</span>
            <span class="nav-settingsSub" id="workspaceArchiveSub">Archived accounts</span>
          </span>
        </button>
        <button type="button" class="nav-settings nav-settings--account" id="workspaceAccount" data-workspace="account" data-active="false" aria-label="Open My account">
          <span class="nav-settingsIco" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <circle cx="12" cy="8" r="3.6"></circle>
              <path d="M5.2 19.4c1.3-3.1 3.8-4.7 6.8-4.7s5.5 1.6 6.8 4.7"></path>
            </svg>
          </span>
          <span class="nav-settingsText">
            <span class="nav-settingsTitle">My account</span>
            <span class="nav-settingsSub">Profile defaults</span>
          </span>
        </button>
        <button type="button" class="nav-settings" id="openSettingsNav" aria-label="Open settings">
          <span class="nav-settingsIco" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path d="M11.7 3.1h.6l.8 2.1a7.4 7.4 0 0 1 1.9.8l2-1 1.1 1.1-1 2a7.4 7.4 0 0 1 .8 1.9l2.1.8v.6l-2.1.8a7.4 7.4 0 0 1-.8 1.9l1 2-1.1 1.1-2-1a7.4 7.4 0 0 1-1.9.8l-.8 2.1h-.6l-.8-2.1a7.4 7.4 0 0 1-1.9-.8l-2 1-1.1-1.1 1-2a7.4 7.4 0 0 1-.8-1.9l-2.1-.8v-.6l2.1-.8a7.4 7.4 0 0 1 .8-1.9l-1-2L8 5l2 1a7.4 7.4 0 0 1 1.9-.8l.8-2.1z"/>
              <circle cx="12" cy="12" r="2.9"/>
            </svg>
          </span>
          <span class="nav-settingsText">
            <span class="nav-settingsTitle">My settings</span>
            <span class="nav-settingsSub">Theme &amp; display</span>
          </span>
        </button>
      </div>
    </div>
  </header>
  <div class="colResize colResize--lhn" id="lhnResizeHandle" aria-hidden="true"></div>
  <div class="colResize colResize--right" id="rightResizeHandle" aria-hidden="true"></div>

  <main class="wrap">
    <section class="globalActionBar" id="globalActionBar" aria-label="Global actions">
      <div class="globalActionContext" id="globalActionContext">Dashboard</div>
      <div class="globalActionBtns">
        <button class="btn primary small" type="button" id="globalCreateRecord">Create new record</button>
        <button class="btn primary small" type="button" id="globalEditConfigurator" hidden>Edit record</button>
        <button class="btn secondaryBlue small" type="button" id="globalBookConsultation" hidden>Book consultation</button>
      </div>
    </section>
    <section id="dashboardView" aria-label="Dashboard view">
      <article class="dashboardShell">
        <div class="dashboardMeta">
          <span class="dashboardPill" id="dashThreadsCount">3 threads</span>
          <span class="dashboardPill" id="dashOverallScore">Average completion: 0%</span>
          <span class="dashboardPill">Owner: Me</span>
          <span class="dashboardPill" id="dashLastUpdated">Updated now</span>
        </div>
        <div class="dashboardToolbar">
          <label class="dashboardSelectAll" for="dashSelectAll">
            <input id="dashSelectAll" type="checkbox" />
            <span>Select all</span>
          </label>
          <span class="dashboardSelectCount" id="dashSelectCount">0 selected</span>
          <button class="btn small dashArchiveSelectedBtn" type="button" id="dashArchiveSelected" disabled>Archive selected</button>
        </div>
        <div class="dashboardTableWrap">
          <table class="dashboardTable" id="dashboardTable" aria-label="Configurator dashboard table">
            <thead>
              <tr>
                <th class="dashSelectCol" aria-label="Select rows"></th>
                <th>
                  <span class="dashColHeadLabel">Company</span>
                  <button class="dashColResizer" type="button" data-dash-col-resize="company" aria-label="Resize Company column"></button>
                </th>
                <th>
                  <span class="dashColHeadLabel">Completion</span>
                  <button class="dashColResizer" type="button" data-dash-col-resize="completion" aria-label="Resize Completion column"></button>
                </th>
                <th>
                  <span class="dashColHeadLabel">Tier</span>
                  <button class="dashColResizer" type="button" data-dash-col-resize="tier" aria-label="Resize Tier column"></button>
                </th>
                <th>
                  <span class="dashColHeadLabel">Key outcomes</span>
                  <button class="dashColResizer" type="button" data-dash-col-resize="outcomes" aria-label="Resize Key outcomes column"></button>
                </th>
                <th>
                  <span class="dashColHeadLabel">Remaining gaps</span>
                  <button class="dashColResizer" type="button" data-dash-col-resize="gaps" aria-label="Resize Remaining gaps column"></button>
                </th>
                <th><span class="dashColHeadLabel">Actions</span></th>
              </tr>
            </thead>
            <tbody id="dashboardRows"></tbody>
          </table>
        </div>
      </article>
    </section>

    <section id="archivedView" aria-label="Archived accounts view">
      <article class="dashboardShell">
        <div class="dashboardMeta">
          <span class="dashboardPill" id="archivedThreadsCount">0 archived</span>
          <span class="dashboardPill" id="archivedLastUpdated">No archived records</span>
        </div>
        <div class="dashboardToolbar">
          <label class="dashboardSelectAll" for="archivedSelectAll">
            <input id="archivedSelectAll" type="checkbox" />
            <span>Select all</span>
          </label>
          <span class="dashboardSelectCount" id="archivedSelectCount">0 selected</span>
          <button class="btn small dashArchiveSelectedBtn" type="button" id="archivedRestoreSelected" disabled>Unarchive selected</button>
        </div>
        <div class="dashboardTableWrap">
          <table class="dashboardTable" id="archivedTable" aria-label="Archived accounts table">
            <thead>
              <tr>
                <th class="dashSelectCol" aria-label="Select rows"></th>
                <th>Company</th>
                <th>Completion</th>
                <th>Tier</th>
                <th>Key outcomes</th>
                <th>Remaining gaps</th>
                <th><span class="dashColHeadLabel">Actions</span></th>
              </tr>
            </thead>
            <tbody id="archivedRows"></tbody>
          </table>
        </div>
      </article>
    </section>

    <section id="accountView" aria-label="My account view">
      <article class="accountShell">
        <header class="accountHead">
          <div>
            <h2>My account</h2>
            <p class="accountSub">Google Workspace profile defaults used to prefill new records and shape role-aware configurator behavior.</p>
          </div>
          <button class="btn" type="button" id="accountOpenSettings">Open settings</button>
        </header>
        <div class="accountBody">
          <section class="settingsRow">
            <div class="settingsLabel">Profile defaults</div>
            <div class="settingsFieldGrid">
              <label class="settingsField">
                <span class="settingsFieldLabel">Full name</span>
                <input id="accountFullName" type="text" placeholder="Jane Doe" autocomplete="name" />
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Work email</span>
                <input id="accountEmail" type="email" placeholder="name@company.com" autocomplete="email" />
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Phone</span>
                <input id="accountPhone" type="tel" placeholder="+1 555 123 4567" autocomplete="tel" />
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Default role</span>
                <select id="accountRole">
                  <option value="">No default</option>
                  <option value="vp_sales">VP Sales</option>
                  <option value="vp_customer_success">VP, Customer Success</option>
                  <option value="director_regional_sales">Director, Regional Sales</option>
                  <option value="senior_manager_customer_success">Senior Manager, Customer Success</option>
                  <option value="senior_enterprise_account_manager">Senior Enterprise Account Manager</option>
                  <option value="lead_customer_success_manager">Lead Customer Success Manager</option>
                  <option value="enterprise_account_manager">Enterprise Account Manager</option>
                  <option value="customer_success_manager">Customer Success Manager</option>
                  <option value="senior_sales_development_representative">Senior Sales Development Representative</option>
                  <option value="sales_development_representative">Sales Development Representative</option>
                  <option value="senior_cyber_resilience_advisor">Senior Cyber Resilience Advisor</option>
                  <option value="cyber_resilience_advisor">Cyber Resilience Advisor</option>
                  <option value="associate_enterprise_account_manager">Associate Enterprise Account Manager</option>
                  <option value="associate_customer_success_manager">Associate Customer Success Manager</option>
                  <option value="associate_sales_development_representative">Associate Sales Development Representative</option>
                  <option value="associate_cyber_resilience_advisor">Associate Cyber Resilience Advisor</option>
                </select>
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Default operating country</span>
                <select id="accountCountry">
                  <option value="">No default</option>
                </select>
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Default region</span>
                <select id="accountRegion">
                  <option value="">No default</option>
                </select>
              </label>
              <label class="settingsField">
                <span class="settingsFieldLabel">Configurator mode</span>
                <select id="accountFieldMode">
                  <option value="guided">Guided</option>
                  <option value="advanced">Advanced</option>
                </select>
                <p class="settingsFieldNote">Guided keeps the flow lean. Advanced exposes extra detail and controls.</p>
              </label>
            </div>
            <div class="settingsOptions settingsInlineOptions" id="accountPrefillOptions">
              <button class="settingsOption" type="button" data-prefill="on" aria-pressed="true">Prefill new records</button>
              <button class="settingsOption" type="button" data-prefill="off" aria-pressed="false">Manual start for new records</button>
            </div>
            <p class="settingsHint" style="margin-top:10px;">This role is your internal workspace role. Customer role/persona is still captured inside each record.</p>
            <div class="settingsRowActions">
              <button class="btn secondaryBlue small" id="accountApplyNow" type="button">Apply to current record</button>
              <button class="btn small" id="accountReset" type="button">Reset account defaults</button>
            </div>
          </section>
        </div>
      </article>
    </section>

    <section id="interstitialView" aria-label="Conversation overview">
      <article class="interShell" id="interstitialContent"></article>
    </section>

    <div class="grid">
      <!-- MAIN -->
      <section class="card">
        <div class="cardPad title">
          <div class="titleBar">
            <h1>Cyber readiness configurator</h1>
            <div class="titleActions">
              <button class="btn secondaryBlue small" type="button" id="jumpNextIncompleteBtn" data-jump-next-incomplete="true" title="Jump to next incomplete section">
                <span class="jumpNextIncompleteBtnLabel" id="jumpNextIncompleteBtnLabel">Next incomplete</span>
              </button>
              <button class="btn primary small saveRecordBtn" type="button" id="saveRecordBtn" data-saved="false" aria-live="polite">
                <span class="saveSpinner" aria-hidden="true"></span>
                <span id="saveRecordBtnLabel">Save record</span>
                <span class="saveCheck" aria-hidden="true"></span>
              </button>
            </div>
          </div>
        </div>

        <div class="cardPad">
          <!-- STEP 0 -->
          <div class="step" data-step="1" data-active="true" aria-label="Step 0  About">
            <div class="stepHead">
              <div>
                <h2>Step 0  Tell us about yourself and your priorities</h2>
                <div class="hint">Capture profile, operating context, and outcomes together so we can infer priorities in one pass.</div>
              </div>
              <div class="pill">~ 23 minutes</div>
            </div>

            <div class="qBlock" id="qBusiness">
              <div class="labelRow">
                <div class="sectionTitle">Your business</div>
                <span class="info" tabindex="0" aria-label="Info: Your business">
                  i
                  <span class="tip">This appears in Review and in copied/exported summaries.</span>
                </span>
              </div>

              <div style="margin-top:12px;">
                <label class="qPrompt">Which best describes your role?</label>
                <div class="options" id="optRole" aria-label="Role options"></div>
              </div>

              <div class="row" style="margin-top:12px;">
                <div>
                  <label for="fullName">Your name</label>
                  <input id="fullName" type="text" placeholder="Jane Doe" />
                </div>
                <div>
                  <label for="company">Company</label>
                  <input id="company" type="text" placeholder="Company name" />
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <div>
                  <label for="companySize">Company size</label>
                  <select id="companySize">
                    <option value="">Select</option>
                    <option value="lt500">&lt; 500 employees</option>
                    <option value="500-2k">5002,000</option>
                    <option value="2k-10k">2,00010,000</option>
                    <option value="10k-50k">10,00050,000</option>
                    <option value="50kplus">50,000+</option>
                  </select>
                </div>
                <div>
                  <label for="operatingCountry">Operating country</label>
                  <select id="operatingCountry">
                    <option value="">Select</option>
                    <option value="United States">United States</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="Ireland">Ireland</option>
                    <option value="Canada">Canada</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Spain">Spain</option>
                    <option value="Italy">Italy</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Norway">Norway</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Australia">Australia</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Japan">Japan</option>
                    <option value="India">India</option>
                    <option value="Other">Other / multiple</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <div>
                  <label for="industry">What best describes your business?</label>
                  <select id="industry">
                    <option value="">Select</option>
                    <option>Financial Services</option>
                    <option>Banking</option>
                    <option>Insurance</option>
                    <option>Payments / FinTech</option>
                    <option>Healthcare / Life Sciences</option>
                    <option>Retail / eCommerce</option>
                    <option>Technology / SaaS</option>
                    <option>Telecommunications</option>
                    <option>Government / Public Sector</option>
                    <option>Defense / Aerospace</option>
                    <option>Energy / Utilities</option>
                    <option>Manufacturing / Industrial</option>
                    <option>Transportation / Logistics</option>
                    <option>Education</option>
                    <option>Managed Services (MSP/MSSP)</option>
                    <option>Professional Services</option>
                    <option>Other</option>
                  </select>
                </div>
                <div>
                  <label for="region">Operating region / footprint</label>
                  <select id="region">
                    <option value="">Select</option>
                    <option value="NA">North America</option>
                    <option value="UKI">UK & Ireland</option>
                    <option value="EU">Europe (EU)</option>
                    <option value="APAC">APAC</option>
                    <option value="Other">Other / Global</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qOutcomeDiscovery">
              <div class="labelRow">
                <div class="sectionTitle">Outcome discovery</div>
                <span class="info" tabindex="0" aria-label="Info: Outcome discovery">
                  i
                  <span class="tip">Answer quickly. We use these signals to infer your top 3 outcomes without forcing a pick from six.</span>
                </span>
              </div>

              <div style="margin-top:12px;">
                <div class="questionHead">
                  <label class="qPrompt">Wheres the pressure coming from? (pick up to 3)</label>
                  <div class="countPill" id="pressureMeta">0 of 3 selected</div>
                </div>
                <div class="radioGrid twoCol" id="pressureCards" aria-label="Pressure source options"></div>
              </div>

              <div style="margin-top:12px;">
                <label class="qPrompt">Whats the most urgent 90-day win?</label>
                <div class="radioGrid twoCol" id="radUrgentWin"></div>
              </div>

              <div style="margin-top:12px;">
                <div class="questionHead">
                  <label class="qPrompt">Which environment is driving risk? (pick up to 2)</label>
                  <div class="countPill" id="riskEnvMeta">0 of 2 selected</div>
                </div>
                <div class="radioGrid twoCol" id="riskEnvCards"></div>
              </div>

              <div style="margin-top:12px;">
                <label class="qPrompt">What are you being measured on today?</label>
                <div class="radioGrid twoCol" id="radMeasuredOn"></div>
              </div>

              <div style="margin-top:12px;">
                <label class="qPrompt">Where is your biggest pain points?</label>
                <div class="radioGrid twoCol" id="radOrgPain"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qOutcomeReveal">
              <div class="labelRow">
                <div class="sectionTitle">Based on what you said, your top outcomes look like:</div>
                <span class="info" tabindex="0" aria-label="Info: Inferred outcomes">
                  i
                  <span class="tip">Use these to validate discovery confidence. You can tune the signals above if the order looks wrong.</span>
                </span>
              </div>
              <div class="outcomeTop3" id="outcomeTop3">Complete the discovery questions above to see your top outcomes.</div>
              <div class="mini" id="outcomePlaybackConfirm">Does this feel right? If not, adjust your answers above.</div>
              <div class="radioGrid twoCol outcomeCardGrid" id="outcomeCards"></div>
            </div>

            <div class="actions">
              <button class="btn ghost" type="button" disabled>Back</button>
              <button class="btn primary" type="button" data-action="next">Continue</button>
            </div>
          </div>

          <!-- STEP 1 -->
          <div class="step" data-step="2" aria-label="Step 1  Coverage">
            <div class="stepHead">
              <div>
                <h2>Step 1  Coverage</h2>
                <div class="hint">Who needs to be ready  and how do you run readiness today?</div>
              </div>
              <div class="pill">~ 12 minutes</div>
            </div>

            <div class="qBlock" id="qCoverage">
              <div class="labelRow">
                <div class="sectionTitle">Teams who need to be ready (select any)</div>
                <span class="info" tabindex="0" aria-label="Info: Coverage groups">
                  i
                  <span class="tip">Coverage shapes the plan (and the tier). Select all groups you need to include in the readiness program.</span>
                </span>
              </div>
              <div class="options" id="optGroups"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock">
              <div class="labelRow">
                <div class="sectionTitle">Cyber resilience cadence today (best fit)</div>
                <span class="info" tabindex="0" aria-label="Info: Exercising cadence">
                  i
                  <span class="tip">Choose the option that best applies. Cadence and realism affect the operating rhythm we propose (and whether Advanced/Ultimate is justified).</span>
                </span>
              </div>
              <div class="radioGrid twoCol" id="radRhythm"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock">
              <div class="labelRow">
                <div class="sectionTitle">How do you measure readiness today?</div>
                <span class="info" tabindex="0" aria-label="Info: Measurement">
                  i
                  <span class="tip">Completion metrics are a starting point. Performance metrics (speed, accuracy, decisions) strengthen evidence and confidence.</span>
                </span>
              </div>
              <div class="radioGrid twoCol" id="radMeasure"></div>
            </div>

            <details class="collapse" id="coverageAdvanced">
              <summary>
                <span>Advanced (optional)</span>
                <span class="chev" aria-hidden="true"></span>
              </summary>

              <div class="qBlock" id="qDrivers" style="margin-top:12px;">
                <div class="labelRow">
                  <div class="sectionTitle">What triggered this conversation? (pick up to 3)</div>
                  <span class="info" tabindex="0" aria-label="Info: Outcome signals">
                    i
                    <span class="tip">These are outcome signals, not a pricing wizard. We use them to shape tier rationale and follow-up agenda.</span>
                  </span>
                </div>
                <div class="helperMetaRow">
                  <div class="helperText">Pick up to three triggers. Each maps to one or more outcomes.</div>
                  <div class="countPill" id="driverMeta">0 of 3 selected</div>
                </div>
                <div class="radioGrid twoCol" id="driverCards"></div>
              </div>

              <div class="qBlock" id="qOutcomeDrill" style="margin-top:12px;">
                <div class="labelRow">
                  <div class="sectionTitle">Outcome drill-down (optional)</div>
                  <span class="info" tabindex="0" aria-label="Info: Outcome drill-down">
                    i
                    <span class="tip">One extra question per inferred top outcome to sharpen the next-meeting agenda.</span>
                  </span>
                </div>
                <div class="mini">Only shown for your current top outcomes.</div>
                <div id="outcomeDrilldowns" class="drillGrid"></div>
              </div>
            </details>

            <div class="actions">
              <button class="btn" type="button" data-action="back">Back</button>
              <button class="btn primary" type="button" data-action="next">Continue</button>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" data-step="3" aria-label="Step 2  Package fit">
            <div class="stepHead">
              <div>
                <h2>Step 2  Package fit</h2>
                <div class="hint">Add the remaining fit signals (realism, scope, delivery) before we recommend a starting tier.</div>
              </div>
              <div class="pill">~ 12 minutes</div>
            </div>

            <div class="qBlock" id="qPackageFit">
              <div class="labelRow">
                <div class="sectionTitle">1) How realistic do exercises need to be?</div>
                <span class="info" tabindex="0" aria-label="Info: Exercise realism">
                  i
                  <span class="tip">Realism increases trust and supports scrutiny, but changes the delivery model.</span>
                </span>
              </div>
              <div class="radioGrid" id="radFitRealism"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qFitScope">
              <div class="labelRow">
                <div class="sectionTitle">2) Scope of the program</div>
                <span class="info" tabindex="0" aria-label="Info: Program scope">
                  i
                  <span class="tip">Scope is about the breadth of coverage needed to deliver ROI and defensible outcomes.</span>
                </span>
              </div>
              <div class="radioGrid" id="radFitScope"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qFitToday">
              <div class="labelRow">
                <div class="sectionTitle">3) Current state (closest match)</div>
                <span class="info" tabindex="0" aria-label="Info: Current state">
                  i
                  <span class="tip">Be honest about the starting point; it improves the recommendation.</span>
                </span>
              </div>
              <div class="radioGrid" id="radFitToday"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qFitServices">
              <div class="labelRow">
                <div class="sectionTitle">4) Delivery style they need</div>
                <span class="info" tabindex="0" aria-label="Info: Delivery style">
                  i
                  <span class="tip">Services signal how much support is needed to deliver outcomes.</span>
                </span>
              </div>
              <div class="radioGrid" id="radFitServices"></div>
            </div>

            <div class="divider"></div>

            <div class="qBlock" id="qFitRisk">
              <div class="labelRow">
                <div class="sectionTitle">5) How they describe the problem</div>
                <span class="info" tabindex="0" aria-label="Info: Problem framing">
                  i
                  <span class="tip">How teams frame the problem indicates maturity and evidence needs.</span>
                </span>
              </div>
              <div class="radioGrid" id="radFitRisk"></div>
            </div>

            <div class="actions">
              <button class="btn" type="button" data-action="back">Back</button>
              <button class="btn primary" type="button" data-action="next">Continue</button>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="step" data-step="4" aria-label="Step 3  Context">
            <div class="stepHead">
              <div>
                <h2>Step 3  Context</h2>
                <div class="hint">Add just enough context for relevance  without turning into the master configurator.</div>
              </div>
              <div class="pill">~ 12 minutes</div>
            </div>

            <div class="qBlock" id="qContext">
              <div class="labelRow">
                <div class="sectionTitle">Context from Step 0</div>
                <span class="info" tabindex="0" aria-label="Info: Context from Step 0">
                  i
                  <span class="tip">Industry and region are set in Step 0 and used here to tailor suggested regulations.</span>
                </span>
              </div>
              <div class="mini" id="contextFromStep0">Complete Step 0 to personalize regulation suggestions.</div>
            </div>

            <div class="divider"></div>

	            <div class="qBlock" id="qRegs">
              <div class="labelRow">
                <div class="sectionTitle">Regulatory / assurance context (optional)</div>
                <span class="info" tabindex="0" aria-label="Info: Regulations">
                  i
                  <span class="tip">Suggested based on your business and region. Used to tailor evidence language and stakeholder framing. Not legal advice.</span>
                </span>
              </div>

	              <div class="regMetaRow">
	                <div class="mini" id="regSuggestedFor">Suggested for: your selected context</div>
	                <div class="helperText" id="regModeHint">Suggested list is tailored by industry and region. All shows the full library AZ. Tags show Regulation / Framework / Assurance.</div>
	              </div>

	              <div class="regControls" aria-label="Regulation picker controls">
	                <div class="grow">
	                  <label for="regSearch">Search regulations &amp; standards</label>
	                  <input id="regSearch" type="search" placeholder="e.g., DORA, NIS2, GDPR, ISO 27001, PCI DSS, NIST 800-53" />
                </div>
                <div class="fixed">
                  <label>View</label>
                  <div class="seg" id="regMode" role="tablist" aria-label="Regulation list mode">
                    <button type="button" class="segBtn" data-mode="suggested" role="tab" aria-selected="true">Suggested</button>
                    <button type="button" class="segBtn" data-mode="all" role="tab" aria-selected="false">All</button>
                  </div>
                </div>
                <div class="fixed">
                  <label>Proof set</label>
                  <button type="button" class="btn secondaryBlue small" id="applyProofSet">Recommended</button>
                </div>
              </div>

	              <div class="options" id="optRegs"></div>
	            </div>

            

            <div class="divider"></div>

            <div class="qBlock" id="qStack">
              <div class="labelRow">
                <div class="sectionTitle">Security tools &amp; platforms (optional)</div>
                <span class="info" tabindex="0" aria-label="Info: Tech stack">
                  i
                  <span class="tip">Pick the platforms you want handson simulations and examples to align to. This helps make the plan feel your world.</span>
                </span>
              </div>

              <div class="mini">Select any tools or platforms you want to practice workflows for.</div>

              <div class="stackGrid" aria-label="Tech stack pick-list">
                <div>
                  <div class="stackH">Security tools &amp; SOC platforms</div>
                  <div class="options" id="optStackSoc"></div>
                </div>
                <div>
                  <div class="stackH">Cloud platforms</div>
                  <div class="options" id="optStackCloud"></div>
                </div>
                <div>
                  <div class="stackH">Cloudnative &amp; DevSecOps</div>
                  <div class="options" id="optStackDevops"></div>
                </div>
                <div>
                  <div class="stackH">Other domains</div>
                  <div class="options" id="optStackDomains"></div>
                </div>
              </div>

              <div style="margin-top:14px;">
                <label for="stackOther">Other musthave tooling (optional)</label>
                <input id="stackOther" type="text" placeholder="e.g., Okta, ServiceNow, Palo Alto" />
              </div>
            </div>

            <div class="actions">
              <button class="btn" type="button" data-action="back">Back</button>
              <button class="btn primary" type="button" data-action="next">Continue</button>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="step" data-step="5" aria-label="Step 4  ROI estimate">
            <div class="stepHead">
              <div>
                <h2>Step 4  ROI estimate</h2>
                <div class="hint">Immersive estimate based on Immersive assumptions and outcomes seen in organizations of similar size and scale. Start with revenue or budget to size quickly, then adjust team sizes and spend.</div>
              </div>
              <div class="pill">~ 1 minute</div>
            </div>

            <div class="roiBox" id="qValue">
              <div class="roiTop">
                <div>
                  <div class="roiTitleRow">
                    <span>How this estimate works</span>
                    <span class="info" tabindex="0" aria-label="Info: How this estimate works">
                      i
                      <span class="tip">This estimate uses Immersive assumptions informed by delivery experience with organizations of similar size and scale. It is for planning guidance and decision support.</span>
                    </span>
                  </div>
                  <div class="roiSub">This is an Immersive estimate to help you sanity-check ROI. Start with <strong>annual revenue / operating budget</strong> to get a typical footprint + indicative spend, then fine-tune team sizes and spend to match your reality. <strong>Based on Immersive assumptions and comparable customer profiles.</strong></div>

                  <div class="roiCtrlBar" aria-label="ROI estimate controls">
                    <div class="seg small" role="group" aria-label="Currency">
                      <button type="button" class="curBtn" data-cur="USD" aria-pressed="true">USD</button>
                      <button type="button" class="curBtn" data-cur="GBP" aria-pressed="false">GBP</button>
                      <button type="button" class="curBtn" data-cur="EUR" aria-pressed="false">EUR</button>
                    </div>

                    <button type="button" class="btn small resetPill" id="resetValue">
                      Reset
                      <span class="resetIcon" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>
              </div>

              <div class="rangeLine">
                <div class="rangeLabel">
                  <label for="revenue">Annual revenue or operating budget</label>
                  <span class="info" tabindex="0" aria-label="Info: Revenue sizing">
                    i
                    <span class="tip">Revenue is used as a quick sizing proxy to suggest a typical starting footprint. You can override team sizes below.</span>
                  </span>
                </div>
                <div class="pill rangeValue" id="revenueLabel">$10B</div>
                <div class="rangeControl">
                  <input id="revenue" type="range" min="0.2" max="200" step="0.1" value="10" />
                </div>
              </div>

              <div class="divider" style="margin:14px 0;"></div>

              <div class="rangeLine">
                <div class="rangeLabel">
                  <label for="teamCyber">Cyber team size</label>
                  <span class="info" tabindex="0" aria-label="Info: Cyber team slider">
                    i
                    <span class="tip">Used to scale cyber workforce benefits (attrition, hiring, training efficiency) in the preview.</span>
                  </span>
                </div>
                <div class="pill rangeValue" id="teamCyberLabel">200</div>
                <div class="rangeControl">
                  <input id="teamCyber" type="range" min="10" max="1500" step="5" value="200" />
                </div>
              </div>

              <div class="rangeLine">
                <div class="rangeLabel">
                  <label for="teamDev">Developer population</label>
                  <span class="info" tabindex="0" aria-label="Info: Developer slider">
                    i
                    <span class="tip">Used to scale developer productivity benefits in the preview.</span>
                  </span>
                </div>
                <div class="pill rangeValue" id="teamDevLabel">1,000</div>
                <div class="rangeControl">
                  <input id="teamDev" type="range" min="50" max="8000" step="50" value="1000" />
                </div>
              </div>

              <div class="rangeLine">
                <div class="rangeLabel">
                  <label for="teamWf">Wider workforce</label>
                  <span class="info" tabindex="0" aria-label="Info: Workforce slider">
                    i
                    <span class="tip">Used for suggested footprint context and workforce-ready planning (not a precise model input).</span>
                  </span>
                </div>
                <div class="pill rangeValue" id="teamWfLabel">3,000</div>
                <div class="rangeControl">
                  <input id="teamWf" type="range" min="200" max="200000" step="250" value="3000" />
                </div>
              </div>

              <div class="divider" style="margin:14px 0;"></div>

              <div class="rangeLine">
                <div class="rangeLabel">
                  <div class="labelRow">
                    <label for="invest">Indicative spend (annual program investment)</label>
                    <span class="info" tabindex="0" aria-label="Info: Indicative spend slider">
                      i
                      <span class="tip">Directional estimate based on revenue + footprint (revenue + team footprint). Preview is capped at roughly US$9M/yr equivalent for realism. If you model materially higher/lower spend, we apply diminishing returns to keep outputs sensible.</span>
                    </span>
                  </div>
                                  </div>
                <div class="pill rangeValue" id="investLabel">$250,000</div>
                <div class="rangeControl">
                  <input id="invest" type="range" min="25000" max="9000000" step="5000" value="250000" />
                </div>
              </div>

                            <div class="divider"></div>

              <div class="roiOutputsHead">
                <div class="roiOutputsTitle">Estimated outcomes</div>
                <div class="roiOutputsSub">Choose an assumption range for estimated ROI, NPV and payback.</div>
              </div>
              <div class="seg roiOutputsSeg" role="group" aria-label="ROI output assumption range">
                <button type="button" class="segBtn" data-real="conservative" aria-pressed="true">Conservative</button>
                <button type="button" class="segBtn" data-real="expected" aria-pressed="false">Expected</button>
                <button type="button" class="segBtn" data-real="immersive" aria-pressed="false">Immersive base</button>
              </div>

              <div class="kpiGrid" aria-label="ROI estimate outputs">
                <div class="kpi">
                  <p class="k">3year ROI (estimate)</p>
                  <p class="v" id="roiOut"></p>
                </div>
                <div class="kpi">
                  <p class="k">3year NPV (estimate)</p>
                  <p class="v" id="npvOut"></p>
                </div>
                <div class="kpi">
                  <p class="k">Payback (est.)</p>
                  <p class="v" id="paybackOut"></p>
                </div>
                <div class="kpi">
                  <p class="k">Indicative spend</p>
                  <p class="v" id="valueInputsOut"></p>
                </div>
              </div>

              <details class="collapse" id="roiMore">
                <summary>
                  <span>Adjust assumptions</span>
                  <span class="chev" aria-hidden="true"></span>
                </summary>

                <div class="row" style="margin-top:14px;">
                  <div>
                    <label for="paybackDelay">Adoption ramp before benefits (months)</label>
                    <input id="paybackDelay" type="number" min="0" max="12" step="1" value="3" />
                  </div>
                  <div>
                    <label for="cyberSalary">Avg cyber fully loaded salary</label>
                    <input id="cyberSalary" type="number" min="40000" max="600000" step="5000" value="180000" />
                  </div>
                </div>

                <div class="row" style="margin-top:12px;">
                  <div>
                    <label for="devSalary">Avg developer fully loaded salary</label>
                    <input id="devSalary" type="number" min="40000" max="600000" step="5000" value="160000" />
                  </div>
                  <div>
                    <label for="fxGBP">FX: 1 USD = (GBP)</label>
                    <input id="fxGBP" type="number" min="0.1" max="2" step="0.01" value="0.80" />
                  </div>
                </div>

                <div class="row" style="margin-top:12px;">
                  <div>
                    <label for="fxEUR">FX: 1 USD = (EUR)</label>
                    <input id="fxEUR" type="number" min="0.1" max="2" step="0.01" value="0.90" />
                  </div>
                  <div>
                    <label for="assumpNote">Note</label>
                    <input id="assumpNote" type="text" value="Planning sensitivity inputs" readonly />
                  </div>
                </div>

                <div class="mini">Salary inputs scale benefits in this estimate. FX defaults are placeholders for the prototype and can be edited for your environment.</div>
              </details>
            </div>

            <div class="actions">
              <button class="btn" type="button" data-action="back">Back</button>
              <button class="btn primary" type="button" data-action="next">Continue</button>
            </div>
          </div>

          <!-- STEP 5 -->
          <div class="step" data-step="6" aria-label="Step 5  Review">
            <div class="stepHead">
              <div>
                <h2>Step 5  Review</h2>
                <div class="hint">Confirm our understanding of your business. If anything looks off, jump back to edit  then book a consultation.</div>
                <div class="reviewCtaBar">
                  <button class="btn secondaryBlue small" type="button" data-action="printReport">Print / Save PDF</button>
                  <button class="btn small" type="button" data-action="downloadCSV">Download CSV</button>
                  <a class="btn primary small" href="#bookForm">Book my consultation</a>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; margin-bottom:16px;">
              <div class="cardPad">
                <div class="sectionTitle">Our understanding of your business</div>
                <div class="mini" style="margin-top:6px;">Review what weve captured across the configurator. Use Edit to adjust any section.</div>
                <div class="summaryGrid" style="margin-top:12px;">
                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Organisation</span>
                      <button class="link" type="button" data-jump="1" data-target="#qBusiness">Edit</button>
                    </div>
                    <div class="sumBody" id="sumOrg"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>ROI inputs</span>
                      <button class="link" type="button" data-jump="5" data-target="#qValue">Edit</button>
                    </div>
                    <div class="sumBody" id="sumValue"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Challenge</span>
                      <button class="link" type="button" data-jump="1" data-target="#qOutcomeDiscovery">Edit</button>
                    </div>
                    <div class="sumBody" id="sumMandate"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Top outcomes</span>
                      <button class="link" type="button" data-jump="1" data-target="#qOutcomeReveal">Edit</button>
                    </div>
                    <div class="sumBody" id="sumOutcomes"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Tier + why</span>
                      <button class="link" type="button" data-jump="3" data-target="#qPackageFit">Edit</button>
                    </div>
                    <div class="sumBody" id="sumTier"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Recommended next meeting agenda</span>
                    </div>
                    <div class="sumBody" id="sumAgenda"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Who to bring</span>
                    </div>
                    <div class="sumBody" id="sumWho"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Recommended resources</span>
                    </div>
                    <div class="sumBody" id="sumResources"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Coverage</span>
                      <button class="link" type="button" data-jump="2" data-target="#qCoverage">Edit</button>
                    </div>
                    <div class="sumBody" id="sumCoverage"></div>
                  </div>
                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Package fit</span>
                      <button class="link" type="button" data-jump="3" data-target="#qPackageFit">Edit</button>
                    </div>
                    <div class="sumBody" id="sumFit"></div>
                  </div>


                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Context</span>
                      <button class="link" type="button" data-jump="4" data-target="#qContext">Edit</button>
                    </div>
                    <div class="sumBody" id="sumContext"></div>
                  </div>

                  <div class="sumCard">
                    <div class="sumHead">
                      <span>Security tools & platforms</span>
                      <button class="link" type="button" data-jump="4" data-target="#qStack">Edit</button>
                    </div>
                    <div class="sumBody" id="sumStack"></div>
                  </div>
                </div>
              </div>
            </div>
<div id="bookForm" class="card darkForm" style="box-shadow:none; margin-top:0;">
              <div class="cardPad">
                <div class="formHead">
                  <div class="sectionTitle" style="color:#fff;">Book your consultation</div>
                  <div class="mini" style="color:rgba(255,255,255,.78); margin-top:6px;">Share your contact details and well follow up to tailor a consultation around your snapshot.</div>
                </div>
                <div class="divider" style="background:rgba(255,255,255,.14); margin:14px 0;"></div>
<div class="row">
              <div>
                <label for="email">Business email</label>
                <input id="email" type="email" placeholder="name@company.com" />
              </div>
              <div>
                <label for="phone">Phone (optional)</label>
                <input id="phone" type="tel" placeholder="+1 555 123 4567" />
              </div>
            </div>

            <div style="margin-top:12px;">
              <label for="notes">Anything you want us to tailor the consultation around? (optional)</label>
              <textarea id="notes" placeholder="e.g., Upcoming audit, recent incident, specific scenarios, teams to include"></textarea>
            </div>

            <div class="mini" style="margin-top:12px;">
              By submitting, you acknowledge that Immersive will process your personal information in accordance with its Privacy Notice.
              <br/>
              <label class="optinRow">
                <input id="optin" type="checkbox" style="transform: translateY(1px); width:20px; height:20px;" />
                Keep me updated on product news and events (optional)
              </label>
            </div>

            <div class="bookOnlyActions">
              <button class="btn primary fullWidth" type="button" data-action="book">Book my consultation</button>
            </div>
              </div>
            </div>
          </div>
          <div class="configBottomActions">
            <button class="btn secondaryBlue small" type="button" id="jumpNextIncompleteBtnBottom" data-jump-next-incomplete="true" title="Jump to next incomplete section">
              <span class="jumpNextIncompleteBtnLabel">Next incomplete</span>
            </button>
          </div>
        </div>
      </section>

      <!-- SIDE -->
      <aside class="card sticky" aria-label="Your readiness snapshot">
        <div class="cardPad">
          <div class="sideTitle">
            <div class="sectionTitle">Your snapshot</div>
            <div class="pill small" id="selPill">0/14 captured</div>
          </div>

          <section class="snapshotDecision" id="decisionCol" aria-label="Decision summary">
            <div class="decisionCard decisionPackageCard">
              <div class="sectionTitle">Package</div>
              <div class="recTitle" id="recTitle"></div>
              <div class="recDesc" id="recDesc"></div>
            </div>

            <div class="decisionCard decisionOutcomeCard">
              <div class="sectionTitle">Primary outcomes in focus</div>
              <div class="sideOutcomeSingle" id="sidePrimaryOutcome">Complete Step 0 to infer top outcomes.</div>
            </div>

            <details class="collapse" id="sideRoiBlock">
              <summary>
                <span class="summaryLabelWithInfo">
                  <span>ROI estimate</span>
                  <span class="info infoTiny" tabindex="0" aria-label="Info: ROI assumptions">
                    i
                    <span class="tip">Assumptions are documented in the main ROI step. Snapshot shows Immersive estimate outputs only.</span>
                  </span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>

              <div class="mini" id="roiSnapNote">Complete Step 4 to see the ROI estimate.</div>

              <div class="kpiGrid hide" id="roiSnapGrid" aria-label="ROI estimate snapshot">
                <div class="kpi">
                  <p class="k">3year ROI</p>
                  <p class="v" id="roiSnap"></p>
                </div>
                <div class="kpi">
                  <p class="k">3year NPV</p>
                  <p class="v" id="npvSnap"></p>
                </div>
                <div class="kpi">
                  <p class="k">Payback (est.)</p>
                  <p class="v" id="paybackSnap"></p>
                </div>
                <div class="kpi">
                  <p class="k">Indicative spend</p>
                  <p class="v" id="valueInputs"></p>
                </div>
              </div>
            </details>
          </section>

          <details class="collapse sideAnswersBlock" id="sideAnswersBlock" open>
            <summary>
              <span class="sectionTitle">YOUR ANSWERS</span>
              <span class="chev" aria-hidden="true"></span>
            </summary>
            <div class="sideAnswersBody">
          <section class="snapshotInputs" id="inputsCol" aria-label="Inputs summary">
            <details class="inputAccordion" id="inputAccAbout" data-input="about" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">About</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="inputSubhead">Organisation</div>
                <div class="kvRow"><span class="kvLabel">Role</span><span class="kvValue" id="snapOrgRole"></span></div>
                <div class="kvRow"><span class="kvLabel">Name</span><span class="kvValue" id="snapOrgName"></span></div>
                <div class="kvRow"><span class="kvLabel">Company</span><span class="kvValue" id="snapOrgCompany"></span></div>
                <div class="kvRow"><span class="kvLabel">Country</span><span class="kvValue" id="snapOrgCountry"></span></div>
                <div class="kvRow"><span class="kvLabel">Size</span><span class="kvValue" id="snapOrgSize"></span></div>
                <div class="inputSubhead">Outcome discovery</div>
                <div class="kvRow"><span class="kvLabel">Pressure</span><span class="kvValue" id="snapPressure"></span></div>
                <div class="kvRow"><span class="kvLabel">Urgent win</span><span class="kvValue" id="snapMilestone"></span></div>
                <div class="kvRow"><span class="kvLabel">Risk env</span><span class="kvValue" id="snapRiskEnv"></span></div>
                <div class="kvRow"><span class="kvLabel">Measured on</span><span class="kvValue" id="snapMeasuredOn"></span></div>
                <div class="kvRow"><span class="kvLabel">Org pain</span><span class="kvValue" id="snapOrgPain"></span></div>
                <div class="kvRow"><span class="kvLabel">Triggers</span><span class="kvValue" id="snapDrivers"></span></div>
                <div class="kvRow"><span class="kvLabel">Evidence</span><span class="kvValue" id="snapEvidence"></span></div>
                <div class="kvRow"><span class="kvLabel">Outcomes</span><span class="kvValue" id="snapOutcomes"></span></div>
              </div>
            </details>

            <details class="inputAccordion" id="inputAccCoverage" data-input="coverage" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">Coverage</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="kvRow"><span class="kvLabel">Groups</span><span class="kvValue" id="snapGroups"></span></div>
                <div class="kvRow"><span class="kvLabel">Cadence</span><span class="kvValue" id="snapCadence"></span></div>
                <div class="kvRow"><span class="kvLabel">Measurement</span><span class="kvValue" id="snapMeasurement"></span></div>
              </div>
            </details>

            <details class="inputAccordion" id="inputAccFit" data-input="fit" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">Package fit</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="kvRow"><span class="kvLabel">Realism</span><span class="kvValue" id="snapFitRealism"></span></div>
                <div class="kvRow"><span class="kvLabel">Scope</span><span class="kvValue" id="snapFitScope"></span></div>
                <div class="kvRow"><span class="kvLabel">State</span><span class="kvValue" id="snapFitToday"></span></div>
                <div class="kvRow"><span class="kvLabel">Delivery</span><span class="kvValue" id="snapFitServices"></span></div>
                <div class="kvRow"><span class="kvLabel">Frame</span><span class="kvValue" id="snapFitRisk"></span></div>
              </div>
            </details>

            <details class="inputAccordion" id="inputAccContext" data-input="context" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">Context</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="kvRow"><span class="kvLabel">Industry</span><span class="kvValue" id="snapIndustry"></span></div>
                <div class="kvRow"><span class="kvLabel">Region</span><span class="kvValue" id="snapRegion"></span></div>
                <div class="kvRow"><span class="kvLabel">Regulations</span><span class="kvValue" id="snapRegulatory"></span></div>
                <div class="kvRow"><span class="kvLabel">Tools</span><span class="kvValue" id="snapStack"></span></div>
                <div class="kvRow"><span class="kvLabel">GRC</span><span class="kvValue" id="snapGrc"></span></div>
              </div>
            </details>

            <details class="inputAccordion" id="inputAccRoi" data-input="roi" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">ROI estimate</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="kvRow"><span class="kvLabel">3-year ROI</span><span class="kvValue" id="snapRoiPct"></span></div>
                <div class="kvRow"><span class="kvLabel">3-year NPV</span><span class="kvValue" id="snapRoiNpv"></span></div>
                <div class="kvRow"><span class="kvLabel">Payback</span><span class="kvValue" id="snapRoiPayback"></span></div>
                <div class="kvRow"><span class="kvLabel">Spend</span><span class="kvValue" id="snapRoiSpend"></span></div>
              </div>
            </details>

            <details class="inputAccordion" id="inputAccReview" data-input="review" open>
              <summary>
                <span class="inputAccHead">
                  <span class="inputAccTitle">Review</span>
                </span>
                <span class="chev" aria-hidden="true"></span>
              </summary>
              <div class="inputAccBody">
                <div class="kvRow"><span class="kvLabel">Package</span><span class="kvValue" id="snapReviewPackage"></span></div>
                <div class="kvRow"><span class="kvLabel">Top outcomes</span><span class="kvValue" id="snapReviewOutcomes"></span></div>
                <div class="kvRow"><span class="kvLabel">Next meeting</span><span class="kvValue" id="snapReviewAgenda"></span></div>
              </div>
            </details>
          </section>
            </div>
          </details>
        </div>
      </aside>
    </div>

    <footer>
      <div class="wrap">
        Prototype for internal discussion. Replace booking action with your scheduling flow (e.g., calendar embed + CRM form submit).
      </div>
    </footer>
  </main>

  
  <!-- Print-only report (populated on demand) -->
  <section id="printReportRoot" class="printRoot" aria-hidden="true"></section>

<!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Booked">
      <h3>Booked (prototype)</h3>
      <p id="modalBody">In a production build, this button would route to your scheduling flow (calendar + CRM handoff) with the summary attached.</p>
      <div class="modalActions">
        <button class="btn" type="button" data-action="closeModal">Close</button>
      </div>
    </div>
  </div>
  <div class="modal" id="archiveModal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Archive records">
      <h3 id="archiveModalTitle">Archive selected records?</h3>
      <p id="archiveModalBody">Archived records are removed from the active list but can be restored later.</p>
      <div class="modalActions">
        <button class="btn" type="button" data-action="closeArchiveModal">Cancel</button>
        <button class="btn primary" type="button" data-action="confirmArchiveModal" id="archiveModalConfirm">Archive</button>
      </div>
    </div>
  </div>

  <div class="settings" id="settings" aria-hidden="true">
    <div class="settingsPanel" role="dialog" aria-label="My settings">
      <div class="settingsHead">
        <div>
          <h3 class="settingsTitle">My settings</h3>
          <p class="settingsSub">Theme, display &amp; test data</p>
        </div>
        <button class="btn small" id="closeSettings" type="button" aria-label="Close settings">Close</button>
      </div>
      <div class="settingsBody">
        <div class="settingsRow">
          <div class="settingsLabel">Theme</div>
          <div class="settingsOptions" id="toneOptions">
            <button class="settingsOption" type="button" data-tone="default" aria-pressed="true">Default</button>
            <button class="settingsOption" type="button" data-tone="soft" aria-pressed="false">Soft</button>
            <button class="settingsOption" type="button" data-tone="dark" aria-pressed="false">Onyx 1</button>
            <button class="settingsOption" type="button" data-tone="comfort" aria-pressed="false">Comfort</button>
          </div>
        </div>
        <div class="settingsRow">
          <div class="settingsLabel">Display</div>
          <div class="settingsOptions" id="densityOptions">
            <button class="settingsOption" type="button" data-density="comfortable" aria-pressed="true">Comfortable</button>
            <button class="settingsOption" type="button" data-density="compact" aria-pressed="false">Compact</button>
          </div>
        </div>
        <div class="settingsRow">
          <div class="settingsLabel">Font size scale</div>
          <div class="settingsOptions" id="fontScaleOptions">
            <button class="settingsOption" type="button" data-font-scale="0.9" aria-pressed="false">90%</button>
            <button class="settingsOption" type="button" data-font-scale="1" aria-pressed="true">100%</button>
            <button class="settingsOption" type="button" data-font-scale="1.1" aria-pressed="false">110%</button>
          </div>
        </div>
        <div class="settingsRow">
          <div class="settingsLabel">Test data</div>
          <div class="settingsOptions" id="dummyOptions">
            <button class="settingsOption" type="button" data-dummy="off" aria-pressed="true">Dummy account off</button>
            <button class="settingsOption" type="button" data-dummy="on" aria-pressed="false">Dummy account on</button>
          </div>
        </div>
        <div class="settingsReset">
          <button class="btn small" id="resetLayoutWidths" type="button">Reset layout widths</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      // ---------- utilities ----------
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
      const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

      function toast(msg){
        const el = $('#toast');
        if(!el) return;
        el.textContent = msg;
        el.classList.add('show');
        window.clearTimeout(el._t);
        el._t = window.setTimeout(()=> el.classList.remove('show'), 2600);
      }

      function setSelectionPill(selector, count, required){
        const el = $(selector);
        if(!el) return;
        const next = Number.isFinite(Number(count)) ? Math.max(0, Number(count)) : 0;
        const prev = Number(el.dataset.count || '0');
        const target = Number(required);
        const hasTarget = Number.isFinite(target) && target > 0;
        const wasComplete = el.dataset.complete === 'true';
        const isComplete = hasTarget ? next >= target : next > 0;
        el.textContent = hasTarget ? `${next} of ${target} selected` : `${next} selected`;
        el.dataset.complete = isComplete ? 'true' : 'false';
        if(!wasComplete && isComplete){
          el.classList.remove('is-bump');
          void el.offsetWidth;
          el.classList.add('is-bump');
        }else if(!isComplete){
          el.classList.remove('is-bump');
        }
        el.dataset.count = String(next);
      }

      function prefersReducedMotion(){
        return !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
      }

      function replayMotionClass(el, className, durationMs=320){
        if(!el || !className || prefersReducedMotion()) return;
        el.classList.remove(className);
        void el.offsetWidth;
        el.classList.add(className);
        window.clearTimeout(el._motionTimer);
        el._motionTimer = window.setTimeout(()=> el.classList.remove(className), durationMs);
      }

      let outcomeTopObserver = null;

      function isElementInViewport(el, visibilityThreshold = 0.3){
        if(!el) return false;
        const rect = el.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight || 0;
        if(vh <= 0) return false;
        const visiblePx = Math.min(rect.bottom, vh) - Math.max(rect.top, 0);
        const requiredPx = Math.min(rect.height, vh) * visibilityThreshold;
        return visiblePx >= Math.max(24, requiredPx);
      }

      function animatePercentValue(el, target, durationMs = 620){
        if(!el || !Number.isFinite(target)) return;
        const goal = Math.max(0, Math.round(target));
        const startTs = performance.now();
        const tick = (now)=>{
          const t = Math.min(1, (now - startTs) / durationMs);
          const eased = 1 - Math.pow(1 - t, 3);
          el.textContent = `${Math.round(goal * eased)}%`;
          if(t < 1) window.requestAnimationFrame(tick);
        };
        el.textContent = '0%';
        window.requestAnimationFrame(tick);
      }

      function animateOutcomeTopPercentages(container){
        if(!container || container.dataset.pctAnimated === 'true' || prefersReducedMotion()) return;
        const pcts = $$('.outcomeTopPct', container);
        if(!pcts.length) return;
        container.dataset.pctAnimated = 'true';
        pcts.forEach((el, idx)=>{
          const target = Number(el.dataset.targetPct || el.textContent.replace(/[^\d.-]/g, ''));
          if(!Number.isFinite(target)) return;
          window.setTimeout(()=> animatePercentValue(el, target), idx * 90);
        });
      }

      function ensureOutcomeTopObserver(container){
        if(!container || prefersReducedMotion()) return;
        if(!('IntersectionObserver' in window)){
          if(isElementInViewport(container, 0.28)) animateOutcomeTopPercentages(container);
          return;
        }
        if(!outcomeTopObserver){
          outcomeTopObserver = new IntersectionObserver((entries)=>{
            entries.forEach((entry)=>{
              if(entry.isIntersecting) animateOutcomeTopPercentages(entry.target);
            });
          }, { threshold: [0.25, 0.45] });
        }
        if(container.dataset.pctObserved !== 'true'){
          outcomeTopObserver.observe(container);
          container.dataset.pctObserved = 'true';
        }
      }

      function tweenMetricText(el, target, formatter, opts){
        if(!el || typeof formatter !== 'function') return;
        const cfg = Object.assign({ duration: 340, formatSig: '' }, opts || {});
        const fmtSig = String(cfg.formatSig || '');
        const fmtChanged = (el.dataset.metricFmtSig || '') !== fmtSig;
        el.dataset.metricFmtSig = fmtSig;

        if(!Number.isFinite(target)){
          if(el._metricRaf) window.cancelAnimationFrame(el._metricRaf);
          el._metricRaf = 0;
          el._metricNow = NaN;
          el.textContent = formatter(target);
          return;
        }

        if(prefersReducedMotion()){
          el.textContent = formatter(target);
          el._metricNow = target;
          return;
        }

        const from = (!fmtChanged && Number.isFinite(el._metricNow)) ? el._metricNow : target;
        if(!fmtChanged && Math.abs(from - target) < 0.01){
          el.textContent = formatter(target);
          el._metricNow = target;
          return;
        }

        if(el._metricRaf) window.cancelAnimationFrame(el._metricRaf);
        const start = performance.now();
        const duration = Math.max(140, Number(cfg.duration) || 340);
        const token = Number(el.dataset.metricTweenToken || '0') + 1;
        el.dataset.metricTweenToken = String(token);

        const step = (now)=>{
          if(Number(el.dataset.metricTweenToken || '0') !== token) return;
          const t = Math.min(1, (now - start) / duration);
          const eased = 1 - Math.pow(1 - t, 3);
          const value = from + ((target - from) * eased);
          el._metricNow = value;
          el.textContent = formatter(value);
          if(t < 1){
            el._metricRaf = window.requestAnimationFrame(step);
          }else{
            el._metricRaf = 0;
            el._metricNow = target;
            el.textContent = formatter(target);
          }
        };

        el._metricRaf = window.requestAnimationFrame(step);
      }

      function isSnapshotValueSelector(sel){
        return typeof sel === 'string' && /^#snap[A-Z]/.test(sel);
      }

      let snapshotMotionReady = false;

      // ---------- currency ----------
      const state = {
        // business
        fullName: '',
        company: '',
        companySize: '',
        operatingCountry: '',
        role: '',

        // mandate
        evidence: new Set(),
        drivers: [],                 // max 3 (no ranking)
        milestone: '',
        pressureSources: [],         // max 3
        urgentWin: '',
        riskEnvs: [],                // max 2
        measuredOn: '',
        orgPain: '',
        outcomeDrilldowns: {},

        // coverage
        groups: new Set(),
        rhythm: '',
        measure: '',

        // package fit
        fitRealism: '',
        fitScope: '',
        fitToday: '',
        fitServices: '',
        fitRiskFrame: '',

        // context
        industry: '',
        region: '',
        regs: new Set(),
        regsTouched: false,
        regMode: 'suggested',     // suggested | all
        regModeTouched: false,
        regSearch: '',

        // tech stack
        stack: new Set(),
        stackOther: '',

        // value preview state (stored in USD internally)
        currency: 'USD',
        fx: { USD: 1, GBP: 0.80, EUR: 0.90 },

        revenueB: 10,                // USD billions (internal)
        investUSD: 250000,           // annual USD spend (internal)
        investManual: false,

        teamCyber: 200,
        teamDev: 1000,
        teamWf: 3000,
        teamManual: false,

        realization: 'conservative', // conservative | expected | immersive
        paybackDelayMonths: 3,

        cyberSalaryUSD: 180000,
        devSalaryUSD: 160000,

        // lead capture
        email: '',
        phone: '',
        notes: '',
        optin: false,

        // nav
        currentView: 'dashboard',
        activeThread: 'current',
        activeStep: 1,
        visited: new Set([1]),
        dashboardSelectedIds: new Set(),
        archivedSelectedIds: new Set(),
        starPulseQueue: new Set(),
        navPreviewThreadId: null,

        // record persistence
        savedThreads: [],
        savedThreadsLoaded: false,
        savePulseUntil: 0,
        saveIsThinking: false,
        autoSaveDueAt: 0
      };
      const THREAD_STORAGE_KEY = 'immersive.launchpad.savedThreads.v1';
      const AUTO_SAVE_FAST_MS = 30000;
      const AUTO_SAVE_BASE_MS = 60000;
      let autoSaveTimerId = 0;
      let archivePromptMode = 'archive';
      let archivePromptIds = [];
      const DASHBOARD_COL_STORAGE_KEY = 'cfg_dashboard_col_widths_v1';
      const DASHBOARD_COLS = {
        company: { css:'--dash-col-company', min:12, max:34, fallback:17 },
        completion: { css:'--dash-col-completion', min:9, max:24, fallback:13 },
        tier: { css:'--dash-col-tier', min:8, max:18, fallback:10 },
        outcomes: { css:'--dash-col-outcomes', min:16, max:42, fallback:26 },
        gaps: { css:'--dash-col-gaps', min:12, max:34, fallback:15 },
        actions: { css:'--dash-col-actions', min:8, max:20, fallback:11 }
      };
      let dashboardColWidths = Object.create(null);

      function loadDashboardColWidths(){
        try{
          const raw = window.localStorage.getItem(DASHBOARD_COL_STORAGE_KEY);
          if(!raw) return {};
          const parsed = JSON.parse(raw);
          return (parsed && typeof parsed === 'object') ? parsed : {};
        }catch(err){
          return {};
        }
      }

      function persistDashboardColWidths(){
        try{
          window.localStorage.setItem(DASHBOARD_COL_STORAGE_KEY, JSON.stringify(dashboardColWidths || {}));
        }catch(err){
          // ignore storage failures
        }
      }

      function setDashboardColWidth(key, value, opts){
        const cfg = DASHBOARD_COLS[key];
        const table = $('#dashboardTable');
        if(!cfg || !table) return;
        const next = clamp(Number(value), cfg.min, cfg.max);
        const resolved = Number.isFinite(next) ? next : cfg.fallback;
        dashboardColWidths[key] = resolved;
        table.style.setProperty(cfg.css, `${resolved}%`);
        if(!opts || opts.persist !== false) persistDashboardColWidths();
      }

      function resetDashboardColumnWidths(opts){
        Object.keys(DASHBOARD_COLS).forEach((key)=>{
          setDashboardColWidth(key, DASHBOARD_COLS[key].fallback, { persist:false });
        });
        if(!opts || opts.persist !== false) persistDashboardColWidths();
      }

      function initDashboardColumnResizing(){
        const table = $('#dashboardTable');
        if(!table || table.dataset.colResizeReady === 'true') return;
        table.dataset.colResizeReady = 'true';

        const stored = loadDashboardColWidths();
        Object.keys(DASHBOARD_COLS).forEach((key)=>{
          const hasStored = Object.prototype.hasOwnProperty.call(stored, key);
          setDashboardColWidth(key, hasStored ? stored[key] : DASHBOARD_COLS[key].fallback, { persist:false });
        });

        let drag = null;
        const clearDragState = ()=>{
          if(drag && drag.th) drag.th.classList.remove('is-col-resizing');
          document.body.classList.remove('is-dash-col-resizing');
        };
        const onMove = (ev)=>{
          if(!drag) return;
          const deltaPct = ((ev.clientX - drag.startX) / drag.baseWidth) * 100;
          setDashboardColWidth(drag.key, drag.startWidth + deltaPct, { persist:false });
        };
        const onUp = ()=>{
          if(!drag) return;
          clearDragState();
          drag = null;
          persistDashboardColWidths();
          window.removeEventListener('pointermove', onMove);
          window.removeEventListener('pointerup', onUp);
          window.removeEventListener('pointercancel', onUp);
        };

        $$('[data-dash-col-resize]', table).forEach((handle)=>{
          handle.addEventListener('dblclick', (ev)=>{
            const key = handle.getAttribute('data-dash-col-resize') || '';
            const cfg = DASHBOARD_COLS[key];
            if(!cfg) return;
            ev.preventDefault();
            setDashboardColWidth(key, cfg.fallback);
          });

          handle.addEventListener('pointerdown', (ev)=>{
            if(ev.button !== 0) return;
            const key = handle.getAttribute('data-dash-col-resize') || '';
            const cfg = DASHBOARD_COLS[key];
            if(!cfg) return;
            const th = handle.closest('th');
            drag = {
              key,
              startX: ev.clientX,
              startWidth: Number(dashboardColWidths[key]) || cfg.fallback,
              baseWidth: Math.max(1, table.getBoundingClientRect().width),
              th
            };
            document.body.classList.add('is-dash-col-resizing');
            if(th) th.classList.add('is-col-resizing');
            if(handle.setPointerCapture) handle.setPointerCapture(ev.pointerId);
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp);
            window.addEventListener('pointercancel', onUp);
            ev.preventDefault();
          });
        });
      }

      function fxRate(){
        const v = Number(state.fx[state.currency]);
        return (Number.isFinite(v) && v > 0) ? v : 1;
      }
      function toCur(usd){ return (Number(usd)||0) * fxRate(); }
      function fromCur(cur){ return (Number(cur)||0) / fxRate(); }

      function fmtMoneyUSD(usd){
        const curVal = toCur(usd);
        try{
          return curVal.toLocaleString(undefined, { style:'currency', currency: state.currency, maximumFractionDigits:0 });
        }catch(e){
          // fallback
          const sym = state.currency === 'GBP' ? '' : state.currency === 'EUR' ? '' : '$';
          return sym + Math.round(curVal).toLocaleString();
        }
      }

      function currencyPrefix(){
        if(state.currency === 'GBP') return '';
        if(state.currency === 'EUR') return '';
        if(state.currency === 'USD') return 'US$';
        return state.currency + ' ';
      }

      function roundToSigFigures(n, sig){
        const num = Number(n);
        if(!Number.isFinite(num) || num === 0) return 0;
        const s = Math.max(1, Number(sig) || 3);
        const power = Math.floor(Math.log10(Math.abs(num)));
        const factor = Math.pow(10, s - power - 1);
        return Math.round(num * factor) / factor;
      }

      function fmtMoneyCompactUSD(usd, opts){
        const cfg = Object.assign({ signed:false, sig:3 }, opts || {});
        const curVal = toCur(usd);
        if(!Number.isFinite(curVal)) return '';

        const abs = Math.abs(curVal);
        const sign = curVal < 0 ? '-' : ((cfg.signed && curVal > 0) ? '+' : '');
        const prefix = currencyPrefix();

        if(abs < 1000){
          const whole = Math.round(abs);
          return `${sign}${prefix}${whole.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        const units = [
          { value: 1e9, suffix: 'b' },
          { value: 1e6, suffix: 'm' },
          { value: 1e3, suffix: 'k' }
        ];

        let unit = units.find(u => abs >= u.value) || units[units.length - 1];
        let scaled = abs / unit.value;
        let rounded = roundToSigFigures(scaled, cfg.sig);

        if(rounded >= 1000){
          const idx = units.indexOf(unit);
          if(idx > 0){
            unit = units[idx - 1];
            scaled = abs / unit.value;
            rounded = roundToSigFigures(scaled, cfg.sig);
          }
        }

        const decimals = rounded >= 100 ? 0 : (rounded >= 10 ? 1 : 2);
        const numTxt = rounded.toFixed(decimals).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
        return `${sign}${prefix}${numTxt}${unit.suffix}`;
      }

      function fmtRevenueFromUSDB(usdB){
        const curB = (Number(usdB)||0) * fxRate();
        const sym = (state.currency === 'GBP') ? '' : (state.currency === 'EUR') ? '' : '$';
        if(curB < 1){
          const m = Math.max(0, Math.round(curB * 1000));
          return `${sym}${m}M`;
        }
        if(curB >= 100) return `${sym}${Math.round(curB)}B`;
        const show1 = curB < 10 && (Math.round(curB*10)/10 !== Math.round(curB));
        return `${sym}${curB.toFixed(show1 ? 1 : 0).replace(/\.0$/,'')}B`;
      }

      function fmtNum(n){
        return (Number(n)||0).toLocaleString(undefined, { maximumFractionDigits:0 });
      }

      // ---------- options ----------
            const roleOpts = [
        { id:'ciso', label:'CISO' },
        { id:'secMgr', label:'Security Manager' },
        { id:'practitioner', label:'Practitioner' },
        { id:'executive', label:'Executive' },
        { id:'other', label:'Other' }
      ];

      const accountRoleOpts = [
        { id:'vp_sales', label:'VP Sales' },
        { id:'vp_customer_success', label:'VP, Customer Success' },
        { id:'director_regional_sales', label:'Director, Regional Sales' },
        { id:'senior_manager_customer_success', label:'Senior Manager, Customer Success' },
        { id:'senior_enterprise_account_manager', label:'Senior Enterprise Account Manager' },
        { id:'lead_customer_success_manager', label:'Lead Customer Success Manager' },
        { id:'enterprise_account_manager', label:'Enterprise Account Manager' },
        { id:'customer_success_manager', label:'Customer Success Manager' },
        { id:'senior_sales_development_representative', label:'Senior Sales Development Representative' },
        { id:'sales_development_representative', label:'Sales Development Representative' },
        { id:'senior_cyber_resilience_advisor', label:'Senior Cyber Resilience Advisor' },
        { id:'cyber_resilience_advisor', label:'Cyber Resilience Advisor' },
        { id:'associate_enterprise_account_manager', label:'Associate Enterprise Account Manager' },
        { id:'associate_customer_success_manager', label:'Associate Customer Success Manager' },
        { id:'associate_sales_development_representative', label:'Associate Sales Development Representative' },
        { id:'associate_cyber_resilience_advisor', label:'Associate Cyber Resilience Advisor' }
      ];
      const accountRoleLegacyMap = Object.freeze({
        cyber_resilience_advisor_senior_to_associate: 'cyber_resilience_advisor'
      });

const evidenceOpts = [
        { id:'board', label:'Board reporting' },
        { id:'reg', label:'Regulators / auditors' },
        { id:'insurer', label:'Insurers' },
        { id:'customer', label:'Customer due diligence' },
        { id:'internal', label:'Internal investment case' }
      ];

      const pressureOpts = [
        { id:'board', title:'Board', desc:'Board-level pressure for defensible readiness and decisions.' },
        { id:'regulator', title:'Regulator', desc:'Regulatory or audit expectations are driving urgency.' },
        { id:'insurer', title:'Insurer', desc:'Insurance evidence requirements are shaping priorities.' },
        { id:'customers', title:'Customers', desc:'Customer assurance and due diligence are forcing pace.' },
        { id:'internal', title:'Internal only', desc:'Pressure is internal, not yet externally driven.' }
      ];

      const urgentWinOpts = [
        { id:'boardEvidence', title:'Board-ready evidence & benchmarks', desc:'Translate readiness into board-defensible proof and clear benchmark position.' },
        { id:'fasterDecisions', title:'Faster detection/response decisions', desc:'Improve MTTD/MTTR and crisis decision quality under pressure.' },
        { id:'attackSurface', title:'Shrink attack surface & remediation time', desc:'Cut exploitable risk in code, cloud, identity, and network faster.' },
        { id:'safeAI', title:'Safe AI adoption & governance', desc:'Adopt AI with tested controls, clear guardrails, and accountable governance.' },
        { id:'workforce', title:'Workforce readiness & retention', desc:'Increase role readiness, accelerate onboarding, and retain key talent.' },
        { id:'thirdParty', title:'Third-party resilience', desc:'Improve supplier resilience and vendor incident containment confidence.' }
      ];

      const riskEnvOpts = [
        { id:'code', title:'Code', desc:'Application and SDLC risk is driving urgency.' },
        { id:'cloud', title:'Cloud', desc:'Cloud exposure and misconfiguration are core concerns.' },
        { id:'identity', title:'Identity', desc:'Credential abuse and IAM weaknesses are driving risk.' },
        { id:'ot', title:'OT', desc:'Operational technology / ICS risk needs coverage.' },
        { id:'enterpriseApps', title:'Enterprise apps', desc:'Business-critical app estate is increasing risk.' },
        { id:'socir', title:'Mostly SOC / IR', desc:'The pressure is mainly in detection, response, and coordination.' }
      ];

      const measuredOnOpts = [
        { id:'mttd', title:'MTTD / MTTR', desc:'Speed to detect, escalate, and contain is tracked.' },
        { id:'audit', title:'Audit evidence', desc:'Readiness proof and governance evidence are key measures.' },
        { id:'vuln', title:'Vulnerability backlog', desc:'Backlog, fix velocity, and closure cadence are central metrics.' },
        { id:'training', title:'Training completion', desc:'Readiness is mostly tracked as completion today.' },
        { id:'notMeasured', title:'Not measured well', desc:'Metrics are fragmented or not trusted by stakeholders.' }
      ];

      const orgPainOpts = [
        { id:'skillsCoverage', title:'Skills coverage & onboarding', desc:'Readiness gaps and onboarding speed are hurting execution.' },
        { id:'coordination', title:'Cross-team coordination', desc:'Decision and response handoffs break down under pressure.' },
        { id:'externalProof', title:'Proving to external stakeholders', desc:'Board/regulator/insurer/customer evidence is hard to package.' },
        { id:'vendorRisk', title:'Vendor risk', desc:'Third-party dependency and resilience are primary pain points.' },
        { id:'aiRisk', title:'AI risk', desc:'AI adoption risk exists without clear controls and governance.' }
      ];

      const driverOpts = [
        {
          id:'nearMiss',
          title:'After an incident / near miss',
          desc:'You want to test and harden decision-making and response.',
          maps:'Typically relates to: Faster Decisions + Secure Enterprise'
        },
        {
          id:'sectorPeer',
          title:'Sector peer incident / competitor hit',
          desc:'A peer was hit and it could have been you  you want to harden readiness before it happens.',
          maps:'Typically relates to: Faster Decisions + Supply Chain'
        },
        {
          id:'skills',
          title:'Skills gap / capability build',
          desc:'You need measurable improvement across teams.',
          maps:'Typically relates to: Cyber Workforce + Secure Enterprise'
        },
        {
          id:'insurance',
          title:'Insurance renewal',
          desc:'You need proof and a credible plan for underwriters.',
          maps:'Typically relates to: Compliance Evidence + Supply Chain'
        },
        {
          id:'change',
          title:'New tech adoption / transformation',
          desc:'Cloud, app modernization, or tooling change is increasing risk.',
          maps:'Typically relates to: Secure Enterprise + Secure AI'
        }
      ];

      const milestoneOpts = [
        { id:'baseline', title:'Baseline + visibility', desc:'Establish a defensible starting point and identify priority gaps.' },
        { id:'operational', title:'Operational improvement rhythm', desc:'Create a cadence to improve response performance over time.' },
        { id:'evidence', title:'Evidence + governance', desc:'Build stakeholder-grade evidence and repeatable reporting.' },
        { id:'explore', title:'Exploring', desc:'You want a direction, a roadmap, and examples.' }
      ];

      const groupOpts = [
        { id:'soc', label:'SOC / Incident Response' },
        { id:'appsec', label:'AppSec / Developers' },
        { id:'cloud', label:'Cloud security' },
        { id:'itops', label:'IT ops / infrastructure' },
        { id:'identity', label:'Identity & access (IAM)' },
        { id:'grc', label:'GRC / compliance' },
        { id:'data', label:'Data / privacy' },
        { id:'product', label:'Product / platform security' },
        { id:'exec', label:'Executive Crisis Team (CMT)' },
        { id:'workforce', label:'Wider workforce' },
        { id:'third', label:'Third-party / supplier readiness' }
      ];

      const rhythmOpts = [
        { id:'adhoc', title:'Ad hoc', desc:'Infrequent / event-driven exercises.' },
        { id:'quarterly', title:'Quarterly', desc:'Some structure, limited cadence.' },
        { id:'monthly', title:'Monthly', desc:'Higher cadence, increasing realism.' },
        { id:'program', title:'Programmatic', desc:'Continuous rhythm + governance + reporting.' }
      ];

      const measureOpts = [
        { id:'completion', title:'Completion-centric', desc:'Primarily tracking training completion.' },
        { id:'performance', title:'Performance-centric', desc:'Measuring outcomes under pressure (speed, accuracy, decisions).' }
      ];

      const primaryOutcomeOpts = [
        {
          id:'fasterResponse',
          label:'Prove Faster Detection, Response & Decision-Making',
          short:'Faster detection, response & decision-making',
          oneLiner:'Cut MTTD/MTTR and make better business decisions under pressure.',
          why:'Breach impact is time plus decision quality. Board scrutiny is highest here.',
          desc:'Cut MTTD/MTTR and make better business decisions under pressure.',
          kpis:'MTTD, MTTR, time-to-escalate, decision latency, playbook execution quality'
        },
        {
          id:'secureEnterprise',
          label:'Secure the Next-Gen Modern Enterprise',
          short:'Secure the next-gen modern enterprise',
          oneLiner:'Shrink attack surface and cut remediation time across code, cloud, identity, and network.',
          why:'Fewer exploitable issues means fewer incidents. Remediation speed is board-visible.',
          desc:'Shrink attack surface and cut remediation time across code, cloud, identity, and network.',
          kpis:'Critical vulnerability MTTR, misconfiguration closure time, exploitability trend'
        },
        {
          id:'secureAI',
          label:'Enable Secure AI Adoption, Innovation & Governance',
          short:'Enable secure AI adoption and governance',
          oneLiner:'Adopt AI and build it safely with trained people, tested controls, and governed operations.',
          why:'AI is a board agenda item. Risk and innovation must be balanced with proof.',
          desc:'Adopt AI and build it safely with trained people, tested controls, and governed operations.',
          kpis:'AI incident playbook readiness, AI control test pass rate, AI governance adherence'
        },
        {
          id:'complianceEvidence',
          label:'Transform Compliance into Evidence & Benchmarks',
          short:'Compliance translated into evidence & benchmarks',
          oneLiner:'Move from checkbox compliance to evidence-based capability mapped to NIST, MITRE, and DORA.',
          why:'Boards and regulators require auditable proof mapped to recognized frameworks.',
          desc:'Move from checkbox compliance to evidence-based capability mapped to NIST, MITRE, and DORA.',
          kpis:'Framework control coverage, resilience score deltas, peer benchmark percentile'
        },
        {
          id:'cyberWorkforce',
          label:'Build & Retain a Verifiable Cyber-Ready Workforce',
          short:'Build and retain a cyber-ready workforce',
          oneLiner:'Accelerate onboarding, upskill continuously, and retain talent with visible progression.',
          why:'Talent shortage persists; readiness must be measurable across the organization.',
          desc:'Accelerate onboarding, upskill continuously, and retain talent with visible progression.',
          kpis:'Role readiness scores, proficiency coverage, retention and progression trend'
        },
        {
          id:'supplyChain',
          label:'Enhance Supply Chain and Third-Party Cyber Resilience',
          short:'Strengthen supply-chain and third-party resilience',
          oneLiner:'Elevate supply-chain resilience with third-party simulations and benchmarking.',
          why:'Vendor breaches are systemic risk and regulators increasingly ask for proof.',
          desc:'Elevate supply-chain resilience with third-party simulations and benchmarking.',
          kpis:'Time to detect vendor-origin incidents, containment success rate, supplier segment resilience'
        }
      ];

      const outcomeDrilldownBank = {
        fasterResponse: {
          prompt:'Whats missing most today?',
          options: [
            { id:'speed', title:'Speed (MTTD/MTTR)', desc:'Detection and containment speed is the biggest gap.' },
            { id:'coordination', title:'Cross-team coordination', desc:'Handoffs and decisions slow down response quality.' },
            { id:'boardReporting', title:'Board-ready reporting', desc:'Performance data is hard to translate for leadership.' }
          ]
        },
        secureEnterprise: {
          prompt:'Where is the backlog?',
          options: [
            { id:'cloudIdentity', title:'Cloud misconfig & identity', desc:'Cloud and IAM hygiene are the primary risk drivers.' },
            { id:'appsec', title:'AppSec / SDLC', desc:'Code and release pipeline exposure are creating delay and risk.' },
            { id:'ot', title:'OT exposure / segmentation', desc:'OT visibility and segmentation need stronger resilience.' }
          ]
        },
        secureAI: {
          prompt:'Whats the AI reality?',
          options: [
            { id:'prod', title:'Already deploying AI in production', desc:'Controls need to catch up with active deployment.' },
            { id:'pilot', title:'Piloting / exploring', desc:'Early AI use cases exist and guardrails are emerging.' },
            { id:'guardrails', title:'Need governance and guardrails first', desc:'Policy and risk frameworks must be set before scale.' }
          ]
        },
        complianceEvidence: {
          prompt:'What kind of proof is required?',
          options: [
            { id:'audit', title:'Internal audit readiness', desc:'Audit evidence quality is a near-term requirement.' },
            { id:'regInsurer', title:'Regulator / insurer defensible evidence', desc:'External validation drives urgency.' },
            { id:'benchmark', title:'Peer benchmarks / board narrative', desc:'Leadership needs comparison and narrative clarity.' }
          ]
        },
        cyberWorkforce: {
          prompt:'Whats the workforce pain?',
          options: [
            { id:'onboarding', title:'Onboarding speed', desc:'Time-to-readiness for new hires is too slow.' },
            { id:'visibility', title:'Skills visibility / analytics', desc:'Current capability data is incomplete or stale.' },
            { id:'retention', title:'Retention / progression', desc:'Retaining and growing key talent is the bottleneck.' }
          ]
        },
        supplyChain: {
          prompt:'Whats driving third-party focus?',
          options: [
            { id:'incidents', title:'Vendor incidents', desc:'Recent events or near-misses raised urgency.' },
            { id:'regs', title:'New regulations / contractual obligations', desc:'External obligations now demand stronger proof.' },
            { id:'critical', title:'Critical suppliers / OT ecosystem', desc:'Supplier dependency and OT exposure require resilience testing.' }
          ]
        }
      };

      // Package fit questions (mirrors master configurator fit signals)
      const fitRealismOpts = [
        { id:'generic', title:'Best-practice / generic scenarios are fine', desc:'Value quickly without mirroring the exact environment.', scores:{ core:4, adv:2, ult:0 } },
        { id:'tooling', title:'Needs to reflect our tooling and processes', desc:'Bring your own tooling and dynamic realism matters.', scores:{ core:1, adv:5, ult:2 } },
        { id:'bespoke', title:'Must mirror our environment and threat landscape', desc:'They will not trust results unless it matches their reality.', scores:{ core:0, adv:2, ult:6 } }
      ];

      const fitScopeOpts = [
        { id:'single', title:'Single team / single function', desc:'Contained rollout focused on one benefitting group.', scores:{ core:4, adv:2, ult:0 } },
        { id:'multi', title:'Multiple teams within a function', desc:'Needs coordination across squads or sub-teams.', scores:{ core:1, adv:5, ult:2 } },
        { id:'enterprise', title:'Enterprise / multi-region / exec plus technical', desc:'Coverage expands across functions, regions, and leaders.', scores:{ core:0, adv:3, ult:5 } }
      ];

      const fitTodayOpts = [
        { id:'training', title:'Mainly training completion today', desc:'They lack proof of capability and want to escape checkbox learning.', scores:{ core:5, adv:1, ult:0 } },
        { id:'adhoc', title:'Exercises exist, but they are ad hoc and do not close gaps', desc:'They want a loop that drives improvement.', scores:{ core:1, adv:5, ult:1 } },
        { id:'scrutiny', title:'Already under scrutiny (audits, board, regulators)', desc:'They need a repeatable evidence layer.', scores:{ core:0, adv:2, ult:6 } }
      ];

      const fitServicesOpts = [
        { id:'diy', title:'Self-serve / light enablement', desc:'They can run most of it internally with minimal support.', scores:{ core:4, adv:2, ult:0 } },
        { id:'guided', title:'Guided program support', desc:'Help building cadence and linking outcomes to improvement.', scores:{ core:1, adv:5, ult:2 } },
        { id:'whiteglove', title:'Dedicated program team + evidence packaging + bespoke realism', desc:'Managed partnership for custom realism, facilitation, and evidence delivery.', scores:{ core:0, adv:2, ult:6 } }
      ];

      const fitRiskFrameOpts = [
        { id:'skills', title:'We need stronger skills', desc:'They frame the issue as practitioner proficiency.', scores:{ core:4, adv:2, ult:0 } },
        { id:'readiness', title:'We need better response outcomes and coordination', desc:'They care about speed, accuracy, and teamwork under pressure.', scores:{ core:1, adv:5, ult:2 } },
        { id:'governance', title:'We need proof for governance', desc:'They talk in board and regulatory evidence terms.', scores:{ core:0, adv:2, ult:6 } }
      ];

      const fitSnapLabels = {
        fitRealism: { generic:'Generic', tooling:'Tooling-aware', bespoke:'Mirror environment' },
        fitScope: { single:'Single team', multi:'Multi-team', enterprise:'Enterprise' },
        fitToday: { training:'Training completion', adhoc:'Ad hoc exercises', scrutiny:'Under scrutiny' },
        fitServices: { diy:'Self-serve', guided:'Guided support', whiteglove:'Managed partnership' },
        fitRiskFrame: { skills:'Skills', readiness:'Readiness outcomes', governance:'Governance proof' }
      };

      // ---------------- Regulations library (enriched) ----------------
      // Note: This is a usability-oriented library for tailoring onboarding language.
      // It is not legal advice and not an exhaustive compliance checklist.
      const regMaster = [
        /* Global standards & frameworks */
        { id:'iso27001', label:'ISO/IEC 27001' },
        { id:'iso27002', label:'ISO/IEC 27002' },
        { id:'iso27005', label:'ISO/IEC 27005 (risk)' },
        { id:'iso27017', label:'ISO/IEC 27017 (cloud security)' },
        { id:'iso27018', label:'ISO/IEC 27018 (cloud privacy)' },
        { id:'iso27035', label:'ISO/IEC 27035 (incident management)' },
        { id:'iso27701', label:'ISO/IEC 27701 (privacy)' },
        { id:'iso22301', label:'ISO 22301 (business continuity)' },
        { id:'iso31000', label:'ISO 31000 (risk management)' },
        { id:'iso42001', label:'ISO/IEC 42001 (AI management)' },

        { id:'nistscf', label:'NIST CSF' },
        { id:'nist80053', label:'NIST SP 800-53' },
        { id:'nist800171', label:'NIST SP 800-171' },
        { id:'nist80061', label:'NIST SP 800-61 (incident response)' },
        { id:'nist800218', label:'NIST SP 800-218 (SSDF)' },
        { id:'nist800207', label:'NIST SP 800-207 (Zero Trust)' },
        { id:'nist800161', label:'NIST SP 800-161 (supply chain)' },
        { id:'nistairmf', label:'NIST AI RMF' },

        { id:'ciscontrols', label:'CIS Controls v8' },
        { id:'cobit', label:'COBIT (governance)' },

        { id:'soc2', label:'SOC 2' },
        { id:'soc1', label:'SOC 1 / ISAE 3402' },
        { id:'pcidss', label:'PCI DSS' },
        { id:'csastar', label:'CSA STAR' },

        { id:'mitreattack', label:'MITRE ATT&CK (mapping)' },
        { id:'owasptop10', label:'OWASP Top 10 (mapping)' },

        /* EU + UK (cyber, privacy, resilience) */
        { id:'dora', label:'DORA' },
        { id:'nis2', label:'NIS2' },
        { id:'gdpr', label:'GDPR' },
        { id:'cer', label:'EU CER Directive (Critical Entities Resilience)' },
        { id:'euaiact', label:'EU AI Act' },
        { id:'ebaict', label:'EBA ICT & security risk guidelines' },

        { id:'ukgdpr', label:'UK GDPR / Data Protection Act 2018' },
        { id:'uknis', label:'UK NIS Regulations' },
        { id:'ukfca', label:'UK FCA/PRA Operational Resilience' },
        { id:'cyberessentials', label:'UK Cyber Essentials' },
        { id:'caf', label:'NCSC CAF (Cyber Assessment Framework)' },
        { id:'cafEnhanced', label:'NCSC CAF Enhanced' },
        { id:'ofcom', label:'Ofcom security & resilience requirements (UK telecoms)' },
        { id:'ofgem', label:'Ofgem cyber & operational resilience requirements (UK energy)' },

        /* North America (US + Canada) */
        { id:'sec', label:'SEC cybersecurity disclosure (US)' },
        { id:'nydfs', label:'NYDFS 23 NYCRR 500' },
        { id:'sox', label:'SOX (SarbanesOxley)' },

        { id:'hipaa', label:'HIPAA (US)' },
        { id:'hitech', label:'HITECH (US)' },
        { id:'glba', label:'GLBA (US)' },
        { id:'ftcsafeguards', label:'FTC Safeguards Rule (US)' },
        { id:'ccpa', label:'CCPA/CPRA (California)' },
        { id:'ferpa', label:'FERPA (US education)' },

        { id:'fedramp', label:'FedRAMP (US)' },
        { id:'fisma', label:'FISMA (US)' },
        { id:'cmmc', label:'CMMC (US DoD contractors)' },
        { id:'dfars7012', label:'DFARS 252.2047012 (US DoD)' },
        { id:'cjiss', label:'CJIS Security Policy (US)' },

        { id:'pipeda', label:'PIPEDA (Canada)' },
        { id:'osfiB13', label:'OSFI B13 (Canada)' },

        /* APAC */
        { id:'apra234', label:'APRA CPS 234 (Australia)' },
        { id:'sociact', label:'SOCI Act (Australia)' },
        { id:'essential8', label:'ASD Essential Eight (Australia)' },
        { id:'privacyau', label:'Privacy Act 1988 (Australia)' },

        { id:'mastrm', label:'MAS TRM (Singapore)' },
        { id:'pdpasg', label:'PDPA (Singapore)' },

        { id:'hkmaCraf', label:'HKMA CRAF (Hong Kong)' },
        { id:'japanFisc', label:'FISC Security Guidelines (Japan)' },
        { id:'nzism', label:'NZISM (New Zealand)' },

        { id:'indiaDpdp', label:'DPDP Act (India)' },
        { id:'certin', label:'CERTIn Directions (India)' },

        { id:'pipl', label:'PIPL (China)' },

        /* LATAM + Africa (privacy) */
        { id:'lgpd', label:'LGPD (Brazil)' },
        { id:'popia', label:'POPIA (South Africa)' },

        /* Sector / critical infrastructure / OT */
        { id:'swiftcscf', label:'SWIFT CSCF' },
        { id:'ffiec', label:'FFIEC (US) cyber guidance' },
        { id:'hitrust', label:'HITRUST CSF' },

        { id:'iec62443', label:'IEC 62443 (OT/IACS)' },
        { id:'nercCip', label:'NERC CIP (North America)' },

        /* Automotive / product security */
        { id:'tisax', label:'TISAX (automotive)' },
        { id:'iso21434', label:'ISO/SAE 21434 (vehicle cybersecurity)' },
        { id:'uneceR155', label:'UNECE R155 (vehicle cybersecurity)' },
        { id:'uneceR156', label:'UNECE R156 (software updates)' }
      ];

      const frameworkRegIds = new Set([
        'iso27001','iso27002','iso27005','iso27017','iso27018','iso27035','iso27701','iso22301','iso31000','iso42001',
        'nistscf','nist80053','nist800171','nist80061','nist800218','nist800207','nist800161','nistairmf',
        'ciscontrols','cobit','mitreattack','owasptop10','caf','cafEnhanced','essential8','ffiec'
      ]);
      const assuranceRegIds = new Set([
        'soc2','soc1','pcidss','csastar','cyberessentials','hitrust','fedramp','tisax','swiftcscf'
      ]);

      function regulationType(id){
        if(frameworkRegIds.has(id)) return 'Framework';
        if(assuranceRegIds.has(id)) return 'Assurance';
        return 'Regulation';
      }

      const commonProofSetIds = [
        'nistscf',
        'iso27001',
        'mitreattack',
        'dora',
        'sec',
        'soc2'
      ];

      const regByIndustry = {
        "Financial Services": ['dora','ebaict','gdpr','nistscf','ciscontrols','iso27001','soc2','pcidss','sec','nydfs','glba','sox','swiftcscf','ffiec'],
        "Banking": ['dora','ebaict','gdpr','nistscf','ciscontrols','iso27001','soc2','pcidss','sec','nydfs','glba','sox','swiftcscf','ffiec'],
        "Insurance": ['dora','ebaict','gdpr','nistscf','ciscontrols','iso27001','soc2','sec','nydfs','glba','sox','swiftcscf'],
        "Payments / FinTech": ['pcidss','soc2','iso27001','nistscf','ciscontrols','sec','nydfs','gdpr','ccpa'],
        "Healthcare / Life Sciences": ['hipaa','hitech','hitrust','gdpr','iso27701','iso27001','nistscf','ciscontrols'],
        "Retail / eCommerce": ['pcidss','soc2','iso27001','nistscf','ciscontrols','gdpr','ccpa'],
        "Technology / SaaS": ['soc2','iso27001','nistscf','ciscontrols','sec','gdpr','ccpa','nist800218','owasptop10'],
        "Telecommunications": ['nis2','uknis','gdpr','iso27001','nistscf','ciscontrols','caf','cafEnhanced','ofcom'],
        "Government / Public Sector": ['nist80053','fisma','fedramp','iso27001','nistscf','ciscontrols'],
        "Defense / Aerospace": ['cmmc','dfars7012','nist800171','iso27001','nistscf','ciscontrols'],
        "Energy / Utilities": ['nercCip','iec62443','nis2','gdpr','iso27001','nistscf','ciscontrols','caf','cafEnhanced','ofgem'],
        "Manufacturing / Industrial": ['iec62443','tisax','iso21434','uneceR155','uneceR156','iso27001','nistscf','ciscontrols'],
        "Transportation / Logistics": ['nis2','cer','gdpr','iso27001','nistscf','ciscontrols'],
        "Education": ['ferpa','gdpr','ccpa','iso27001','nistscf','ciscontrols'],
        "Managed Services (MSP/MSSP)": ['soc2','iso27001','nistscf','ciscontrols','gdpr','dora'],
        "Professional Services": ['soc2','iso27001','nistscf','ciscontrols','gdpr','dora'],
        "Other": [] // "Other" defaults to the full library via view mode
      };

      // Region-aware *suggestions* (not hard gating).
      // We avoid auto-suggesting blatantly out-of-region items (e.g., HIPAA for EU),
      // but users can still choose anything from the full library if they operate globally.
      const regByRegion = {
        NA:   ['nistscf','ciscontrols','iso27001','soc2','soc1','pcidss','gdpr','sec','nydfs','sox','hipaa','hitech','glba','ftcsafeguards','ccpa','fedramp','fisma','cmmc','dfars7012','cjiss','pipeda','osfiB13','nercCip','iec62443'],
        UKI:  ['iso27001','nistscf','ciscontrols','soc2','pcidss','ukgdpr','uknis','ukfca','cyberessentials','gdpr','dora','caf','cafEnhanced','ofcom','ofgem','iec62443'],
        EU:   ['iso27001','nistscf','ciscontrols','soc2','pcidss','dora','nis2','gdpr','cer','euaiact','ebaict','iec62443','tisax','iso21434','uneceR155','uneceR156'],
        APAC: ['iso27001','nistscf','ciscontrols','soc2','pcidss','gdpr','apra234','sociact','essential8','privacyau','mastrm','pdpasg','hkmaCraf','japanFisc','nzism','indiaDpdp','certin','pipl','iec62443'],
        Other: [] // Other / Global shows the full library
      };

      // Region-level "core" suggestions used to avoid sector leakage when both
      // industry and region are provided (e.g., automotive rules in EU finance).
      const regByRegionCore = {
        NA:   ['iso27001','nistscf','ciscontrols','soc2','soc1','pcidss','ccpa','pipeda'],
        UKI:  ['iso27001','nistscf','ciscontrols','soc2','pcidss','ukgdpr','gdpr','cyberessentials'],
        EU:   ['iso27001','nistscf','ciscontrols','soc2','pcidss','gdpr','nis2'],
        APAC: ['iso27001','nistscf','ciscontrols','soc2','pcidss'],
        Other: []
      };

      const uniq = (arr)=> Array.from(new Set((arr||[]).filter(Boolean)));

      function regSuggestedIds(industry, region){
        const base = ['iso27001','nistscf','ciscontrols'];

        const ind = industry ? (regByIndustry[industry] || []) : [];
        const reg = region ? (regByRegion[region] || []) : [];
        const regCore = region ? (regByRegionCore[region] || []) : [];

        let out = [...base];

        if(industry && region){
          // Bias suggestions toward true overlap between sector and region.
          // Region "core" keeps a small compliance baseline.
          const inter = ind.filter(id => reg.includes(id));
          out = uniq([...base, ...inter, ...regCore]);
        }else if(industry){
          out = uniq([...base, ...ind]);
        }else if(region){
          out = uniq([...base, ...regCore]);
        }

        // Extra nudge for common patterns
        if(industry && industry.includes('Technology')) out = uniq([...out, 'nist800218']);
        if(industry && industry.includes('Financial')) out = uniq([...out, 'swiftcscf']);
        if(industry && industry.includes('Healthcare')) out = uniq([...out, 'iso27701']);

        // Region-aware filtering: keep suggested relevant to the chosen footprint
        if(region && region !== 'Other'){
          const allow = new Set(uniq([...base, ...(regByRegion[region] || [])]));
          out = out.filter(id => allow.has(id));
        }

        return out;
      }

      function regOptionsForUI(){
        const search = (state.regSearch || '').trim().toLowerCase();

        const forceAll = (state.industry === 'Other' || state.region === 'Other');
        const allMode = forceAll || state.regMode === 'all';

        // Base ids: suggested (rich) OR full library (AZ)
        let ids = [];
        if(allMode){
          ids = regMaster.map(r => r.id);
        }else{
          const suggested = regSuggestedIds(state.industry, state.region);
          // Keep suggested list rich, but avoid turning the step into a wall of pills.
          // (Users can switch to All for the full library.)
          const MAX_SUGGESTED = 22;
          ids = suggested.slice(0, MAX_SUGGESTED);
        }

        // Always keep selected visible
        const selected = Array.from(state.regs || []);
        ids = uniq([...ids, ...selected]);

        let items = ids
          .map(id => regMaster.find(r => r.id === id))
          .filter(Boolean);

        if(search){
          items = items.filter(it => {
            // Keep selected regs visible even while searching
            if(state.regs && state.regs.has(it.id)) return true;
            const hay = (it.label || '').toLowerCase();
            const hayId = (it.id || '').toLowerCase();
            return hay.includes(search) || hayId.includes(search);
          });
        }

        if(allMode){
          items.sort((a,b)=> (a.label||'').localeCompare(b.label||''));
        }

        return items.map(it => Object.assign({}, it, { typeTag: regulationType(it.id) }));
      }

      function syncContextRegSignals(){
        const ctxChanged = !!(state._industryChanged || state._regionChanged);
        if(!ctxChanged) return;

        state._industryChanged = false;
        state._regionChanged = false;

        // "Other / Global" should default to the full library (unless the user explicitly chose a mode)
        if(!state.regModeTouched){
          state.regMode = (state.industry === 'Other' || state.region === 'Other') ? 'all' : 'suggested';
        }

        // Keep auto-suggesting until the user edits the regulation set
        if(!state.regsTouched || state.regs.size === 0){
          state.regs.clear();
          regSuggestedIds(state.industry, state.region).forEach(id => state.regs.add(id));
        }
      }

      function syncRegModeUI(){
        const forceAll = (state.industry === 'Other' || state.region === 'Other');
        const mode = forceAll ? 'all' : state.regMode;
        const regionLabels = { NA:'North America', UKI:'UK & Ireland', EU:'Europe (EU)', APAC:'APAC', Other:'Other / Global' };

        // Segmented control state
        const seg = $('#regMode');
        if(seg){
          seg.querySelectorAll('.segBtn').forEach(btn=>{
            const m = btn.dataset.mode;
            const active = (m === mode);
            btn.dataset.active = active ? 'true' : 'false';
            btn.setAttribute('aria-selected', active ? 'true' : 'false');
          });
        }

        // Hint copy (tiny nudge)
        const hint = $('#regModeHint');
        if(hint){
          if(forceAll){
            hint.textContent = 'Other / Global shows the full library. Use search to find specific regs (nothing is auto-selected).';
          }else{
            hint.textContent = 'Suggested list is tailored by industry and region. All shows the full library AZ. Tags show Regulation / Framework / Assurance.';
          }
        }

        const suggestedFor = $('#regSuggestedFor');
        if(suggestedFor){
          const bits = [];
          if(state.industry) bits.push(state.industry);
          if(state.region) bits.push(regionLabels[state.region] || state.region);
          suggestedFor.textContent = bits.length
            ? `Suggested for: ${bits.join('  ')}`
            : 'Suggested for: your selected context';
        }
      }

      function applyCommonProofSet(){
        const available = new Set(regMaster.map(r => r.id));
        commonProofSetIds.forEach(id=>{
          if(available.has(id)) state.regs.add(id);
        });
        state.regsTouched = true;
      }

      // Tech stack pick-list (expanded but still digestible)
      const stackSocOpts = [
        { id:'crowdstrike', label:'CrowdStrike Falcon' },
        { id:'falconxdr', label:'Falcon Insight XDR' },
        { id:'falconsiem', label:'Falcon NextGen SIEM' },
        { id:'sentinelone', label:'SentinelOne Singularity' },
        { id:'defender', label:'Microsoft Defender' },
        { id:'sentinel', label:'Microsoft Sentinel' },
        { id:'splunk', label:'Splunk' },
        { id:'qradar', label:'IBM QRadar' },
        { id:'elastic', label:'Elastic' },
        { id:'sumologic', label:'Sumo Logic' },
        { id:'exabeam', label:'Exabeam' },
        { id:'logrhythm', label:'LogRhythm' },
        { id:'rapid7', label:'Rapid7 InsightIDR' },
        { id:'cortexxdr', label:'Palo Alto Cortex XDR' },
        { id:'cortexxsoar', label:'Palo Alto Cortex XSOAR' },
        { id:'googlesecops', label:'Google Security Operations' }
      ];

      const stackCloudOpts = [
        { id:'aws', label:'Amazon Web Services (AWS)' },
        { id:'azure', label:'Microsoft Azure' },
        { id:'gcp', label:'Google Cloud Platform (GCP)' },
        { id:'awsGuardduty', label:'AWS GuardDuty / Security Hub' },
        { id:'azureDefenderCloud', label:'Defender for Cloud (Azure)' },
        { id:'gcpScc', label:'Security Command Center (GCP)' }
      ];

      const stackDevopsOpts = [
        { id:'kubernetes', label:'Kubernetes' },
        { id:'docker', label:'Docker' },
        { id:'terraform', label:'Terraform' },
        { id:'github', label:'GitHub' },
        { id:'gitlab', label:'GitLab' },
        { id:'azuredevops', label:'Azure DevOps' },
        { id:'jenkins', label:'Jenkins' },
        { id:'nginx', label:'NGINX' },
        { id:'vault', label:'Vault' }
      ];

      const stackDomainOpts = [
        { id:'appsec', label:'Application Security / OWASP' },
        { id:'identity', label:'Identity & access (Okta / Entra ID)' },
        { id:'grc', label:'GRC / risk (ServiceNow / Archer)' },
        { id:'vuln', label:'Vulnerability mgmt (Tenable / Qualys)' },
        { id:'email', label:'Email security (Proofpoint / MDO)' },
        { id:'network', label:'Network security (Palo Alto / Fortinet)' },
        { id:'ot', label:'OT/ICS' },
        { id:'ai', label:'AI security' },
        { id:'threat', label:'Threat intel & malware' },
        { id:'range', label:'Cyber range & workforce drills' }
      ];

      const stackMaster = [
        ...stackSocOpts,
        ...stackCloudOpts,
        ...stackDevopsOpts,
        ...stackDomainOpts
      ];

      // ---------- DOM render ----------
      function renderOptionButtons(container, items, setRef, onChange){
        if(!container) return;
        container.innerHTML = '';
        items.forEach(it=>{
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt';
          if(it.typeTag){
            b.classList.add('optReg');
            b.innerHTML = `<span>${escapeHtml(it.label)}</span><span class="regType">${escapeHtml(it.typeTag)}</span>`;
          }else{
            b.textContent = it.label;
          }
          b.setAttribute('data-id', it.id);
          b.setAttribute('aria-pressed', setRef.has(it.id) ? 'true' : 'false');
          b.addEventListener('click', ()=>{
            const id = it.id;
            if(setRef.has(id)){ setRef.delete(id); b.setAttribute('aria-pressed','false'); }
            else { setRef.add(id); b.setAttribute('aria-pressed','true'); }
            if(typeof onChange === 'function') onChange(id, setRef);
            update();
          });
          container.appendChild(b);
        });
      }



      function renderSingleOptionButtons(container, items, key){
        if(!container) return;
        container.innerHTML = '';
        items.forEach(it=>{
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt';
          b.textContent = it.label;
          b.setAttribute('data-id', it.id);
          b.setAttribute('aria-pressed', (state[key] === it.id) ? 'true' : 'false');
          b.addEventListener('click', ()=>{
            state[key] = (state[key] === it.id) ? '' : it.id;
            // sync pressed state within this container only
            container.querySelectorAll('.opt').forEach(btn=>{
              btn.setAttribute('aria-pressed', (btn.getAttribute('data-id') === state[key]) ? 'true' : 'false');
            });
            update();
          });
          container.appendChild(b);
        });
      }

      function renderRadios(container, name, items, onPick){
        if(!container) return;
        container.innerHTML = '';
        const drillKey = (name && name.indexOf('drill_') === 0) ? name.replace('drill_','') : '';
        const currentValue = drillKey ? (state.outcomeDrilldowns[drillKey] || '') : (state[name] || '');
        items.forEach(it=>{
          const row = document.createElement('label');
          row.className = 'radio';
          row.innerHTML = `
            <input type="radio" name="${name}" value="${it.id}">
            <div><strong>${escapeHtml(it.title)}</strong><span>${escapeHtml(it.desc)}</span></div>
          `;
          const input = row.querySelector('input');
          input.checked = (currentValue === it.id);
          input.addEventListener('change', (e)=>{
            if(e.target.checked){ onPick(it.id); update(); }
          });
          container.appendChild(row);
        });
      }

      function renderLimitedChecks(container, listKey, metaSelector, items, limit, onPick){
        if(!container) return;
        container.innerHTML = '';
        const current = Array.isArray(state[listKey]) ? state[listKey] : [];
        items.forEach(it=>{
          const row = document.createElement('label');
          row.className = 'radio';
          row.innerHTML = `
            <input type="checkbox" value="${it.id}">
            <div><strong>${escapeHtml(it.title)}</strong><span>${escapeHtml(it.desc)}</span></div>
          `;
          const cb = row.querySelector('input');
          cb.checked = current.includes(it.id);
          cb.addEventListener('change', ()=>{
            const selected = Array.isArray(state[listKey]) ? state[listKey] : [];
            let next = selected.slice();
            if(cb.checked){
              if(selected.length >= limit){
                cb.checked = false;
                toast(`Select up to ${limit}.`);
                return;
              }
              next.push(it.id);
            }else{
              next = next.filter(x => x !== it.id);
            }
            state[listKey] = next.filter((v, i, arr)=> arr.indexOf(v) === i);
            if(typeof onPick === 'function') onPick(state[listKey]);
            setSelectionPill(metaSelector, state[listKey].length, limit);
            update();
          });
          container.appendChild(row);
        });
      }

      function renderDriverCards(){
        const container = $('#driverCards');
        if(!container) return;
        container.innerHTML = '';
        driverOpts.forEach(it=>{
          const row = document.createElement('label');
          row.className = 'radio';
          row.innerHTML = `
            <input type="checkbox" value="${it.id}">
            <div>
              <strong>${escapeHtml(it.title)}</strong>
              <span>${escapeHtml(it.desc)}</span>
              <span class="mapHint">${escapeHtml(it.maps || '')}</span>
            </div>
          `;
          const cb = row.querySelector('input');
          cb.checked = state.drivers.includes(it.id);

          cb.addEventListener('change', ()=>{
            if(cb.checked){
              if(state.drivers.length >= 3){
                cb.checked = false;
                toast('Select up to 3 drivers.');
                return;
              }
              state.drivers.push(it.id);
              state.drivers = Array.from(new Set(state.drivers));
            }else{
              state.drivers = state.drivers.filter(d => d !== it.id);
            }
            update();
          });

          container.appendChild(row);
        });
      }

      function renderOutcomeCards(topOutcomes){
        const container = $('#outcomeCards');
        if(!container) return;
        const rank = {};
        (topOutcomes || []).forEach((o, i)=>{ rank[o.id] = i + 1; });
        const topIds = new Set((topOutcomes || []).map(o => o.id));
        const ordered = [
          ...(topOutcomes || []).map(o => outcomeById(o.id) || o),
          ...primaryOutcomeOpts.filter(o => !topIds.has(o.id))
        ];
        container.innerHTML = '';
        ordered.forEach(o=>{
          const card = document.createElement('article');
          card.className = 'outcomeCard';
          card.dataset.top = rank[o.id] ? 'true' : 'false';
          card.innerHTML = `
            <h4>${rank[o.id] ? `<span class="outcomeBadge">${rank[o.id]}</span>` : ''}<span class="outcomeTitle">${escapeHtml(o.label)}</span></h4>
            <div class="oneLiner">${escapeHtml(o.oneLiner || o.desc)}</div>
            ${o.why ? `<div class="whyTitle">Why CISOs care</div><p class="whyBody">${escapeHtml(o.why)}</p>` : ''}
          `;
          container.appendChild(card);
        });
      }

      function renderOutcomeDrilldowns(topOutcomes){
        const container = $('#outcomeDrilldowns');
        if(!container) return;
        const keepIds = new Set((topOutcomes || []).map(o => o.id));
        Object.keys(state.outcomeDrilldowns || {}).forEach(id=>{
          if(!keepIds.has(id)) delete state.outcomeDrilldowns[id];
        });

        container.innerHTML = '';
        (topOutcomes || []).forEach(outcome=>{
          const bank = outcomeDrilldownBank[outcome.id];
          if(!bank || !bank.options || !bank.options.length) return;

          const card = document.createElement('div');
          card.className = 'drillCard';
          const qName = `drill_${outcome.id}`;
          card.innerHTML = `
            <p class="drillTitle">${escapeHtml(outcome.label)}</p>
            <p class="drillQ">${escapeHtml(bank.prompt)}</p>
            <div class="radioGrid twoCol" id="${qName}"></div>
          `;
          container.appendChild(card);

          const target = card.querySelector(`#${qName}`);
          if(!target) return;
          renderRadios(target, `drill_${outcome.id}`, bank.options, (id)=>{
            state.outcomeDrilldowns[outcome.id] = id;
          });
        });
      }

      // ---------- navigation ----------
      function setView(view, opts){
        const cfg = Object.assign({ render: true }, opts || {});
        const next = (view === 'dashboard' || view === 'archived' || view === 'interstitial' || view === 'account') ? view : 'configurator';
        state.currentView = next;
        document.body.classList.toggle('is-configurator-view', next === 'configurator');
        document.body.classList.toggle('is-dashboard-view', next === 'dashboard');
        document.body.classList.toggle('is-archived-view', next === 'archived');
        document.body.classList.toggle('is-interstitial-view', next === 'interstitial');
        document.body.classList.toggle('is-account-view', next === 'account');
        if(next === 'dashboard' || next === 'archived' || next === 'account'){
          state.navPreviewThreadId = null;
        }
        if(next !== 'configurator'){
          clearScheduledAutoSave();
        }else{
          requestAutoSave(AUTO_SAVE_BASE_MS);
        }

        const workspaceDash = $('#workspaceDashboard');
        const workspaceArchive = $('#workspaceArchive');
        const workspaceAccount = $('#workspaceAccount');
        if(workspaceDash){
          workspaceDash.dataset.active = (next === 'dashboard') ? 'true' : 'false';
        }
        if(workspaceArchive){
          workspaceArchive.dataset.active = (next === 'archived') ? 'true' : 'false';
        }
        if(workspaceAccount){
          workspaceAccount.dataset.active = (next === 'account') ? 'true' : 'false';
        }
        const recordContextName = $('#recordContextName');
        if(recordContextName){
          const thread = activeThreadModel();
          const editingCompany = String(state.company || '').trim();
          recordContextName.textContent = editingCompany || ((thread && thread.company) ? thread.company : 'Record');
        }

        if(cfg.render) update();
      }

      function syncGlobalActionBar(){
        const bar = $('#globalActionBar');
        if(!bar) return;
        const context = $('#globalActionContext');
        const createBtn = $('#globalCreateRecord');
        const editBtn = $('#globalEditConfigurator');
        const bookBtn = $('#globalBookConsultation');
        const view = state.currentView || 'configurator';
        const thread = activeThreadModel();
        const company = String(state.company || '').trim() || (thread && thread.company) || 'Untitled company';

        if(context){
          if(view === 'dashboard'){
            context.textContent = 'Dashboard';
            context.title = 'Active configurator threads with completion, tier recommendation, key outcomes, and remaining gaps.';
          }
          else if(view === 'archived'){
            context.textContent = 'Archived Accounts';
            context.removeAttribute('title');
          }
          else if(view === 'interstitial') context.textContent = `${company} overview actions`;
          else if(view === 'configurator') context.textContent = `${company} configurator`;
          else if(view === 'account') context.textContent = 'My account';
          else context.textContent = '';
          if(view !== 'dashboard') context.removeAttribute('title');
        }

        const setActionBtnVisible = (el, visible)=>{
          if(!el) return;
          const on = !!visible;
          el.hidden = !on;
          el.style.display = on ? '' : 'none';
        };
        setActionBtnVisible(createBtn, view === 'dashboard');
        setActionBtnVisible(editBtn, view === 'interstitial');
        setActionBtnVisible(bookBtn, view === 'interstitial');

        bar.hidden = (view === 'account');
      }

      function setActiveStep(n){
        const nn = clamp(Number(n)||1, 1, 6);
        setView('configurator', { render:false });
        state.activeStep = nn;
        state.visited.add(nn);

        $$('.step').forEach(s => s.dataset.active = (s.dataset.step === String(nn)) ? 'true' : 'false');
        $$('.chip').forEach(c => c.dataset.active = (c.dataset.chip === String(nn)) ? 'true' : 'false');

        window.scrollTo({ top: 0, behavior: 'smooth' });
        update();
      }

      function optionLabel(list, id){
        if(!id) return '';
        const it = (list || []).find((x)=> x.id === id);
        if(!it) return String(id);
        return String(it.label || it.title || id);
      }

      function listOrDash(values){
        const arr = (values || []).map((v)=> String(v || '').trim()).filter(Boolean);
        return arr.length ? arr.join('  ') : '';
      }

      function dashLabelsFromIds(ids, list){
        return Array.from(ids || [])
          .map((id)=> optionLabel(list, id))
          .filter((v)=> v && v !== '');
      }

      function dashboardFirstGapStep(thread){
        const gapStep = Number(thread && thread.gaps && thread.gaps[0] && thread.gaps[0].step);
        if(Number.isFinite(gapStep)) return clamp(gapStep, 1, 6);
        const snapStep = Number(thread && thread.snapshot && thread.snapshot.activeStep);
        if(Number.isFinite(snapStep)) return clamp(snapStep, 1, 6);
        return 1;
      }

      function incompleteStepsFromState(){
        const steps = Array.from(new Set(
          dashboardCurrentGaps()
            .map((gap)=> clamp(Number(gap && gap.step) || 1, 1, 6))
        )).sort((a,b)=> a - b);
        return steps;
      }

      function nextIncompleteStepFrom(currentStep){
        const steps = incompleteStepsFromState();
        if(!steps.length) return null;
        const cur = clamp(Number(currentStep) || 1, 1, 6);
        return steps.find((step)=> step > cur) || steps[0];
      }

      function jumpToNextIncomplete(){
        const nextStep = nextIncompleteStepFrom(state.activeStep);
        if(nextStep === null){
          toast('All sections are complete.');
          return;
        }
        setActiveStep(nextStep);
        requestAutoSave(AUTO_SAVE_FAST_MS);
      }

      function clearAutoSaveTimer(){
        if(!autoSaveTimerId) return;
        window.clearTimeout(autoSaveTimerId);
        autoSaveTimerId = 0;
      }

      function clearScheduledAutoSave(){
        clearAutoSaveTimer();
        state.autoSaveDueAt = 0;
      }

      function armAutoSaveTimer(){
        if(state.currentView !== 'configurator'){
          clearScheduledAutoSave();
          return;
        }
        const dueAt = Number(state.autoSaveDueAt) || 0;
        if(!dueAt) return;
        clearAutoSaveTimer();
        const waitMs = Math.max(140, dueAt - Date.now());
        autoSaveTimerId = window.setTimeout(()=>{
          autoSaveTimerId = 0;
          if(state.currentView !== 'configurator'){
            state.autoSaveDueAt = 0;
            return;
          }
          if(Date.now() < (Number(state.autoSaveDueAt) || 0)){
            armAutoSaveTimer();
            return;
          }
          state.autoSaveDueAt = 0;
          const didSave = saveActiveRecord({ quiet:true, auto:true, thinkMs:420 });
          if(didSave === false){
            requestAutoSave(10000);
          }
        }, waitMs);
      }

      function requestAutoSave(delayMs){
        if(state.currentView !== 'configurator') return;
        const ms = Math.max(1000, Number(delayMs) || AUTO_SAVE_BASE_MS);
        const nextDue = Date.now() + ms;
        const currentDue = Number(state.autoSaveDueAt) || 0;
        if(!currentDue || nextDue < currentDue){
          state.autoSaveDueAt = nextDue;
          armAutoSaveTimer();
          return;
        }
        if(!autoSaveTimerId) armAutoSaveTimer();
      }

      function dashboardStage(){
        if(state.activeStep >= 6) return 'Review';
        if(state.activeStep >= 5) return 'ROI estimate';
        if(state.activeStep >= 4) return 'Context';
        if(state.activeStep >= 3) return 'Package fit';
        if(state.activeStep >= 2) return 'Coverage';
        return 'About';
      }

      function dashboardCompletionSummary(){
        const checks = [
          !!state.role,
          !!state.fullName,
          !!state.company,
          !!state.companySize,
          !!state.operatingCountry,
          !!state.industry,
          !!state.region,
          (state.pressureSources || []).length > 0,
          !!state.urgentWin,
          (state.riskEnvs || []).length > 0,
          !!state.measuredOn,
          !!state.orgPain,
          (state.groups && state.groups.size > 0),
          !!state.rhythm,
          !!state.measure,
          !!state.fitRealism,
          !!state.fitScope,
          !!state.fitToday,
          !!state.fitServices,
          !!state.fitRiskFrame,
          state.visited.has(5)
        ];
        const done = checks.filter(Boolean).length;
        const total = checks.length;
        const pct = Math.round((done / total) * 100);
        return `${done}/${total} (${pct}%)`;
      }

      function dashboardTierName(){
        const rec = score();
        if(rec.best === 'adv') return 'Advanced';
        if(rec.best === 'ult') return 'Ultimate';
        return 'Core';
      }

      function dashboardCurrentGaps(){
        const gaps = [];
        const pushGap = (when, title, why, step)=>{
          if(when){
            gaps.push({ title, why, step: Number(step) || 1 });
          }
        };

        pushGap(!state.role, 'Role not confirmed', 'Role anchors ownership for outcomes and follow-up.', 1);
        pushGap(!state.company, 'Company not captured', 'Company context is needed before sharing a recommendation.', 1);
        pushGap(!state.companySize, 'Company size missing', 'Size influences cadence and recommendation confidence.', 1);
        pushGap(!state.operatingCountry, 'Operating country missing', 'Country informs the likely regulatory evidence path.', 1);
        pushGap(!state.industry, 'Industry not selected', 'Industry context changes suggested standards and language.', 1);
        pushGap(!state.region, 'Region not selected', 'Region influences evidence and audit expectations.', 1);
        pushGap(!(state.pressureSources || []).length, 'Pressure sources not selected', 'Pressure signals help prioritize the right outcomes.', 1);
        pushGap(!state.urgentWin, 'Urgent 90-day win not set', 'Urgency clarifies what success must look like first.', 1);
        pushGap(!state.measuredOn, 'Current measurement baseline missing', 'Baseline metrics are required to quantify uplift.', 1);
        pushGap(!state.orgPain, 'Current organisation challenge unclear', 'Current challenge shapes where value shows up fastest.', 1);

        pushGap(!state.groups.size, 'Coverage groups not selected', 'Coverage determines program scope and rollout design.', 2);
        pushGap(!state.rhythm, 'Cadence not selected', 'Cadence impacts operating model and package fit.', 2);
        pushGap(!state.measure, 'Measurement model not selected', 'Measurement model drives reporting and evidence quality.', 2);

        pushGap(!state.fitRealism, 'Realism requirement unanswered', 'Realism changes effort and content structure.', 3);
        pushGap(!state.fitScope, 'Scope requirement unanswered', 'Scope alters expected delivery footprint.', 3);
        pushGap(!state.fitToday, 'Current state unanswered', 'Current state helps calibrate the starting package.', 3);
        pushGap(!state.fitServices, 'Delivery support unanswered', 'Support model affects implementation recommendations.', 3);
        pushGap(!state.fitRiskFrame, 'Risk frame unanswered', 'Risk framing helps position the narrative for stakeholders.', 3);

        pushGap(!state.visited.has(4), 'Context step not reviewed', 'Review context to confirm region-driven suggestions and relevance.', 4);

        pushGap(!state.visited.has(5), 'ROI estimate not reviewed', 'ROI inputs are needed for investment and timing decisions.', 5);
        return gaps;
      }

      function currentThreadModel(){
        const regionLabels = { NA:'North America', UKI:'UK & Ireland', EU:'Europe (EU)', APAC:'APAC', Other:'Other / Global' };
        const sizeMap = {
          lt500:'< 500 employees',
          '500-2k':'5002,000 employees',
          '2k-10k':'2,00010,000 employees',
          '10k-50k':'10,00050,000 employees',
          '50kplus':'50,000+ employees'
        };

        const outcomes = inferredPrimaryOutcomes(3).map((o)=> o.short || o.label).filter(Boolean);
        const gaps = dashboardCurrentGaps();
        const gapSummary = gaps.length ? gaps.slice(0, 2).map((g)=> g.title).join('  ') : 'No open gaps';
        const stackLabels = dashLabelsFromIds(state.stack, stackMaster);
        if(String(state.stackOther || '').trim()) stackLabels.push(String(state.stackOther).trim());

        return {
          id: 'current',
          company: (state.company && String(state.company).trim()) ? state.company.trim() : 'Untitled company',
          stage: dashboardStage(),
          completion: dashboardCompletionSummary(),
          tier: dashboardTierName(),
          outcomes,
          outcomesText: outcomes.length ? outcomes.join('  ') : 'Awaiting outcome signals',
          gapSummary,
          gaps,
          modules: {
            organisation: [
              { label:'Name', value: state.fullName || '' },
              { label:'Company', value: (state.company && String(state.company).trim()) ? state.company.trim() : 'Untitled company' },
              { label:'Role', value: optionLabel(roleOpts, state.role) },
              { label:'Company size', value: state.companySize ? (sizeMap[state.companySize] || state.companySize) : '' },
              { label:'Operating country', value: state.operatingCountry || '' }
            ],
            discovery: [
              { label:'Pressure sources', value: listOrDash(dashLabelsFromIds(state.pressureSources, pressureOpts.map((p)=> ({ id:p.id, label:p.title })))) },
              { label:'Urgent win', value: optionLabel(urgentWinOpts, state.urgentWin) },
              { label:'Risk environment', value: listOrDash(dashLabelsFromIds(state.riskEnvs, riskEnvOpts.map((r)=> ({ id:r.id, label:r.title })))) },
              { label:'Measured on today', value: optionLabel(measuredOnOpts, state.measuredOn) },
              { label:'Organisation challenge', value: optionLabel(orgPainOpts, state.orgPain) },
              { label:'Conversation triggers', value: listOrDash(dashLabelsFromIds(state.drivers, driverOpts.map((d)=> ({ id:d.id, label:d.title })))) },
              { label:'Evidence audience', value: listOrDash(dashLabelsFromIds(state.evidence, evidenceOpts)) },
              { label:'Primary outcomes', value: outcomes.length ? outcomes.join('  ') : '' }
            ],
            coverage: [
              { label:'Coverage groups', value: listOrDash(dashLabelsFromIds(state.groups, groupOpts)) },
              { label:'Cadence', value: optionLabel(rhythmOpts, state.rhythm) },
              { label:'Measurement', value: optionLabel(measureOpts, state.measure) }
            ],
            packageFit: [
              { label:'Realism', value: optionLabel(fitRealismOpts, state.fitRealism) },
              { label:'Scope', value: optionLabel(fitScopeOpts, state.fitScope) },
              { label:'Current state', value: optionLabel(fitTodayOpts, state.fitToday) },
              { label:'Delivery model', value: optionLabel(fitServicesOpts, state.fitServices) },
              { label:'Risk frame', value: optionLabel(fitRiskFrameOpts, state.fitRiskFrame) }
            ],
            context: [
              { label:'Industry', value: state.industry || '' },
              { label:'Region', value: state.region ? (regionLabels[state.region] || state.region) : '' },
              { label:'Regulatory references', value: listOrDash(dashLabelsFromIds(state.regs, regMaster)) },
              { label:'Tools / stack', value: listOrDash(stackLabels) }
            ]
          }
        };
      }

      function staticThreadModels(){
        return [
          {
            id: 'northbridge',
            company: 'Northbridge Bank',
            stage: 'Validation',
            completion: '14/22 (64%)',
            tier: 'Core',
            priority: true,
            outcomes: ['Regulator readiness evidence', 'Board confidence'],
            outcomesText: 'Regulator readiness evidence  Board confidence',
            gapSummary: 'Evidence audience not confirmed  Delivery model unanswered',
            gaps: [
              { title:'Evidence audience not confirmed', why:'Audience determines the proof format and sign-off path.', step:1 },
              { title:'Delivery model unanswered', why:'Delivery model changes implementation effort and pace.', step:3 },
              { title:'Regulatory context incomplete', why:'Regulation context impacts evidence depth and urgency.', step:4 }
            ],
            modules: {
              organisation: [
                { label:'Name', value:'Will Bloor' },
                { label:'Company', value:'Northbridge Bank' },
                { label:'Role', value:'CISO' },
                { label:'Company size', value:'2,00010,000 employees' },
                { label:'Operating country', value:'United Kingdom' }
              ],
              discovery: [
                { label:'Pressure sources', value:'Board  Regulator  Insurer' },
                { label:'Urgent win', value:'Executive evidence pack before quarter close' },
                { label:'Risk environment', value:'Cloud workloads  Identity' },
                { label:'Measured on today', value:'Audit and control findings' },
                { label:'Organisation challenge', value:'Proof for external stakeholders is fragmented' },
                { label:'Conversation triggers', value:'Near miss  Insurance renewal' },
                { label:'Evidence audience', value:'Board  Regulator' },
                { label:'Primary outcomes', value:'Regulator readiness evidence  Board confidence' }
              ],
              coverage: [
                { label:'Coverage groups', value:'SOC  Executive leadership  GRC' },
                { label:'Cadence', value:'Quarterly' },
                { label:'Measurement', value:'Outcome metrics + trend' }
              ],
              packageFit: [
                { label:'Realism', value:'High realism required for sign-off confidence' },
                { label:'Scope', value:'Cross-functional, multi-team scope' },
                { label:'Current state', value:'Ad hoc exercising, inconsistent closure loop' },
                { label:'Delivery model', value:'TBC' },
                { label:'Risk frame', value:'Governance and evidence confidence' }
              ],
              context: [
                { label:'Industry', value:'Financial Services' },
                { label:'Region', value:'UK & Ireland' },
                { label:'Regulatory references', value:'NIST CSF  ISO 27001  SOC 2' },
                { label:'Tools / stack', value:'Sentinel  ServiceNow GRC  Microsoft Defender' }
              ]
            }
            ,
            viz: {
              roiPct: 168,
              npv: 2450000,
              spend: 820000,
              paybackMonths: 13,
              outcomeBreakdown: [
                { label:'Regulator readiness evidence', pct: 54 },
                { label:'Board confidence', pct: 31 },
                { label:'Evidence-led follow-up planning', pct: 15 }
              ]
            }
          },
          {
            id: 'aster',
            company: 'Aster Mobility',
            stage: 'Discovery',
            completion: '18/22 (82%)',
            tier: 'Advanced',
            priority: true,
            outcomes: ['Evidence-led follow-up planning', 'Coverage roadmap'],
            outcomesText: 'Evidence-led follow-up planning  Coverage roadmap',
            gapSummary: 'Cadence baseline still needed',
            gaps: [
              { title:'Cadence baseline still needed', why:'Cadence determines review rhythm and value realization timing.', step:2 }
            ],
            modules: {
              organisation: [
                { label:'Name', value:'Will Bloor' },
                { label:'Company', value:'Aster Mobility' },
                { label:'Role', value:'Security program lead' },
                { label:'Company size', value:'10,00050,000 employees' },
                { label:'Operating country', value:'United States' }
              ],
              discovery: [
                { label:'Pressure sources', value:'Board  Customer assurance' },
                { label:'Urgent win', value:'Quarterly readiness narrative' },
                { label:'Risk environment', value:'Cloud workloads  Third-party risk' },
                { label:'Measured on today', value:'Mixed metrics' },
                { label:'Organisation challenge', value:'Inconsistent closure and follow-through' },
                { label:'Conversation triggers', value:'Growth + regional expansion' },
                { label:'Evidence audience', value:'Board  Customers' },
                { label:'Primary outcomes', value:'Evidence-led follow-up planning  Coverage roadmap' }
              ],
              coverage: [
                { label:'Coverage groups', value:'SOC  Cloud  Third-party' },
                { label:'Cadence', value:'Not confirmed' },
                { label:'Measurement', value:'Completion and follow-up trend' }
              ],
              packageFit: [
                { label:'Realism', value:'Scenario realism required for exec confidence' },
                { label:'Scope', value:'Multi-team pilot scope' },
                { label:'Current state', value:'Exercises in place, no standard operating loop' },
                { label:'Delivery model', value:'Guided rollout support requested' },
                { label:'Risk frame', value:'Readiness outcomes' }
              ],
              context: [
                { label:'Industry', value:'Transport / Mobility' },
                { label:'Region', value:'North America' },
                { label:'Regulatory references', value:'NIST CSF  ISO 27001' },
                { label:'Tools / stack', value:'CrowdStrike  AWS  Jira Service Management' }
              ]
            }
            ,
	            viz: {
	              roiPct: 214,
	              npv: 3180000,
	              spend: 1040000,
	              paybackMonths: 11,
	              outcomeBreakdown: [
	                { label:'Evidence-led follow-up planning', pct: 42 },
	                { label:'Coverage roadmap', pct: 33 },
	                { label:'Regulator readiness evidence', pct: 25 }
	              ]
	            }
	          },
	          {
	            id: 'pioneer',
	            company: 'Pioneer Cloud',
	            stage: 'Closed',
	            completion: '22/22 (100%)',
	            tier: 'Ultimate',
	            outcomes: ['Regulator readiness evidence', 'Operational decision quality'],
	            outcomesText: 'Regulator readiness evidence  Operational decision quality',
	            gapSummary: 'No open gaps',
	            gaps: [],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Pioneer Cloud' },
	                { label:'Role', value:'CISO' },
	                { label:'Company size', value:'10,00050,000 employees' },
	                { label:'Operating country', value:'United States' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Board  Regulator  Customers' },
	                { label:'Primary outcomes', value:'Regulator readiness evidence  Operational decision quality' }
	              ],
	              coverage: [
	                { label:'Coverage groups', value:'SOC  Cloud security  Executive Crisis Team (CMT)' },
	                { label:'Cadence', value:'Programmatic' }
	              ],
	              packageFit: [
	                { label:'Delivery model', value:'Guided program support' },
	                { label:'Risk frame', value:'Governance and evidence confidence' }
	              ],
	              context: [
	                { label:'Industry', value:'Technology / SaaS' },
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 241,
	              npv: 3920000,
	              spend: 1180000,
	              paybackMonths: 10,
	              outcomeBreakdown: [
	                { label:'Regulator readiness evidence', pct: 49 },
	                { label:'Operational decision quality', pct: 30 },
	                { label:'Evidence-led follow-up planning', pct: 21 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Pioneer Cloud',
	              role: 'ciso',
	              activeStep: 6,
	              visited: [1,2,3,4,5,6]
	            }
	          },
	          {
	            id: 'cedar',
	            company: 'Cedar Health',
	            stage: 'Closed',
	            completion: '22/22 (100%)',
	            tier: 'Advanced',
	            outcomes: ['Evidence-led follow-up planning', 'Compliance translated into evidence & benchmarks'],
	            outcomesText: 'Evidence-led follow-up planning  Compliance translated into evidence & benchmarks',
	            gapSummary: 'No open gaps',
	            gaps: [],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Cedar Health' },
	                { label:'Role', value:'Security Manager' },
	                { label:'Company size', value:'2,00010,000 employees' },
	                { label:'Operating country', value:'United States' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Board  Internal only' },
	                { label:'Primary outcomes', value:'Evidence-led follow-up planning  Compliance translated into evidence & benchmarks' }
	              ],
	              coverage: [
	                { label:'Coverage groups', value:'SOC  GRC / compliance  Workforce' },
	                { label:'Cadence', value:'Monthly' }
	              ],
	              packageFit: [
	                { label:'Delivery model', value:'Guided program support' },
	                { label:'Risk frame', value:'Readiness outcomes' }
	              ],
	              context: [
	                { label:'Industry', value:'Healthcare / Life Sciences' },
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 188,
	              npv: 2760000,
	              spend: 990000,
	              paybackMonths: 12,
	              outcomeBreakdown: [
	                { label:'Evidence-led follow-up planning', pct: 45 },
	                { label:'Compliance translated into evidence & benchmarks', pct: 37 },
	                { label:'Board confidence', pct: 18 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Cedar Health',
	              role: 'secMgr',
	              activeStep: 6,
	              visited: [1,2,3,4,5,6]
	            }
	          },
	          {
	            id: 'arclight',
	            company: 'Arclight Retail',
	            stage: 'Discovery',
	            completion: '8/22 (36%)',
	            tier: 'Core',
	            outcomes: ['Build and retain a cyber-ready workforce', 'Secure the next-gen modern enterprise'],
	            outcomesText: 'Build and retain a cyber-ready workforce  Secure the next-gen modern enterprise',
	            gapSummary: 'Coverage groups not selected  Package fit unanswered',
	            gaps: [
	              { title:'Coverage groups not selected', why:'Coverage determines who the readiness plan includes.', step:2 },
	              { title:'Package fit unanswered', why:'Package fit decisions are needed before recommendation.', step:3 }
	            ],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Arclight Retail' },
	                { label:'Role', value:'Practitioner' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Internal only' },
	                { label:'Primary outcomes', value:'Build and retain a cyber-ready workforce  Secure the next-gen modern enterprise' }
	              ],
	              coverage: [
	                { label:'Coverage groups', value:'' }
	              ],
	              packageFit: [
	                { label:'Current state', value:'Not yet captured' }
	              ],
	              context: [
	                { label:'Industry', value:'Retail / eCommerce' },
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 94,
	              npv: 840000,
	              spend: 470000,
	              paybackMonths: 18,
	              outcomeBreakdown: [
	                { label:'Build and retain a cyber-ready workforce', pct: 52 },
	                { label:'Secure the next-gen modern enterprise', pct: 48 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Arclight Retail',
	              role: 'practitioner',
	              activeStep: 2,
	              visited: [1]
	            }
	          },
	          {
	            id: 'blueharbor',
	            company: 'Blueharbor Logistics',
	            stage: 'Discovery',
	            completion: '9/22 (41%)',
	            tier: 'Core',
	            outcomes: ['Faster detection, response & decision-making', 'Coverage roadmap'],
	            outcomesText: 'Faster detection, response & decision-making  Coverage roadmap',
	            gapSummary: 'Cadence not selected  Context unanswered',
	            gaps: [
	              { title:'Cadence not selected', why:'Cadence drives operating rhythm and follow-up design.', step:2 },
	              { title:'Industry not selected', why:'Industry helps tailor relevant regulatory language.', step:4 }
	            ],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Blueharbor Logistics' },
	                { label:'Role', value:'Security Manager' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Board  Customers' },
	                { label:'Primary outcomes', value:'Faster detection, response & decision-making  Coverage roadmap' }
	              ],
	              coverage: [
	                { label:'Cadence', value:'Not selected' }
	              ],
	              packageFit: [
	                { label:'Delivery model', value:'Not selected' }
	              ],
	              context: [
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 103,
	              npv: 980000,
	              spend: 520000,
	              paybackMonths: 17,
	              outcomeBreakdown: [
	                { label:'Faster detection, response & decision-making', pct: 55 },
	                { label:'Coverage roadmap', pct: 45 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Blueharbor Logistics',
	              role: 'secMgr',
	              activeStep: 2,
	              visited: [1,2]
	            }
	          },
	          {
	            id: 'nexus',
	            company: 'Nexus Utilities',
	            stage: 'Validation',
	            completion: '13/22 (59%)',
	            tier: 'Core',
	            outcomes: ['Regulator readiness evidence', 'Evidence-led follow-up planning'],
	            outcomesText: 'Regulator readiness evidence  Evidence-led follow-up planning',
	            gapSummary: 'Delivery support unanswered  ROI estimate not reviewed',
	            gaps: [
	              { title:'Delivery support unanswered', why:'Support model changes rollout confidence and timing.', step:3 },
	              { title:'ROI estimate not reviewed', why:'Commercial confidence needs quantified value signals.', step:5 }
	            ],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Nexus Utilities' },
	                { label:'Role', value:'CISO' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Regulator  Internal only' },
	                { label:'Primary outcomes', value:'Regulator readiness evidence  Evidence-led follow-up planning' }
	              ],
	              coverage: [
	                { label:'Coverage groups', value:'SOC  GRC / compliance' },
	                { label:'Cadence', value:'Quarterly' }
	              ],
	              packageFit: [
	                { label:'Current state', value:'Exercises are ad hoc today' }
	              ],
	              context: [
	                { label:'Industry', value:'Energy / Utilities' },
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 141,
	              npv: 1890000,
	              spend: 760000,
	              paybackMonths: 14,
	              outcomeBreakdown: [
	                { label:'Regulator readiness evidence', pct: 46 },
	                { label:'Evidence-led follow-up planning', pct: 34 },
	                { label:'Board confidence', pct: 20 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Nexus Utilities',
	              role: 'ciso',
	              activeStep: 3,
	              visited: [1,2,3,4]
	            }
	          },
	          {
	            id: 'lunar',
	            company: 'Lunar Systems',
	            stage: 'Validation',
	            completion: '19/22 (86%)',
	            tier: 'Advanced',
	            outcomes: ['Secure the next-gen modern enterprise', 'Faster detection, response & decision-making'],
	            outcomesText: 'Secure the next-gen modern enterprise  Faster detection, response & decision-making',
	            gapSummary: 'Regulatory references not selected',
	            gaps: [
	              { title:'Regulatory references not selected', why:'References improve the evidence narrative for stakeholders.', step:4 }
	            ],
	            modules: {
	              organisation: [
	                { label:'Name', value:'Will Bloor' },
	                { label:'Company', value:'Lunar Systems' },
	                { label:'Role', value:'CISO' }
	              ],
	              discovery: [
	                { label:'Pressure sources', value:'Board  Customers  Insurer' },
	                { label:'Primary outcomes', value:'Secure the next-gen modern enterprise  Faster detection, response & decision-making' }
	              ],
	              coverage: [
	                { label:'Coverage groups', value:'SOC  Cloud security  Identity & access (IAM)' },
	                { label:'Cadence', value:'Monthly' }
	              ],
	              packageFit: [
	                { label:'Delivery model', value:'Guided program support' },
	                { label:'Risk frame', value:'Readiness outcomes' }
	              ],
	              context: [
	                { label:'Industry', value:'Technology / SaaS' },
	                { label:'Region', value:'North America' }
	              ]
	            },
	            viz: {
	              roiPct: 209,
	              npv: 3340000,
	              spend: 1120000,
	              paybackMonths: 11,
	              outcomeBreakdown: [
	                { label:'Secure the next-gen modern enterprise', pct: 44 },
	                { label:'Faster detection, response & decision-making', pct: 36 },
	                { label:'Compliance translated into evidence & benchmarks', pct: 20 }
	              ]
	            },
	            snapshot: {
	              fullName: 'Will Bloor',
	              company: 'Lunar Systems',
	              role: 'ciso',
	              activeStep: 5,
	              visited: [1,2,3,4,5]
	            }
	          }
	        ];
	      }

      function jsonClone(value){
        try{
          return JSON.parse(JSON.stringify(value));
        }catch(err){
          return null;
        }
      }

      function completionPctFromSummary(completion){
        const m = String(completion || '').match(/\((\d+)\s*%\)/);
        return m ? clamp(Number(m[1]) || 0, 0, 100) : 0;
      }

      function defaultSnapshotForThread(thread){
        const pct = completionPctFromSummary(thread && thread.completion);
        let visitedMax = 1;
        if(pct >= 100) visitedMax = 6;
        else if(pct >= 80) visitedMax = 5;
        else if(pct >= 60) visitedMax = 4;
        else if(pct >= 40) visitedMax = 2;
        const firstGap = Number(thread && thread.gaps && thread.gaps[0] && thread.gaps[0].step);
        return {
          fullName: 'Will Bloor',
          company: (thread && thread.company) ? String(thread.company) : 'Record',
          role: 'ciso',
          activeStep: clamp(Number.isFinite(firstGap) ? firstGap : visitedMax, 1, 6),
          visited: Array.from({ length: visitedMax }, (_, idx)=> idx + 1)
        };
      }

      function normalizeThreadModel(raw, idx){
        const source = (raw && typeof raw === 'object') ? raw : {};
        const outcomes = Array.isArray(source.outcomes)
          ? source.outcomes.map((it)=> String(it || '').trim()).filter(Boolean)
          : [];
        const gaps = Array.isArray(source.gaps)
          ? source.gaps.map((gap)=> ({
              title: String((gap && gap.title) || 'Gap'),
              why: String((gap && gap.why) || ''),
              step: clamp(Number(gap && gap.step) || 1, 1, 6)
            }))
          : [];
        const modulesIn = (source.modules && typeof source.modules === 'object') ? source.modules : {};
        const modules = {
          organisation: Array.isArray(modulesIn.organisation) ? modulesIn.organisation : [{ label:'Company', value: source.company || 'Record' }],
          discovery: Array.isArray(modulesIn.discovery) ? modulesIn.discovery : [{ label:'Primary outcomes', value: outcomes.join('  ') || '' }],
          coverage: Array.isArray(modulesIn.coverage) ? modulesIn.coverage : [{ label:'Coverage groups', value:'' }],
          packageFit: Array.isArray(modulesIn.packageFit) ? modulesIn.packageFit : [{ label:'Delivery model', value:'' }],
          context: Array.isArray(modulesIn.context) ? modulesIn.context : [{ label:'Region', value:'' }]
        };
        const vizIn = (source.viz && typeof source.viz === 'object') ? source.viz : {};
        const snapshot = (source.snapshot && typeof source.snapshot === 'object')
          ? source.snapshot
          : defaultSnapshotForThread({ company: source.company, completion: source.completion, gaps });

        return {
          id: String(source.id || `record-${idx + 1}`),
          company: String(source.company || 'Record'),
          stage: String(source.stage || 'Discovery'),
          completion: String(source.completion || '0/22 (0%)'),
          tier: String(source.tier || 'Core'),
          outcomes,
          outcomesText: String(source.outcomesText || (outcomes.length ? outcomes.join('  ') : 'Awaiting outcome signals')),
          gapSummary: String(source.gapSummary || (gaps.length ? gaps.slice(0,2).map((g)=> g.title).join('  ') : 'No open gaps')),
          gaps,
          modules: jsonClone(modules) || modules,
          viz: {
            roiPct: Number(vizIn.roiPct),
            npv: Number(vizIn.npv),
            spend: Number(vizIn.spend),
            paybackMonths: (vizIn.paybackMonths === null || vizIn.paybackMonths === undefined) ? null : Number(vizIn.paybackMonths),
            outcomeBreakdown: Array.isArray(vizIn.outcomeBreakdown)
              ? vizIn.outcomeBreakdown
                  .map((row)=> ({
                    label: String((row && row.label) || '').trim(),
                    pct: clamp(Number(row && row.pct) || 0, 0, 100)
                  }))
                  .filter((row)=> row.label)
              : []
          },
          snapshot: jsonClone(snapshot) || defaultSnapshotForThread(source),
          updatedAt: Number(source.updatedAt) || 0,
          priority: !!source.priority,
          archived: !!source.archived,
          archivedAt: Number(source.archivedAt) || 0
        };
      }

      function loadSavedThreadsFromStorage(){
        try{
          const raw = window.localStorage.getItem(THREAD_STORAGE_KEY);
          if(!raw) return [];
          const parsed = JSON.parse(raw);
          if(!Array.isArray(parsed)) return [];
          return parsed.map((thread, idx)=> normalizeThreadModel(thread, idx));
        }catch(err){
          return [];
        }
      }

      function persistSavedThreads(){
        try{
          window.localStorage.setItem(THREAD_STORAGE_KEY, JSON.stringify(state.savedThreads || []));
        }catch(err){
          // Ignore storage failures (private mode / blocked storage).
        }
      }

      function ensureSavedThreadsLoaded(){
        if(state.savedThreadsLoaded) return;
        const stored = loadSavedThreadsFromStorage();
        if(stored.length){
          state.savedThreads = stored;
        }else{
          state.savedThreads = staticThreadModels().map((thread, idx)=> normalizeThreadModel(thread, idx));
          persistSavedThreads();
        }
        state.savedThreadsLoaded = true;
      }

      function findSavedThread(threadId){
        ensureSavedThreadsLoaded();
        return (state.savedThreads || []).find((thread)=> thread.id === threadId) || null;
      }

      function nextSavedThreadId(){
        const stamp = Date.now().toString(36);
        const rand = Math.random().toString(36).slice(2, 7);
        return `record-${stamp}-${rand}`;
      }

      function buildThreadSnapshotFromState(){
        return {
          role: state.role,
          fullName: state.fullName,
          company: state.company,
          companySize: state.companySize,
          operatingCountry: state.operatingCountry,
          industry: state.industry,
          region: state.region,
          pressureSources: Array.from(state.pressureSources || []),
          urgentWin: state.urgentWin,
          riskEnvs: Array.from(state.riskEnvs || []),
          measuredOn: state.measuredOn,
          orgPain: state.orgPain,
          drivers: Array.from(state.drivers || []),
          milestone: state.milestone,
          evidence: Array.from(state.evidence || []),
          outcomeDrilldowns: jsonClone(state.outcomeDrilldowns || {}) || {},
          groups: Array.from(state.groups || []),
          rhythm: state.rhythm,
          measure: state.measure,
          fitRealism: state.fitRealism,
          fitScope: state.fitScope,
          fitToday: state.fitToday,
          fitServices: state.fitServices,
          fitRiskFrame: state.fitRiskFrame,
          regMode: state.regMode,
          regModeTouched: !!state.regModeTouched,
          regSearch: state.regSearch,
          regsTouched: !!state.regsTouched,
          regs: Array.from(state.regs || []),
          stack: Array.from(state.stack || []),
          stackOther: state.stackOther,
          currency: state.currency,
          fx: { USD: 1, GBP: Number(state.fx.GBP) || 0.80, EUR: Number(state.fx.EUR) || 0.90 },
          revenueB: Number(state.revenueB) || IMMERSIVE_MODEL.baselineRevenueB,
          investUSD: Number(state.investUSD) || IMMERSIVE_MODEL.baselineInvestment,
          investManual: !!state.investManual,
          teamCyber: Number(state.teamCyber) || IMMERSIVE_MODEL.baselineCyber,
          teamDev: Number(state.teamDev) || IMMERSIVE_MODEL.baselineDev,
          teamWf: Number(state.teamWf) || IMMERSIVE_MODEL.baselineWorkforce,
          teamManual: !!state.teamManual,
          realization: state.realization,
          paybackDelayMonths: Number(state.paybackDelayMonths) || 0,
          cyberSalaryUSD: Number(state.cyberSalaryUSD) || 180000,
          devSalaryUSD: Number(state.devSalaryUSD) || 160000,
          email: state.email,
          phone: state.phone,
          notes: state.notes,
          optin: !!state.optin,
          activeStep: clamp(Number(state.activeStep) || 1, 1, 6),
          visited: Array.from(state.visited || [1])
        };
      }

      function buildSavedVizFromState(){
        const viz = interVizModel({ id:'current' });
        return {
          roiPct: Number(viz && viz.roiPct),
          npv: Number(viz && viz.npv),
          spend: Number(viz && viz.spend),
          paybackMonths: (viz && (viz.paybackMonths === null || viz.paybackMonths === undefined)) ? null : Number(viz && viz.paybackMonths),
          outcomeBreakdown: Array.isArray(viz && viz.outcomeBreakdown)
            ? viz.outcomeBreakdown
                .map((row)=> ({
                  label: String((row && row.label) || '').trim(),
                  pct: clamp(Number(row && row.pct) || 0, 0, 100)
                }))
                .filter((row)=> row.label)
            : []
        };
      }

      function buildSavedThreadFromState(threadId, meta){
        const summary = currentThreadModel();
        const metaIn = (meta && typeof meta === 'object') ? meta : {};
        return normalizeThreadModel({
          id: threadId || nextSavedThreadId(),
          company: summary.company,
          stage: summary.stage,
          completion: summary.completion,
          tier: summary.tier,
          outcomes: summary.outcomes,
          outcomesText: summary.outcomesText,
          gapSummary: summary.gapSummary,
          gaps: summary.gaps,
          modules: summary.modules,
          viz: buildSavedVizFromState(),
          snapshot: buildThreadSnapshotFromState(),
          updatedAt: Date.now(),
          priority: !!metaIn.priority,
          archived: !!metaIn.archived,
          archivedAt: Number(metaIn.archivedAt) || 0
        }, 0);
      }

      function applyThreadSnapshot(snapshot, opts){
        const snap = (snapshot && typeof snapshot === 'object') ? snapshot : {};
        const cfg = opts || {};
        state.savePulseUntil = 0;
        state.saveIsThinking = false;
        clearScheduledAutoSave();

        state.role = snap.role || '';
        state.fullName = snap.fullName || '';
        state.company = (snap.company && String(snap.company).trim()) ? String(snap.company).trim() : '';
        state.companySize = snap.companySize || '';
        state.operatingCountry = snap.operatingCountry || '';
        state.industry = snap.industry || '';
        state.region = snap.region || '';
        state._industryChanged = false;
        state._regionChanged = false;

        state.pressureSources = Array.from(new Set(Array.isArray(snap.pressureSources) ? snap.pressureSources : [])).slice(0,3);
        state.urgentWin = snap.urgentWin || '';
        state.riskEnvs = Array.from(new Set(Array.isArray(snap.riskEnvs) ? snap.riskEnvs : [])).slice(0,2);
        state.measuredOn = snap.measuredOn || '';
        state.orgPain = snap.orgPain || '';
        state.drivers = Array.from(new Set(Array.isArray(snap.drivers) ? snap.drivers : [])).slice(0,3);
        state.milestone = snap.milestone || '';
        state.evidence = new Set(Array.isArray(snap.evidence) ? snap.evidence : []);
        state.outcomeDrilldowns = (snap.outcomeDrilldowns && typeof snap.outcomeDrilldowns === 'object')
          ? jsonClone(snap.outcomeDrilldowns) || {}
          : {};

        state.groups = new Set(Array.isArray(snap.groups) ? snap.groups : []);
        state.rhythm = snap.rhythm || '';
        state.measure = snap.measure || '';
        state.fitRealism = snap.fitRealism || '';
        state.fitScope = snap.fitScope || '';
        state.fitToday = snap.fitToday || '';
        state.fitServices = snap.fitServices || '';
        state.fitRiskFrame = snap.fitRiskFrame || '';

        state.regMode = (snap.regMode === 'all') ? 'all' : 'suggested';
        state.regModeTouched = !!snap.regModeTouched;
        state.regSearch = snap.regSearch || '';
        state.regsTouched = !!snap.regsTouched;
        state.regs = new Set(Array.isArray(snap.regs) ? snap.regs : []);
        state.stack = new Set(Array.isArray(snap.stack) ? snap.stack : []);
        state.stackOther = snap.stackOther || '';

        state.currency = (snap.currency === 'GBP' || snap.currency === 'EUR') ? snap.currency : 'USD';
        const fx = (snap.fx && typeof snap.fx === 'object') ? snap.fx : {};
        state.fx.GBP = (Number.isFinite(Number(fx.GBP)) && Number(fx.GBP) > 0) ? Number(fx.GBP) : 0.80;
        state.fx.EUR = (Number.isFinite(Number(fx.EUR)) && Number(fx.EUR) > 0) ? Number(fx.EUR) : 0.90;
        state.revenueB = Number.isFinite(Number(snap.revenueB)) ? Number(snap.revenueB) : IMMERSIVE_MODEL.baselineRevenueB;
        state.investUSD = Number.isFinite(Number(snap.investUSD)) ? Number(snap.investUSD) : IMMERSIVE_MODEL.baselineInvestment;
        state.investManual = !!snap.investManual;
        state.teamCyber = Number.isFinite(Number(snap.teamCyber)) ? Number(snap.teamCyber) : IMMERSIVE_MODEL.baselineCyber;
        state.teamDev = Number.isFinite(Number(snap.teamDev)) ? Number(snap.teamDev) : IMMERSIVE_MODEL.baselineDev;
        state.teamWf = Number.isFinite(Number(snap.teamWf)) ? Number(snap.teamWf) : IMMERSIVE_MODEL.baselineWorkforce;
        state.teamManual = !!snap.teamManual;
        state.realization = (snap.realization === 'expected' || snap.realization === 'immersive') ? snap.realization : 'conservative';
        state.paybackDelayMonths = Number.isFinite(Number(snap.paybackDelayMonths)) ? Number(snap.paybackDelayMonths) : 3;
        state.cyberSalaryUSD = Number.isFinite(Number(snap.cyberSalaryUSD)) ? Number(snap.cyberSalaryUSD) : 180000;
        state.devSalaryUSD = Number.isFinite(Number(snap.devSalaryUSD)) ? Number(snap.devSalaryUSD) : 160000;

        state.email = snap.email || '';
        state.phone = snap.phone || '';
        state.notes = snap.notes || '';
        state.optin = !!snap.optin;

        const visitedRaw = Array.isArray(snap.visited) ? snap.visited : [1];
        state.visited = new Set(
          visitedRaw
            .map((v)=> clamp(Number(v) || 1, 1, 6))
        );
        if(!state.visited.size) state.visited.add(1);

        const nextStep = clamp(Number(cfg.step || snap.activeStep) || 1, 1, 6);
        state.activeStep = nextStep;

        syncFormControlsFromState();
        setActiveStep(nextStep);
      }

      function saveActiveRecord(opts){
        const cfg = Object.assign({ quiet:false, auto:false, thinkMs:560 }, opts || {});
        if(state.saveIsThinking) return false;
        clearScheduledAutoSave();

        const commitSave = ()=>{
          ensureSavedThreadsLoaded();
          const existing = (state.activeThread && state.activeThread !== 'current') ? findSavedThread(state.activeThread) : null;
          const recordId = existing ? existing.id : nextSavedThreadId();
          const nextThread = buildSavedThreadFromState(recordId, existing ? {
            priority: !!existing.priority,
            archived: !!existing.archived,
            archivedAt: Number(existing.archivedAt) || 0
          } : null);
          const idx = state.savedThreads.findIndex((thread)=> thread.id === nextThread.id);
          if(idx >= 0){
            state.savedThreads[idx] = nextThread;
          }else{
            state.savedThreads.unshift(nextThread);
          }
          state.activeThread = nextThread.id;
          state.saveIsThinking = false;
          state.savePulseUntil = Date.now() + 1600;
          persistSavedThreads();
          update();
          window.setTimeout(()=>{
            if(Date.now() >= state.savePulseUntil) update();
          }, 1650);
          if(!cfg.quiet){
            toast('Record saved.');
          }
          if(state.currentView === 'configurator'){
            requestAutoSave(AUTO_SAVE_BASE_MS);
          }
        };

        const thinkMs = Math.max(0, Number(cfg.thinkMs) || 0);
        if(thinkMs > 0){
          state.saveIsThinking = true;
          state.savePulseUntil = 0;
          update();
          window.setTimeout(commitSave, thinkMs);
        }else{
          commitSave();
        }
        return true;
      }

      function threadModels(){
        ensureSavedThreadsLoaded();
        return (state.savedThreads || []).slice();
      }

      function activeThreadModel(){
        ensureSavedThreadsLoaded();
        if(state.activeThread && state.activeThread !== 'current'){
          const saved = findSavedThread(state.activeThread);
          if(saved) return saved;
        }
        return currentThreadModel();
      }

      function dashboardSortThreads(rows){
        return (rows || []).slice().sort((a, b)=>{
          const byPriority = Number(!!b.priority) - Number(!!a.priority);
          if(byPriority) return byPriority;
          const byUpdated = Number(b.updatedAt || 0) - Number(a.updatedAt || 0);
          if(byUpdated) return byUpdated;
          return String(a.company || '').localeCompare(String(b.company || ''));
        });
      }

      function dashboardRowsModel(){
        const filtered = threadModels().filter((thread)=> !thread.archived);
        return dashboardSortThreads(filtered).map((thread)=> ({
          id: thread.id,
          company: thread.company,
          completion: thread.completion,
          tier: thread.tier,
          outcomes: thread.outcomesText,
          gaps: thread.gapSummary,
          priority: !!thread.priority,
          openLabel: 'Open overview'
        }));
      }

      function archivedRowsModel(){
        const filtered = threadModels().filter((thread)=> !!thread.archived);
        return dashboardSortThreads(filtered).map((thread)=> ({
          id: thread.id,
          company: thread.company,
          completion: thread.completion,
          tier: thread.tier,
          outcomes: thread.outcomesText,
          gaps: thread.gapSummary,
          openLabel: 'Open overview'
        }));
      }

      function renderWorkspaceCompanies(){
        const host = $('#workspaceCompaniesList');
        const countEl = $('#workspaceCompaniesCount');
        if(!host) return;

        const starredRows = dashboardSortThreads(
          threadModels().filter((thread)=> !thread.archived && !!thread.priority)
        );
        const rows = starredRows.slice();
        const previewId = String(state.navPreviewThreadId || '').trim();
        if(previewId){
          const previewThread = findSavedThread(previewId);
          const alreadyVisible = rows.some((thread)=> thread.id === previewId);
          if(previewThread && !previewThread.archived && !previewThread.priority && !alreadyVisible){
            rows.unshift(previewThread);
          }
        }
        if(countEl) countEl.textContent = String(starredRows.length);

        if(!rows.length){
          host.innerHTML = '<p class="workspaceCompaniesEmpty">No starred companies yet. Star a record to pin it here.</p>';
          return;
        }

        host.innerHTML = rows.map((thread)=>{
          const pct = completionPctFromSummary(thread.completion);
          const active = (state.activeThread === thread.id && (state.currentView === 'interstitial' || state.currentView === 'configurator'));
          const isStarred = !!thread.priority;
          const animateStar = isStarred && !!state.starPulseQueue && state.starPulseQueue.has(thread.id);
          const star = isStarred
            ? `<span class="workspacePriorityStar${animateStar ? ' is-animate' : ''}" aria-hidden="true"></span>`
            : '';
          return `
            <button type="button" class="workspaceCompanyBtn" data-company-open="${escapeHtml(thread.id)}" data-active="${active ? 'true' : 'false'}" title="Open ${escapeHtml(thread.company)} overview">
              <span class="workspaceCompanyName">${star}<span class="workspaceCompanyNameLabel">${escapeHtml(thread.company)}</span></span>
              <span class="workspaceCompanyMeta">${pct}% complete  ${escapeHtml(thread.tier)}</span>
            </button>
          `;
        }).join('');
        if(state.starPulseQueue && state.starPulseQueue.size){
          state.starPulseQueue.clear();
        }
      }

      function renderArchiveNavMeta(){
        const sub = $('#workspaceArchiveSub');
        if(!sub) return;
        const archivedCount = threadModels().filter((thread)=> !!thread.archived).length;
        sub.textContent = archivedCount > 0 ? `Archived accounts  ${archivedCount}` : 'Archived accounts';
      }

      function toggleThreadPriority(threadId){
        const thread = findSavedThread(threadId);
        if(!thread) return;
        thread.priority = !thread.priority;
        if(thread.priority){
          if(!(state.starPulseQueue instanceof Set)) state.starPulseQueue = new Set();
          state.starPulseQueue.add(threadId);
          if(state.navPreviewThreadId === threadId) state.navPreviewThreadId = null;
        }else if(state.starPulseQueue instanceof Set){
          state.starPulseQueue.delete(threadId);
          if(state.navPreviewThreadId === threadId) state.navPreviewThreadId = null;
        }
        thread.updatedAt = Date.now();
        persistSavedThreads();
        update();
      }

      function closeArchivePrompt(){
        archivePromptMode = 'archive';
        archivePromptIds = [];
        $('#archiveModal')?.classList.remove('show');
      }

      function openArchivePrompt(ids, mode){
        const uniq = Array.from(new Set((ids || []).map((id)=> String(id || '').trim()).filter(Boolean)));
        const validIds = uniq.filter((id)=> !!findSavedThread(id));
        if(!validIds.length) return;

        archivePromptMode = (mode === 'restore') ? 'restore' : 'archive';
        archivePromptIds = validIds;
        const count = validIds.length;
        const verb = archivePromptMode === 'restore' ? 'Restore' : 'Archive';
        const titleEl = $('#archiveModalTitle');
        const bodyEl = $('#archiveModalBody');
        const confirmBtn = $('#archiveModalConfirm');
        if(titleEl) titleEl.textContent = `${verb} ${count === 1 ? 'this record' : `${count} records`}?`;
        if(bodyEl){
          bodyEl.textContent = archivePromptMode === 'restore'
            ? 'Restored records return to the active dashboard and company list.'
            : 'Archived records are removed from active lists and can be restored later.';
        }
        if(confirmBtn) confirmBtn.textContent = `${verb} ${count === 1 ? 'record' : 'records'}`;
        const modal = $('#archiveModal');
        if(modal) modal.classList.add('show');
      }

      function applyArchivePrompt(){
        const ids = Array.from(new Set((archivePromptIds || []).map((id)=> String(id || '').trim()).filter(Boolean)));
        if(!ids.length){
          closeArchivePrompt();
          return;
        }
        const restoreMode = archivePromptMode === 'restore';
        let touched = 0;
        ids.forEach((id)=>{
          const thread = findSavedThread(id);
          if(!thread) return;
          touched += 1;
          thread.archived = !restoreMode;
          thread.archivedAt = restoreMode ? 0 : Date.now();
          if(!restoreMode) thread.priority = false;
          thread.updatedAt = Date.now();
          if(!restoreMode && state.activeThread === thread.id){
            state.activeThread = 'current';
          }
        });
        if(!restoreMode && state.currentView !== 'dashboard' && state.activeThread === 'current'){
          setView('dashboard', { render:false });
        }
        state.dashboardSelectedIds = new Set();
        state.archivedSelectedIds = new Set();
        persistSavedThreads();
        closeArchivePrompt();
        update();
        if(touched > 0){
          toast(
            restoreMode
              ? `${touched} record${touched === 1 ? '' : 's'} restored.`
              : `${touched} record${touched === 1 ? '' : 's'} archived.`
          );
        }
      }

      function openThreadOverview(threadId){
        const target = threadId || 'current';
        state.activeThread = (target !== 'current' && !findSavedThread(target)) ? 'current' : target;
        if(state.activeThread !== 'current'){
          const thread = findSavedThread(state.activeThread);
          state.navPreviewThreadId = (thread && !thread.archived && !thread.priority) ? thread.id : null;
        }else{
          state.navPreviewThreadId = null;
        }
        setView('interstitial');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function openThreadConfigurator(threadId, step){
        const target = threadId || state.activeThread || 'current';
        if(target !== 'current'){
          const thread = findSavedThread(target);
          if(thread){
            state.activeThread = target;
            applyThreadSnapshot(thread.snapshot || defaultSnapshotForThread(thread), {
              step: Number(step) || dashboardFirstGapStep(thread)
            });
            return;
          }
        }
        state.activeThread = 'current';
        setActiveStep(Number(step) || dashboardFirstGapStep(currentThreadModel()));
      }

      function openThreadBooking(threadId){
        const target = threadId || state.activeThread || 'current';
        openThreadConfigurator(target, 6);
        window.setTimeout(()=>{
          const bookForm = $('#bookForm');
          if(bookForm){
            bookForm.scrollIntoView({ behavior:'smooth', block:'start' });
          }
          const emailField = $('#email');
          if(emailField && !String(emailField.value || '').trim()){
            emailField.focus();
          }
        }, 240);
      }

      function packageOverviewForTier(tier){
        const name = String(tier || '').trim().toLowerCase();
        if(name.startsWith('adv')){
          return {
            key: 'adv',
            title: 'Advanced package',
            body: 'Operational performance, measurable over time. Higher cadence exercising, more realism, benchmarking, and repeatable improvement.'
          };
        }
        if(name.startsWith('ult')){
          return {
            key: 'ult',
            title: 'Ultimate package',
            body: 'Evidence you can defend. High cadence proving with executive readiness outputs and scalable governance.'
          };
        }
        return {
          key: 'core',
          title: 'Core package',
          body: 'Baseline capability, quickly. Role-based labs plus a small, controlled amount of team-level proving.'
        };
      }

      function renderInterstitialKvs(rows){
        return (rows || [])
          .map((row)=> `
            <div class="interKv">
              <span class="interKvLabel">${escapeHtml(row.label)}</span>
              <span class="interKvVal">${escapeHtml(row.value || '')}</span>
            </div>
          `)
          .join('');
      }

      function interVizModel(thread){
        if(thread && thread.id === 'current'){
          const topOutcomes = inferredPrimaryOutcomes(3);
          const pctById = topOutcomePercentages(topOutcomes);
          let outcomeBreakdown = topOutcomes
            .map((o)=> ({
              label: String(o.short || o.label || '').trim(),
              pct: Number(pctById[o.id] || 0)
            }))
            .filter((o)=> o.label && Number.isFinite(o.pct));

          if(!outcomeBreakdown.length){
            outcomeBreakdown = [{ label:'Outcome confidence pending', pct:100 }];
          }

          const roi = computeRoi();
          const paybackMonths = computePaybackMonths(roi);
          return {
            roiPct: Number(roi.roi * 100),
            npv: Number(roi.npv),
            spend: Number(state.investUSD),
            paybackMonths,
            outcomeBreakdown
          };
        }

        const viz = (thread && thread.viz) ? thread.viz : {};
        let outcomeBreakdown = Array.isArray(viz.outcomeBreakdown)
          ? viz.outcomeBreakdown
              .map((row)=> ({
                label: String((row && row.label) || '').trim(),
                pct: Number(row && row.pct)
              }))
              .filter((row)=> row.label && Number.isFinite(row.pct))
          : [];

        if(!outcomeBreakdown.length){
          const outcomes = Array.isArray(thread && thread.outcomes) ? thread.outcomes : [];
          if(outcomes.length){
            const share = Math.floor(100 / outcomes.length);
            const carry = 100 - (share * (outcomes.length - 1));
            outcomeBreakdown = outcomes.map((label, idx)=> ({
              label: String(label),
              pct: idx === outcomes.length - 1 ? carry : share
            }));
          }else{
            outcomeBreakdown = [{ label:'Outcome confidence pending', pct:100 }];
          }
        }

        return {
          roiPct: Number(viz.roiPct),
          npv: Number(viz.npv),
          spend: Number(viz.spend),
          paybackMonths: (viz.paybackMonths === null || viz.paybackMonths === undefined) ? null : Number(viz.paybackMonths),
          outcomeBreakdown
        };
      }

      function renderInterstitialView(){
        const host = $('#interstitialContent');
        if(!host) return;

        const thread = activeThreadModel();
        const viz = interVizModel(thread);
        const gaps = thread.gaps || [];
        const pkg = packageOverviewForTier(thread.tier);
        const canTogglePriority = !!(thread && thread.id && thread.id !== 'current' && !!findSavedThread(thread.id));
        const interTitleStar = canTogglePriority
          ? `<button type="button" class="interTitleStarBtn" data-inter-star-id="${escapeHtml(thread.id)}" data-active="${thread.priority ? 'true' : 'false'}" aria-pressed="${thread.priority ? 'true' : 'false'}" title="${thread.priority ? 'Unstar company' : 'Star company'}"></button>`
          : '';
        const outcomeRows = (viz.outcomeBreakdown || []).slice(0, 4).map((row, idx)=> {
          const pct = clamp(Number(row.pct) || 0, 0, 100);
          return `
            <div class="interOutcomeRow">
              <div class="interOutcomeTop">
                <span class="interOutcomeLabel">${escapeHtml(row.label)}</span>
                <span class="interOutcomePct">${pct}%</span>
              </div>
              <div class="interOutcomeTrack">
                <span class="interOutcomeFill" data-target="${pct}" style="--delay:${idx * 90}ms;"></span>
              </div>
            </div>
          `;
        }).join('');

        const gapItems = gaps.length
          ? gaps.slice(0, 8).map((gap)=> `
              <div class="interGapItem">
                <p class="interGapTitle">${escapeHtml(gap.title)}</p>
                <p class="interGapWhy">Why it matters: ${escapeHtml(gap.why || 'Required for confidence in recommendation and plan.')}</p>
                <div class="interGapActions">
                  <button type="button" class="interEditLink" data-inter-edit-step="${Number(gap.step) || 1}">Edit this section</button>
                </div>
              </div>
            `).join('')
          : '<div class="interEmpty">No open gaps. This thread is ready for package confirmation.</div>';

        host.innerHTML = `
          <header class="interHead">
            <div class="interCrumbs">
              <span class="interCrumbHome">Dashboard</span>
              <span>/</span>
              <span>${escapeHtml(thread.company)}</span>
            </div>
            <div class="interTitleRow">
              <div>
                <div class="interTitleMain">
                  ${interTitleStar}
                  <h2>${escapeHtml(thread.company)}</h2>
                </div>
                <p class="interSub">Our understanding of your business. Use Edit to jump directly to incomplete sections.</p>
              </div>
            </div>
            <div class="interMeta">
              <span class="interPill">Stage: ${escapeHtml(thread.stage || 'Discovery')}</span>
              <span class="interPill">Completion: ${escapeHtml(thread.completion)}</span>
              <span class="interPill">Tier: ${escapeHtml(thread.tier)}</span>
              <span class="interPill">Open gaps: ${gaps.length}</span>
            </div>
          </header>

          <section class="interPackageHero" data-tier-key="${escapeHtml(pkg.key)}">
            <p class="interPackageKicker">Package</p>
            <h3 class="interPackageTitle">${escapeHtml(pkg.title)}</h3>
            <p class="interPackageBody">${escapeHtml(pkg.body)}</p>
          </section>

          <section class="interViz">
            <article class="interVizCard">
              <h3 class="interVizTitle">ROI snapshot</h3>
              <p class="interVizSub">Directional signal for commercial confidence, based on the current record profile.</p>
              <div class="interRoiGrid">
                <div class="interRoiMetric">
                  <p class="interRoiMetricLabel">3-year ROI</p>
                  <p class="interRoiMetricValue" id="interRoiPctValue"></p>
                </div>
                <div class="interRoiMetric">
                  <p class="interRoiMetricLabel">3-year NPV</p>
                  <p class="interRoiMetricValue" id="interNpvValue"></p>
                </div>
                <div class="interRoiMetric">
                  <p class="interRoiMetricLabel">Payback</p>
                  <p class="interRoiMetricValue" id="interPaybackValue"></p>
                </div>
                <div class="interRoiMetric">
                  <p class="interRoiMetricLabel">Indicative spend</p>
                  <p class="interRoiMetricValue" id="interSpendValue"></p>
                </div>
              </div>
            </article>

            <article class="interVizCard">
              <h3 class="interVizTitle">Outcome weighting</h3>
              <p class="interVizSub">Relative confidence split across the leading outcomes for this record.</p>
              <div class="interOutcomeList">
                ${outcomeRows}
              </div>
            </article>
          </section>

          <section class="interGrid">
            <article class="interCard interCardWide">
              <h3>Gaps: what we still need</h3>
              <div class="interGapList">${gapItems}</div>
            </article>

            <article class="interCard interCardWide">
              <h3>Snapshot</h3>
              <div class="interKvs">
                <div class="interKv">
                  <span class="interKvLabel">Primary outcomes</span>
                  <span class="interKvVal">${escapeHtml(thread.outcomesText || '')}</span>
                </div>
                <div class="interKv">
                  <span class="interKvLabel">Current status</span>
                  <span class="interKvVal">${escapeHtml(thread.gapSummary || 'No open gaps')}</span>
                </div>
              </div>
            </article>

            <article class="interCard">
              <h3>Organisation</h3>
              <div class="interKvs">${renderInterstitialKvs((thread.modules && thread.modules.organisation) || [])}</div>
            </article>

            <article class="interCard">
              <h3>Discovery & outcomes</h3>
              <div class="interKvs">${renderInterstitialKvs((thread.modules && thread.modules.discovery) || [])}</div>
            </article>

            <article class="interCard">
              <h3>Coverage & package fit</h3>
              <div class="interKvs">${renderInterstitialKvs([...(thread.modules?.coverage || []), ...(thread.modules?.packageFit || [])])}</div>
            </article>

            <article class="interCard">
              <h3>Context</h3>
              <div class="interKvs">${renderInterstitialKvs((thread.modules && thread.modules.context) || [])}</div>
            </article>
          </section>
        `;

        $$('#interstitialContent .interGapList [data-inter-edit-step]').forEach((btn)=>{
          btn.addEventListener('click', ()=>{
            const step = Number(btn.getAttribute('data-inter-edit-step') || dashboardFirstGapStep(thread));
            openThreadConfigurator(thread.id, step);
          });
        });
        const interStarBtn = $('#interstitialContent [data-inter-star-id]');
        if(interStarBtn){
          interStarBtn.addEventListener('click', ()=>{
            const id = interStarBtn.getAttribute('data-inter-star-id') || '';
            if(id) toggleThreadPriority(id);
          });
        }

        tweenMetricText(
          $('#interRoiPctValue'),
          viz.roiPct,
          (v)=> Number.isFinite(v) ? `${Math.round(v)}%` : '',
          { duration: 420, formatSig: 'inter-roi-pct' }
        );
        tweenMetricText(
          $('#interNpvValue'),
          viz.npv,
          (v)=> Number.isFinite(v) ? fmtMoneyCompactUSD(v, { signed:true, sig:3 }) : '',
          { duration: 520, formatSig: `inter-npv-${state.currency}` }
        );
        tweenMetricText(
          $('#interPaybackValue'),
          viz.paybackMonths,
          (v)=> fmtPayback(v),
          { duration: 420, formatSig: 'inter-payback' }
        );
        tweenMetricText(
          $('#interSpendValue'),
          viz.spend,
          (v)=> Number.isFinite(v) ? `${fmtMoneyCompactUSD(v, { sig:3 })}/yr` : '',
          { duration: 520, formatSig: `inter-spend-${state.currency}` }
        );

        $$('#interstitialContent .interOutcomeFill').forEach((fill)=>{
          const pct = clamp(Number(fill.dataset.target) || 0, 0, 100);
          fill.style.width = '0%';
          window.requestAnimationFrame(()=>{ fill.style.width = `${pct}%`; });
        });
      }

      function renderDashboardRows(){
        const body = $('#dashboardRows');
        if(!body) return;

        const rows = dashboardRowsModel();
        const visibleIds = new Set(rows.map((row)=> row.id));
        state.dashboardSelectedIds = new Set(
          Array.from(state.dashboardSelectedIds || []).filter((id)=> visibleIds.has(id))
        );
        const selectedCount = state.dashboardSelectedIds.size;

        if(!rows.length){
          body.innerHTML = `
            <tr>
              <td colspan="7" style="padding:16px 12px; color: var(--muted);">
                No active records yet. Create a new record to get started.
              </td>
            </tr>
          `;
        }else{
          body.innerHTML = rows.map((row)=> {
            const pct = completionPctFromSummary(row.completion);
            const checked = state.dashboardSelectedIds.has(row.id) ? 'checked' : '';
            return `
              <tr data-dashboard-row-id="${escapeHtml(row.id)}" data-selected="${checked ? 'true' : 'false'}">
                <td class="dashSelectCol">
                  <input class="dashRowCheck" type="checkbox" data-dashboard-select-id="${escapeHtml(row.id)}" aria-label="Select ${escapeHtml(row.company)}" ${checked} />
                </td>
                <td>
                  <div class="dashCompanyCell">
                    <button class="dashStarBtn" type="button" data-dashboard-star-id="${escapeHtml(row.id)}" data-active="${row.priority ? 'true' : 'false'}" title="Toggle priority for ${escapeHtml(row.company)}"></button>
                    <span class="dash-company">${escapeHtml(row.company)}</span>
                  </div>
                </td>
                <td>
                  <div class="dashCompletion" title="${escapeHtml(row.completion)}">
                    <span class="dashCompletionRing" style="--pct:${pct};"><span>${pct}%</span></span>
                  </div>
                </td>
                <td><span class="dash-tier">${escapeHtml(row.tier)}</span></td>
                <td><span class="dash-outcomes">${escapeHtml(row.outcomes)}</span></td>
                <td><span class="dash-gaps">${escapeHtml(row.gaps)}</span></td>
                <td>
                  <span class="dashActions">
                    <button class="dashActionBtn open" type="button" data-dashboard-open-btn="${escapeHtml(row.id)}">${escapeHtml(row.openLabel)}</button>
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }

        const count = $('#dashThreadsCount');
        if(count) count.textContent = `${rows.length} threads`;
        const overall = $('#dashOverallScore');
        if(overall){
          const avg = rows.length
            ? Math.round(rows.reduce((sum, row)=> sum + completionPctFromSummary(row.completion), 0) / rows.length)
            : 0;
          overall.textContent = rows.length ? `Average completion: ${avg}%` : 'Average completion: ';
        }
        const last = $('#dashLastUpdated');
        if(last){
          last.textContent = rows.length ? 'Saved records' : 'No saved records yet';
        }

        const selectCount = $('#dashSelectCount');
        if(selectCount) selectCount.textContent = `${selectedCount} selected`;

        const selectAll = $('#dashSelectAll');
        if(selectAll){
          const allChecked = rows.length > 0 && selectedCount === rows.length;
          selectAll.checked = allChecked;
          selectAll.indeterminate = !allChecked && selectedCount > 0;
        }

        const archiveBtn = $('#dashArchiveSelected');
        if(archiveBtn){
          archiveBtn.disabled = selectedCount === 0;
          archiveBtn.textContent = 'Archive selected';
        }
      }

      function renderArchivedRows(){
        const body = $('#archivedRows');
        if(!body) return;

        const rows = archivedRowsModel();
        const visibleIds = new Set(rows.map((row)=> row.id));
        state.archivedSelectedIds = new Set(
          Array.from(state.archivedSelectedIds || []).filter((id)=> visibleIds.has(id))
        );
        const selectedCount = state.archivedSelectedIds.size;

        if(!rows.length){
          body.innerHTML = `
            <tr>
              <td colspan="7" style="padding:16px 12px; color: var(--muted);">
                No archived accounts yet.
              </td>
            </tr>
          `;
        }else{
          body.innerHTML = rows.map((row)=> {
            const pct = completionPctFromSummary(row.completion);
            const checked = state.archivedSelectedIds.has(row.id) ? 'checked' : '';
            return `
              <tr data-archived-row-id="${escapeHtml(row.id)}" data-selected="${checked ? 'true' : 'false'}">
                <td class="dashSelectCol">
                  <input class="dashRowCheck" type="checkbox" data-archived-select-id="${escapeHtml(row.id)}" aria-label="Select ${escapeHtml(row.company)}" ${checked} />
                </td>
                <td><span class="dash-company">${escapeHtml(row.company)}</span></td>
                <td>
                  <div class="dashCompletion" title="${escapeHtml(row.completion)}">
                    <span class="dashCompletionRing" style="--pct:${pct};"><span>${pct}%</span></span>
                  </div>
                </td>
                <td><span class="dash-tier">${escapeHtml(row.tier)}</span></td>
                <td><span class="dash-outcomes">${escapeHtml(row.outcomes)}</span></td>
                <td><span class="dash-gaps">${escapeHtml(row.gaps)}</span></td>
                <td>
                  <span class="dashActions">
                    <button class="dashActionBtn open" type="button" data-archived-unarchive-id="${escapeHtml(row.id)}">Unarchive</button>
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }

        const count = $('#archivedThreadsCount');
        if(count) count.textContent = `${rows.length} archived`;

        const last = $('#archivedLastUpdated');
        if(last) last.textContent = rows.length ? 'Archived records' : 'No archived records';

        const selectCount = $('#archivedSelectCount');
        if(selectCount) selectCount.textContent = `${selectedCount} selected`;

        const selectAll = $('#archivedSelectAll');
        if(selectAll){
          const allChecked = rows.length > 0 && selectedCount === rows.length;
          selectAll.checked = allChecked;
          selectAll.indeterminate = !allChecked && selectedCount > 0;
        }

        const restoreBtn = $('#archivedRestoreSelected');
        if(restoreBtn){
          restoreBtn.disabled = selectedCount === 0;
          restoreBtn.textContent = 'Unarchive selected';
        }
      }

      // ---------- recommendation logic ----------
      const packages = {
        core: {
          key:'core',
          name:'Core',
          tagline:'Baseline capability, quickly.',
          desc:'Role-based labs plus a small, controlled amount of team-level proving.'
        },
        adv: {
          key:'adv',
          name:'Advanced',
          tagline:'Operational performance, measurable over time.',
          desc:'Higher cadence exercising, more realism, benchmarking, and repeatable improvement.'
        },
        ult: {
          key:'ult',
          name:'Ultimate',
          tagline:'Evidence you can defend.',
          desc:'High cadence proving with executive readiness outputs and scalable governance.'
        }
      };

      function fitCompute(){
        const totals = { core: 0, adv: 0, ult: 0 };
        let answered = 0;

        const add = (opts, id) => {
          if(!id) return;
          const it = (opts || []).find(x => x.id === id);
          if(!it || !it.scores) return;
          totals.core += (it.scores.core || 0);
          totals.adv += (it.scores.adv || 0);
          totals.ult += (it.scores.ult || 0);
          answered += 1;
        };

        add(fitRealismOpts, state.fitRealism);
        add(fitScopeOpts, state.fitScope);
        add(fitTodayOpts, state.fitToday);
        add(fitServicesOpts, state.fitServices);
        add(fitRiskFrameOpts, state.fitRiskFrame);

        // Light persona nudge based on role (mirrors master configurator behavior)
        if(answered > 0){
          if(state.role === 'practitioner') totals.core += 1;
          if(state.role === 'secMgr') totals.adv += 1;
          if(state.role === 'ciso' || state.role === 'executive') totals.ult += 1;

          // Light benefitting-group nudges (from master configurator)
          const groupWeights = {
            soc:      { core: 0, adv: 2, ult: 1 },
            appsec:   { core: 2, adv: 1, ult: 0 },
            exec:     { core: 0, adv: 1, ult: 2 },
            workforce:{ core: 1, adv: 1, ult: 1 },
            cloud:    { core: 0, adv: 2, ult: 1 },
            third:    { core: 0, adv: 0, ult: 2 }
          };
          Array.from(state.groups || []).forEach(id=>{
            const w = groupWeights[id];
            if(!w) return;
            totals.core += (w.core || 0);
            totals.adv += (w.adv || 0);
            totals.ult += (w.ult || 0);
          });
        }

        const sum = Math.max(1, totals.core + totals.adv + totals.ult);
        const entries = [
          ['core', totals.core],
          ['adv', totals.adv],
          ['ult', totals.ult]
        ].sort((a,b)=>{
          if(b[1] !== a[1]) return b[1] - a[1];
          const order = { ult:3, adv:2, core:1 };
          return order[b[0]] - order[a[0]];
        });

        const winner = answered ? entries[0][0] : null;
        const runner = answered ? entries[1][0] : null;

        const winnerScore = entries[0][1];
        const runnerScore = entries[1][1];
        const share = winnerScore / sum;
        const gap = (winnerScore - runnerScore) / sum;
        const conf = answered ? Math.round(100 * Math.min(1, (0.75*share + 0.25*(share + gap)))) : 0;

        // Pressure hint (used by primary outcome + Ultimate guardrails)
        let pressureHint = 0;
        if(state.fitToday === 'scrutiny') pressureHint += 3;
        if(state.fitRiskFrame === 'governance') pressureHint += 2;
        if(state.fitRealism === 'bespoke') pressureHint += 1;

        return { totals, answeredCount: answered, winner, runner, conf, pressureHint };
      }

      function score(){
        let core=1, adv=0, ult=0;
        let pressure = 0;

        const largeBands = new Set(['10k-50k','50kplus']);
        const scaleBands = new Set(['2k-10k','10k-50k','50kplus']);

        // Early scale signals (company size moved earlier in decisioning)
        switch(state.companySize){
          case 'lt500': core += 1.5; break;
          case '500-2k': core += 1.0; adv += 0.5; break;
          case '2k-10k': adv += 1.5; ult += 0.5; pressure += 0.5; break;
          case '10k-50k': adv += 2.0; ult += 1.5; pressure += 1.0; break;
          case '50kplus': adv += 2.5; ult += 2.5; pressure += 1.5; break;
        }

        // Discovery signal: pressure source
        if(hasPressure('board')){ adv += 2.0; ult += 1.2; pressure += 2.0; }
        if(hasPressure('regulator')){ adv += 2.0; ult += 1.2; pressure += 2.2; }
        if(hasPressure('insurer')){ adv += 1.6; ult += 1.0; pressure += 1.7; }
        if(hasPressure('customers')){ adv += 1.4; ult += 0.8; pressure += 1.4; }
        if(hasPressure('internal')){ core += 1.0; adv += 0.6; pressure += 0.5; }

        // Evidence outputs
        if(state.evidence.has('board')){ adv+=1.5; ult+=1.0; pressure += 1.8; }
        if(state.evidence.has('reg')){ adv+=1.8; ult+=1.0; pressure += 2.0; }
        if(state.evidence.has('insurer')){ adv+=1.2; ult+=0.8; pressure += 1.4; }
        if(state.evidence.has('customer')){ adv+=1.0; ult+=0.8; pressure += 1.1; }
        if(state.evidence.has('internal')){ adv+=0.8; core+=0.8; pressure += 0.6; }

        // Discovery signal: urgent 90-day win
        switch(state.urgentWin){
          case 'boardEvidence': adv += 1.2; ult += 1.6; pressure += 1.6; break;
          case 'fasterDecisions': adv += 1.8; ult += 0.8; pressure += 0.9; break;
          case 'attackSurface': core += 0.6; adv += 1.2; break;
          case 'safeAI': adv += 1.2; ult += 0.8; pressure += 0.7; break;
          case 'workforce': core += 1.2; adv += 0.7; break;
          case 'thirdParty': adv += 1.0; ult += 0.9; pressure += 0.7; break;
        }

        // Discovery signal: current measurement
        switch(state.measuredOn){
          case 'mttd': adv += 1.4; ult += 0.5; pressure += 0.6; break;
          case 'audit': adv += 1.4; ult += 1.0; pressure += 1.0; break;
          case 'vuln': core += 0.5; adv += 1.2; break;
          case 'training': core += 1.0; adv += 0.5; break;
          case 'notMeasured': adv += 0.8; pressure += 0.5; break;
        }

        // Discovery signal: organization pain
        switch(state.orgPain){
          case 'skillsCoverage': core += 1.3; adv += 0.6; break;
          case 'coordination': adv += 1.2; ult += 0.5; pressure += 0.6; break;
          case 'externalProof': adv += 1.4; ult += 1.0; pressure += 1.2; break;
          case 'vendorRisk': adv += 1.0; ult += 0.8; pressure += 0.8; break;
          case 'aiRisk': adv += 1.0; ult += 0.7; pressure += 0.7; break;
        }

        // Discovery signal: risk environments
        (state.riskEnvs || []).forEach((env)=>{
          switch(env){
            case 'code': core += 0.5; adv += 0.9; break;
            case 'cloud': adv += 1.0; ult += 0.3; break;
            case 'identity': adv += 0.9; ult += 0.3; break;
            case 'ot': adv += 0.8; ult += 0.5; pressure += 0.5; break;
            case 'enterpriseApps': adv += 0.7; break;
            case 'socir': adv += 1.3; ult += 0.5; pressure += 0.8; break;
          }
        });
        if((state.riskEnvs || []).length >= 2) adv += 0.5;

        // Drivers (top 3, no ranking)
        state.drivers.forEach((d)=>{
          switch(d){
            case 'nearMiss': adv+=1.3; ult+=0.7; pressure += 1.2; break;
            case 'sectorPeer': adv+=1.2; ult+=0.6; pressure += 1.0; break;
            case 'skills': core+=1.4; adv+=0.7; break;
            case 'insurance': adv+=1.2; ult+=0.8; pressure += 1.2; break;
            case 'change': adv+=1.2; ult+=0.4; pressure += 0.8; break;
          }
        });

        // Milestone focus (derived from discovery if not explicitly selected)
        switch(state.milestone){
          case 'baseline': core += 1; adv += 0.8; break;
          case 'operational': adv += 1.4; ult += 0.5; break;
          case 'evidence': adv += 1.0; ult += 1.4; pressure += 0.8; break;
          case 'explore': core += 0.8; break;
        }

        // Groups
        if(state.groups.has('soc')){ adv+=1.5; ult+=0.5; }
        if(state.groups.has('appsec')){ core+=1.2; adv+=1.0; }
        if(state.groups.has('exec')){ ult+=1.8; adv+=0.8; pressure += 1.2; }
        if(state.groups.has('workforce')){ core+=0.8; adv+=0.8; ult+=0.6; }
        if(state.groups.has('cloud')){ adv+=1.2; ult+=0.4; }
        if(state.groups.has('third')){ adv+=1.0; ult+=0.8; pressure += 0.8; }

        const gCount = state.groups.size;
        if(gCount >= 3){ adv += 0.9; }
        if(gCount >= 5){ ult += 0.8; pressure += 0.7; }

        // Rhythm
        switch(state.rhythm){
          case 'adhoc': core+=1.5; break;
          case 'quarterly': adv+=1.4; break;
          case 'monthly': adv+=1.8; ult+=0.5; break;
          case 'program': ult+=2.2; adv+=1.5; pressure += 1.2; break;
        }

        // Measurement
        switch(state.measure){
          case 'completion': core+=0.8; break;
          case 'performance': adv+=1.5; ult+=0.8; pressure += 0.6; break;
        }

        // Regs: small bias to evidence-grade tiers
        const regBias = ['dora','nis2','sec','nydfs','cmmc'];
        regBias.forEach(r=>{
          if(state.regs.has(r)){ adv += 0.25; ult += 0.35; pressure += 0.25; }
        });

        // Scale by revenue (secondary only)
        const revScale = Math.max(0.02, state.revenueB / 10);
        if(revScale < 0.5) core += 0.6;
        else if(revScale >= 2.5){ adv += 0.7; ult += 0.5; }
        else core += 0.2;

        // Package fit contribution
        const fit = fitCompute();
        if(fit.answeredCount){
          const w = 0.22;
          core += fit.totals.core * w;
          adv += fit.totals.adv * w;
          ult += fit.totals.ult * w;
          pressure += fit.pressureHint;
        }

        // Inferred outcomes nudge package logic
        const inferredOutcomeSet = new Set(inferredPrimaryOutcomes(3).map(o => o.id));
        if(inferredOutcomeSet.has('fasterResponse')){ adv += 0.9; ult += 0.5; pressure += 0.4; }
        if(inferredOutcomeSet.has('complianceEvidence')){ adv += 0.9; ult += 1.0; pressure += 0.9; }
        if(inferredOutcomeSet.has('secureEnterprise')){ core += 0.4; adv += 0.8; }
        if(inferredOutcomeSet.has('cyberWorkforce')){ core += 0.9; adv += 0.4; }
        if(inferredOutcomeSet.has('secureAI')){ adv += 0.9; ult += 0.6; pressure += 0.4; }
        if(inferredOutcomeSet.has('supplyChain')){ adv += 0.7; ult += 0.8; pressure += 0.5; }

        // Ultimate gate: external accountability + strategic framing + large scale.
        const externalAccountability =
          hasPressure('board') || hasPressure('regulator') || hasPressure('insurer') || hasPressure('customers') ||
          state.evidence.has('board') || state.evidence.has('reg') || state.evidence.has('insurer') || state.evidence.has('customer') ||
          state.drivers.includes('insurance');

        const strategicFraming =
          state.fitScope === 'enterprise' ||
          state.fitRealism === 'bespoke' ||
          state.fitRiskFrame === 'governance';

        const scaleSignal =
          (largeBands.has(state.companySize) ? 2 : (scaleBands.has(state.companySize) ? 1 : 0)) +
          (state.fitScope === 'enterprise' ? 1 : 0) +
          (state.groups.size >= 4 ? 1 : 0) +
          (state.region === 'Other' ? 1 : 0);

        const scaleLarge = scaleSignal >= 2;
        const strategicOrService = strategicFraming || state.fitServices === 'whiteglove';
        const ultObvious = externalAccountability && strategicOrService && scaleLarge;

        if(ultObvious){
          ult += 2.3;
          pressure += 1.0;
          if(state.fitServices === 'whiteglove') ult += 1.2; // accelerator, not requirement
          else ult += 0.4;
        }else{
          ult -= 1.0;
          if(!externalAccountability) ult -= 0.8;
          if(!strategicOrService) ult -= 0.6;
          if(!scaleLarge) ult -= 0.6;
        }

        if(state.fitServices === 'whiteglove') adv += 0.6;
        if(state.fitServices === 'guided') adv += 0.4;
        if(state.fitServices === 'diy') core += 0.4;

        if(pressure < 5 && !ultObvious) ult -= 0.8;

        core = Math.max(0, core);
        adv = Math.max(0, adv);
        ult = Math.max(0, ult);
        pressure = clamp(pressure, 0, 10);

        const pref = { core: 0, adv: 1, ult: 2 };
        const arr = [
          {k:'core', v:core},
          {k:'adv', v:adv},
          {k:'ult', v:ult}
        ].sort((a,b)=> (b.v - a.v) || (pref[a.k] - pref[b.k]));

        let best = arr[0].k;
        let gap = arr[0].v - arr[1].v;

        if(best === 'ult' && (!ultObvious && gap < 1.2)){
          best = 'adv';
          gap = 0;
        }else if(best === 'ult' && gap < 1.2){
          best = 'adv';
          gap = 0;
        }

        const conf = gap >= 3 ? 'strong' : gap >= 1.5 ? 'moderate' : 'directional';
        return { best, conf, scores: { core, adv, ult, pressure, scaleLarge: scaleLarge ? 1 : 0, ultObvious: ultObvious ? 1 : 0 } };
      }

      function driverTitle(id){
        const d = driverOpts.find(x => x.id === id);
        return d ? d.title : id;
      }
      function hasPressure(id){
        return Array.isArray(state.pressureSources) && state.pressureSources.includes(id);
      }
      function hasOutcomeDiscoveryInputs(){
        return (
          (state.pressureSources || []).length > 0 &&
          !!state.urgentWin &&
          (state.riskEnvs || []).length > 0 &&
          !!state.measuredOn &&
          !!state.orgPain
        );
      }

      function syncEvidenceFromPressure(){
        const mapped = new Set();
        if(hasPressure('board')) mapped.add('board');
        if(hasPressure('regulator')) mapped.add('reg');
        if(hasPressure('insurer')) mapped.add('insurer');
        if(hasPressure('customers')) mapped.add('customer');
        if(hasPressure('internal')) mapped.add('internal');
        state.evidence = mapped;
      }

      function outcomeLabel(id){
        const it = primaryOutcomeOpts.find(x => x.id === id);
        return it ? it.label : id;
      }

      function computePrimaryOutcomeScores(){
        const scores = {};
        primaryOutcomeOpts.forEach(o => { scores[o.id] = 0; });
        if(!hasOutcomeDiscoveryInputs()) return scores;

        const add = (id, n = 1)=>{
          if(typeof scores[id] !== 'number') return;
          scores[id] += n;
        };
        const addWhen = (cond, id, n = 1)=>{ if(cond) add(id, n); };
        const hasReg = (id)=> state.regs && state.regs.has(id);
        const hasGroup = (id)=> state.groups && state.groups.has(id);
        const hasStack = (id)=> state.stack && state.stack.has(id);

        // Discovery-first signals (primary)
        addWhen(hasPressure('board'), 'complianceEvidence', 2.2);
        addWhen(hasPressure('board'), 'fasterResponse', 1.0);
        addWhen(hasPressure('regulator'), 'complianceEvidence', 2.4);
        addWhen(hasPressure('insurer'), 'complianceEvidence', 1.6);
        addWhen(hasPressure('insurer'), 'supplyChain', 1.0);
        addWhen(hasPressure('customers'), 'supplyChain', 2.1);
        addWhen(hasPressure('customers'), 'complianceEvidence', 0.9);
        addWhen(hasPressure('internal'), 'secureEnterprise', 1.0);
        addWhen(hasPressure('internal'), 'cyberWorkforce', 1.0);

        switch(state.urgentWin){
          case 'boardEvidence':
            add('complianceEvidence', 4.0);
            add('fasterResponse', 0.4);
            break;
          case 'fasterDecisions':
            add('fasterResponse', 4.0);
            break;
          case 'attackSurface':
            add('secureEnterprise', 4.0);
            break;
          case 'safeAI':
            add('secureAI', 4.0);
            break;
          case 'workforce':
            add('cyberWorkforce', 4.0);
            break;
          case 'thirdParty':
            add('supplyChain', 4.0);
            break;
        }

        (state.riskEnvs || []).forEach((env)=>{
          switch(env){
            case 'code': add('secureEnterprise', 1.4); break;
            case 'cloud': add('secureEnterprise', 1.4); break;
            case 'identity': add('secureEnterprise', 1.3); break;
            case 'ot': add('secureEnterprise', 0.9); add('supplyChain', 1.2); break;
            case 'enterpriseApps': add('secureEnterprise', 1.0); break;
            case 'socir': add('fasterResponse', 2.1); break;
          }
        });

        switch(state.measuredOn){
          case 'mttd': add('fasterResponse', 2.0); break;
          case 'audit': add('complianceEvidence', 2.2); break;
          case 'vuln': add('secureEnterprise', 2.0); break;
          case 'training': add('cyberWorkforce', 2.0); break;
          case 'notMeasured': add('complianceEvidence', 1.0); add('cyberWorkforce', 0.8); add('fasterResponse', 0.4); break;
        }

        switch(state.orgPain){
          case 'skillsCoverage': add('cyberWorkforce', 2.4); break;
          case 'coordination': add('fasterResponse', 2.2); break;
          case 'externalProof': add('complianceEvidence', 2.4); break;
          case 'vendorRisk': add('supplyChain', 2.4); break;
          case 'aiRisk': add('secureAI', 3.2); break;
        }

        // Drivers (optional refiners)
        addWhen(state.drivers.includes('nearMiss'), 'fasterResponse', 1.2);
        addWhen(state.drivers.includes('sectorPeer'), 'fasterResponse', 0.8);
        addWhen(state.drivers.includes('sectorPeer'), 'supplyChain', 1.0);
        addWhen(state.drivers.includes('insurance'), 'complianceEvidence', 1.2);
        addWhen(state.drivers.includes('insurance'), 'supplyChain', 0.6);
        addWhen(state.drivers.includes('change'), 'secureEnterprise', 1.2);
        addWhen(state.drivers.includes('change'), 'secureAI', 1.1);
        addWhen(state.drivers.includes('skills'), 'cyberWorkforce', 1.6);

        // Secondary refiners (low weight so discovery remains decisive)
        addWhen(hasGroup('soc'), 'fasterResponse', 0.8);
        addWhen(hasGroup('exec'), 'fasterResponse', 0.4);
        addWhen(hasGroup('exec'), 'complianceEvidence', 0.6);
        addWhen(hasGroup('workforce'), 'cyberWorkforce', 1.0);
        addWhen(hasGroup('third'), 'supplyChain', 1.2);
        addWhen(hasGroup('appsec'), 'secureEnterprise', 0.5);
        addWhen(hasGroup('cloud'), 'secureEnterprise', 0.5);
        addWhen(hasGroup('identity'), 'secureEnterprise', 0.5);
        addWhen(hasGroup('itops'), 'secureEnterprise', 0.4);
        addWhen(hasGroup('product'), 'secureEnterprise', 0.5);
        addWhen(hasGroup('data'), 'complianceEvidence', 0.5);
        addWhen(hasGroup('grc'), 'complianceEvidence', 0.7);

        addWhen(state.fitRiskFrame === 'readiness', 'fasterResponse', 0.6);
        addWhen(state.fitRiskFrame === 'governance', 'complianceEvidence', 0.8);
        addWhen(state.fitRiskFrame === 'skills', 'cyberWorkforce', 0.8);
        addWhen(state.fitScope === 'enterprise', 'supplyChain', 0.4);
        addWhen(state.fitScope === 'enterprise', 'secureEnterprise', 0.4);

        addWhen(state.industry === 'Financial Services' || state.industry === 'Banking' || state.industry === 'Insurance', 'complianceEvidence', 0.5);
        addWhen(state.industry === 'Technology / SaaS', 'secureEnterprise', 0.4);
        addWhen(state.industry === 'Technology / SaaS', 'secureAI', 0.4);
        addWhen(state.industry === 'Manufacturing / Industrial', 'secureEnterprise', 0.5);
        addWhen(state.industry === 'Manufacturing / Industrial', 'supplyChain', 0.5);
        addWhen(state.industry === 'Transportation / Logistics', 'supplyChain', 0.6);

        ['dora','nis2','gdpr','sec','nydfs','soc2','cmmc'].forEach(id => addWhen(hasReg(id), 'complianceEvidence', 0.35));
        ['euaiact','iso42001','nistairmf'].forEach(id => addWhen(hasReg(id), 'secureAI', 0.6));
        ['nist800161','dfars7012','cmmc'].forEach(id => addWhen(hasReg(id), 'supplyChain', 0.5));
        ['iec62443','nist800218','nist800207','owasptop10'].forEach(id => addWhen(hasReg(id), 'secureEnterprise', 0.35));

        ['appsec','cloud','identity','network','ot'].forEach(id => addWhen(hasStack(id), 'secureEnterprise', 0.45));
        addWhen(hasStack('threat'), 'fasterResponse', 0.45);
        addWhen(hasStack('range'), 'cyberWorkforce', 0.55);
        addWhen(hasStack('ai'), 'secureAI', 0.7);

        const stackOtherTxt = String(state.stackOther || '').toLowerCase();
        addWhen(stackOtherTxt.includes('ai'), 'secureAI', 0.4);
        addWhen(stackOtherTxt.includes('supplier') || stackOtherTxt.includes('third'), 'supplyChain', 0.4);

        // Outcome drill-down answers: light confidence boost
        Object.entries(state.outcomeDrilldowns || {}).forEach(([outcomeId, answerId])=>{
          if(!answerId) return;
          add(outcomeId, 0.5);
        });

        return scores;
      }

      function inferredPrimaryOutcomes(max = 3){
        if(!hasOutcomeDiscoveryInputs()) return [];
        const scores = computePrimaryOutcomeScores();
        const rank = {};
        primaryOutcomeOpts.forEach((o, idx)=>{ rank[o.id] = idx; });
        const rows = primaryOutcomeOpts.map(o => ({
          id: o.id,
          label: o.label,
          short: o.short,
          desc: o.desc,
          score: Number(scores[o.id] || 0)
        })).sort((a,b)=> (b.score - a.score) || (rank[a.id] - rank[b.id]));

        const top = rows.length ? rows[0].score : 0;
        if(top <= 0) return [];
        const n = clamp(Number(max) || 3, 1, 3);
        return rows.slice(0, n);
      }

      function topOutcomePercentages(topOutcomes){
        const rows = Array.isArray(topOutcomes) ? topOutcomes : [];
        if(!rows.length) return {};
        const scores = computePrimaryOutcomeScores();
        const total = rows.reduce((sum, o)=> sum + Math.max(0, Number(scores[o.id] || o.score || 0)), 0);
        if(total <= 0) return {};

        const pctById = {};
        let used = 0;
        rows.forEach((o, idx)=>{
          const raw = Math.max(0, Number(scores[o.id] || o.score || 0));
          let pct = Math.round((raw / total) * 100);
          if(idx === rows.length - 1){
            pct = Math.max(0, 100 - used);
          }else{
            used += pct;
          }
          pctById[o.id] = pct;
        });
        return pctById;
      }

      function primaryOutcomesText(max = 3){
        const xs = inferredPrimaryOutcomes(max).map(o => o.short);
        if(!xs.length) return '';
        return xs.join('  ');
      }

      function syncMilestoneFromSignals(){
        const map = {
          boardEvidence: 'evidence',
          fasterDecisions: 'operational',
          attackSurface: 'baseline',
          safeAI: 'operational',
          workforce: 'baseline',
          thirdParty: 'evidence'
        };
        const inferred = map[state.urgentWin] || '';
        if(inferred){
          state.milestone = inferred;
          return;
        }
        if(!state.milestone && (state.drivers.length || (state.pressureSources || []).length || state.orgPain)) state.milestone = 'explore';
      }

      function outcomeById(id){
        return primaryOutcomeOpts.find(o => o.id === id) || null;
      }

      function tierWhyBullets(best, max = 3){
        return reasons(best)
          .filter(r => !String(r).startsWith('ROI estimate is based on Immersive assumptions'))
          .slice(0, max);
      }

      function buildNextMeetingAgenda(topOutcomes){
        const agenda = [];
        (topOutcomes || []).forEach(o=>{
          switch(o.id){
            case 'fasterResponse':
              agenda.push('Agree scenario scope, response KPIs (MTTD/MTTR/decision latency), and reporting cadence.');
              break;
            case 'secureEnterprise':
              agenda.push('Prioritize code/cloud/identity/OT backlog and define remediation SLA targets.');
              break;
            case 'secureAI':
              agenda.push('Confirm AI deployment posture, guardrails, and control testing plan.');
              break;
            case 'complianceEvidence':
              agenda.push('Lock framework mapping and define the evidence pack for board/regulator/insurer.');
              break;
            case 'cyberWorkforce':
              agenda.push('Set role-readiness baseline and the first upskilling/progression sprint.');
              break;
            case 'supplyChain':
              agenda.push('Prioritize critical suppliers and define third-party exercise cadence.');
              break;
          }
        });
        if(!agenda.length){
          agenda.push('Confirm top outcomes and baseline metrics.');
          agenda.push('Agree scope, cadence, and evidence audience.');
          agenda.push('Align pilot plan and stakeholder owners.');
        }
        return agenda.slice(0, 3);
      }

      function buildWhoToBring(topOutcomes){
        const who = ['Account Executive + Solutions Engineer'];
        const add = (txt)=>{ if(!who.includes(txt)) who.push(txt); };
        (topOutcomes || []).forEach(o=>{
          switch(o.id){
            case 'fasterResponse': add('SOC / Incident Response lead'); break;
            case 'secureEnterprise': add('AppSec / Cloud / IAM owner'); break;
            case 'secureAI': add('AI security or governance lead'); break;
            case 'complianceEvidence': add('GRC / Compliance lead'); break;
            case 'cyberWorkforce': add('Security enablement / L&D owner'); break;
            case 'supplyChain': add('Third-party risk / procurement lead'); break;
          }
        });
        return who.slice(0, 5);
      }

      function buildRecommendedResources(topOutcomes){
        const res = [];
        const add = (txt)=>{ if(!res.includes(txt)) res.push(txt); };
        (topOutcomes || []).forEach(o=>{
          switch(o.id){
            case 'fasterResponse': add('Crisis decision and IR benchmarking examples'); break;
            case 'secureEnterprise': add('Code/cloud/identity remediation benchmark pack'); break;
            case 'secureAI': add('AI governance + control validation starter pack'); break;
            case 'complianceEvidence': add('Framework-to-evidence mapping template (NIST / MITRE / DORA)'); break;
            case 'cyberWorkforce': add('Role-readiness and progression reporting template'); break;
            case 'supplyChain': add('Third-party resilience simulation playbook'); break;
          }
        });
        return res.slice(0, 3);
      }

      function reasons(best){
        const bullets = [];

        const lbl = (list, id) => {
          const it = (list || []).find(x => x.id === id);
          return it ? (it.label || it.title || id) : id;
        };

        const shorten = (arr, max=3) => {
          const xs = (arr || []).filter(Boolean);
          if(xs.length <= max) return xs.join('  ');
          return xs.slice(0, max).join('  ') + `  +${xs.length - max} more`;
        };

        const topOutcomes = inferredPrimaryOutcomes(3);

        // 1) Primary outcomes (always first)
        if(topOutcomes.length){
          bullets.push(`Primary outcomes in focus: ${topOutcomes.map(o => o.short).join('  ')}.`);
          bullets.push(topOutcomes[0].desc);
        }else{
          const outcome = primaryOutcome(best);
          bullets.push(`Primary outcome: ${outcome}.`);
        }

        // 2) Coverage (turn the selection into a sentence)
        const groups = Array.from(state.groups || []).map(id => lbl(groupOpts, id));
        if(groups.length){
          bullets.push(`Coverage: ${shorten(groups, 3)}.`);
        }else{
          bullets.push('Coverage: select who needs to be ready (SOC/IR, executives, developers, workforce, suppliers).');
        }

        // 3) Cadence + measurement (constructive sentence)
        const cadenceTitle = state.rhythm ? lbl(rhythmOpts, state.rhythm) : '';
        if(state.measure === 'performance'){
          bullets.push(`Youre aiming for ${cadenceTitle ? cadenceTitle.toLowerCase() : 'repeatable'} cyber resilience exercising, measured on performance (speed, accuracy, decision quality).`);
        }else if(state.measure === 'completion'){
          bullets.push(`Youre running ${cadenceTitle ? cadenceTitle.toLowerCase() : 'repeatable'} exercises and tracking completion  shifting to performance data strengthens proof and confidence.`);
        }else if(cadenceTitle){
          bullets.push(`Cadence today: ${cadenceTitle}.`);
        }

        // 4) Package fit signals (realism, scope, delivery)
        const fitBits = [];
        const fitRealismShort = { generic:'generic scenarios', tooling:'tooling-aware', bespoke:'mirror environment' };
        const fitScopeShort = { single:'single team', multi:'multi-team', enterprise:'enterprise / multi-region' };
        const fitTodayShort = { training:'training completion', adhoc:'ad hoc exercises', scrutiny:'under scrutiny' };
        const fitServicesShort = { diy:'self-serve', guided:'guided support', whiteglove:'managed partnership' };
        const fitRiskShort = { skills:'skills gap', readiness:'response outcomes', governance:'governance proof' };

        if(state.fitRealism) fitBits.push('realism: ' + (fitRealismShort[state.fitRealism] || state.fitRealism));
        if(state.fitScope) fitBits.push('scope: ' + (fitScopeShort[state.fitScope] || state.fitScope));
        if(state.fitToday) fitBits.push('today: ' + (fitTodayShort[state.fitToday] || state.fitToday));
        if(state.fitServices) fitBits.push('delivery: ' + (fitServicesShort[state.fitServices] || state.fitServices));
        if(state.fitRiskFrame) fitBits.push('framing: ' + (fitRiskShort[state.fitRiskFrame] || state.fitRiskFrame));

        if(fitBits.length){
          bullets.push(`Package fit: ${shorten(fitBits, 3)}.`);
        }

        // 4) Context (industry/region + frameworks) as a single, readable line
        const regionLabels = { NA:'North America', UKI:'UK & Ireland', EU:'Europe (EU)', APAC:'APAC', Other:'Other / Global' };

        const ctxBits = [];
        if(state.industry) ctxBits.push(state.industry);
        if(state.region) ctxBits.push(regionLabels[state.region] || state.region);
        const regs = Array.from(state.regs || []).map(id => lbl(regMaster, id));

        if(ctxBits.length && regs.length){
          bullets.push(`Context: ${ctxBits.join('  ')} mapped to ${shorten(regs, 4)}.`);
        }else if(ctxBits.length){
          bullets.push(`Context: ${ctxBits.join('  ')}.`);
        }else if(regs.length){
          bullets.push(`Framework / regulation mapping: ${shorten(regs, 4)}.`);
        }

        // 5) Why now (keep short)
        const whyNow = [];
        if(state.drivers.includes('nearMiss')) whyNow.push('incident / near miss');
        if(state.drivers.includes('sectorPeer')) whyNow.push('sector peer incident');
        if(hasPressure('board') || state.evidence.has('board')) whyNow.push('board scrutiny');
        if(hasPressure('regulator') || state.evidence.has('reg')) whyNow.push('regulator / audit');
        if(state.drivers.includes('insurance') || state.evidence.has('insurer')) whyNow.push('insurance renewal');
        if(state.drivers.includes('change')) whyNow.push('transformation risk');

        if(whyNow.length){
          bullets.push(`Why now: ${shorten(whyNow, 2)}.`);
        }else if(state.milestone){
          bullets.push(`First milestone: ${lbl(milestoneOpts, state.milestone)}.`);
        }

        // Keep at most 5 bullets + add the always-on disclaimer.
        const out = bullets.filter(Boolean).slice(0, 6);
        out.push('ROI estimate is based on Immersive assumptions and comparable organizations, and is intended for planning guidance.');
        return out;
      }

      function primaryOutcome(best){
        const inferred = inferredPrimaryOutcomes(1);
        if(inferred.length) return outcomeLabel(inferred[0].id);
        const pressure = score().scores.pressure;
        if(pressure >= 7) return 'Transform Compliance into Evidence & Benchmarks';
        if(best === 'adv') return 'Prove Faster Detection, Response & Decision-Making';
        return 'Baseline capability + gaps';
      }

      function phasePlan(best){
        const prove = [];
        if(state.groups.has('exec')) prove.push('Run a Crisis Simulation to test decision-making, comms, and accountability.');
        if(state.groups.has('soc')) prove.push('Run a team cyber range exercise to measure detection, investigation, and response coordination.');
        if(state.groups.has('workforce')) prove.push('Launch a workforce exercise to quantify human risk and target upskilling.');
        if(!prove.length) prove.push('Run a targeted drill to establish a defensible baseline for readiness.');

        const improve = [];
        if(state.groups.has('appsec')) improve.push('Assign secure coding labs to close gaps and reduce vulnerability flow to production.');
        if(state.groups.has('cloud')) improve.push('Assign cloud security labs to reduce misconfiguration risk and speed response.');
        if(state.groups.has('soc')) improve.push('Assign DFIR / threat hunting labs aligned to the techniques you want to cover.');
        if(!improve.length) improve.push('Assign targeted labs based on baseline results to close the biggest gaps fast.');

        const br = [];
        if(best === 'ult') br.push('Stand up executive evidence mapping and reporting for board / regulator conversations.');
        else br.push('Establish a benchmark cadence and track deltas over time.');
        br.push('Produce a stakeholder-ready summary: what improved, whats still at risk, and what were doing next.');

        return [
          'Prove: ' + prove.join(' '),
          'Improve: ' + improve.join(' '),
          'Benchmark & Report: ' + br.join(' ')
        ].join(' ');
      }

      function evidenceLine(){
        const list = [];
        if(state.evidence.has('board')) list.push('Board pack with trends + so what recommendations');
        if(state.evidence.has('reg')) list.push('Framework-aligned evidence map (audit / regulator)');
        if(state.evidence.has('insurer')) list.push('Insurer-ready narrative + controls / readiness proof points');
        if(state.evidence.has('customer')) list.push('Customer assurance support (due diligence responses)');
        if(state.evidence.has('internal')) list.push('Internal investment case backed by measurable outcomes');
        if(!list.length) return 'Evidence outputs tailored to your stakeholders (board, audit, insurer, customers).';
        return list.join('  ');
      }

      // ---------- ROI estimate maths ----------
      // Baseline assumptions are derived from Immersive delivery experience with similar organizations.
      const IMMERSIVE_MODEL = {
        baselineRevenueB: 10,
        baselineInvestment: 250000,
        baselineCyber: 200,
        baselineDev: 1000,
        baselineWorkforce: 3000,
        benefitsPVBreak: {
          attrition: 1341322,
          hires: 747262,
          devProd: 257837,
          training: 275742,
          posture: 257717
        },
        costsPVBreak: { internal: 52033 },
        yearBenefits: [765067, 1328817, 1445692],
        initialCost: 11000,
        internalAnnual: 16500
      };

      const PV_FACTOR_3YR_10 = 2.48685;

      function inferProgramScale(revB){
        const revScale = Math.max(0.02, (Number(revB)||0) / IMMERSIVE_MODEL.baselineRevenueB);

        let cyber = IMMERSIVE_MODEL.baselineCyber * Math.pow(revScale, 0.60);
        let dev   = IMMERSIVE_MODEL.baselineDev   * Math.pow(revScale, 0.70);
        let wf    = IMMERSIVE_MODEL.baselineWorkforce * Math.pow(revScale, 0.70);

        cyber = clamp(Math.round(cyber / 5) * 5, 10, 1500);
        dev   = clamp(Math.round(dev / 50) * 50, 50, 8000);
        wf    = clamp(Math.round(wf / 250) * 250, 200, 200000);

        return { cyber, dev, wf, revScale };
      }

      // Pricing is driven primarily by how many people are exercised (and their roles),
      // plus configuration / cadence. We approximate that here with weighted "seat units" so footprint
      // changes visibly move the estimated spend.
      const COST_MODEL = {
  // Pricing is driven primarily by who is exercised (and their roles), plus cadence / scope.
  // We approximate that with weighted "seat units" and a volume-discount curve.
  // Tuned so most mid/large enterprises land around ~$500k$1M/yr, with multi-million
  // edge cases supported for strategic enterprise deals.
  wCyber: 2.50,   // cyber / IR roles are range-heavy (highest unit weight)
  wDev:   1.00,   // devs are lab-heavy (mid unit weight)
  wWf:    0.02,   // wider workforce has a *very* light influence (directional only)
  alpha:  0.90    // modest volume discount (keeps outputs sane, can reach higher enterprise ranges)
};

      function weightedSeatUnits(cyber, dev, wf){
        return (Number(cyber)||0) * COST_MODEL.wCyber +
               (Number(dev)||0)   * COST_MODEL.wDev +
               (Number(wf)||0)    * COST_MODEL.wWf;
      }

      const BASE_WEIGHTED_SEATS = weightedSeatUnits(IMMERSIVE_MODEL.baselineCyber, IMMERSIVE_MODEL.baselineDev, IMMERSIVE_MODEL.baselineWorkforce);

      function typicalInvestment(revB, footprint = {}){
        const suggested = footprint.suggested || inferProgramScale(revB);
        const cyber = Number(footprint.cyber) || suggested.cyber;
        const dev   = Number(footprint.dev)   || suggested.dev;
        const wf    = Number(footprint.wf)    || suggested.wf;

        const weighted = weightedSeatUnits(cyber, dev, wf);
        const seatScale = (BASE_WEIGHTED_SEATS > 0) ? (weighted / BASE_WEIGHTED_SEATS) : 1;

        // Keep the model stable at extremes:
        // - floor prevents spend collapsing to near-zero for small orgs
        // - ceiling avoids absurd outputs for very large / mismatched inputs
        let invUSD = IMMERSIVE_MODEL.baselineInvestment * Math.pow(clamp(seatScale, 0.08, 25), COST_MODEL.alpha);

        invUSD = clamp(invUSD, 25000, 9000000);
        invUSD = Math.round(invUSD / 5000) * 5000;
        return invUSD;
      }


      function realizationFactor(){
        if(state.realization === 'conservative') return 0.60;
        if(state.realization === 'expected') return 0.80;
        return 1.00; // Immersive base
      }

      function computeRoi(){
        const invest = Number(state.investUSD)||0;
        const revB = Number(state.revenueB)||0;

        const suggested = inferProgramScale(revB);

        const cyber = Number(state.teamCyber)||suggested.cyber;
        const dev   = Number(state.teamDev)||suggested.dev;
        const wf    = Number(state.teamWf)||suggested.wf;

        const typInvest = typicalInvestment(revB, { cyber, dev, wf, suggested });


        const cyberScale = cyber / IMMERSIVE_MODEL.baselineCyber;
        const devScale = dev / IMMERSIVE_MODEL.baselineDev;
        const postureScale = Math.pow(suggested.revScale, 0.70);

        // Salary sensitivity (directional)
        const BASE_CYBER_SAL = 180000;
        const BASE_DEV_SAL = 160000;
        const salaryCyberScale = clamp((Number(state.cyberSalaryUSD)||BASE_CYBER_SAL) / BASE_CYBER_SAL, 0.5, 2.0);
        const salaryDevScale = clamp((Number(state.devSalaryUSD)||BASE_DEV_SAL) / BASE_DEV_SAL, 0.5, 2.0);

        let benefitsPV =
          (IMMERSIVE_MODEL.benefitsPVBreak.attrition * cyberScale * salaryCyberScale) +
          (IMMERSIVE_MODEL.benefitsPVBreak.hires * cyberScale * salaryCyberScale) +
          (IMMERSIVE_MODEL.benefitsPVBreak.devProd * devScale * salaryDevScale) +
          (IMMERSIVE_MODEL.benefitsPVBreak.training * cyberScale * salaryCyberScale) +
          (IMMERSIVE_MODEL.benefitsPVBreak.posture * postureScale);

        // Diminishing returns if investment deviates from suggested (keeps maths sensible)
        const invRatio = typInvest > 0 ? invest / typInvest : 1;
        const invScale = Math.pow(clamp(invRatio, 0.4, 1.6), 0.85);

        benefitsPV = benefitsPV * invScale * realizationFactor();

        const subscriptionPV = invest * PV_FACTOR_3YR_10;
        const internalPV = IMMERSIVE_MODEL.costsPVBreak.internal * Math.pow(suggested.revScale, 0.25);
        const costsPV = subscriptionPV + internalPV;

        const npv = benefitsPV - costsPV;
        const roi = costsPV > 0 ? (npv / costsPV) : 0;

        return { benefitsPV, costsPV, npv, roi, suggested, typInvest };
      }

      const MODEL_BENEFITS_PV = Object.values(IMMERSIVE_MODEL.benefitsPVBreak).reduce((a,b)=>a+b,0);

      function computePaybackMonths(roi){
        const delay = clamp(Number(state.paybackDelayMonths)||0, 0, 12);

        const benefitScale = MODEL_BENEFITS_PV > 0 ? (roi.benefitsPV / MODEL_BENEFITS_PV) : 1;
        const yearBenefits = (IMMERSIVE_MODEL.yearBenefits || [0,0,0]).map(v => v * benefitScale);

        const internalScale = Math.pow(roi.suggested.revScale, 0.25);
        const initial = (IMMERSIVE_MODEL.initialCost || 0) * internalScale;
        const internalAnnual = (IMMERSIVE_MODEL.internalAnnual || 0) * internalScale;

        const annualCost = (Number(state.investUSD)||0) + internalAnnual;

        let cum = -initial;

        for(let m=1; m<=36; m++){
          const y = Math.floor((m-1)/12);
          const monthlyCost = annualCost / 12;
          const monthlyBenefit = (m <= delay) ? 0 : (yearBenefits[y] / 12);
          cum += (monthlyBenefit - monthlyCost);
          if(cum >= 0) return m;
        }
        return null;
      }

      function fmtPayback(months){
        if(months === null || months === undefined) return '';
        if(months <= 0) return 'Immediate';
        if(months < 12) return `~${Math.round(months)} mo`;
        const yrs = months / 12;
        return `~${yrs.toFixed(1).replace(/\.0$/,'')} yrs`;
      }

      // ---------- Update UI ----------
      function update(){
        const setText = (sel, val) => {
          const el = $(sel);
          if(!el) return;
          const next = String(val ?? '');
          if(el.textContent === next) return;
          el.textContent = next;
          if(snapshotMotionReady && isSnapshotValueSelector(sel)){
            replayMotionClass(el, 'is-refresh', 260);
          }
        };
        const setHTML = (sel, val) => {
          const el = $(sel);
          if(!el) return;
          const next = String(val ?? '');
          if(el.innerHTML === next) return;
          el.innerHTML = next;
          if(snapshotMotionReady && isSnapshotValueSelector(sel)){
            replayMotionClass(el, 'is-refresh', 260);
          }
        };

        setView(state.currentView, { render:false });
        syncGlobalActionBar();
        renderDashboardRows();
        renderArchivedRows();
        renderWorkspaceCompanies();
        renderArchiveNavMeta();
        renderInterstitialView();
        const jumpBtns = $$('[data-jump-next-incomplete]');
        const jumpLabels = $$('.jumpNextIncompleteBtnLabel');
        if(jumpBtns.length){
          const nextIncomplete = nextIncompleteStepFrom(state.activeStep);
          if(nextIncomplete === null){
            jumpBtns.forEach((jumpBtn)=>{
              jumpBtn.disabled = true;
              jumpBtn.title = 'All sections complete';
            });
            jumpLabels.forEach((jumpLabel)=>{ jumpLabel.textContent = 'All complete'; });
          }else{
            jumpBtns.forEach((jumpBtn)=>{
              jumpBtn.disabled = false;
              jumpBtn.title = `Jump to next incomplete section (Step ${nextIncomplete})`;
            });
            jumpLabels.forEach((jumpLabel)=>{ jumpLabel.textContent = 'Next incomplete'; });
          }
        }
        const saveBtn = $('#saveRecordBtn');
        const saveLabel = $('#saveRecordBtnLabel');
        if(saveBtn){
          const isThinking = !!state.saveIsThinking;
          const justSaved = !isThinking && Date.now() < (state.savePulseUntil || 0);
          saveBtn.dataset.saved = justSaved ? 'true' : 'false';
          saveBtn.dataset.thinking = isThinking ? 'true' : 'false';
          saveBtn.setAttribute('aria-busy', isThinking ? 'true' : 'false');
          if(saveLabel){
            saveLabel.textContent = isThinking ? 'Saving...' : (justSaved ? 'Saved' : 'Save record');
          }
        }

        const labelFrom = (list, id) => {
          const it = (list||[]).find(x => x.id === id);
          if(!it) return id;
          return it.label || it.title || id;
        };

        const regionLabels = { NA:'North America', UKI:'UK & Ireland', EU:'Europe (EU)', APAC:'APAC', Other:'Other / Global' };
        const liveGaps = dashboardCurrentGaps();
        const gapSteps = new Set(
          liveGaps.map((gap)=> clamp(Number(gap && gap.step) || 1, 1, 6))
        );

        syncMilestoneFromSignals();
        syncEvidenceFromPressure();

        // Context-driven regulatory suggestions (industry + region)
        syncContextRegSignals();
        syncRegModeUI();

        // Render the (dynamic) regulatory options list
        renderOptionButtons($('#optRegs'), regOptionsForUI(), state.regs, ()=>{
          state.regsTouched = true;
        });

        const topOutcomes = inferredPrimaryOutcomes(3);
        const topOutcomePct = topOutcomePercentages(topOutcomes);
        const top3 = $('#outcomeTop3');
        if(top3){
          const topOutcomeSig = topOutcomes.length
            ? topOutcomes.map(o => `${o.id}:${Number(topOutcomePct[o.id] || 0)}`).join('|')
            : 'empty';
          if(!topOutcomes.length){
            if(top3.dataset.sig !== topOutcomeSig){
              top3.textContent = 'Complete the discovery questions above to see your top outcomes.';
              top3.classList.remove('is-stagger');
              top3.dataset.sig = topOutcomeSig;
              top3.dataset.pctAnimated = 'true';
            }
          }else{
            if(top3.dataset.sig !== topOutcomeSig){
              top3.innerHTML = topOutcomes.map((o, i)=>
                `<div class="outcomeTopItem" style="--row-i:${i};"><span class="outcomeBadge">${i+1}</span><span class="outcomeTopLabel">${escapeHtml(o.label)}</span><span class="outcomeTopPct" data-target-pct="${Number(topOutcomePct[o.id] || 0)}">${Number(topOutcomePct[o.id] || 0)}%</span></div>`
              ).join('');
              top3.dataset.sig = topOutcomeSig;
              top3.dataset.pctAnimated = 'false';
              if(!prefersReducedMotion()){
                replayMotionClass(top3, 'is-stagger', 520);
              }else{
                top3.classList.remove('is-stagger');
              }
            }
            ensureOutcomeTopObserver(top3);
            if(isElementInViewport(top3, 0.28)) animateOutcomeTopPercentages(top3);
          }
        }
        setText('#outcomePlaybackConfirm',
          topOutcomes.length
            ? 'Ordered by weighted fit from your selections. Percentages show the relative weighting across these top outcomes.'
            : 'These outcomes are derived from your previous answers.'
        );
        renderOutcomeCards(topOutcomes);
        renderOutcomeDrilldowns(topOutcomes);
        setSelectionPill('#riskEnvMeta', (state.riskEnvs || []).length, 2);


        const joinFromSet = (setRef, list) => {
          const ids = Array.from(setRef || []);
          if(!ids.length) return '';
          return ids.map(id => labelFrom(list, id)).join('  ');
        };

        const joinArray = (arr, list) => {
          const ids = Array.from(arr || []);
          if(!ids.length) return '';
          return ids.map(id => labelFrom(list, id)).join('  ');
        };
        const lbl = labelFrom;

        // Driver meta
        setSelectionPill('#driverMeta', state.drivers.length, 3);
        setSelectionPill('#pressureMeta', (state.pressureSources || []).length, 3);

        // Recommendation
        const rec = score();
        const tier = (rec.best === 'core') ? packages.core : (rec.best === 'adv') ? packages.adv : packages.ult;

        setText('#recTitle', `${tier.name} package`);
        setText('#recDesc', `${tier.tagline}  ${tier.desc}`);

        const rs = reasons(rec.best);
        const reasonsHtml = rs.map(r => `<li><span class="dot"></span><div>${escapeHtml(r)}</div></li>`).join('');
        const reasonsEl = $('#reasons');
        if(reasonsEl) reasonsEl.innerHTML = reasonsHtml;
        setText('#sideWhySummary', `Why this package  ${rs.length} reason${rs.length === 1 ? '' : 's'}`);

        const sideWhy = $('#sideWhyBlock');
        const sideRoi = $('#sideRoiBlock');
        const sideAnswers = $('#sideAnswersBlock');
        const autoOpen = (el, open)=>{
          if(!el) return;
          if(el.dataset.userSet === 'true') return;
          const want = !!open;
          if(el.open !== want){
            el.dataset.autoToggle = 'true';
            el.open = want;
          }
        };
        autoOpen(sideWhy, false);
        autoOpen(sideRoi, state.activeStep >= 5 || state.visited.has(5));
        autoOpen(sideAnswers, true);

        const sideAnswersBody = sideAnswers ? sideAnswers.querySelector('.sideAnswersBody') : null;
        if(sideAnswers && sideAnswersBody){
          if(sideAnswers.open){
            const sideAnswersSummary = sideAnswers.querySelector('summary');
            const summaryH = sideAnswersSummary ? sideAnswersSummary.offsetHeight : 0;
            const availableH = Math.max(120, sideAnswers.clientHeight - summaryH);
            sideAnswersBody.style.maxHeight = `${availableH}px`;
          }else{
            sideAnswersBody.style.maxHeight = '';
          }
        }

        const inputAccByStep = {
          1: ['inputAccAbout'],
          2: ['inputAccCoverage'],
          3: ['inputAccFit'],
          4: ['inputAccContext'],
          5: ['inputAccRoi'],
          6: ['inputAccReview']
        };
        const openAccordions = new Set(inputAccByStep[state.activeStep] || []);
        const inputsCol = $('#inputsCol');
        if(inputsCol){
          $$('.inputAccordion', inputsCol).forEach((acc)=>{
            acc.open = openAccordions.has(acc.id);
            const stepForAcc = Number(Object.keys(inputAccByStep).find((stepNo)=>{
              return (inputAccByStep[stepNo] || []).includes(acc.id);
            })) || null;
            const hasGap = stepForAcc ? gapSteps.has(stepForAcc) : false;
            acc.dataset.incomplete = hasGap ? 'true' : 'false';
          });
        }

        const sidePrimaryOutcome = $('#sidePrimaryOutcome');
        if(sidePrimaryOutcome){
          const sideOutcomeSig = topOutcomes.length
            ? topOutcomes.map(o => o.id).join('|')
            : 'empty';
          if(topOutcomes.length){
            if(sidePrimaryOutcome.dataset.sig !== sideOutcomeSig){
              const staggerClass = prefersReducedMotion() ? '' : ' is-stagger';
              sidePrimaryOutcome.innerHTML = `<div class="sideOutcomeList${staggerClass}" data-count="${topOutcomes.length}">${topOutcomes.map((o, i)=>{
                const meta = outcomeById(o.id) || o;
                const text = meta.short || meta.label || '';
                return `<div class="sideOutcomeItem" style="--item-i:${i};"><span class="sideOutcomeRank">${i + 1}</span><span class="sideOutcomeText">${escapeHtml(text)}</span></div>`;
              }).join('')}</div>`;
              sidePrimaryOutcome.dataset.sig = sideOutcomeSig;
            }
          }else{
            if(sidePrimaryOutcome.dataset.sig !== sideOutcomeSig){
              sidePrimaryOutcome.textContent = 'Complete Step 0 to infer your top outcomes.';
              sidePrimaryOutcome.dataset.sig = sideOutcomeSig;
            }
          }
        }
// ROI estimate
        const revLabel = $('#revenueLabel');
        if(revLabel) revLabel.textContent = fmtRevenueFromUSDB(state.revenueB);

        const roi = computeRoi();
        const paybackMonths = computePaybackMonths(roi);

        const roiPctVal = roi.roi * 100;
        const npvVal = roi.npv;
        const spendVal = state.investUSD;
        const roiTxt = Math.round(roiPctVal) + '%';
        const npvTxt = fmtMoneyCompactUSD(npvVal, { signed:true, sig:3 });
        const paybackTxt = fmtPayback(paybackMonths);
        const spendTxt = fmtMoneyCompactUSD(spendVal, { sig:3 }) + '/yr';
        const showROI = state.visited.has(5);

        const moneyFmtSig = `cur:${state.currency}`;
        tweenMetricText($('#roiOut'), roiPctVal, (v)=> `${Math.round(v)}%`, { duration: 320, formatSig: 'pct' });
        tweenMetricText($('#npvOut'), npvVal, (v)=> fmtMoneyCompactUSD(v, { signed:true, sig:3 }), { duration: 380, formatSig: moneyFmtSig });
        tweenMetricText($('#paybackOut'), paybackMonths, (v)=> fmtPayback(v), { duration: 320, formatSig: 'payback' });
        tweenMetricText($('#valueInputsOut'), spendVal, (v)=> `${fmtMoneyCompactUSD(v, { sig:3 })}/yr`, { duration: 380, formatSig: moneyFmtSig });

        // Snapshot ROI estimate (hide until ROI step is visited)
        const roiGrid = $('#roiSnapGrid');
        const roiNote = $('#roiSnapNote');
        if(roiGrid) roiGrid.classList.toggle('hide', !showROI);
        if(roiNote) roiNote.classList.toggle('hide', showROI);

        if(showROI){
          tweenMetricText($('#roiSnap'), roiPctVal, (v)=> `${Math.round(v)}%`, { duration: 320, formatSig: 'pct' });
          tweenMetricText($('#npvSnap'), npvVal, (v)=> fmtMoneyCompactUSD(v, { signed:true, sig:3 }), { duration: 380, formatSig: moneyFmtSig });
          tweenMetricText($('#paybackSnap'), paybackMonths, (v)=> fmtPayback(v), { duration: 320, formatSig: 'payback' });
          tweenMetricText($('#valueInputs'), spendVal, (v)=> `${fmtMoneyCompactUSD(v, { sig:3 })}/yr`, { duration: 380, formatSig: moneyFmtSig });
        }else{
          setText('#roiSnap', '');
          setText('#npvSnap', '');
          setText('#paybackSnap', '');
          setText('#valueInputs', '');
        }
        setText('#snapRoiPct', showROI ? roiTxt : 'Complete Step 4');
        setText('#snapRoiNpv', showROI ? npvTxt : '');
        setText('#snapRoiPayback', showROI ? paybackTxt : '');
        setText('#snapRoiSpend', showROI ? spendTxt : '');
// Key selections (snapshot)
        const milestoneTitle = state.milestone ? labelFrom(milestoneOpts, state.milestone) : '';
        const urgentWinTitle = state.urgentWin ? labelFrom(urgentWinOpts, state.urgentWin) : '';
        const measuredOnTitle = state.measuredOn ? labelFrom(measuredOnOpts, state.measuredOn) : '';
        const orgPainTitle = state.orgPain ? labelFrom(orgPainOpts, state.orgPain) : '';
        const rhythmTitle = state.rhythm ? labelFrom(rhythmOpts, state.rhythm) : '';
        const measureTitle = state.measure ? labelFrom(measureOpts, state.measure) : '';
        const outcomesTxt = primaryOutcomesText(3);

        const toLabels = (ids, list) => (Array.from(ids || [])).map(id => labelFrom(list, id)).filter(Boolean);
        const pressureLabels = toLabels(state.pressureSources || [], pressureOpts.map(p => ({ id:p.id, label:p.title })));
        const riskEnvLabels = toLabels(state.riskEnvs || [], riskEnvOpts.map(r => ({ id:r.id, label:r.title })));
        const driverLabels = toLabels(state.drivers || [], driverOpts.map(d => ({ id:d.id, label:d.title })));
        const evidenceLabels = toLabels(Array.from(state.evidence || []), evidenceOpts);
        const groupLabels = toLabels(Array.from(state.groups || []), groupOpts);
        const regsLabels = toLabels(Array.from(state.regs || []), regMaster);
        const stackLabels = toLabels(Array.from(state.stack || []), stackMaster);
        if(state.stackOther && String(state.stackOther).trim()){
          stackLabels.push(String(state.stackOther).trim());
        }

        const pressureTitle = pressureLabels.length ? pressureLabels.join('  ') : '';
        const riskEnvTxt = riskEnvLabels.length ? riskEnvLabels.join('  ') : '';
        const driversTxt = driverLabels.length ? driverLabels.join('  ') : '';
        const evidenceTxt = evidenceLabels.length ? evidenceLabels.join('  ') : '';
        const groupsTxt = groupLabels.length ? groupLabels.join('  ') : '';
        const regsTxt = regsLabels.length ? regsLabels.join('  ') : '';
        const stackTxt = stackLabels.length ? stackLabels.join('  ') : '';

        const chipsHTML = (items, maxVisible=3) => {
          const vals = (items || []).map(v => String(v || '').trim()).filter(Boolean);
          if(!vals.length) return '<span class="kvEmpty"></span>';
          const shown = vals.slice(0, maxVisible);
          const hidden = vals.slice(maxVisible);
          const shownHtml = shown.map(v => `<span class="valueChip">${escapeHtml(v)}</span>`).join('');
          if(!hidden.length) return `<div class="chipsInline">${shownHtml}</div>`;
          const hiddenHtml = hidden.map(v => `<span class="valueChip">${escapeHtml(v)}</span>`).join('');
          return `<div class="chipsInline">${shownHtml}</div><details class="chipsMore"><summary>+${hidden.length} more</summary><div class="chipsInline">${hiddenHtml}</div></details>`;
        };
        const short = (v, max=26) => {
          const s = String(v || '').trim();
          if(!s) return '';
          return s.length > max ? (s.slice(0, max - 1) + '') : s;
        };

        const ctxBits = [];
        if(state.industry) ctxBits.push(state.industry);
        if(state.region) ctxBits.push(regionLabels[state.region] || state.region);
        const ctxTxt = ctxBits.length ? ctxBits.join('  ') : '';
        const contextNote = $('#contextFromStep0');
        if(contextNote){
          contextNote.textContent = (ctxTxt === '')
            ? 'Complete Step 0 to personalize regulation suggestions.'
            : `Using ${ctxTxt} to tailor suggested regulations.`;
        }

        // Side snapshot (decision + selections)
        setHTML('#snapPressure', chipsHTML(pressureLabels, 99));
        setHTML('#snapDrivers', chipsHTML(driverLabels, 99));
        setText('#snapMilestone', urgentWinTitle !== '' ? urgentWinTitle : milestoneTitle);
        setHTML('#snapRiskEnv', chipsHTML(riskEnvLabels, 99));
        setText('#snapMeasuredOn', measuredOnTitle);
        setText('#snapOrgPain', orgPainTitle);
        setHTML('#snapEvidence', chipsHTML(evidenceLabels, 99));
        setHTML('#snapOutcomes', chipsHTML(topOutcomes.map(o => o.short || o.label), 99));
        setHTML('#snapGroups', chipsHTML(groupLabels, 99));

        // Package fit snapshot
        const fitRealismSnap = state.fitRealism ? ((fitSnapLabels.fitRealism && fitSnapLabels.fitRealism[state.fitRealism]) || lbl(fitRealismOpts, state.fitRealism)) : '';
        const fitScopeSnap = state.fitScope ? ((fitSnapLabels.fitScope && fitSnapLabels.fitScope[state.fitScope]) || lbl(fitScopeOpts, state.fitScope)) : '';
        const fitTodaySnap = state.fitToday ? ((fitSnapLabels.fitToday && fitSnapLabels.fitToday[state.fitToday]) || lbl(fitTodayOpts, state.fitToday)) : '';
        const fitServicesSnap = state.fitServices ? ((fitSnapLabels.fitServices && fitSnapLabels.fitServices[state.fitServices]) || lbl(fitServicesOpts, state.fitServices)) : '';
        const fitRiskSnap = state.fitRiskFrame ? ((fitSnapLabels.fitRiskFrame && fitSnapLabels.fitRiskFrame[state.fitRiskFrame]) || lbl(fitRiskFrameOpts, state.fitRiskFrame)) : '';

        setText('#snapFitRealism', fitRealismSnap);
        setText('#snapFitScope', fitScopeSnap);
        setText('#snapFitToday', fitTodaySnap);
        setText('#snapFitServices', fitServicesSnap);
        setText('#snapFitRisk', fitRiskSnap);

        setText('#snapCadence', rhythmTitle);
        setText('#snapMeasurement', measureTitle);

        setText('#snapIndustry', state.industry ? state.industry : '');
        setText('#snapRegion', state.region ? (regionLabels[state.region] || state.region) : '');
        setHTML('#snapRegulatory', chipsHTML(regsLabels, 99));

        setHTML('#snapStack', chipsHTML(stackLabels, 99));

        const stackOtherLower = String(state.stackOther || '').toLowerCase();
        let grcLabel = '';
        if(stackOtherLower.includes('servicenow')) grcLabel = 'ServiceNow';
        else if(stackOtherLower.includes('archer')) grcLabel = 'Archer';
        else if(state.stack.has('grc')) grcLabel = 'ServiceNow / Archer';
        setText('#snapGrc', grcLabel);

        const sizeMapInline = {
          'lt500':'< 500',
          '500-2k':'5002,000',
          '2k-10k':'2,00010,000',
          '10k-50k':'10,00050,000',
          '50kplus':'50,000+'
        };
        const roleLabelInline = state.role ? labelFrom(roleOpts, state.role) : '';
        const companySizeInline = state.companySize ? (sizeMapInline[state.companySize] || state.companySize) : '';
        setText('#snapOrgRole', roleLabelInline);
        setText('#snapOrgName', state.fullName || '');
        setText('#snapOrgCompany', state.company || '');
        setText('#snapOrgCountry', state.operatingCountry || '');
        setText('#snapOrgSize', companySizeInline);
        setText('#snapReviewPackage', `${tier.name} package`);
        setHTML('#snapReviewOutcomes', chipsHTML(topOutcomes.map(o => o.short || o.label), 99));

        // captured count
        const selTotal = 14;
        const fitAnsweredCount = ['fitRealism','fitScope','fitToday','fitServices','fitRiskFrame'].filter(k => !!state[k]).length;
        const discoveryDone =
          (state.pressureSources || []).length > 0 &&
          !!state.urgentWin &&
          !!state.measuredOn &&
          !!state.orgPain &&
          (state.riskEnvs || []).length > 0;

        const selDone =
          ((state.role || state.fullName || state.company || state.companySize || state.operatingCountry) ? 1 : 0) +
          (discoveryDone ? 1 : 0) +
          (state.drivers.length ? 1 : 0) +
          (state.evidence.size ? 1 : 0) +
          (state.groups.size ? 1 : 0) +
          (state.rhythm ? 1 : 0) +
          (state.measure ? 1 : 0) +
          (fitAnsweredCount ? 1 : 0) +
          ((state.industry || state.region) ? 1 : 0) +
          (state.regs.size ? 1 : 0) +
          ((state.stack.size || state.stackOther) ? 1 : 0) +
          (state.visited.has(5) ? 1 : 0) +
          (topOutcomes.length ? 1 : 0) +
          (Object.keys(state.outcomeDrilldowns || {}).length ? 1 : 0);

        setText('#selPill', `${selDone}/${selTotal} captured`);

        // Step completion + incomplete highlighting
        const done1 = !gapSteps.has(1);
        const done2 = !gapSteps.has(2);
        const done3 = !gapSteps.has(3);
        const done4 = !gapSteps.has(4);
        const done5 = !gapSteps.has(5);
        const done6 = false;
        const chipLabel = { 1:'0', 2:'1', 3:'2', 4:'3', 5:'4', 6:'5' };

        $$('.chip').forEach(ch=>{
          const step = Number(ch.dataset.chip);
          const strong = ch.querySelector('strong');
          const wasDone = ch.dataset.done === 'true';
          const isDone =
            (step===1 && done1) ||
            (step===2 && done2) ||
            (step===3 && done3) ||
            (step===4 && done4) ||
            (step===5 && done5) ||
            (step===6 && done6);

          ch.dataset.done = isDone ? 'true' : 'false';
          ch.dataset.incomplete = (!isDone && gapSteps.has(step)) ? 'true' : 'false';
          if(strong){
            strong.textContent = isDone ? '' : (chipLabel[step] || String(step));
            if(!wasDone && isDone){
              replayMotionClass(strong, 'tick-pop', 300);
            }
          }
        });
        $$('.step').forEach((stepEl)=>{
          const stepNo = clamp(Number(stepEl.dataset.step) || 1, 1, 6);
          const hasGap = gapSteps.has(stepNo);
          stepEl.dataset.incomplete = hasGap ? 'true' : 'false';
          $$('.qBlock', stepEl).forEach((block)=>{
            block.classList.toggle('is-incomplete', hasGap);
          });
        });

        // Your plan view
        setText('#planTitle', `${tier.name} is the best starting point`);
        setText('#planDesc', `${tier.tagline} ${tier.desc}`);
setText('#primaryOutcome', primaryOutcome(rec.best));
        setText('#coverageKpi', groupsTxt);

        const planReasons = $('#planReasons');
        if(planReasons) planReasons.innerHTML = reasonsHtml;

        setText('#plan90', phasePlan(rec.best));
        setText('#planEvidence', evidenceLine());

        // Review: our understanding (Step 5)
        const sizeMap = {
          'lt500':'< 500 employees',
          '500-2k':'5002,000 employees',
          '2k-10k':'2,00010,000 employees',
          '10k-50k':'10,00050,000 employees',
          '50kplus':'50,000+ employees'
        };

        const line = (k, v) => {
          const key = escapeHtml(k);
          const val = escapeHtml((v && String(v).trim()) ? v : '');
          return `<div class="sumLine"><span class="sumK">${key}</span><span class="sumV">${val}</span></div>`;
        };

        // Organisation (who you are)
        const orgBits = [];
        if(state.role){
          const r = roleOpts.find(x => x.id === state.role);
          orgBits.push(`Role: ${r ? r.label : state.role}`);
        }
        if(state.company) orgBits.push(state.company);
        if(state.companySize) orgBits.push(sizeMap[state.companySize] || state.companySize);
        if(state.operatingCountry) orgBits.push(`Country: ${state.operatingCountry}`);
        if(state.fullName) orgBits.push(`Contact: ${state.fullName}`);
        const orgTxt = orgBits.length ? orgBits.join('  ') : '';
        setHTML('#sumOrg', escapeHtml(orgTxt));

        // ROI inputs (how you sized)
        if(showROI){
          const valueBits = [];
          valueBits.push(`Revenue/budget: ${fmtRevenueFromUSDB(state.revenueB)}`);
          valueBits.push(`Spend: ${fmtMoneyUSD(state.investUSD)}/yr`);
          valueBits.push(`Footprint: ~${fmtNum(state.teamCyber)} cyber  ~${fmtNum(state.teamDev)} dev  ~${fmtNum(state.teamWf)} workforce`);
          const valueTxt = valueBits.join('  ');
          setHTML('#sumValue', escapeHtml(valueTxt));
        } else {
          setHTML('#sumValue', escapeHtml('Complete Step 4 to generate an Immersive estimate based on comparable organizations.'));
        }

        // Mandate
        setHTML('#sumMandate', [
          line('Pressure sources', pressureTitle),
          line('Urgent 90-day win', urgentWinTitle),
          line('Risk environment', riskEnvTxt),
          line('Measured on today', measuredOnTitle),
          line('Org pain', orgPainTitle),
          line('Evidence audience', evidenceTxt),
          line('Primary outcomes', outcomesTxt)
        ].join(''));

        const outcomesDetailHtml = topOutcomes.length
          ? topOutcomes.map((o, idx)=>{
              const meta = outcomeById(o.id) || o;
              return line(`${idx + 1}) ${meta.label}`, meta.oneLiner || meta.desc || '');
            }).join('')
          : line('Top outcomes', 'Complete the outcome discovery questions in Step 0.');
        setHTML('#sumOutcomes', outcomesDetailHtml);

        const tierBullets = tierWhyBullets(rec.best, 3);
        const tierHtml = [
          line('Recommended tier', `${tier.name} (${rec.conf})`),
          tierBullets.length
            ? `<ul>${tierBullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')}</ul>`
            : `<div class="sumLine"><span class="sumV"></span></div>`
        ].join('');
        setHTML('#sumTier', tierHtml);

        const agenda = buildNextMeetingAgenda(topOutcomes);
        setHTML('#sumAgenda', agenda.length ? `<ul>${agenda.map(a => `<li>${escapeHtml(a)}</li>`).join('')}</ul>` : '');
        setText('#snapReviewAgenda', agenda.length ? agenda.slice(0, 2).join('  ') : '');

        const who = buildWhoToBring(topOutcomes);
        setHTML('#sumWho', who.length ? `<ul>${who.map(w => `<li>${escapeHtml(w)}</li>`).join('')}</ul>` : '');

        const resources = buildRecommendedResources(topOutcomes);
        setHTML('#sumResources', resources.length ? `<ul>${resources.map(r => `<li>${escapeHtml(r)}</li>`).join('')}</ul>` : '');

        // Coverage
        setHTML('#sumCoverage', [
          line('Groups', groupsTxt),
          line('Cadence', rhythmTitle),
          line('Measurement', measureTitle),
          line('Advanced triggers', driversTxt)
        ].join(''));

        // Package fit
        setHTML('#sumFit', [
          line('Exercise realism', fitRealismSnap),
          line('Program scope', fitScopeSnap),
          line('Current state', fitTodaySnap),
          line('Delivery style', fitServicesSnap),
          line('Problem framing', fitRiskSnap)
        ].join(''));

        // Context
        const industryTitle = state.industry ? state.industry : '';
        const regionTitle = state.region ? (regionLabels[state.region] || state.region) : '';
        setHTML('#sumContext', [
          line('Industry', industryTitle),
          line('Region', regionTitle),
          line('Regulatory', regsTxt)
        ].join(''));

        // Tools & platforms
        setHTML('#sumStack', escapeHtml(stackTxt));

        snapshotMotionReady = true;
      }

      function escapeHtml(str){
        return String(str)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#039;');
      }

      function buildSummaryText(tier, rs, roi, paybackTxt){
        const lines = [];
        const sizeMap = {
          'lt500':'< 500 employees',
          '500-2k':'5002,000 employees',
          '2k-10k':'2,00010,000 employees',
          '10k-50k':'10,00050,000 employees',
          '50kplus':'50,000+ employees'
        };
        const lbl = (list, id) => {
          const it = (list || []).find(x => x.id === id);
          return it ? (it.label || it.title || id) : id;
        };

        lines.push('Immersive One  Cyber Readiness Configurator (Prototype v27)');
        lines.push('');

        if(state.company || state.fullName || state.companySize || state.operatingCountry || state.role){
          const sizeTxt = state.companySize ? (sizeMap[state.companySize] || state.companySize) : '';
          const roleTxt = state.role ? ((roleOpts.find(x => x.id === state.role) || {}).label || state.role) : '';
          lines.push('Business: ' + [
            state.company,
            sizeTxt,
            state.operatingCountry ? ('Country: ' + state.operatingCountry) : '',
            roleTxt ? ('Role: ' + roleTxt) : '',
            state.fullName ? ('Contact: ' + state.fullName) : ''
          ].filter(Boolean).join(' | '));
          lines.push('');
        }

        lines.push('Recommended package: ' + tier.name);
        lines.push('');

        const topOutcomes = inferredPrimaryOutcomes(3);
        const outcomesTxt = topOutcomes.length ? topOutcomes.map(o => o.short).join(', ') : '';
        if(outcomesTxt !== '') lines.push('Primary outcomes: ' + outcomesTxt);

        if((state.pressureSources || []).length){
          const p = (state.pressureSources || []).map(id => lbl(pressureOpts.map(x=>({ id:x.id, label:x.title })), id));
          lines.push('Pressure sources: ' + p.join(', '));
        }
        if(state.urgentWin) lines.push('Urgent 90-day win: ' + lbl(urgentWinOpts, state.urgentWin));
        if((state.riskEnvs || []).length){
          const envs = (state.riskEnvs || []).map(id => lbl(riskEnvOpts, id));
          lines.push('Risk environment: ' + envs.join(', '));
        }
        if(state.measuredOn) lines.push('Measured on today: ' + lbl(measuredOnOpts, state.measuredOn));
        if(state.orgPain) lines.push('Org pain: ' + lbl(orgPainOpts, state.orgPain));
        if(state.drivers.length) lines.push('Conversation triggers: ' + state.drivers.map(d => driverTitle(d)).join(', '));
        if(state.milestone){
          const m = milestoneOpts.find(x => x.id === state.milestone);
          lines.push('First milestone: ' + (m ? m.title : state.milestone));
        }
        if(state.evidence.size){
          const ev = Array.from(state.evidence).map(id=>{
            const it = evidenceOpts.find(x => x.id === id);
            return it ? it.label : id;
          });
          lines.push('Evidence audience: ' + ev.join(', '));
        }
        if(state.groups.size){
          const gs = Array.from(state.groups).map(id=>{
            const it = groupOpts.find(x => x.id === id);
            return it ? it.label : id;
          });
          lines.push('Groups in scope: ' + gs.join(', '));
        }
        if(state.rhythm){
          const r = rhythmOpts.find(x => x.id === state.rhythm);
          lines.push('Exercise cadence: ' + (r ? r.title : state.rhythm));
        }
        if(state.measure){
          const m2 = measureOpts.find(x => x.id === state.measure);
          lines.push('Readiness measurement: ' + (m2 ? m2.title : state.measure));
        }

        // Package fit (optional)
        const fitBits = [];
        if(state.fitRealism) fitBits.push('Realism: ' + ((fitSnapLabels.fitRealism && fitSnapLabels.fitRealism[state.fitRealism]) || lbl(fitRealismOpts, state.fitRealism)));
        if(state.fitScope) fitBits.push('Scope: ' + ((fitSnapLabels.fitScope && fitSnapLabels.fitScope[state.fitScope]) || lbl(fitScopeOpts, state.fitScope)));
        if(state.fitToday) fitBits.push('Current state: ' + ((fitSnapLabels.fitToday && fitSnapLabels.fitToday[state.fitToday]) || lbl(fitTodayOpts, state.fitToday)));
        if(state.fitServices) fitBits.push('Delivery: ' + ((fitSnapLabels.fitServices && fitSnapLabels.fitServices[state.fitServices]) || lbl(fitServicesOpts, state.fitServices)));
        if(state.fitRiskFrame) fitBits.push('Problem framing: ' + ((fitSnapLabels.fitRiskFrame && fitSnapLabels.fitRiskFrame[state.fitRiskFrame]) || lbl(fitRiskFrameOpts, state.fitRiskFrame)));
        if(fitBits.length) lines.push('Package fit: ' + fitBits.join(' | '));

        if(state.industry) lines.push('Industry: ' + state.industry);
        if(state.region) lines.push('Region: ' + state.region);

        if(state.stack.size || state.stackOther){
          const st = Array.from(state.stack).map(id=>{
            const it = stackMaster.find(x => x.id === id);
            return it ? it.label : id;
          });
          if(state.stackOther) st.push(state.stackOther);
          lines.push('Tech stack focus: ' + st.join(', '));
        }
        if(state.regs.size){
          const rg = Array.from(state.regs).map(id=>{
            const it = regMaster.find(x => x.id === id);
            return it ? it.label : id;
          });
          lines.push('Regulatory context: ' + rg.join(', '));
        }

        if(topOutcomes.length){
          lines.push('');
          lines.push('Top outcomes + one-liners:');
          topOutcomes.forEach((o, idx)=>{
            const meta = outcomeById(o.id) || o;
            lines.push(`${idx + 1}. ${meta.label}  ${meta.oneLiner || meta.desc}`);
          });
        }

        lines.push('');
        lines.push('Why this starting point (top 3):');
        tierWhyBullets(score().best, 3).forEach(r => lines.push('- ' + r));
        lines.push('');

        lines.push('Recommended next meeting agenda:');
        buildNextMeetingAgenda(topOutcomes).forEach(a => lines.push('- ' + a));
        lines.push('');

        lines.push('Who to bring:');
        buildWhoToBring(topOutcomes).forEach(w => lines.push('- ' + w));
        lines.push('');

        lines.push('Recommended resources:');
        buildRecommendedResources(topOutcomes).forEach(r => lines.push('- ' + r));
        lines.push('');

        lines.push('ROI estimate:');
        lines.push('Annual revenue: ' + fmtRevenueFromUSDB(state.revenueB));
        lines.push('Team sizes: ' + `~${state.teamCyber} cyber | ~${state.teamDev} dev | ~${state.teamWf} workforce`);
        lines.push('Salary sensitivity: ' + `Cyber ${fmtMoneyUSD(state.cyberSalaryUSD)} | Dev ${fmtMoneyUSD(state.devSalaryUSD)}`);
        lines.push('Indicative spend: ' + fmtMoneyUSD(state.investUSD) + '/yr');
        lines.push('Scenario: ' + (state.realization === 'immersive' ? 'Immersive base' : (state.realization === 'expected' ? 'Expected' : 'Conservative')));
        lines.push('3-year ROI: ' + (roi.roi*100).toFixed(0) + '%');
        lines.push('3-year NPV: ' + fmtMoneyUSD(roi.npv));
        if(paybackTxt) lines.push('Payback (est.): ' + paybackTxt);

        lines.push('');
        if(state.notes) lines.push('Notes: ' + state.notes);
        return lines.join('\n');
      }

      function buildMailto(tier, rs, roi, paybackTxt){
        const subject = encodeURIComponent('Immersive  readiness summary (prototype)');
        const body = encodeURIComponent(buildSummaryText(tier, rs, roi, paybackTxt));
        return `mailto:?subject=${subject}&body=${body}`;
      }

      function copyToClipboard(text){
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text)
            .then(()=> toast('Copied summary to clipboard.'))
            .catch(()=> fallbackCopy(text));
        }else{
          fallbackCopy(text);
        }
      }

      function fallbackCopy(text){
        try{
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position='fixed';
          ta.style.left='-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          toast('Copied summary (fallback).');
        }catch(e){
          toast('Clipboard copy blocked in this browser.');
        }
      }

      
      // ---------- export (PoC): structured data + CSV + print ----------
      function syncLeadFromDOM(){
        const emailEl = $('#email');
        const phoneEl = $('#phone');
        const notesEl = $('#notes');
        const optinEl = $('#optin');

        if(emailEl) state.email = (emailEl.value || '').trim();
        if(phoneEl) state.phone = (phoneEl.value || '').trim();
        if(notesEl) state.notes = (notesEl.value || '').trim();
        if(optinEl) state.optin = !!optinEl.checked;
      }

      function makeReportId(){
        try{
          if(window.crypto && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
        }catch(e){}
        // fallback (prototype only)
        const s4 = ()=> Math.floor((1+Math.random())*0x10000).toString(16).substring(1);
        return `${s4()}${s4()}-${s4()}-${s4()}-${s4()}-${s4()}${s4()}${s4()}`;
      }

      function labelsFromIds(ids, list){
        return Array.from(ids || []).map(id=>{
          const it = (list || []).find(x => x.id === id);
          return it ? (it.label || it.title || id) : id;
        }).filter(Boolean);
      }
      function labelsFromSet(setRef, list){
        return labelsFromIds(Array.from(setRef || []), list);
      }

      function safeFilePart(v){
        return String(v || '')
          .trim()
          .replace(/\s+/g,'-')
          .replace(/[^a-zA-Z0-9\-_]/g,'')
          .slice(0, 60) || 'report';
      }

      function downloadBlob(blob, filename){
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(()=> URL.revokeObjectURL(url), 1200);
      }

      function downloadText(text, filename, mime){
        const blob = new Blob([text], { type: mime || 'text/plain;charset=utf-8;' });
        downloadBlob(blob, filename);
      }

      function buildReportModelV1(){
        syncLeadFromDOM();

        const rec = score();
        const tierKey = rec.best;
        const tier = (tierKey === 'core') ? packages.core : (tierKey === 'adv') ? packages.adv : packages.ult;
        const serviceTier = (tierKey === 'core') ? 'Good' : (tierKey === 'adv') ? 'Better' : 'Best';

        const rs = reasons(tierKey);

        const roi = computeRoi();
        const paybackMonths = computePaybackMonths(roi);
        const paybackDisplay = fmtPayback(paybackMonths);

        const now = new Date();
        const reportId = makeReportId();

        const regionLabels = { NA:'North America', UKI:'UK & Ireland', EU:'Europe (EU)', APAC:'APAC', Other:'Other / Global' };
        const sizeMap = {
          'lt500':'< 500 employees',
          '500-2k':'5002,000 employees',
          '2k-10k':'2,00010,000 employees',
          '10k-50k':'10,00050,000 employees',
          '50kplus':'50,000+ employees'
        };

        // Labels
        const roleLabel = state.role ? (labelsFromIds([state.role], roleOpts)[0] || state.role) : '';
        const milestoneLabel = state.milestone ? (labelsFromIds([state.milestone], milestoneOpts)[0] || state.milestone) : '';
        const rhythmLabel = state.rhythm ? (labelsFromIds([state.rhythm], rhythmOpts)[0] || state.rhythm) : '';
        const measureLabel = state.measure ? (labelsFromIds([state.measure], measureOpts)[0] || state.measure) : '';
        const pressureSourceLabels = labelsFromIds(state.pressureSources || [], pressureOpts.map(x => ({ id:x.id, title:x.title })));
        const urgentWinLabel = state.urgentWin ? (labelsFromIds([state.urgentWin], urgentWinOpts)[0] || state.urgentWin) : '';
        const measuredOnLabel = state.measuredOn ? (labelsFromIds([state.measuredOn], measuredOnOpts)[0] || state.measuredOn) : '';
        const orgPainLabel = state.orgPain ? (labelsFromIds([state.orgPain], orgPainOpts)[0] || state.orgPain) : '';
        const riskEnvLabels = labelsFromIds(state.riskEnvs || [], riskEnvOpts.map(x => ({ id:x.id, title:x.title })));

        const driverLabels = labelsFromIds(state.drivers || [], driverOpts.map(d => ({ id:d.id, title:d.title })));
        const evidenceLabels = labelsFromSet(state.evidence, evidenceOpts);
        const primaryOutcomes = inferredPrimaryOutcomes(3);
        const primaryOutcomeScores = computePrimaryOutcomeScores();
        const groupLabels = labelsFromSet(state.groups, groupOpts);
        const regLabels = labelsFromSet(state.regs, regMaster);
        const stackLabels = labelsFromSet(state.stack, stackMaster);

        const stackLabelFull = (state.stackOther && String(state.stackOther).trim())
          ? [...stackLabels, String(state.stackOther).trim()]
          : stackLabels;

        // ROI display strings
        const roiPercent = (roi.roi * 100).toFixed(0) + '%';
        const npvDisplay = fmtMoneyUSD(roi.npv);
        const investDisplay = fmtMoneyUSD(state.investUSD);

        const report = {
          schemaVersion: '1.0',
          reportId,
          createdAt: now.toISOString(),
          locale: (navigator.language || 'en'),
          currency: state.currency,

          app: {
            name: 'Immersive One  Cyber readiness configurator',
            build: 'v27-outcomes-first'
          },

          lead: {
            email: state.email || '',
            phone: state.phone || '',
            optin: !!state.optin,
            notes: state.notes || ''
          },

          organisation: {
            role: state.role || '',
            roleLabel,
            fullName: state.fullName || '',
            company: state.company || '',
            companySize: state.companySize || '',
            companySizeLabel: state.companySize ? (sizeMap[state.companySize] || state.companySize) : '',
            operatingCountry: state.operatingCountry || ''
          },

          selections: {
            pressureSources: state.pressureSources || [],
            pressureSourceLabels,
            urgentWin: state.urgentWin || '',
            urgentWinLabel,
            riskEnvs: state.riskEnvs || [],
            riskEnvLabels,
            measuredOn: state.measuredOn || '',
            measuredOnLabel,
            orgPain: state.orgPain || '',
            orgPainLabel,

            drivers: state.drivers || [],
            driverLabels,
            milestone: state.milestone || '',
            milestoneLabel,
            evidence: Array.from(state.evidence || []),
            evidenceLabels,
            outcomeDrilldowns: Object.assign({}, state.outcomeDrilldowns || {}),
            primaryOutcomes: primaryOutcomes.map(o => o.id),
            primaryOutcomeLabels: primaryOutcomes.map(o => o.short),
            primaryOutcomeOneLiners: primaryOutcomes.map(o => {
              const meta = outcomeById(o.id) || o;
              return meta.oneLiner || meta.desc || '';
            }),
            primaryOutcomeScores,
            groups: Array.from(state.groups || []),
            groupLabels,
            rhythm: state.rhythm || '',
            rhythmLabel,
            measure: state.measure || '',
            measureLabel,

            fitRealism: state.fitRealism || '',
            fitScope: state.fitScope || '',
            fitToday: state.fitToday || '',
            fitServices: state.fitServices || '',
            fitRiskFrame: state.fitRiskFrame || '',

            industry: state.industry || '',
            region: state.region || '',
            regionLabel: state.region ? (regionLabels[state.region] || state.region) : '',
            regulations: Array.from(state.regs || []),
            regulationLabels: regLabels,

            techStack: Array.from(state.stack || []),
            techStackLabels: stackLabelFull
          },

          recommendation: {
            packageKey: tierKey,
            packageName: tier.name,
            serviceTier,
            confidence: rec.conf,
            pressureScore: rec.scores && typeof rec.scores.pressure === 'number' ? rec.scores.pressure : null,
            scaleLargeSignal: rec.scores && typeof rec.scores.scaleLarge === 'number' ? rec.scores.scaleLarge : null,
            ultimateGateMatched: rec.scores && typeof rec.scores.ultObvious === 'number' ? rec.scores.ultObvious : null,
            tagline: tier.tagline,
            description: tier.desc,
            reasons: rs
          },

          followup: {
            tierWhy: tierWhyBullets(tierKey, 3),
            agenda: buildNextMeetingAgenda(primaryOutcomes),
            recommendedAttendees: buildWhoToBring(primaryOutcomes),
            recommendedResources: buildRecommendedResources(primaryOutcomes)
          },

          roi: {
            visited: !!state.visited.has(5),
            scenario: (state.realization === 'expected')
              ? 'Expected'
              : (state.realization === 'conservative')
                ? 'Conservative'
                : 'Immersive base',
            revenueB_USD: Number(state.revenueB) || 0,
            revenueDisplay: fmtRevenueFromUSDB(state.revenueB),
            teamCyber: Number(state.teamCyber) || 0,
            teamDev: Number(state.teamDev) || 0,
            teamWorkforce: Number(state.teamWf) || 0,
            investUSD_Annual: Number(state.investUSD) || 0,
            investDisplay_Annual: investDisplay,
            roiPercent,
            npvUSD_3yr: Number(roi.npv) || 0,
            npvDisplay_3yr: npvDisplay,
            paybackMonths: (paybackMonths === null || paybackMonths === undefined) ? null : Number(paybackMonths),
            paybackDisplay,
            assumptions: {
              paybackDelayMonths: Number(state.paybackDelayMonths) || 0,
              cyberSalaryUSD: Number(state.cyberSalaryUSD) || 0,
              devSalaryUSD: Number(state.devSalaryUSD) || 0,
              fx: Object.assign({}, state.fx || {})
            }
          }
        };

        return report;
      }

      function reportToCSV(report){
        // One-row CSV (flattened). Arrays are semicolon-separated.
        const join = (arr)=> (arr && arr.length) ? arr.join('; ') : '';
        const val = (v)=> (v === null || v === undefined) ? '' : String(v);

        const row = {
          report_id: report.reportId,
          created_at: report.createdAt,
          locale: report.locale,
          currency: report.currency,

          lead_email: report.lead.email,
          lead_phone: report.lead.phone,
          lead_optin: report.lead.optin ? 'true' : 'false',

          full_name: report.organisation.fullName,
          company: report.organisation.company,
          company_size: report.organisation.companySizeLabel || report.organisation.companySize,
          operating_country: report.organisation.operatingCountry,
          role: report.organisation.roleLabel || report.organisation.role,

          pressure_sources: join(report.selections.pressureSourceLabels),
          urgent_win: report.selections.urgentWinLabel,
          risk_environments: join(report.selections.riskEnvLabels),
          measured_on_today: report.selections.measuredOnLabel,
          org_pain: report.selections.orgPainLabel,

          drivers: join(report.selections.driverLabels),
          milestone: report.selections.milestoneLabel,
          evidence: join(report.selections.evidenceLabels),
          primary_outcomes: join(report.selections.primaryOutcomeLabels),
          groups: join(report.selections.groupLabels),
          cadence: report.selections.rhythmLabel,
          measurement: report.selections.measureLabel,

          fit_realism: report.selections.fitRealism,
          fit_scope: report.selections.fitScope,
          fit_today: report.selections.fitToday,
          fit_services: report.selections.fitServices,
          fit_risk_frame: report.selections.fitRiskFrame,

          industry: report.selections.industry,
          region: report.selections.regionLabel,
          regulations: join(report.selections.regulationLabels),
          tech_stack: join(report.selections.techStackLabels),

          roi_scenario: report.roi.scenario,
          revenue_display: report.roi.revenueDisplay,
          revenueB_usd: val(report.roi.revenueB_USD),
          invest_display_annual: report.roi.investDisplay_Annual,
          invest_usd_annual: val(report.roi.investUSD_Annual),

          team_cyber: val(report.roi.teamCyber),
          team_dev: val(report.roi.teamDev),
          team_workforce: val(report.roi.teamWorkforce),

          roi_percent_3yr: report.roi.roiPercent,
          npv_display_3yr: report.roi.npvDisplay_3yr,
          npv_usd_3yr: val(report.roi.npvUSD_3yr),
          payback_display: report.roi.paybackDisplay,
          payback_months: val(report.roi.paybackMonths),

          recommended_package: report.recommendation.packageName,
          service_tier: report.recommendation.serviceTier,
          confidence: report.recommendation.confidence,
          pressure_score: val(report.recommendation.pressureScore),
          scale_large_signal: val(report.recommendation.scaleLargeSignal),
          ultimate_gate_matched: val(report.recommendation.ultimateGateMatched),

          reasons: join(report.recommendation.reasons),
          followup_tier_why: join(report.followup.tierWhy),
          followup_agenda: join(report.followup.agenda),
          followup_attendees: join(report.followup.recommendedAttendees),
          followup_resources: join(report.followup.recommendedResources)
        };

        const cols = Object.keys(row);

        const esc = (s)=>{
          const str = String(s ?? '');
          if(/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
          return str;
        };

        const header = cols.map(esc).join(',');
        const line = cols.map(c => esc(row[c])).join(',');
        return header + '\n' + line + '\n';
      }

      function buildPrintHTML(report){
        const dt = new Date(report.createdAt);
        const dateStr = dt.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
        const logoSrc = 'https://cdn.prod.website-files.com/6735fba9a631272fb4513263/6762d3c19105162149b9f1dc_Immersive%20Logo.svg';

        const pill = (t)=> `<span class="pillTag">${escapeHtml(t)}</span>`;

        const pillBits = [];
        if(report.organisation.company) pillBits.push(pill(report.organisation.company));
        if(report.organisation.companySizeLabel) pillBits.push(pill(report.organisation.companySizeLabel));
        if(report.selections.industry) pillBits.push(pill(report.selections.industry));
        if(report.selections.regionLabel) pillBits.push(pill(report.selections.regionLabel));
        pillBits.push(pill('Currency: ' + report.currency));

        const list = (items)=> {
          const xs = (items || []).filter(Boolean);
          if(!xs.length) return '<div class="small"></div>';
          return '<ul>' + xs.map(x => `<li>${escapeHtml(x)}</li>`).join('') + '</ul>';
        };

        const line = (k,v)=> `<p class="k">${escapeHtml(k)}</p><p class="v">${escapeHtml(v || '')}</p>`;

        const orgLines = [
          report.organisation.fullName ? (`Contact: ${report.organisation.fullName}`) : '',
          report.organisation.roleLabel ? (`Role: ${report.organisation.roleLabel}`) : '',
          report.organisation.operatingCountry ? (`Country: ${report.organisation.operatingCountry}`) : ''
        ].filter(Boolean).join('  ');
        const metaBits = [
          report.organisation.company || '',
          orgLines || ''
        ].filter(Boolean);
        const metaLine = metaBits.length ? metaBits.join('  ') : 'Prepared for internal planning and scoping.';

        const roiMini = report.roi.visited
          ? `${report.roi.npvDisplay_3yr} NPV  ${report.roi.paybackDisplay} payback  ${report.roi.investDisplay_Annual}/yr spend`
          : `Complete Step 4 for the Immersive ROI estimate  Spend model shows ${report.roi.investDisplay_Annual}/yr`;

        const fitBits = [
          report.selections.fitRealism ? ('Realism: ' + report.selections.fitRealism) : '',
          report.selections.fitScope ? ('Scope: ' + report.selections.fitScope) : '',
          report.selections.fitToday ? ('Current state: ' + report.selections.fitToday) : '',
          report.selections.fitServices ? ('Delivery: ' + report.selections.fitServices) : '',
          report.selections.fitRiskFrame ? ('Framing: ' + report.selections.fitRiskFrame) : ''
        ].filter(Boolean);

        return `
          <div>
            <div class="brandHeader">
              <div class="brandMark">
                <img class="brandLogo" src="${logoSrc}" alt="Immersive" />
                <div class="brandKicker">Cyber readiness configurator</div>
              </div>
              <div class="reportStamp">
                <p class="stampLabel">Report ID</p>
                <p class="stampValue">${escapeHtml(report.reportId)}</p>
                <p class="stampLabel">Generated</p>
                <p class="stampValue">${escapeHtml(dateStr)}</p>
              </div>
            </div>
            <h1>Cyber readiness snapshot</h1>
            <div class="meta">
              ${escapeHtml(metaLine)}
            </div>

            <div class="pillRow">${pillBits.join('')}</div>

            <div class="grid2">
              <div class="box">
                ${line('Recommended package', `${report.recommendation.packageName}`)}
                <div class="small">${escapeHtml(report.recommendation.tagline)}  ${escapeHtml(report.recommendation.description)}</div>
              </div>
              <div class="box">
                ${line('Directional ROI (3year)', report.roi.roiPercent)}
                <div class="small">${escapeHtml(roiMini)}</div>
              </div>
            </div>

            <h2>Why this starting point</h2>
            ${list((report.followup && report.followup.tierWhy) ? report.followup.tierWhy : report.recommendation.reasons)}

            <div class="grid2" style="margin-top:6mm;">
              <div class="box">
                ${line('Top outcomes', (report.selections.primaryOutcomeLabels || []).join('  ') || '')}
              </div>
              <div class="box">
                ${line('Recommended next meeting agenda', (report.followup && report.followup.agenda) ? report.followup.agenda.join('  ') : '')}
                <div class="small"><strong>Who to bring:</strong> ${escapeHtml((report.followup && report.followup.recommendedAttendees) ? report.followup.recommendedAttendees.join('  ') : '')}</div>
                <div class="small"><strong>Resources:</strong> ${escapeHtml((report.followup && report.followup.recommendedResources) ? report.followup.recommendedResources.join('  ') : '')}</div>
              </div>
            </div>

            <div class="divider"></div>

            <h2>Your selections</h2>
            <div class="grid2">
              <div class="box">
                ${line('Pressure sources', (report.selections.pressureSourceLabels || []).join('  ') || '')}
                <div class="small"><strong>Urgent 90-day win:</strong> ${escapeHtml(report.selections.urgentWinLabel || '')}</div>
                <div class="small"><strong>Risk environment:</strong> ${escapeHtml((report.selections.riskEnvLabels || []).join('  ') || '')}</div>
                <div class="small"><strong>Conversation triggers:</strong> ${escapeHtml((report.selections.driverLabels || []).join('  ') || '')}</div>
                <div class="small"><strong>Evidence audience:</strong> ${escapeHtml((report.selections.evidenceLabels || []).join('  ') || '')}</div>
                <div class="small"><strong>Primary outcomes:</strong> ${escapeHtml((report.selections.primaryOutcomeLabels || []).join('  ') || '')}</div>
              </div>
              <div class="box">
                ${line('Coverage', (report.selections.groupLabels || []).join('  ') || '')}
                <div class="small"><strong>Cadence:</strong> ${escapeHtml(report.selections.rhythmLabel || '')}</div>
                <div class="small"><strong>Measurement:</strong> ${escapeHtml(report.selections.measureLabel || '')}</div>
              </div>
            </div>

            <div class="grid2" style="margin-top:6mm;">
              <div class="box">
                ${line('Package fit', fitBits.length ? fitBits.join('  ') : '')}
                <div class="small">Fit signals refine whether Core / Advanced / Ultimate is justified.</div>
              </div>
              <div class="box">
                ${line('Regulatory context', (report.selections.regulationLabels || []).length ? report.selections.regulationLabels.slice(0,10).join('  ') : '')}
                <div class="small">Not legal advice. Select All in Step 3 to choose from the full library.</div>
              </div>
            </div>

            <div class="grid2" style="margin-top:6mm;">
              <div class="box">
                ${line('Tools & platforms', (report.selections.techStackLabels || []).length ? report.selections.techStackLabels.slice(0,12).join('  ') : '')}
              </div>
              <div class="box">
                ${line('ROI inputs (Immersive estimate)', `${report.roi.revenueDisplay} revenue/budget  ${report.roi.investDisplay_Annual}/yr spend`)}
                <div class="small">Footprint: ~${escapeHtml(String(report.roi.teamCyber))} cyber  ~${escapeHtml(String(report.roi.teamDev))} dev  ~${escapeHtml(String(report.roi.teamWorkforce))} workforce</div>
                <div class="small">Scenario: ${escapeHtml(report.roi.scenario)}  Payback delay: ${escapeHtml(String(report.roi.assumptions.paybackDelayMonths || 0))} mo</div>
              </div>
            </div>

            <h2>Notes</h2>
            <div class="box">
              <div class="small">${escapeHtml(report.lead.notes || '')}</div>
            </div>

            <div class="divider"></div>
            <div class="small">
              This report is a prototype snapshot. ROI figures are Immersive estimates based on Immersive assumptions and comparable organizations. Framework/regulation references are for tailoring language only and are not legal advice.
            </div>
          </div>
        `;
      }

      function printReport(report){
        const root = $('#printReportRoot');
        if(!root){
          toast('Print view is unavailable in this build.');
          return;
        }
        root.innerHTML = buildPrintHTML(report);
        root.setAttribute('aria-hidden', 'false');
        document.body.classList.add('is-print-report');

        const cleanup = ()=>{
          document.body.classList.remove('is-print-report');
          root.setAttribute('aria-hidden','true');
          root.innerHTML = '';
          window.removeEventListener('afterprint', cleanup);
        };

        window.addEventListener('afterprint', cleanup, { once: true });

        toast('Opening print dialog');
        window.print();
      }
// ---------- init UI ----------
      // progress chip click
      $$('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=> setActiveStep(Number(ch.dataset.step)));
      });
      const brandHome = $('#brandHome');
      const workspaceDashboard = $('#workspaceDashboard');
      const workspaceArchive = $('#workspaceArchive');
      const workspaceAccount = $('#workspaceAccount');
      const recordOverviewBtn = $('#recordOverviewBtn');
      const globalCreateRecord = $('#globalCreateRecord');
      const globalEditConfigurator = $('#globalEditConfigurator');
      const globalBookConsultation = $('#globalBookConsultation');
      const accountOpenSettings = $('#accountOpenSettings');
      const jumpNextIncompleteBtns = $$('[data-jump-next-incomplete]');
      const saveRecordBtn = $('#saveRecordBtn');
      const workspaceCompaniesList = $('#workspaceCompaniesList');
      const dashboardRowsBody = $('#dashboardRows');
      const dashSelectAll = $('#dashSelectAll');
      const dashArchiveSelected = $('#dashArchiveSelected');
      const archivedRowsBody = $('#archivedRows');
      const archivedSelectAll = $('#archivedSelectAll');
      const archivedRestoreSelected = $('#archivedRestoreSelected');
      const brandLogo = $('.logo');
      if(brandHome){
        brandHome.addEventListener('click', (e)=>{
          e.preventDefault();
          setView('dashboard');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
      if(workspaceDashboard){
        workspaceDashboard.addEventListener('click', ()=>{
          setView('dashboard');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
      if(workspaceArchive){
        workspaceArchive.addEventListener('click', ()=>{
          setView('archived');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
      if(workspaceAccount){
        workspaceAccount.addEventListener('click', ()=>{
          setView('account');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
      if(recordOverviewBtn){
        recordOverviewBtn.addEventListener('click', ()=>{
          openThreadOverview(state.activeThread || 'current');
        });
      }
      if(globalCreateRecord){
        globalCreateRecord.addEventListener('click', ()=>{
          createNewRecord();
        });
      }
      if(globalEditConfigurator){
        globalEditConfigurator.addEventListener('click', ()=>{
          const thread = activeThreadModel();
          const step = dashboardFirstGapStep(thread);
          openThreadConfigurator((thread && thread.id) ? thread.id : (state.activeThread || 'current'), step);
        });
      }
      if(globalBookConsultation){
        globalBookConsultation.addEventListener('click', ()=>{
          const thread = activeThreadModel();
          openThreadBooking((thread && thread.id) ? thread.id : (state.activeThread || 'current'));
        });
      }
      if(workspaceCompaniesList){
        workspaceCompaniesList.addEventListener('click', (e)=>{
          const openBtn = e.target.closest('[data-company-open]');
          if(openBtn){
            const id = openBtn.getAttribute('data-company-open') || '';
            if(id) openThreadOverview(id);
          }
        });
      }
      if(dashboardRowsBody){
        dashboardRowsBody.addEventListener('change', (e)=>{
          const sel = e.target.closest('[data-dashboard-select-id]');
          if(!sel) return;
          const id = sel.getAttribute('data-dashboard-select-id') || '';
          if(!id) return;
          if(sel.checked) state.dashboardSelectedIds.add(id);
          else state.dashboardSelectedIds.delete(id);
          update();
        });
        dashboardRowsBody.addEventListener('click', (e)=>{
          const starBtn = e.target.closest('[data-dashboard-star-id]');
          if(starBtn){
            const id = starBtn.getAttribute('data-dashboard-star-id') || '';
            if(id) toggleThreadPriority(id);
            return;
          }
          const openBtn = e.target.closest('[data-dashboard-open-btn]');
          if(openBtn){
            const id = openBtn.getAttribute('data-dashboard-open-btn') || '';
            if(id) openThreadOverview(id);
            return;
          }
          if(e.target.closest('input,button,a,select,textarea,label')) return;
          const row = e.target.closest('[data-dashboard-row-id]');
          if(!row) return;
          const id = row.getAttribute('data-dashboard-row-id') || '';
          if(id) openThreadOverview(id);
        });
      }
      if(dashSelectAll){
        dashSelectAll.addEventListener('change', ()=>{
          if(!dashSelectAll.checked){
            state.dashboardSelectedIds = new Set();
            update();
            return;
          }
          const ids = dashboardRowsModel().map((row)=> row.id);
          state.dashboardSelectedIds = new Set(ids);
          update();
        });
      }
      if(dashArchiveSelected){
        dashArchiveSelected.addEventListener('click', ()=>{
          const ids = Array.from(state.dashboardSelectedIds || []);
          if(!ids.length) return;
          openArchivePrompt(ids, 'archive');
        });
      }
      if(archivedRowsBody){
        archivedRowsBody.addEventListener('change', (e)=>{
          const sel = e.target.closest('[data-archived-select-id]');
          if(!sel) return;
          const id = sel.getAttribute('data-archived-select-id') || '';
          if(!id) return;
          if(sel.checked) state.archivedSelectedIds.add(id);
          else state.archivedSelectedIds.delete(id);
          update();
        });
        archivedRowsBody.addEventListener('click', (e)=>{
          const restoreBtn = e.target.closest('[data-archived-unarchive-id]');
          if(restoreBtn){
            const id = restoreBtn.getAttribute('data-archived-unarchive-id') || '';
            if(id) openArchivePrompt([id], 'restore');
            return;
          }
          if(e.target.closest('input,button,a,select,textarea,label')) return;
          const row = e.target.closest('[data-archived-row-id]');
          if(!row) return;
          const id = row.getAttribute('data-archived-row-id') || '';
          if(id) openThreadOverview(id);
        });
      }
      if(archivedSelectAll){
        archivedSelectAll.addEventListener('change', ()=>{
          if(!archivedSelectAll.checked){
            state.archivedSelectedIds = new Set();
            update();
            return;
          }
          const ids = archivedRowsModel().map((row)=> row.id);
          state.archivedSelectedIds = new Set(ids);
          update();
        });
      }
      if(archivedRestoreSelected){
        archivedRestoreSelected.addEventListener('click', ()=>{
          const ids = Array.from(state.archivedSelectedIds || []);
          if(!ids.length) return;
          openArchivePrompt(ids, 'restore');
        });
      }
      jumpNextIncompleteBtns.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          jumpToNextIncomplete();
        });
      });
      if(saveRecordBtn){
        saveRecordBtn.addEventListener('click', ()=>{
          saveActiveRecord();
        });
      }
      if(accountOpenSettings){
        accountOpenSettings.addEventListener('click', ()=>{
          toggleSettings(true);
        });
      }

      const settings = $('#settings');
      const openSettingsPanelNav = $('#openSettingsNav');
      const closeSettings = $('#closeSettings');
      const accountFullNameInput = $('#accountFullName');
      const accountEmailInput = $('#accountEmail');
      const accountPhoneInput = $('#accountPhone');
      const accountRoleSelect = $('#accountRole');
      const accountCountrySelect = $('#accountCountry');
      const accountRegionSelect = $('#accountRegion');
      const accountFieldModeSelect = $('#accountFieldMode');
      const accountPrefillOptions = $$('#accountPrefillOptions [data-prefill]');
      const accountApplyNowBtn = $('#accountApplyNow');
      const accountResetBtn = $('#accountReset');
      const toneOptions = $$('#toneOptions [data-tone]');
      const densityOptions = $$('#densityOptions [data-density]');
      const fontScaleOptions = $$('#fontScaleOptions [data-font-scale]');
      const dummyOptions = $$('#dummyOptions [data-dummy]');
      const resetLayoutWidthsBtn = $('#resetLayoutWidths');
      const ACCOUNT_PROFILE_STORAGE_KEY = 'cfg_shell_account_profile_v1';

      const settingsState = {
        tone: 'default',
        density: 'comfortable',
        fontScale: 1,
        dummyMode: 'off',
        account: {
          fullName: '',
          email: '',
          phone: '',
          defaultRole: '',
          defaultCountry: '',
          defaultRegion: '',
          fieldMode: 'guided',
          prefillMode: 'on'
        }
      };

      function resolveFontScale(next){
        const allowed = [0.9, 1, 1.1];
        const n = Number(next);
        if(!Number.isFinite(n)) return 1;
        return allowed.reduce((best, val)=> Math.abs(val - n) < Math.abs(best - n) ? val : best, 1);
      }

      function resolveDummyMode(next){
        return String(next || '').toLowerCase() === 'on' ? 'on' : 'off';
      }

      function resolveAccountFieldMode(next){
        return String(next || '').toLowerCase() === 'advanced' ? 'advanced' : 'guided';
      }

      function resolveAccountPrefillMode(next){
        if(next === false) return 'off';
        if(next === true) return 'on';
        return String(next || '').toLowerCase() === 'off' ? 'off' : 'on';
      }

      function pickSelectValue(raw, sourceSel){
        const source = $(sourceSel);
        const wanted = String(raw || '').trim();
        if(!source || !wanted) return '';
        return Array.from(source.options || []).some((opt)=> opt.value === wanted) ? wanted : '';
      }

      function normalizeAccountProfile(raw){
        const src = (raw && typeof raw === 'object') ? raw : {};
        const roleRaw = String(src.defaultRole || '').trim();
        const roleId = accountRoleLegacyMap[roleRaw] || roleRaw;
        const roleOk = accountRoleOpts.some((opt)=> opt.id === roleId);
        return {
          // Preserve spaces while typing (e.g. first + last name).
          fullName: String(src.fullName || ''),
          email: String(src.email || '').trim(),
          phone: String(src.phone || ''),
          defaultRole: roleOk ? roleId : '',
          defaultCountry: pickSelectValue(src.defaultCountry, '#operatingCountry'),
          defaultRegion: pickSelectValue(src.defaultRegion, '#region'),
          fieldMode: resolveAccountFieldMode(src.fieldMode),
          prefillMode: resolveAccountPrefillMode(src.prefillMode)
        };
      }

      function readAccountProfileFromSettingsUI(){
        return normalizeAccountProfile({
          fullName: accountFullNameInput ? accountFullNameInput.value : '',
          email: accountEmailInput ? accountEmailInput.value : '',
          phone: accountPhoneInput ? accountPhoneInput.value : '',
          defaultRole: accountRoleSelect ? accountRoleSelect.value : '',
          defaultCountry: accountCountrySelect ? accountCountrySelect.value : '',
          defaultRegion: accountRegionSelect ? accountRegionSelect.value : '',
          fieldMode: accountFieldModeSelect ? accountFieldModeSelect.value : '',
          prefillMode: (settingsState.account && settingsState.account.prefillMode) || 'on'
        });
      }

      function syncAccountSettingsUI(){
        const acc = settingsState.account || {};
        if(accountFullNameInput) accountFullNameInput.value = acc.fullName || '';
        if(accountEmailInput) accountEmailInput.value = acc.email || '';
        if(accountPhoneInput) accountPhoneInput.value = acc.phone || '';
        if(accountRoleSelect) accountRoleSelect.value = acc.defaultRole || '';
        if(accountCountrySelect) accountCountrySelect.value = acc.defaultCountry || '';
        if(accountRegionSelect) accountRegionSelect.value = acc.defaultRegion || '';
        if(accountFieldModeSelect) accountFieldModeSelect.value = resolveAccountFieldMode(acc.fieldMode);
        const prefill = resolveAccountPrefillMode(acc.prefillMode);
        accountPrefillOptions.forEach((btn)=>{
          btn.setAttribute('aria-pressed', btn.getAttribute('data-prefill') === prefill ? 'true' : 'false');
        });
        document.documentElement.setAttribute('data-config-profile-depth', resolveAccountFieldMode(acc.fieldMode));
      }

      function persistAccountProfile(){
        try{
          window.localStorage.setItem(ACCOUNT_PROFILE_STORAGE_KEY, JSON.stringify(settingsState.account || {}));
        }catch(err){
          // Ignore storage failures.
        }
      }

      function applyAccountProfile(next, persist){
        settingsState.account = normalizeAccountProfile(next);
        if(persist !== false) persistAccountProfile();
        syncAccountSettingsUI();
      }

      function copySelectOptions(sourceSel, targetEl){
        if(!targetEl) return;
        const source = $(sourceSel);
        if(!source) return;
        const prev = targetEl.value;
        const opts = Array.from(source.options || []);
        targetEl.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'No default';
        targetEl.appendChild(none);
        opts.forEach((opt)=>{
          const value = String(opt.value || '');
          if(!value) return;
          const clone = document.createElement('option');
          clone.value = value;
          clone.textContent = opt.textContent || value;
          targetEl.appendChild(clone);
        });
        targetEl.value = Array.from(targetEl.options).some((opt)=> opt.value === prev) ? prev : '';
      }

      function syncAccountChoiceSources(){
        copySelectOptions('#operatingCountry', accountCountrySelect);
        copySelectOptions('#region', accountRegionSelect);
        settingsState.account = normalizeAccountProfile(settingsState.account);
        syncAccountSettingsUI();
      }

      function applyAccountDefaultsToState(opts){
        const cfg = Object.assign({ emptyOnly:true }, opts || {});
        const acc = settingsState.account || {};
        const applyText = (key, val)=>{
          const next = String(val || '').trim();
          if(!next) return;
          const cur = String(state[key] || '').trim();
          if(cfg.emptyOnly && cur) return;
          state[key] = next;
        };
        applyText('fullName', acc.fullName);
        applyText('email', acc.email);
        applyText('phone', acc.phone);
        applyText('operatingCountry', acc.defaultCountry);
        applyText('region', acc.defaultRegion);
      }

      function applyRootFontSize(){
        const basePx = settingsState.density === 'compact' ? 12 : 13;
        const scale = Number(settingsState.fontScale) || 1;
        const px = basePx * scale;
        document.documentElement.style.fontSize = `${px.toFixed(2).replace(/\.00$/,'')}px`;
      }

      function syncSettingsUI(){
        toneOptions.forEach((btn)=>{
          btn.setAttribute('aria-pressed', btn.getAttribute('data-tone') === settingsState.tone ? 'true' : 'false');
        });
        densityOptions.forEach((btn)=>{
          btn.setAttribute('aria-pressed', btn.getAttribute('data-density') === settingsState.density ? 'true' : 'false');
        });
        fontScaleOptions.forEach((btn)=>{
          const btnScale = resolveFontScale(btn.getAttribute('data-font-scale'));
          btn.setAttribute('aria-pressed', btnScale === settingsState.fontScale ? 'true' : 'false');
        });
        dummyOptions.forEach((btn)=>{
          btn.setAttribute('aria-pressed', btn.getAttribute('data-dummy') === settingsState.dummyMode ? 'true' : 'false');
        });
        syncAccountSettingsUI();
      }

      function syncBrandLogoForTone(tone){
        if(!brandLogo) return;
        const lightSrc = brandLogo.getAttribute('data-light') || brandLogo.getAttribute('src');
        const darkSrc = brandLogo.getAttribute('data-dark') || lightSrc;
        const current = String(tone || '').toLowerCase();
        const isDark = (current === 'dark' || current === 'comfort');
        brandLogo.setAttribute('src', isDark ? darkSrc : lightSrc);
      }

      function applyShellTone(next, persist){
        const raw0 = String(next || '').toLowerCase();
        const raw = (raw0 === 'onyx' || raw0 === 'onyx1' || raw0 === 'onyx-1') ? 'dark' : raw0;
        const val = (raw === 'soft' || raw === 'dark' || raw === 'comfort') ? raw : 'default';
        settingsState.tone = val;
        if(val === 'default') document.documentElement.removeAttribute('data-shell-tone');
        else document.documentElement.setAttribute('data-shell-tone', val);
        syncBrandLogoForTone(val);
        if(persist !== false) window.localStorage.setItem('cfg_shell_tone', val);
        syncSettingsUI();
      }

      function applyShellDensity(next, persist){
        const val = (String(next).toLowerCase() === 'compact') ? 'compact' : 'comfortable';
        settingsState.density = val;
        document.documentElement.setAttribute('data-shell-density', val);
        applyRootFontSize();
        if(persist !== false) window.localStorage.setItem('cfg_shell_density', val);
        syncSettingsUI();
      }

      function applyShellFontScale(next, persist){
        const val = resolveFontScale(next);
        settingsState.fontScale = val;
        applyRootFontSize();
        if(persist !== false) window.localStorage.setItem('cfg_shell_font_scale', String(val));
        syncSettingsUI();
      }

      function applyDummyMode(next, persist, opts){
        const mode = resolveDummyMode(next);
        const prev = settingsState.dummyMode;
        settingsState.dummyMode = mode;
        if(persist !== false) window.localStorage.setItem('cfg_shell_dummy_mode', mode);
        syncSettingsUI();

        const cfg = opts || {};
        if(mode !== 'on'){
          if(prev === 'on' && cfg.silent !== true){
            toast('Dummy account mode off.');
          }
          return;
        }
        applyDummyAccountProfile({
          preserveActiveStep: cfg.preserveActiveStep !== false,
          silent: cfg.silent === true
        });
      }

      function toggleSettings(force){
        if(!settings) return;
        const open = (typeof force === 'boolean') ? force : !settings.classList.contains('open');
        settings.classList.toggle('open', open);
        settings.setAttribute('aria-hidden', open ? 'false' : 'true');
        if(open){
          syncAccountChoiceSources();
        }
      }

      (function initSettingsPrefs(){
        const storedTone = window.localStorage.getItem('cfg_shell_tone');
        const storedDensity = window.localStorage.getItem('cfg_shell_density');
        const storedFontScale = window.localStorage.getItem('cfg_shell_font_scale');
        const storedDummyMode = window.localStorage.getItem('cfg_shell_dummy_mode');
        const storedAccountRaw = window.localStorage.getItem(ACCOUNT_PROFILE_STORAGE_KEY);
        let storedAccount = null;
        if(storedAccountRaw){
          try{
            const parsed = JSON.parse(storedAccountRaw);
            storedAccount = (parsed && typeof parsed === 'object') ? parsed : null;
          }catch(err){
            storedAccount = null;
          }
        }
        settingsState.dummyMode = resolveDummyMode(storedDummyMode || 'off');
        syncAccountChoiceSources();
        applyAccountProfile(storedAccount || settingsState.account, false);
        applyAccountDefaultsToState({ emptyOnly:true });
        applyShellTone(storedTone || 'default', false);
        applyShellDensity(storedDensity || 'comfortable', false);
        applyShellFontScale(storedFontScale || 1, false);
        syncSettingsUI();
      })();

      // Desktop app-shell column sizing (bounded, persisted)
      const shellDesktopMQ = window.matchMedia('(min-width: 1200px)');
      const rootStyle = document.documentElement.style;
      const shellBounds = {
        lhn: { key:'cfg_shell_lhn_w', css:'--app-lhn-w', min:220, max:320, fallback:236 },
        right: { key:'cfg_shell_right_w', css:'--app-right-w', min:520, max:860, fallback:620 }
      };
      const getStoredPx = (cfg)=>{
        const raw = window.localStorage.getItem(cfg.key);
        const n = Number(raw);
        return Number.isFinite(n) ? clamp(n, cfg.min, cfg.max) : null;
      };
      const setSizePx = (cfg, px)=>{
        const next = clamp(px, cfg.min, cfg.max);
        rootStyle.setProperty(cfg.css, `${next}px`);
        window.localStorage.setItem(cfg.key, String(next));
      };
      const resetShellLayoutWidths = ()=>{
        rootStyle.setProperty(shellBounds.lhn.css, `${shellBounds.lhn.fallback}px`);
        rootStyle.setProperty(shellBounds.right.css, `${shellBounds.right.fallback}px`);
        window.localStorage.setItem(shellBounds.lhn.key, String(shellBounds.lhn.fallback));
        window.localStorage.setItem(shellBounds.right.key, String(shellBounds.right.fallback));
        resetDashboardColumnWidths({ persist:true });
      };
      const initShellSizes = ()=>{
        const lhnSaved = getStoredPx(shellBounds.lhn);
        const rightSaved = getStoredPx(shellBounds.right);
        if(lhnSaved !== null) rootStyle.setProperty(shellBounds.lhn.css, `${lhnSaved}px`);
        if(rightSaved !== null) rootStyle.setProperty(shellBounds.right.css, `${rightSaved}px`);
      };
      const wireShellHandle = (el, cfg, invertDelta=false)=>{
        if(!el) return;
        let dragging = false;
        let startX = 0;
        let startW = cfg.fallback;
        const onMove = (ev)=>{
          if(!dragging) return;
          const dx = ev.clientX - startX;
          const delta = invertDelta ? -dx : dx;
          setSizePx(cfg, startW + delta);
        };
        const onUp = ()=>{
          if(!dragging) return;
          dragging = false;
          document.body.classList.remove('is-col-resizing');
          window.removeEventListener('pointermove', onMove);
          window.removeEventListener('pointerup', onUp);
          window.removeEventListener('pointercancel', onUp);
        };
        el.addEventListener('pointerdown', (ev)=>{
          if(!shellDesktopMQ.matches) return;
          dragging = true;
          startX = ev.clientX;
          startW = getStoredPx(cfg) ?? cfg.fallback;
          document.body.classList.add('is-col-resizing');
          window.addEventListener('pointermove', onMove);
          window.addEventListener('pointerup', onUp);
          window.addEventListener('pointercancel', onUp);
        });
      };
      initShellSizes();
      wireShellHandle($('#lhnResizeHandle'), shellBounds.lhn, false);
      wireShellHandle($('#rightResizeHandle'), shellBounds.right, true);
      initDashboardColumnResizing();

      if(openSettingsPanelNav){
        openSettingsPanelNav.addEventListener('click', ()=> toggleSettings(true));
      }
      if(closeSettings){
        closeSettings.addEventListener('click', ()=> toggleSettings(false));
      }
      if(settings){
        settings.addEventListener('click', (e)=>{
          if(e.target === settings) toggleSettings(false);
        });
      }
      let shellResizeTimer = null;
      window.addEventListener('resize', ()=>{
        window.clearTimeout(shellResizeTimer);
        shellResizeTimer = window.setTimeout(()=> update(), 80);
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key !== 'Escape') return;
        if(settings && settings.classList.contains('open')){
          toggleSettings(false);
        }
        if($('#archiveModal')?.classList.contains('show')) closeArchivePrompt();
        if($('#modal')?.classList.contains('show')) $('#modal').classList.remove('show');
      });
      const persistAccountFromInputs = ()=>{
        applyAccountProfile(readAccountProfileFromSettingsUI(), true);
      };
      [accountFullNameInput, accountEmailInput, accountPhoneInput].forEach((el)=>{
        if(!el) return;
        el.addEventListener('input', persistAccountFromInputs);
      });
      [accountRoleSelect, accountCountrySelect, accountRegionSelect, accountFieldModeSelect].forEach((el)=>{
        if(!el) return;
        el.addEventListener('change', persistAccountFromInputs);
      });
      accountPrefillOptions.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          const next = resolveAccountPrefillMode(btn.getAttribute('data-prefill') || 'on');
          const profile = Object.assign({}, settingsState.account || {}, { prefillMode: next });
          applyAccountProfile(profile, true);
        });
      });
      if(accountApplyNowBtn){
        accountApplyNowBtn.addEventListener('click', ()=>{
          persistAccountFromInputs();
          applyAccountDefaultsToState({ emptyOnly:false });
          syncFormControlsFromState();
          update();
          toast('Applied account defaults to this record.');
        });
      }
      if(accountResetBtn){
        accountResetBtn.addEventListener('click', ()=>{
          applyAccountProfile({
            fullName: '',
            email: '',
            phone: '',
            defaultRole: '',
            defaultCountry: '',
            defaultRegion: '',
            fieldMode: 'guided',
            prefillMode: 'on'
          }, true);
          toast('Account defaults reset.');
        });
      }
      toneOptions.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          applyShellTone(btn.getAttribute('data-tone') || 'default');
        });
      });
      densityOptions.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          applyShellDensity(btn.getAttribute('data-density') || 'comfortable');
        });
      });
      fontScaleOptions.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          applyShellFontScale(btn.getAttribute('data-font-scale') || 1);
        });
      });
      dummyOptions.forEach((btn)=>{
        btn.addEventListener('click', ()=>{
          applyDummyMode(btn.getAttribute('data-dummy') || 'off');
        });
      });
      if(resetLayoutWidthsBtn){
        resetLayoutWidthsBtn.addEventListener('click', ()=>{
          resetShellLayoutWidths();
          toggleSettings(false);
          toast('Layout widths reset.');
        });
      }

      // Side panel collapsibles: respect manual toggles once the user interacts.
      ['#sideWhyBlock', '#sideRoiBlock', '#sideAnswersBlock'].forEach(sel=>{
        const el = $(sel);
        if(!el) return;
        el.addEventListener('toggle', ()=>{
          if(el.dataset.autoToggle === 'true'){
            delete el.dataset.autoToggle;
            return;
          }
          el.dataset.userSet = 'true';
        });
      });

      // "Edit" links in the Review summary (jump back to a step + question)
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-jump]');
        if(!btn) return;
        e.preventDefault();
        const step = Number(btn.dataset.jump || 0);
        const sel = btn.dataset.target;
        if(step) setActiveStep(step);

        if(sel){
          window.setTimeout(()=>{
            const el = document.querySelector(sel);
            if(!el) return;
            el.classList.add('flash');
            el.scrollIntoView({ behavior:'smooth', block:'start' });
            window.setTimeout(()=> el.classList.remove('flash'), 1200);
          }, 260);
        }
      });


      // business inputs
      const fullNameEl = $('#fullName');
      if(fullNameEl) fullNameEl.addEventListener('input', (e)=>{ state.fullName = e.target.value; update(); });

      const companyEl = $('#company');
      if(companyEl) companyEl.addEventListener('input', (e)=>{ state.company = e.target.value; update(); });

      const companySizeEl = $('#companySize');
      if(companySizeEl) companySizeEl.addEventListener('change', (e)=>{ state.companySize = e.target.value; update(); });

      const operatingCountryEl = $('#operatingCountry');
      if(operatingCountryEl) operatingCountryEl.addEventListener('change', (e)=>{ state.operatingCountry = e.target.value; update(); });

      renderSingleOptionButtons($('#optRole'), roleOpts, 'role');
      renderLimitedChecks($('#pressureCards'), 'pressureSources', '#pressureMeta', pressureOpts, 3);
      renderRadios($('#radUrgentWin'), 'urgentWin', urgentWinOpts, (id)=> state.urgentWin = id);
      renderLimitedChecks($('#riskEnvCards'), 'riskEnvs', '#riskEnvMeta', riskEnvOpts, 2);
      renderRadios($('#radMeasuredOn'), 'measuredOn', measuredOnOpts, (id)=> state.measuredOn = id);
      renderRadios($('#radOrgPain'), 'orgPain', orgPainOpts, (id)=> state.orgPain = id);

      renderDriverCards();

      renderOptionButtons($('#optGroups'), groupOpts, state.groups);
      renderRadios($('#radRhythm'), 'rhythm', rhythmOpts, (id)=> state.rhythm = id);
      renderRadios($('#radMeasure'), 'measure', measureOpts, (id)=> state.measure = id);

      // Package fit
      renderRadios($('#radFitRealism'), 'fitRealism', fitRealismOpts, (id)=> state.fitRealism = id);
      renderRadios($('#radFitScope'), 'fitScope', fitScopeOpts, (id)=> state.fitScope = id);
      renderRadios($('#radFitToday'), 'fitToday', fitTodayOpts, (id)=> state.fitToday = id);
      renderRadios($('#radFitServices'), 'fitServices', fitServicesOpts, (id)=> state.fitServices = id);
      renderRadios($('#radFitRisk'), 'fitRiskFrame', fitRiskFrameOpts, (id)=> state.fitRiskFrame = id);

      // Tech stack pick-list
      renderOptionButtons($('#optStackSoc'), stackSocOpts, state.stack);
      renderOptionButtons($('#optStackCloud'), stackCloudOpts, state.stack);
      renderOptionButtons($('#optStackDevops'), stackDevopsOpts, state.stack);
      renderOptionButtons($('#optStackDomains'), stackDomainOpts, state.stack);

      const stackOtherEl = $('#stackOther');
      if(stackOtherEl){
        stackOtherEl.addEventListener('input', (e)=>{
          state.stackOther = e.target.value;
          update();
        });
      }


      // Context dropdowns
      $('#industry').addEventListener('change', (e)=>{
        state.industry = e.target.value;
        state._industryChanged = true;
        update();
      });
      $('#region').addEventListener('change', (e)=>{
        state.region = e.target.value;
        state._regionChanged = true;
        update();
      });

      // Regulation picker controls
      const regSearchEl = $('#regSearch');
      if(regSearchEl){
        regSearchEl.addEventListener('input', (e)=>{
          state.regSearch = e.target.value;
          update();
        });
      }

      $$('#regMode .segBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const mode = btn.dataset.mode;
          if(!mode) return;
          state.regModeTouched = true;
          state.regMode = mode;
          update();
        });
      });

      const proofSetBtn = $('#applyProofSet');
      if(proofSetBtn){
        proofSetBtn.addEventListener('click', ()=>{
          applyCommonProofSet();
          toast('Applied recommended set.');
          update();
        });
      }

      // Currency toggle
      $$('.curBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const cur = btn.dataset.cur;
          if(!cur) return;
          state.currency = cur;

          // reflect pressed state
          $$('.curBtn').forEach(b=> b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');

          // resync sliders into the selected currency
          syncCurrencyUI();
          update();
        });
      });

      // FX inputs
      const fxGBP = $('#fxGBP');
      if(fxGBP){
        fxGBP.addEventListener('input', (e)=>{
          const v = Number(e.target.value);
          if(Number.isFinite(v) && v > 0) state.fx.GBP = v;
          syncCurrencyUI();
          update();
        });
      }
      const fxEUR = $('#fxEUR');
      if(fxEUR){
        fxEUR.addEventListener('input', (e)=>{
          const v = Number(e.target.value);
          if(Number.isFinite(v) && v > 0) state.fx.EUR = v;
          syncCurrencyUI();
          update();
        });
      }

      // ROI estimate controls
      const revenueEl = $('#revenue');
      const investEl = $('#invest');
      const cyberEl = $('#teamCyber');
      const devEl = $('#teamDev');
      const wfEl = $('#teamWf');

      function syncCurrencyUI(){
        const fx = fxRate();

        // Revenue slider is expressed in "selected currency billions" for UX.
        // Internal state stays in USD billions.
        if(revenueEl){
          revenueEl.min = String((0.2 * fx).toFixed(2));
          revenueEl.max = String((200 * fx).toFixed(0));
          revenueEl.step = String((0.1 * fx).toFixed(2));
          revenueEl.value = String((state.revenueB * fx).toFixed(2));
        }

        // Spend slider is expressed in selected currency.
        if(investEl){
          investEl.min = String(Math.round(25000 * fx));
          investEl.max = String(Math.round(9000000 * fx));
          investEl.step = String(Math.max(1000, Math.round(5000 * fx)));
          investEl.value = String(Math.round(state.investUSD * fx));
        }

        // Salary inputs are expressed in selected currency (internal state stays USD)
        const cyberSal = $('#cyberSalary');
        if(cyberSal) cyberSal.value = String(Math.round(state.cyberSalaryUSD * fx));
        const devSal = $('#devSalary');
        if(devSal) devSal.value = String(Math.round(state.devSalaryUSD * fx));
      }

      function syncFormControlsFromState(){
        const setVal = (sel, val)=>{
          const el = $(sel);
          if(el) el.value = val;
        };
        setVal('#fullName', state.fullName);
        setVal('#company', state.company);
        setVal('#companySize', state.companySize);
        setVal('#operatingCountry', state.operatingCountry);
        setVal('#industry', state.industry);
        setVal('#region', state.region);
        setVal('#regSearch', state.regSearch);
        setVal('#stackOther', state.stackOther);
        setVal('#email', state.email);
        setVal('#phone', state.phone);
        setVal('#notes', state.notes);

        const optinEl = $('#optin');
        if(optinEl) optinEl.checked = !!state.optin;

        const fxGBPEl = $('#fxGBP');
        if(fxGBPEl) fxGBPEl.value = String(state.fx.GBP);
        const fxEUREl = $('#fxEUR');
        if(fxEUREl) fxEUREl.value = String(state.fx.EUR);
        const payEl = $('#paybackDelay');
        if(payEl) payEl.value = String(state.paybackDelayMonths);

        if(cyberEl) cyberEl.value = String(state.teamCyber);
        if(devEl) devEl.value = String(state.teamDev);
        if(wfEl) wfEl.value = String(state.teamWf);

        $$('.curBtn').forEach((btn)=>{
          btn.setAttribute('aria-pressed', (btn.dataset.cur === state.currency) ? 'true' : 'false');
        });
        $$('.segBtn[data-real]').forEach((btn)=>{
          btn.setAttribute('aria-pressed', (btn.dataset.real === state.realization) ? 'true' : 'false');
        });

        renderSingleOptionButtons($('#optRole'), roleOpts, 'role');
        renderLimitedChecks($('#pressureCards'), 'pressureSources', '#pressureMeta', pressureOpts, 3);
        renderRadios($('#radUrgentWin'), 'urgentWin', urgentWinOpts, (id)=> state.urgentWin = id);
        renderLimitedChecks($('#riskEnvCards'), 'riskEnvs', '#riskEnvMeta', riskEnvOpts, 2);
        renderRadios($('#radMeasuredOn'), 'measuredOn', measuredOnOpts, (id)=> state.measuredOn = id);
        renderRadios($('#radOrgPain'), 'orgPain', orgPainOpts, (id)=> state.orgPain = id);
        renderDriverCards();
        renderOptionButtons($('#optGroups'), groupOpts, state.groups);
        renderRadios($('#radRhythm'), 'rhythm', rhythmOpts, (id)=> state.rhythm = id);
        renderRadios($('#radMeasure'), 'measure', measureOpts, (id)=> state.measure = id);
        renderRadios($('#radFitRealism'), 'fitRealism', fitRealismOpts, (id)=> state.fitRealism = id);
        renderRadios($('#radFitScope'), 'fitScope', fitScopeOpts, (id)=> state.fitScope = id);
        renderRadios($('#radFitToday'), 'fitToday', fitTodayOpts, (id)=> state.fitToday = id);
        renderRadios($('#radFitServices'), 'fitServices', fitServicesOpts, (id)=> state.fitServices = id);
        renderRadios($('#radFitRisk'), 'fitRiskFrame', fitRiskFrameOpts, (id)=> state.fitRiskFrame = id);
        renderOptionButtons($('#optStackSoc'), stackSocOpts, state.stack);
        renderOptionButtons($('#optStackCloud'), stackCloudOpts, state.stack);
        renderOptionButtons($('#optStackDevops'), stackDevopsOpts, state.stack);
        renderOptionButtons($('#optStackDomains'), stackDomainOpts, state.stack);

        $$('.step').forEach((s)=> s.dataset.active = (s.dataset.step === String(state.activeStep)) ? 'true' : 'false');
        $$('.chip').forEach((c)=> c.dataset.active = (c.dataset.chip === String(state.activeStep)) ? 'true' : 'false');

        syncCurrencyUI();
      }

      function createNewRecord(){
        const account = settingsState.account || {};
        const useAccountDefaults = resolveAccountPrefillMode(account.prefillMode) !== 'off';
        state.activeThread = 'current';
        state.savePulseUntil = 0;
        state.saveIsThinking = false;
        clearScheduledAutoSave();

        // Identity + context
        state.role = '';
        state.fullName = useAccountDefaults ? (account.fullName || '') : '';
        state.company = '';
        state.companySize = '';
        state.operatingCountry = useAccountDefaults ? (account.defaultCountry || '') : '';
        state.industry = '';
        state.region = useAccountDefaults ? (account.defaultRegion || '') : '';
        state._industryChanged = false;
        state._regionChanged = false;

        // Outcome discovery
        state.pressureSources = [];
        state.urgentWin = '';
        state.riskEnvs = [];
        state.measuredOn = '';
        state.orgPain = '';
        state.drivers = [];
        state.milestone = '';
        state.evidence = new Set();
        state.outcomeDrilldowns = {};

        // Coverage + package fit
        state.groups = new Set();
        state.rhythm = '';
        state.measure = '';
        state.fitRealism = '';
        state.fitScope = '';
        state.fitToday = '';
        state.fitServices = '';
        state.fitRiskFrame = '';

        // Context + stack
        state.regMode = 'suggested';
        state.regModeTouched = false;
        state.regSearch = '';
        state.regsTouched = false;
        state.regs = new Set();
        state.stack = new Set();
        state.stackOther = '';

        // ROI assumptions
        state.currency = 'USD';
        state.fx.GBP = 0.80;
        state.fx.EUR = 0.90;
        state.revenueB = IMMERSIVE_MODEL.baselineRevenueB;
        state.teamCyber = IMMERSIVE_MODEL.baselineCyber;
        state.teamDev = IMMERSIVE_MODEL.baselineDev;
        state.teamWf = IMMERSIVE_MODEL.baselineWorkforce;
        state.teamManual = false;
        state.investManual = false;
        state.investUSD = IMMERSIVE_MODEL.baselineInvestment;
        state.realization = 'conservative';
        state.paybackDelayMonths = 3;
        state.cyberSalaryUSD = 180000;
        state.devSalaryUSD = 160000;

        // Lead capture
        state.email = useAccountDefaults ? (account.email || '') : '';
        state.phone = useAccountDefaults ? (account.phone || '') : '';
        state.notes = '';
        state.optin = false;

        // Nav state
        state.activeStep = 1;
        state.visited = new Set([1]);

        syncFormControlsFromState();
        setView('interstitial', { render:false });
        update();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        toast('New record created.');
      }

      function applyDummyAccountProfile(opts){
        const cfg = opts || {};
        const keepStep = clamp(Number(state.activeStep) || 1, 1, 6);

        // Identity + context
        state.role = 'ciso';
        state.fullName = 'Jane Doe';
        state.company = 'Orchid Corp';
        state.companySize = '10k-50k';
        state.operatingCountry = 'United States';
        state.industry = 'Financial Services';
        state.region = 'NA';
        state._industryChanged = false;
        state._regionChanged = false;

        // Outcome discovery
        state.pressureSources = ['board', 'regulator', 'insurer'];
        state.urgentWin = 'boardEvidence';
        state.riskEnvs = ['cloud', 'identity'];
        state.measuredOn = 'audit';
        state.orgPain = 'externalProof';
        state.drivers = ['insurance', 'nearMiss', 'change'];
        state.milestone = 'evidence';
        state.evidence = new Set(['board', 'reg', 'insurer']);
        state.outcomeDrilldowns = {
          complianceEvidence: 'regInsurer',
          fasterResponse: 'coordination',
          secureEnterprise: 'cloudIdentity',
          supplyChain: 'regs'
        };

        // Coverage + package fit
        state.groups = new Set(['soc', 'cloud', 'grc', 'exec', 'third']);
        state.rhythm = 'monthly';
        state.measure = 'performance';
        state.fitRealism = 'tooling';
        state.fitScope = 'multi';
        state.fitToday = 'adhoc';
        state.fitServices = 'guided';
        state.fitRiskFrame = 'governance';

        // Context + stack
        state.regMode = 'suggested';
        state.regModeTouched = false;
        state.regSearch = '';
        state.regsTouched = true;
        state.regs = new Set(['nistscf', 'iso27001', 'soc2', 'sec', 'nydfs']);
        state.stack = new Set(['crowdstrike', 'sentinel', 'aws', 'azure', 'kubernetes', 'github', 'identity', 'grc', 'vuln']);
        state.stackOther = 'ServiceNow GRC';

        // ROI assumptions
        state.currency = 'USD';
        state.fx.GBP = 0.80;
        state.fx.EUR = 0.90;
        state.revenueB = 12;
        state.teamCyber = 240;
        state.teamDev = 1200;
        state.teamWf = 5200;
        state.teamManual = true;
        state.investUSD = 850000;
        state.investManual = true;
        state.realization = 'expected';
        state.paybackDelayMonths = 2;
        state.cyberSalaryUSD = 185000;
        state.devSalaryUSD = 165000;

        // Lead capture
        state.email = 'jane.doe@orchidcorp.com';
        state.phone = '+1 415 555 0147';
        state.notes = 'Dummy account for visual QA and layout checks.';
        state.optin = true;

        // Mark all steps visited so snapshot/review/ROI render fully.
        state.visited = new Set([1, 2, 3, 4, 5, 6]);
        state.activeStep = cfg.preserveActiveStep === false ? 6 : keepStep;

        syncFormControlsFromState();
        update();

        if(cfg.silent !== true){
          toast('Dummy account populated.');
        }
      }

      function applySuggested(){
        const suggested = inferProgramScale(state.revenueB);
        state.teamCyber = suggested.cyber;
        state.teamDev = suggested.dev;
        state.teamWf = suggested.wf;
        state.teamManual = false;

        if(!state.investManual){
          state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });
        }

        // sync sliders
        if(cyberEl) cyberEl.value = String(state.teamCyber);
        if(devEl) devEl.value = String(state.teamDev);
        if(wfEl) wfEl.value = String(state.teamWf);

        syncCurrencyUI();
        update();
      }

      if(revenueEl){
        revenueEl.addEventListener('input', (e)=>{
          // slider value is in selected currency billions
          const curB = Number(e.target.value)||0;
          state.revenueB = curB / fxRate();

          if(!state.teamManual){
            const suggested = inferProgramScale(state.revenueB);
            state.teamCyber = suggested.cyber;
            state.teamDev = suggested.dev;
            state.teamWf = suggested.wf;

            if(cyberEl) cyberEl.value = String(state.teamCyber);
            if(devEl) devEl.value = String(state.teamDev);
            if(wfEl) wfEl.value = String(state.teamWf);
          }

          if(!state.investManual){
            state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });
            syncCurrencyUI();
          }else{
            syncCurrencyUI();
          }
          update();
        });
      }

      if(investEl){
        investEl.addEventListener('input', (e)=>{
          const curVal = Number(e.target.value)||0;
          state.investUSD = fromCur(curVal);
          state.investManual = true;
          update();
        });
      }

      if(cyberEl){
        cyberEl.addEventListener('input', (e)=>{
          state.teamCyber = Number(e.target.value)||0;
          state.teamManual = true;

          // If spend hasn't been manually overridden, keep it in sync with footprint changes.
          if(!state.investManual){
            state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });
            syncCurrencyUI();
          }

          update();
        });
      }
      if(devEl){
        devEl.addEventListener('input', (e)=>{
          state.teamDev = Number(e.target.value)||0;
          state.teamManual = true;

          if(!state.investManual){
            state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });
            syncCurrencyUI();
          }

          update();
        });
      }
      if(wfEl){
        wfEl.addEventListener('input', (e)=>{
          state.teamWf = Number(e.target.value)||0;
          state.teamManual = true;

          if(!state.investManual){
            state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });
            syncCurrencyUI();
          }

          update();
        });
      }

      // labels for team sliders
      function syncTeamLabels(){
        const a = $('#teamCyberLabel'); if(a) a.textContent = fmtNum(state.teamCyber);
        const b = $('#teamDevLabel'); if(b) b.textContent = fmtNum(state.teamDev);
        const c = $('#teamWfLabel'); if(c) c.textContent = fmtNum(state.teamWf);
        const d = $('#investLabel'); if(d) d.textContent = fmtMoneyUSD(state.investUSD);
      }

      // show reset if needed
      function syncReset(){
        const btn = $('#resetValue');
        if(!btn) return;
        btn.style.display = 'inline-flex';
      }


      function resetValuePreview(){
        // Reset Step 4 inputs to the baseline model.
        state.currency = 'USD';
        state.fx.GBP = 0.80;
        state.fx.EUR = 0.90;

        state.revenueB = IMMERSIVE_MODEL.baselineRevenueB;

        state.teamCyber = IMMERSIVE_MODEL.baselineCyber;
        state.teamDev = IMMERSIVE_MODEL.baselineDev;
        state.teamWf = IMMERSIVE_MODEL.baselineWorkforce;
        state.teamManual = false;

        state.investManual = false;
        state.investUSD = IMMERSIVE_MODEL.baselineInvestment;

        state.realization = 'conservative';
        state.paybackDelayMonths = 3;
        state.cyberSalaryUSD = 180000;
        state.devSalaryUSD = 160000;

        // UI: currency buttons
        $$('.curBtn').forEach(b=> b.setAttribute('aria-pressed', (b.dataset.cur === state.currency) ? 'true' : 'false'));

        // UI: scenario buttons
        $$('.segBtn[data-real]').forEach(b=> b.setAttribute('aria-pressed', (b.dataset.real === state.realization) ? 'true' : 'false'));

        // Inputs (FX / payback delay)
        const fxGBPEl = $('#fxGBP'); if(fxGBPEl) fxGBPEl.value = String(state.fx.GBP);
        const fxEUREl = $('#fxEUR'); if(fxEUREl) fxEUREl.value = String(state.fx.EUR);
        const payEl = $('#paybackDelay'); if(payEl) payEl.value = String(state.paybackDelayMonths);

        // Sliders
        if(cyberEl) cyberEl.value = String(state.teamCyber);
        if(devEl) devEl.value = String(state.teamDev);
        if(wfEl) wfEl.value = String(state.teamWf);

        // Ensure spend matches the baseline model
        state.investUSD = typicalInvestment(state.revenueB, { cyber: state.teamCyber, dev: state.teamDev, wf: state.teamWf });

        syncCurrencyUI();
        update();
      }

      const resetBtn = $('#resetValue');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          resetValuePreview();
          toast('Reset to baseline.');
        });
      }

      // Scenario toggle
      $$('.segBtn[data-real]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          state.realization = btn.dataset.real;
          $$('.segBtn[data-real]').forEach(b=> b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          update();
        });
      });

      // Payback delay
      const paybackDelayEl = $('#paybackDelay');
      if(paybackDelayEl){
        paybackDelayEl.addEventListener('input', (e)=>{
          state.paybackDelayMonths = Number(e.target.value)||0;
          update();
        });
      }

      const cyberSalaryEl = $('#cyberSalary');
      if(cyberSalaryEl){
        cyberSalaryEl.addEventListener('input', (e)=>{
          const curVal = Number(e.target.value)||0;
          state.cyberSalaryUSD = fromCur(curVal);
          update();
        });
      }

      const devSalaryEl = $('#devSalary');
      if(devSalaryEl){
        devSalaryEl.addEventListener('input', (e)=>{
          const curVal = Number(e.target.value)||0;
          state.devSalaryUSD = fromCur(curVal);
          update();
        });
      }

      // Step nav actions
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;

        if(action === 'next'){
          setActiveStep(state.activeStep + 1);
          requestAutoSave(AUTO_SAVE_FAST_MS);
        }
        if(action === 'back'){
          setActiveStep(state.activeStep - 1);
        }
        if(action === 'copy'){
          const rec = score();
          const tier = (rec.best === 'core') ? packages.core : (rec.best === 'adv') ? packages.adv : packages.ult;
          const rs = reasons(rec.best);
          const roi = computeRoi();
          const paybackTxt = fmtPayback(computePaybackMonths(roi));
          copyToClipboard(buildSummaryText(tier, rs, roi, paybackTxt));
        }
        if(action === 'downloadCSV'){
          const report = buildReportModelV1();
          const csv = reportToCSV(report);
          const fname = `immersive-readiness-${safeFilePart(report.organisation.company || 'report')}-${report.createdAt.slice(0,10)}.csv`;
          downloadText(csv, fname, 'text/csv;charset=utf-8;');
          toast('Downloaded CSV.');
        }
        if(action === 'printReport'){
          const report = buildReportModelV1();
          printReport(report);
        }
        if(action === 'book'){
          state.email = $('#email').value.trim();
          state.phone = $('#phone').value.trim();
          state.notes = $('#notes').value.trim();
          state.optin = $('#optin').checked;

          if(!state.email){
            toast('Add a business email to book a consultation.');
            $('#email').focus();
            return;
          }

          $('#modal').classList.add('show');
        }
        if(action === 'closeModal'){
          $('#modal').classList.remove('show');
        }
        if(action === 'closeArchiveModal'){
          closeArchivePrompt();
        }
        if(action === 'confirmArchiveModal'){
          applyArchivePrompt();
        }
      });

      // Close modal on backdrop click
      $('#modal').addEventListener('click', (e)=>{
        if(e.target.id === 'modal') $('#modal').classList.remove('show');
      });
      $('#archiveModal')?.addEventListener('click', (e)=>{
        if(e.target.id === 'archiveModal') closeArchivePrompt();
      });

      // Boot: align suggested sizing
      applySuggested();
      syncFormControlsFromState();

      // keep slider labels in sync on each update
      const _update = update;
      update = function(){
        syncTeamLabels();
        syncReset();
        _update();
      }

      if(settingsState.dummyMode === 'on'){
        applyDummyAccountProfile({ preserveActiveStep:true, silent:true });
      }else{
        update();
      }
    })();
  
</script>
</body>
</html>
